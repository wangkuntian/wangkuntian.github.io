
<!DOCTYPE html>
<html lang="zh-en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Wang kuntian&#39;s Blog">
    <title>源码看Trove（一） - Wang kuntian&#39;s Blog</title>
    <meta name="author" content="Wang kuntian">
    
        <meta name="keywords" content="Trove">
    
    
        <link rel="icon" href="https://wangkuntian.github.io/assets/images/favicon.png">
    
    
        
            <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
        
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Wang kuntian","sameAs":["https://github.com/wangkuntian","mailto:wangkuntian1994@163.com"],"image":"faker.jpg"},"articleBody":"Trove create 源码解析\n\n\ntrove create命令（python-troveclient仓库的一部分）封装了用户提供的所有命令行参数，并发送一个POST到Trove公共API定义的URI /v1.0/{tenant_id}/instances。\ntrove在api-paste.ini中定义程序的入口。\n12[app:troveapp]paste.app_factory = trove.common.api:app_factory\n\n可以在trove.common.api.py文件中，找到API类。其中它的_instance_router定义了实例的路由路径和被调用的方法。\n12345678910111213141516171819def app_factory(global_conf, **local_conf):    return API()class API(wsgi.Router):&quot;&quot;&quot;Defines the API routes.&quot;&quot;&quot;    def __init__(self):        mapper = routes.Mapper()        super(API, self).__init__(mapper)        self._instance_router(mapper)        ...    def _instance_router(self, mapper):        instance_resource = InstanceController().create_resource()        mapper.connect(&quot;/&#123;tenant_id&#125;/instances&quot;,                        controller=instance_resource,                        action=&quot;create&quot;,                        conditions=&#123;&#x27;method&#x27;: [&#x27;POST&#x27;]&#125;)        ...\nInstanceController类在trove.instance.service.py文件中被定义。实例创建时将会调用create()。\n123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112class InstanceController(wsgi.Controller):    ...    def create(self, req, body, tenant_id):        # TODO(hub-cap): turn this into middleware        LOG.info(_LI(&quot;Creating a database instance for tenant &#x27;%s&#x27;&quot;),                 tenant_id)        LOG.debug(&quot;req : &#x27;%s&#x27;\\n\\n&quot;, strutils.mask_password(req))        LOG.debug(&quot;body : &#x27;%s&#x27;\\n\\n&quot;, strutils.mask_password(body))        context = req.environ[wsgi.CONTEXT_KEY]        policy.authorize_on_tenant(context, &#x27;instance:create&#x27;)        # 消息        context.notification = notification.DBaaSInstanceCreate(context,                                                                request=req)        # 数据库参数        datastore_args = body[&#x27;instance&#x27;].get(&#x27;datastore&#x27;, &#123;&#125;)        # 验证并获取数据库以及版本        datastore, datastore_version = (            datastore_models.get_datastore_version(**datastore_args))        # 镜像        image_id = datastore_version.image_id        # 实例名        name = body[&#x27;instance&#x27;][&#x27;name&#x27;]        # flavor        flavor_ref = body[&#x27;instance&#x27;][&#x27;flavorRef&#x27;]        flavor_id = utils.get_id_from_href(flavor_ref)        # 配置组        configuration = self._configuration_parse(context, body)        databases = populate_validated_databases(            body[&#x27;instance&#x27;].get(&#x27;databases&#x27;, []))        database_names = [database.get(&#x27;_name&#x27;, &#x27;&#x27;) for database in databases]        users = None        try:            users = populate_users(body[&#x27;instance&#x27;].get(&#x27;users&#x27;, []),                                   database_names)        except ValueError as ve:            raise exception.BadRequest(msg=ve)        modules = body[&#x27;instance&#x27;].get(&#x27;modules&#x27;)        # The following operations have their own API calls.        # We need to make sure the same policies are enforced when        # creating an instance.        # i.e. if attaching configuration group to an existing instance is not        # allowed, it should not be possible to create a new instance with the        # group attached either        if configuration:            policy.authorize_on_tenant(context, &#x27;instance:update&#x27;)        if modules:            policy.authorize_on_tenant(context, &#x27;instance:module_apply&#x27;)        if users:            policy.authorize_on_tenant(                context, &#x27;instance:extension:user:create&#x27;)        if databases:            policy.authorize_on_tenant(                context, &#x27;instance:extension:database:create&#x27;)        # 卷        if &#x27;volume&#x27; in body[&#x27;instance&#x27;]:            volume_info = body[&#x27;instance&#x27;][&#x27;volume&#x27;]            volume_size = int(volume_info[&#x27;size&#x27;])            volume_type = volume_info.get(&#x27;type&#x27;)        else:            volume_size = None            volume_type = None        # 备份        if &#x27;restorePoint&#x27; in body[&#x27;instance&#x27;]:            backupRef = body[&#x27;instance&#x27;][&#x27;restorePoint&#x27;][&#x27;backupRef&#x27;]            backup_id = utils.get_id_from_href(backupRef)        else:            backup_id = None        availability_zone = body[&#x27;instance&#x27;].get(&#x27;availability_zone&#x27;)        nics = body[&#x27;instance&#x27;].get(&#x27;nics&#x27;)        # 复制        slave_of_id = body[&#x27;instance&#x27;].get(&#x27;replica_of&#x27;,                                           # also check for older name                                           body[&#x27;instance&#x27;].get(&#x27;slave_of&#x27;))        replica_count = body[&#x27;instance&#x27;].get(&#x27;replica_count&#x27;)        locality = body[&#x27;instance&#x27;].get(&#x27;locality&#x27;)        if locality:            locality_domain = [&#x27;affinity&#x27;, &#x27;anti-affinity&#x27;]            locality_domain_msg = (&quot;Invalid locality &#x27;%s&#x27;. &quot;                                   &quot;Must be one of [&#x27;%s&#x27;]&quot; %                                   (locality,                                    &quot;&#x27;, &#x27;&quot;.join(locality_domain)))            if locality not in locality_domain:                raise exception.BadRequest(msg=locality_domain_msg)            if slave_of_id:                dupe_locality_msg = (                    &#x27;Cannot specify locality when adding replicas to existing &#x27;                    &#x27;master.&#x27;)                raise exception.BadRequest(msg=dupe_locality_msg)        region_name = body[&#x27;instance&#x27;].get(&#x27;region_name&#x27;, CONF.os_region_name)        instance = models.Instance.create(context, name, flavor_id,                                          image_id, databases, users,                                          datastore, datastore_version,                                          volume_size, backup_id,                                          availability_zone, nics,                                          configuration, slave_of_id,                                          replica_count=replica_count,                                          volume_type=volume_type,                                          modules=modules,                                          locality=locality,                                          region_name=region_name)        view = views.InstanceDetailView(instance, req=req)        return wsgi.Result(view.data(), 200)    ...\n在拆包并理解了接收到的req和body中的参数的意义后，信息被传递到trove.instances.models.py中（见第98行代码）的create() 方法中。\n123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249@classmethoddef create(cls, context, name, flavor_id, image_id, databases, users,          datastore, datastore_version, volume_size, backup_id,          availability_zone=None, nics=None,          configuration_id=None, slave_of_id=None, cluster_config=None,          replica_count=None, volume_type=None, modules=None,          locality=None, region_name=None):   region_name = region_name or CONF.os_region_name   call_args = &#123;       &#x27;name&#x27;: name,       &#x27;flavor_id&#x27;: flavor_id,       &#x27;datastore&#x27;: datastore.name if datastore else None,       &#x27;datastore_version&#x27;: datastore_version.name,       &#x27;image_id&#x27;: image_id,       &#x27;availability_zone&#x27;: availability_zone,       &#x27;region_name&#x27;: region_name,   &#125;   # All nova flavors are permitted for a datastore-version unless one   # or more entries are found in datastore_version_metadata,   # in which case only those are permitted.   bound_flavors = DBDatastoreVersionMetadata.find_all(       datastore_version_id=datastore_version.id,       key=&#x27;flavor&#x27;, deleted=False   )   if bound_flavors.count() &gt; 0:       valid_flavors = tuple(f.value for f in bound_flavors)       if flavor_id not in valid_flavors:           raise exception.DatastoreFlavorAssociationNotFound(               datastore=datastore.name,               datastore_version=datastore_version.name,               flavor_id=flavor_id)   datastore_cfg = CONF.get(datastore_version.manager)   # 调用Nova检查flavor是否有效。   client = create_nova_client(context)   try:       flavor = client.flavors.get(flavor_id)   except nova_exceptions.NotFound:       raise exception.FlavorNotFound(uuid=flavor_id)   # If a different region is specified for the instance, ensure   # that the flavor and image are the same in both regions   if region_name and region_name != CONF.os_region_name:       cls._validate_remote_datastore(context, region_name, flavor,                                      datastore, datastore_version)   deltas = &#123;&#x27;instances&#x27;: 1&#125;   volume_support = datastore_cfg.volume_support   if volume_support:       call_args[&#x27;volume_type&#x27;] = volume_type       dvm.validate_volume_type(context, volume_type,                                datastore.name, datastore_version.name)       call_args[&#x27;volume_size&#x27;] = volume_size       validate_volume_size(volume_size)       deltas[&#x27;volumes&#x27;] = volume_size       # Instance volume should have enough space for the backup       # Backup, and volume sizes are in GBs       target_size = volume_size   else:       target_size = flavor.disk  # local_storage       if volume_size is not None:           raise exception.VolumeNotSupported()       if datastore_cfg.device_path:           if flavor.ephemeral == 0:               raise exception.LocalStorageNotSpecified(flavor=flavor_id)           target_size = flavor.ephemeral  # ephemeral_Storage   # 从现有的备份启动一个实例。（用户指定一个备份作为实例的源。）   if backup_id:       call_args[&#x27;backup_id&#x27;] = backup_id       backup_info = Backup.get_by_id(context, backup_id)       if not backup_info.is_done_successfuly:           raise exception.BackupNotCompleteError(               backup_id=backup_id, state=backup_info.state)       if backup_info.size &gt; target_size:           raise exception.BackupTooLarge(               backup_size=backup_info.size, disk_size=target_size)       if not backup_info.check_swift_object_exist(               context,               verify_checksum=CONF.verify_swift_checksum_on_restore):           raise exception.BackupFileNotFound(               location=backup_info.location)       if (backup_info.datastore_version_id               and backup_info.datastore.name != datastore.name):           raise exception.BackupDatastoreMismatchError(               datastore1=backup_info.datastore.name,               datastore2=datastore.name)   # 启动一个实例作为另一个实例的副本。（用户启动复制。）   if slave_of_id:       call_args[&#x27;replica_of&#x27;] = slave_of_id       call_args[&#x27;replica_count&#x27;] = replica_count       replication_support = datastore_cfg.replication_strategy       if not replication_support:           raise exception.ReplicationNotSupported(               datastore=datastore.name)       try:           # looking for replica source           replica_source = DBInstance.find_by(               context,               id=slave_of_id,               deleted=False)           if replica_source.slave_of_id:               raise exception.Forbidden(                   _(&quot;Cannot create a replica of a replica %(id)s.&quot;)                   % &#123;&#x27;id&#x27;: slave_of_id&#125;)           # load the replica source status to check if           # source is available           load_simple_instance_server_status(               context,               replica_source)           replica_source_instance = Instance(               context, replica_source,               None,               InstanceServiceStatus.find_by(                   context,                   instance_id=slave_of_id))           replica_source_instance.validate_can_perform_action()       except exception.ModelNotFoundError:           LOG.exception(               _(&quot;Cannot create a replica of %(id)s &quot;                 &quot;as that instance could not be found.&quot;),               &#123;&#x27;id&#x27;: slave_of_id&#125;)           raise exception.NotFound(uuid=slave_of_id)   elif replica_count and replica_count != 1:       raise exception.Forbidden(_(           &quot;Replica count only valid when creating replicas. Cannot &quot;           &quot;create %(count)d instances.&quot;) % &#123;&#x27;count&#x27;: replica_count&#125;)   multi_replica = slave_of_id and replica_count and replica_count &gt; 1   instance_count = replica_count if multi_replica else 1   if locality:       call_args[&#x27;locality&#x27;] = locality   if not nics:       nics = []   if CONF.default_neutron_networks:       nics = [&#123;&quot;net-id&quot;: net_id&#125;               for net_id in CONF.default_neutron_networks] + nics   if nics:       call_args[&#x27;nics&#x27;] = nics   if cluster_config:       call_args[&#x27;cluster_id&#x27;] = cluster_config.get(&quot;id&quot;, None)   if not modules:       modules = []   module_ids = [mod[&#x27;id&#x27;] for mod in modules]   modules = module_models.Modules.load_by_ids(context, module_ids)   auto_apply_modules = module_models.Modules.load_auto_apply(       context, datastore.id, datastore_version.id)   for aa_module in auto_apply_modules:       if aa_module.id not in module_ids:           modules.append(aa_module)   module_models.Modules.validate(       modules, datastore.id, datastore_version.id)   module_list = module_views.convert_modules_to_list(modules)   def _create_resources():       if cluster_config:           cluster_id = cluster_config.get(&quot;id&quot;, None)           shard_id = cluster_config.get(&quot;shard_id&quot;, None)           instance_type = cluster_config.get(&quot;instance_type&quot;, None)       else:           cluster_id = shard_id = instance_type = None       ids = []       names = []       root_passwords = []       root_password = None       for instance_index in range(0, instance_count):           # 实例的创建被记录在基础设施数据库中，           # 并且该实例被标记为InstanceTasks.BUILDING状态           db_info = DBInstance.create(               name=name, flavor_id=flavor_id, tenant_id=context.tenant,               volume_size=volume_size,               datastore_version_id=datastore_version.id,               task_status=InstanceTasks.BUILDING,               configuration_id=configuration_id,               slave_of_id=slave_of_id, cluster_id=cluster_id,               shard_id=shard_id, type=instance_type,               region_id=region_name)           LOG.debug(&quot;Tenant %(tenant)s created new Trove instance &quot;                     &quot;%(db)s in region %(region)s.&quot;,                     &#123;&#x27;tenant&#x27;: context.tenant, &#x27;db&#x27;: db_info.id,                      &#x27;region&#x27;: region_name&#125;)           instance_id = db_info.id           cls.add_instance_modules(context, instance_id, modules)           instance_name = name           ids.append(instance_id)           names.append(instance_name)           root_passwords.append(None)           # change the name to be name + replica_number if more than one           if multi_replica:               replica_number = instance_index + 1               names[instance_index] += &#x27;-&#x27; + str(replica_number)               setattr(db_info, &#x27;name&#x27;, names[instance_index])               db_info.save()           # if a configuration group is associated with an instance,           # generate an overrides dict to pass into the instance creation           # method           config = Configuration(context, configuration_id)           overrides = config.get_configuration_overrides()           service_status = InstanceServiceStatus.create(               instance_id=instance_id,               status=tr_instance.ServiceStatuses.NEW)           if CONF.trove_dns_support:               dns_client = create_dns_client(context)               hostname = dns_client.determine_hostname(instance_id)               db_info.hostname = hostname               db_info.save()           # 如果用户需要指定一个root密码，则必须在启动时指定。           # root密码在这时生成。           if cls.get_root_on_create(                   datastore_version.manager) and not backup_id:               root_password = utils.generate_random_password()               root_passwords[instance_index] = root_password       if instance_count &gt; 1:           instance_id = ids           instance_name = names           root_password = root_passwords       # Trove API发送一个请求给Trove task manager来做其余的工作。       # 将用户请求的实例的上下文和用户端提供的所有参数都传递给task manager。       task_api.API(context).create_instance(           instance_id, instance_name, flavor, image_id, databases, users,           datastore_version.manager, datastore_version.packages,           volume_size, backup_id, availability_zone, root_password,           nics, overrides, slave_of_id, cluster_config,           volume_type=volume_type, modules=module_list,           locality=locality)       return SimpleInstance(context, db_info, service_status,                             root_password, locality=locality)with StartNotification(context, **call_args):    return run_with_quotas(context.tenant, deltas, _create_resources)\n\nTrove API发送请求到task manager。在trove.taskmanager.api.py文件中。\n12345678910111213141516171819202122232425262728def create_instance(self, instance_id, name, flavor,                       image_id, databases, users, datastore_manager,                       packages, volume_size, backup_id=None,                       availability_zone=None, root_password=None,                       nics=None, overrides=None, slave_of_id=None,                       cluster_config=None, volume_type=None,                       modules=None, locality=None):       LOG.debug(&quot;Making async call to create instance %s &quot;, instance_id)       version = self.API_BASE_VERSION       self._cast(&quot;create_instance&quot;, version=version,                  instance_id=instance_id, name=name,                  flavor=self._transform_obj(flavor),                  image_id=image_id,                  databases=databases,                  users=users,                  datastore_manager=datastore_manager,                  packages=packages,                  volume_size=volume_size,                  backup_id=backup_id,                  availability_zone=availability_zone,                  root_password=root_password,                  nics=nics,                  overrides=overrides,                  slave_of_id=slave_of_id,                  cluster_config=cluster_config,                  volume_type=volume_type,                  modules=modules, locality=locality)\n该api得到了被提供的所有信息，并发送一个异步_cast()调用到task manager。\n_cast()是异步请求。call()是同步请求。\n\n\n程序进入到trove.taskmanager.manager.py文件下，并执行下面的create_instance方法\n1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950def _create_instance(self, context, instance_id, name, flavor,                     image_id, databases, users, datastore_manager,                     packages, volume_size, backup_id, availability_zone,                     root_password, nics, overrides, slave_of_id,                     cluster_config, volume_type, modules, locality):    # 创建现有实例的副本    if slave_of_id:        self._create_replication_slave(context, instance_id, name,                                       flavor, image_id, databases, users,                                       datastore_manager, packages,                                       volume_size,                                       availability_zone, root_password,                                       nics, overrides, slave_of_id,                                       backup_id, volume_type, modules)    else:        if type(instance_id) in [list]:            raise AttributeError(_(                &quot;Cannot create multiple non-replica instances.&quot;))        instance_tasks = FreshInstanceTasks.load(context, instance_id)        scheduler_hints = srv_grp.ServerGroup.build_scheduler_hint(            context, locality, instance_id)        instance_tasks.create_instance(flavor, image_id, databases, users,                                       datastore_manager, packages,                                       volume_size, backup_id,                                       availability_zone, root_password,                                       nics, overrides, cluster_config,                                       None, volume_type, modules,                                       scheduler_hints)        timeout = (CONF.restore_usage_timeout if backup_id                   else CONF.usage_timeout)        instance_tasks.wait_for_instance(timeout, flavor)def create_instance(self, context, instance_id, name, flavor,                    image_id, databases, users, datastore_manager,                    packages, volume_size, backup_id, availability_zone,                    root_password, nics, overrides, slave_of_id,                    cluster_config, volume_type, modules, locality):    with EndNotification(context,                         instance_id=(instance_id[0]                                      if isinstance(instance_id, list)                                      else instance_id)):        self._create_instance(context, instance_id, name, flavor,                              image_id, databases, users,                              datastore_manager, packages, volume_size,                              backup_id, availability_zone,                              root_password, nics, overrides, slave_of_id,                              cluster_config, volume_type, modules,                              locality)\n在第24行代码中，instance_tasks在trove.taskmanager.models.py中。\n123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293class FreshInstanceTasks(FreshInstance, NotifyMixin, ConfigurationMixin):    def create_instance(self, flavor, image_id, databases, users,                        datastore_manager, packages, volume_size,                        backup_id, availability_zone, root_password, nics,                        overrides, cluster_config, snapshot, volume_type,                        modules, scheduler_hints):        # It is the caller&#x27;s responsibility to ensure that        # FreshInstanceTasks.wait_for_instance is called after        # create_instance to ensure that the proper usage event gets sent        LOG.info(_(&quot;Creating instance %s.&quot;), self.id)        security_groups = None        if CONF.trove_security_groups_support:            try:                security_groups = self._create_secgroup(datastore_manager)            except Exception as e:                msg = (_(&quot;Error creating security group for instance: %s&quot;) %                       self.id)                err = inst_models.InstanceTasks.BUILDING_ERROR_SEC_GROUP                self._log_and_raise(e, msg, err)            else:                LOG.debug(&quot;Successfully created security group for &quot;                          &quot;instance: %s&quot;, self.id)        # 获取发送到guest的文件。（下面会讲到）        files = self.get_injected_files(datastore_manager)        cinder_volume_type = volume_type or CONF.cinder_volume_type        # 根据系统的配置，可以单独调用两种种方法来创建服务器和卷。        # 分别是使用Nova创建实例和卷、单独创建Nova实例和卷。        # 两种方法，配置文件都被一起传入（Nova调用注入）。        if use_nova_server_volume:            volume_info = self._create_server_volume(                            flavor[&#x27;id&#x27;],                            image_id,                            security_groups,                            datastore_manager,                            volume_size,                            availability_zone,                            nics,                            files,                            scheduler_hints)        else:            volume_info = self._create_server_volume_individually(                            flavor[&#x27;id&#x27;],                            image_id,                            security_groups,                            datastore_manager,                            volume_size,                            availability_zone,                            nics,                            files,                            cinder_volume_type,                            scheduler_hints)        config = self._render_config(flavor)        backup_info = None        if backup_id is not None:            backup = bkup_models.Backup.get_by_id(self.context, backup_id)            backup_info = &#123;&#x27;id&#x27;: backup_id,                           &#x27;instance_id&#x27;: backup.instance_id,                           &#x27;location&#x27;: backup.location,                           &#x27;type&#x27;: backup.backup_type,                           &#x27;checksum&#x27;: backup.checksum,                           &#125;        # 最终转换为调用guest agent的prepare()方法。        self._guest_prepare(flavor[&#x27;ram&#x27;], volume_info,                            packages, databases, users, backup_info,                            config.config_contents, root_password,                            overrides,                            cluster_config, snapshot, modules)        if root_password:            self.report_root_enabled()        if not self.db_info.task_status.is_error:            self.reset_task_status()        # when DNS is supported, we attempt to add this after the        # instance is prepared.  Otherwise, if DNS fails, instances        # end up in a poorer state and there&#x27;s no tooling around        # re-sending the prepare call; retrying DNS is much easier.        try:            self._create_dns_entry()        except Exception as e:            msg = _(&quot;Error creating DNS entry for instance: %s&quot;) % self.id            err = inst_models.InstanceTasks.BUILDING_ERROR_DNS            self._log_and_raise(e, msg, err)\nget_injected_files()在第28行代码中被调用。该方法是执行创建工作流程中最为关键的部分。其生成的配置文件将在启动时被发送到guest实例，并提供给guest agent后续操作的信息。\n1234567891011121314151617181920212223242526272829303132333435# 构建files集合。# 包含了guest_info和trove-guestagent.conf这两个文件。def get_injected_files(self, datastore_manager):    injected_config_location = CONF.get(&#x27;injected_config_location&#x27;)    guest_info = CONF.get(&#x27;guest_info&#x27;)    if (&#x27;/&#x27; in guest_info):        # Set guest_info_file to exactly guest_info from the conf file.        # This should be /etc/guest_info for pre-Kilo compatibility.        guest_info_file = guest_info    else:        guest_info_file = os.path.join(injected_config_location,                                       guest_info)    files = &#123;guest_info_file: (        &quot;[DEFAULT]\\n&quot;        &quot;guest_id=%s\\n&quot;        &quot;datastore_manager=%s\\n&quot;        &quot;tenant_id=%s\\n&quot;        % (self.id, datastore_manager, self.tenant_id))&#125;    instance_key = get_instance_encryption_key(self.id)    if instance_key:        files = &#123;guest_info_file: (            &quot;%s&quot;            &quot;instance_rpc_encr_key=%s\\n&quot; % (                files.get(guest_info_file),                instance_key))&#125;    if os.path.isfile(CONF.get(&#x27;guest_config&#x27;)):        with open(CONF.get(&#x27;guest_config&#x27;), &quot;r&quot;) as f:            files[os.path.join(injected_config_location,                               &quot;trove-guestagent.conf&quot;)] = f.read()    return files\n_create_server_volume在trove.taskmanager.manager.py文件下的_create_instance中被调用(第36行代码)。\n123456789101112131415161718192021222324252627282930313233343536373839404142434445464748def _create_server_volume(self, flavor_id, image_id, security_groups,                          datastore_manager, volume_size,                          availability_zone, nics, files,                          scheduler_hints):    LOG.debug(&quot;Begin _create_server_volume for id: %s&quot;, self.id)    try:        # 准备用户的数据。        userdata = self._prepare_userdata(datastore_manager)        name = self.hostname or self.name        volume_desc = (&quot;datastore volume for %s&quot; % self.id)        volume_name = (&quot;datastore-%s&quot; % self.id)        volume_ref = &#123;&#x27;size&#x27;: volume_size, &#x27;name&#x27;: volume_name,                      &#x27;description&#x27;: volume_desc&#125;        config_drive = CONF.use_nova_server_config_drive        # 调用Nova（公共API）创建一个实例。        server = self.nova_client.servers.create(            name, image_id, flavor_id,            files=files, volume=volume_ref,            security_groups=security_groups,            availability_zone=availability_zone,            nics=nics, config_drive=config_drive,            userdata=userdata, scheduler_hints=scheduler_hints)        server_dict = server._info        LOG.debug(&quot;Created new compute instance %(server_id)s &quot;                  &quot;for id: %(id)s\\nServer response: %(response)s&quot;,                  &#123;&#x27;server_id&#x27;: server.id, &#x27;id&#x27;: self.id,                   &#x27;response&#x27;: server_dict&#125;)        volume_id = None        for volume in server_dict.get(&#x27;os:volumes&#x27;, []):            volume_id = volume.get(&#x27;id&#x27;)        # Record the server ID and volume ID in case something goes wrong.        self.update_db(compute_instance_id=server.id, volume_id=volume_id)    except Exception as e:        msg = _(&quot;Error creating server and volume for &quot;                &quot;instance %s&quot;) % self.id        LOG.debug(&quot;End _create_server_volume for id: %s&quot;, self.id)        err = inst_models.InstanceTasks.BUILDING_ERROR_SERVER        self._log_and_raise(e, msg, err)    device_path = self.device_path    mount_point = CONF.get(datastore_manager).mount_point    volume_info = &#123;&#x27;device_path&#x27;: device_path, &#x27;mount_point&#x27;: mount_point&#125;    LOG.debug(&quot;End _create_server_volume for id: %s&quot;, self.id)    return volume_info\n\n_prepare_userdata在上面的第9行被调用。其目的是生成不许传递给Nova的用户数据。\n123456789def _prepare_userdata(self, datastore_manager):    userdata = None    cloudinit = os.path.join(CONF.get(&#x27;cloudinit_location&#x27;),                             &quot;%s.cloudinit&quot; % datastore_manager)    if os.path.isfile(cloudinit):        with open(cloudinit, &quot;r&quot;) as f:            userdata = f.read()    return userdata\n由get_injected_files()生成配置文件，根据设定的方式传递到guest agent。\n最后，guest agent调用prepare()方法，在trove.guestagent.api.py文件中。\n12345678910111213141516171819202122232425262728293031def prepare(self, memory_mb, packages, databases, users,            device_path=&#x27;/dev/vdb&#x27;, mount_point=&#x27;/mnt/volume&#x27;,            backup_info=None, config_contents=None, root_password=None,            overrides=None, cluster_config=None, snapshot=None,            modules=None):    &quot;&quot;&quot;Make an asynchronous call to prepare the guest       as a database container optionally includes a backup id for restores    &quot;&quot;&quot;    LOG.debug(&quot;Sending the call to prepare the Guest.&quot;)    version = self.API_BASE_VERSION    # Taskmanager is a publisher, guestagent is a consumer. Usually    # consumer creates a queue, but in this case we have to make sure    # &quot;prepare&quot; doesn&#x27;t get lost if for some reason guest was delayed and    # didn&#x27;t create a queue on time.    # 初始化与guest沟通的进程间的通信（IPC）。    self._create_guest_queue()    packages = packages.split()    # 发送prepare()到队列中。    # 一旦实例启动并连接到这个消息队列，则这个prepare()调用将被    # guest实例上的guest agent获取。    self._cast(        &quot;prepare&quot;, version=version, packages=packages,        databases=databases, memory_mb=memory_mb, users=users,        device_path=device_path, mount_point=mount_point,        backup_info=backup_info, config_contents=config_contents,        root_password=root_password, overrides=overrides,        cluster_config=cluster_config, snapshot=snapshot, modules=modules)\nprepare()方法在每个guest agent都可以找到实现方法。\n12345678910111213141516171819202122232425262728293031323334353637383940414243444546def do_prepare(self, context, packages, databases, memory_mb, users,               device_path, mount_point, backup_info,               config_contents, root_password, overrides,               cluster_config, snapshot):    &quot;&quot;&quot;This is called from prepare in the base class.&quot;&quot;&quot;    app = self.mysql_app(self.mysql_app_status.get())    app.install_if_needed(packages)    if device_path:        # stop and do not update database        app.stop_db(            do_not_start_on_reboot=self.volume_do_not_start_on_reboot)        device = volume.VolumeDevice(device_path)        # unmount if device is already mounted        device.unmount_device(device_path)        device.format()        if os.path.exists(mount_point):            # rsync existing data to a &quot;data&quot; sub-directory            # on the new volume            device.migrate_data(mount_point, target_subdir=&quot;data&quot;)        # mount the volume        device.mount(mount_point)        operating_system.chown(mount_point, service.MYSQL_OWNER,                               service.MYSQL_OWNER,                               recursive=False, as_root=True)        LOG.debug(&quot;Mounted the volume at %s.&quot;, mount_point)        # We need to temporarily update the default my.cnf so that        # mysql will start after the volume is mounted. Later on it        # will be changed based on the config template        # (see MySqlApp.secure()) and restart.        app.set_data_dir(mount_point + &#x27;/data&#x27;)        app.start_mysql()    if backup_info:        self._perform_restore(backup_info, context,                              mount_point + &quot;/data&quot;, app)    app.secure(config_contents)    enable_root_on_restore = (backup_info and                              self.mysql_admin().is_root_enabled())    if enable_root_on_restore:        app.secure_root(secure_remote_root=False)        self.mysql_app_status.get().report_root(context, &#x27;root&#x27;)    else:        app.secure_root(secure_remote_root=True)    if snapshot:        self.attach_replica(context, snapshot, snapshot[&#x27;config&#x27;])\n在prepare()调用完成后，guest数据库就可以使用了。\n","dateCreated":"2018-09-19T10:51:46+08:00","dateModified":"2023-09-21T10:45:00+08:00","datePublished":"2018-09-19T10:51:46+08:00","description":"Trove create 源码解析","headline":"源码看Trove（一）","image":[null,"images/PROJECT-Vayne.jpg"],"mainEntityOfPage":{"@type":"WebPage","@id":"https://wangkuntian.github.io/2018/09/19/%E6%BA%90%E7%A0%81%E7%9C%8BTrove%EF%BC%88%E4%B8%80%EF%BC%89/"},"publisher":{"@type":"Organization","name":"Wang kuntian","sameAs":["https://github.com/wangkuntian","mailto:wangkuntian1994@163.com"],"image":"faker.jpg","logo":{"@type":"ImageObject","url":"faker.jpg"}},"url":"https://wangkuntian.github.io/2018/09/19/%E6%BA%90%E7%A0%81%E7%9C%8BTrove%EF%BC%88%E4%B8%80%EF%BC%89/","keywords":"Trove","thumbnailUrl":"images/PROJECT-Vayne.jpg"}</script>
    <meta name="description" content="Trove create 源码解析">
<meta property="og:type" content="blog">
<meta property="og:title" content="源码看Trove（一）">
<meta property="og:url" content="https://wangkuntian.github.io/2018/09/19/%E6%BA%90%E7%A0%81%E7%9C%8BTrove%EF%BC%88%E4%B8%80%EF%BC%89/index.html">
<meta property="og:site_name" content="Wang kuntian&#39;s Blog">
<meta property="og:description" content="Trove create 源码解析">
<meta property="og:locale" content="zh_EN">
<meta property="article:published_time" content="2018-09-19T02:51:46.000Z">
<meta property="article:modified_time" content="2023-09-21T02:45:00.331Z">
<meta property="article:author" content="Wang kuntian">
<meta property="article:tag" content="Trove">
<meta name="twitter:card" content="summary">
    
    
        
    
    
        <meta property="og:image" content="https://wangkuntian.github.io/assets/images/faker.jpg"/>
    
    
    
        <meta property="og:image" content="https://wangkuntian.github.io/2018/09/19/%E6%BA%90%E7%A0%81%E7%9C%8BTrove%EF%BC%88%E4%B8%80%EF%BC%89/images/PROJECT-Vayne.jpg"/>
        <meta class="swiftype" name="image" data-type="enum" content="https://wangkuntian.github.io/2018/09/19/%E6%BA%90%E7%A0%81%E7%9C%8BTrove%EF%BC%88%E4%B8%80%EF%BC%89/images/PROJECT-Vayne.jpg"/>
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/style-bkzaqwnhdy35ne9gawopbfxp7lltc7yhde0uckf6kikurfjo9ztq2v5apuqa.min.css">

    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-136102260-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-136102260-1');
    </script>


    

    
        
    
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --></head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="4">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            Wang kuntian&#39;s Blog
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="Öffne den Link: /#about"
            >
        
        
            <img class="header-picture" src="/assets/images/faker.jpg" alt="Author&#39;s picture"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="4">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="Lesen Sie mehr über den Autor"
                >
                    <img class="sidebar-profile-picture" src="/assets/images/faker.jpg" alt="Author&#39;s picture"/>
                </a>
                <h4 class="sidebar-profile-name">Wang kuntian</h4>
                
                    <h5 class="sidebar-profile-bio"><p>Hi</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="Home"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="Categories"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="Tags"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="Archives"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link open-algolia-search"
                            href="#search"
                            
                            rel="noopener"
                            title="Search"
                        >
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Search</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="About"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/wangkuntian"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="mailto:wangkuntian1994@163.com"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Mail"
                        >
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Mail</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/atom.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
        <div class="post-header-cover
                    text-center
                    post-header-cover--full"
             style="background-image:url('/images/PROJECT-Vayne.jpg');"
             data-behavior="4">
            
                <div class="post-header main-content-wrap text-center">
    
        <h1 class="post-title">
            源码看Trove（一）
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2018-09-19T10:51:46+08:00">
	
		    Sep 19, 2018
    	
    </time>
    
</div>

    
</div>

            
        </div>

            <div id="main" data-behavior="4"
                 class="hasCover
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <p>Trove create 源码解析</p>
<span id="more"></span>

<p>trove create命令（python-troveclient仓库的一部分）封装了用户提供的所有命令行参数，并发送一个POST到Trove公共API定义的URI /v1.0/{tenant_id}/instances。</p>
<p>trove在api-paste.ini中定义程序的入口。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[app:troveapp]</span><br><span class="line">paste.app_factory = trove.common.api:app_factory</span><br></pre></td></tr></table></figure>

<p>可以在trove.common.api.py文件中，找到API类。其中它的_instance_router定义了实例的路由路径和被调用的方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">app_factory</span>(<span class="params">global_conf, **local_conf</span>):</span><br><span class="line">    <span class="keyword">return</span> API()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">API</span>(wsgi.Router):</span><br><span class="line"><span class="string">&quot;&quot;&quot;Defines the API routes.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        mapper = routes.Mapper()</span><br><span class="line">        <span class="built_in">super</span>(API, self).__init__(mapper)</span><br><span class="line">        self._instance_router(mapper)</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_instance_router</span>(<span class="params">self, mapper</span>):</span><br><span class="line">        instance_resource = InstanceController().create_resource()</span><br><span class="line">        mapper.connect(<span class="string">&quot;/&#123;tenant_id&#125;/instances&quot;</span>,</span><br><span class="line">                        controller=instance_resource,</span><br><span class="line">                        action=<span class="string">&quot;create&quot;</span>,</span><br><span class="line">                        conditions=&#123;<span class="string">&#x27;method&#x27;</span>: [<span class="string">&#x27;POST&#x27;</span>]&#125;)</span><br><span class="line">        ...</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>InstanceController类在trove.instance.service.py文件中被定义。实例创建时将会调用create()。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">class InstanceController(wsgi.Controller):</span><br><span class="line">    ...</span><br><span class="line">    def create(self, req, body, tenant_id):</span><br><span class="line">        <span class="comment"># TODO(hub-cap): turn this into middleware</span></span><br><span class="line">        LOG.info(_LI(<span class="string">&quot;Creating a database instance for tenant &#x27;%s&#x27;&quot;</span>),</span><br><span class="line">                 tenant_id)</span><br><span class="line">        LOG.debug(<span class="string">&quot;req : &#x27;%s&#x27;\n\n&quot;</span>, strutils.mask_password(req))</span><br><span class="line">        LOG.debug(<span class="string">&quot;body : &#x27;%s&#x27;\n\n&quot;</span>, strutils.mask_password(body))</span><br><span class="line">        context = req.environ[wsgi.CONTEXT_KEY]</span><br><span class="line">        policy.authorize_on_tenant(context, <span class="string">&#x27;instance:create&#x27;</span>)</span><br><span class="line">        <span class="comment"># 消息</span></span><br><span class="line">        context.notification = notification.DBaaSInstanceCreate(context,</span><br><span class="line">                                                                request=req)</span><br><span class="line">        <span class="comment"># 数据库参数</span></span><br><span class="line">        datastore_args = body[<span class="string">&#x27;instance&#x27;</span>].get(<span class="string">&#x27;datastore&#x27;</span>, &#123;&#125;)</span><br><span class="line">        <span class="comment"># 验证并获取数据库以及版本</span></span><br><span class="line">        datastore, datastore_version = (</span><br><span class="line">            datastore_models.get_datastore_version(**datastore_args))</span><br><span class="line">        <span class="comment"># 镜像</span></span><br><span class="line">        image_id = datastore_version.image_id</span><br><span class="line">        <span class="comment"># 实例名</span></span><br><span class="line">        name = body[<span class="string">&#x27;instance&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">        <span class="comment"># flavor</span></span><br><span class="line">        flavor_ref = body[<span class="string">&#x27;instance&#x27;</span>][<span class="string">&#x27;flavorRef&#x27;</span>]</span><br><span class="line">        flavor_id = utils.get_id_from_href(flavor_ref)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 配置组</span></span><br><span class="line">        configuration = self._configuration_parse(context, body)</span><br><span class="line">        databases = populate_validated_databases(</span><br><span class="line">            body[<span class="string">&#x27;instance&#x27;</span>].get(<span class="string">&#x27;databases&#x27;</span>, []))</span><br><span class="line">        database_names = [database.get(<span class="string">&#x27;_name&#x27;</span>, <span class="string">&#x27;&#x27;</span>) <span class="keyword">for</span> database <span class="keyword">in</span> databases]</span><br><span class="line">        <span class="built_in">users</span> = None</span><br><span class="line">        try:</span><br><span class="line">            <span class="built_in">users</span> = populate_users(body[<span class="string">&#x27;instance&#x27;</span>].get(<span class="string">&#x27;users&#x27;</span>, []),</span><br><span class="line">                                   database_names)</span><br><span class="line">        except ValueError as ve:</span><br><span class="line">            raise exception.BadRequest(msg=ve)</span><br><span class="line"></span><br><span class="line">        modules = body[<span class="string">&#x27;instance&#x27;</span>].get(<span class="string">&#x27;modules&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># The following operations have their own API calls.</span></span><br><span class="line">        <span class="comment"># We need to make sure the same policies are enforced when</span></span><br><span class="line">        <span class="comment"># creating an instance.</span></span><br><span class="line">        <span class="comment"># i.e. if attaching configuration group to an existing instance is not</span></span><br><span class="line">        <span class="comment"># allowed, it should not be possible to create a new instance with the</span></span><br><span class="line">        <span class="comment"># group attached either</span></span><br><span class="line">        <span class="keyword">if</span> configuration:</span><br><span class="line">            policy.authorize_on_tenant(context, <span class="string">&#x27;instance:update&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> modules:</span><br><span class="line">            policy.authorize_on_tenant(context, <span class="string">&#x27;instance:module_apply&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">users</span>:</span><br><span class="line">            policy.authorize_on_tenant(</span><br><span class="line">                context, <span class="string">&#x27;instance:extension:user:create&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> databases:</span><br><span class="line">            policy.authorize_on_tenant(</span><br><span class="line">                context, <span class="string">&#x27;instance:extension:database:create&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 卷</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;volume&#x27;</span> <span class="keyword">in</span> body[<span class="string">&#x27;instance&#x27;</span>]:</span><br><span class="line">            volume_info = body[<span class="string">&#x27;instance&#x27;</span>][<span class="string">&#x27;volume&#x27;</span>]</span><br><span class="line">            volume_size = int(volume_info[<span class="string">&#x27;size&#x27;</span>])</span><br><span class="line">            volume_type = volume_info.get(<span class="string">&#x27;type&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            volume_size = None</span><br><span class="line">            volume_type = None</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 备份</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;restorePoint&#x27;</span> <span class="keyword">in</span> body[<span class="string">&#x27;instance&#x27;</span>]:</span><br><span class="line">            backupRef = body[<span class="string">&#x27;instance&#x27;</span>][<span class="string">&#x27;restorePoint&#x27;</span>][<span class="string">&#x27;backupRef&#x27;</span>]</span><br><span class="line">            backup_id = utils.get_id_from_href(backupRef)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            backup_id = None</span><br><span class="line"></span><br><span class="line">        availability_zone = body[<span class="string">&#x27;instance&#x27;</span>].get(<span class="string">&#x27;availability_zone&#x27;</span>)</span><br><span class="line">        nics = body[<span class="string">&#x27;instance&#x27;</span>].get(<span class="string">&#x27;nics&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 复制</span></span><br><span class="line">        slave_of_id = body[<span class="string">&#x27;instance&#x27;</span>].get(<span class="string">&#x27;replica_of&#x27;</span>,</span><br><span class="line">                                           <span class="comment"># also check for older name</span></span><br><span class="line">                                           body[<span class="string">&#x27;instance&#x27;</span>].get(<span class="string">&#x27;slave_of&#x27;</span>))</span><br><span class="line">        replica_count = body[<span class="string">&#x27;instance&#x27;</span>].get(<span class="string">&#x27;replica_count&#x27;</span>)</span><br><span class="line">        locality = body[<span class="string">&#x27;instance&#x27;</span>].get(<span class="string">&#x27;locality&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> locality:</span><br><span class="line">            locality_domain = [<span class="string">&#x27;affinity&#x27;</span>, <span class="string">&#x27;anti-affinity&#x27;</span>]</span><br><span class="line">            locality_domain_msg = (<span class="string">&quot;Invalid locality &#x27;%s&#x27;. &quot;</span></span><br><span class="line">                                   <span class="string">&quot;Must be one of [&#x27;%s&#x27;]&quot;</span> %</span><br><span class="line">                                   (locality,</span><br><span class="line">                                    <span class="string">&quot;&#x27;, &#x27;&quot;</span>.<span class="built_in">join</span>(locality_domain)))</span><br><span class="line">            <span class="keyword">if</span> locality not <span class="keyword">in</span> locality_domain:</span><br><span class="line">                raise exception.BadRequest(msg=locality_domain_msg)</span><br><span class="line">            <span class="keyword">if</span> slave_of_id:</span><br><span class="line">                dupe_locality_msg = (</span><br><span class="line">                    <span class="string">&#x27;Cannot specify locality when adding replicas to existing &#x27;</span></span><br><span class="line">                    <span class="string">&#x27;master.&#x27;</span>)</span><br><span class="line">                raise exception.BadRequest(msg=dupe_locality_msg)</span><br><span class="line">        region_name = body[<span class="string">&#x27;instance&#x27;</span>].get(<span class="string">&#x27;region_name&#x27;</span>, CONF.os_region_name)</span><br><span class="line"></span><br><span class="line">        instance = models.Instance.create(context, name, flavor_id,</span><br><span class="line">                                          image_id, databases, <span class="built_in">users</span>,</span><br><span class="line">                                          datastore, datastore_version,</span><br><span class="line">                                          volume_size, backup_id,</span><br><span class="line">                                          availability_zone, nics,</span><br><span class="line">                                          configuration, slave_of_id,</span><br><span class="line">                                          replica_count=replica_count,</span><br><span class="line">                                          volume_type=volume_type,</span><br><span class="line">                                          modules=modules,</span><br><span class="line">                                          locality=locality,</span><br><span class="line">                                          region_name=region_name)</span><br><span class="line"></span><br><span class="line">        view = views.InstanceDetailView(instance, req=req)</span><br><span class="line">        <span class="built_in">return</span> wsgi.Result(view.data(), 200)</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>在拆包并理解了接收到的req和body中的参数的意义后，信息被传递到trove.instances.models.py中（见第98行代码）的create() 方法中。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@classmethod</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">cls, context, name, flavor_id, image_id, databases, users,</span></span><br><span class="line"><span class="params">          datastore, datastore_version, volume_size, backup_id,</span></span><br><span class="line"><span class="params">          availability_zone=<span class="literal">None</span>, nics=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">          configuration_id=<span class="literal">None</span>, slave_of_id=<span class="literal">None</span>, cluster_config=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">          replica_count=<span class="literal">None</span>, volume_type=<span class="literal">None</span>, modules=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">          locality=<span class="literal">None</span>, region_name=<span class="literal">None</span></span>):</span><br><span class="line"></span><br><span class="line">   region_name = region_name <span class="keyword">or</span> CONF.os_region_name</span><br><span class="line"></span><br><span class="line">   call_args = &#123;</span><br><span class="line">       <span class="string">&#x27;name&#x27;</span>: name,</span><br><span class="line">       <span class="string">&#x27;flavor_id&#x27;</span>: flavor_id,</span><br><span class="line">       <span class="string">&#x27;datastore&#x27;</span>: datastore.name <span class="keyword">if</span> datastore <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">       <span class="string">&#x27;datastore_version&#x27;</span>: datastore_version.name,</span><br><span class="line">       <span class="string">&#x27;image_id&#x27;</span>: image_id,</span><br><span class="line">       <span class="string">&#x27;availability_zone&#x27;</span>: availability_zone,</span><br><span class="line">       <span class="string">&#x27;region_name&#x27;</span>: region_name,</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment"># All nova flavors are permitted for a datastore-version unless one</span></span><br><span class="line">   <span class="comment"># or more entries are found in datastore_version_metadata,</span></span><br><span class="line">   <span class="comment"># in which case only those are permitted.</span></span><br><span class="line">   bound_flavors = DBDatastoreVersionMetadata.find_all(</span><br><span class="line">       datastore_version_id=datastore_version.<span class="built_in">id</span>,</span><br><span class="line">       key=<span class="string">&#x27;flavor&#x27;</span>, deleted=<span class="literal">False</span></span><br><span class="line">   )</span><br><span class="line">   <span class="keyword">if</span> bound_flavors.count() &gt; <span class="number">0</span>:</span><br><span class="line">       valid_flavors = <span class="built_in">tuple</span>(f.value <span class="keyword">for</span> f <span class="keyword">in</span> bound_flavors)</span><br><span class="line">       <span class="keyword">if</span> flavor_id <span class="keyword">not</span> <span class="keyword">in</span> valid_flavors:</span><br><span class="line">           <span class="keyword">raise</span> exception.DatastoreFlavorAssociationNotFound(</span><br><span class="line">               datastore=datastore.name,</span><br><span class="line">               datastore_version=datastore_version.name,</span><br><span class="line">               flavor_id=flavor_id)</span><br><span class="line"></span><br><span class="line">   datastore_cfg = CONF.get(datastore_version.manager)</span><br><span class="line"></span><br><span class="line">   <span class="comment"># 调用Nova检查flavor是否有效。</span></span><br><span class="line">   client = create_nova_client(context)</span><br><span class="line">   <span class="keyword">try</span>:</span><br><span class="line">       flavor = client.flavors.get(flavor_id)</span><br><span class="line">   <span class="keyword">except</span> nova_exceptions.NotFound:</span><br><span class="line">       <span class="keyword">raise</span> exception.FlavorNotFound(uuid=flavor_id)</span><br><span class="line"></span><br><span class="line">   <span class="comment"># If a different region is specified for the instance, ensure</span></span><br><span class="line">   <span class="comment"># that the flavor and image are the same in both regions</span></span><br><span class="line">   <span class="keyword">if</span> region_name <span class="keyword">and</span> region_name != CONF.os_region_name:</span><br><span class="line">       cls._validate_remote_datastore(context, region_name, flavor,</span><br><span class="line">                                      datastore, datastore_version)</span><br><span class="line"></span><br><span class="line">   deltas = &#123;<span class="string">&#x27;instances&#x27;</span>: <span class="number">1</span>&#125;</span><br><span class="line">   volume_support = datastore_cfg.volume_support</span><br><span class="line">   <span class="keyword">if</span> volume_support:</span><br><span class="line">       call_args[<span class="string">&#x27;volume_type&#x27;</span>] = volume_type</span><br><span class="line">       dvm.validate_volume_type(context, volume_type,</span><br><span class="line">                                datastore.name, datastore_version.name)</span><br><span class="line">       call_args[<span class="string">&#x27;volume_size&#x27;</span>] = volume_size</span><br><span class="line">       validate_volume_size(volume_size)</span><br><span class="line">       deltas[<span class="string">&#x27;volumes&#x27;</span>] = volume_size</span><br><span class="line">       <span class="comment"># Instance volume should have enough space for the backup</span></span><br><span class="line">       <span class="comment"># Backup, and volume sizes are in GBs</span></span><br><span class="line">       target_size = volume_size</span><br><span class="line">   <span class="keyword">else</span>:</span><br><span class="line">       target_size = flavor.disk  <span class="comment"># local_storage</span></span><br><span class="line">       <span class="keyword">if</span> volume_size <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">           <span class="keyword">raise</span> exception.VolumeNotSupported()</span><br><span class="line">       <span class="keyword">if</span> datastore_cfg.device_path:</span><br><span class="line">           <span class="keyword">if</span> flavor.ephemeral == <span class="number">0</span>:</span><br><span class="line">               <span class="keyword">raise</span> exception.LocalStorageNotSpecified(flavor=flavor_id)</span><br><span class="line">           target_size = flavor.ephemeral  <span class="comment"># ephemeral_Storage</span></span><br><span class="line"></span><br><span class="line">   <span class="comment"># 从现有的备份启动一个实例。（用户指定一个备份作为实例的源。）</span></span><br><span class="line">   <span class="keyword">if</span> backup_id:</span><br><span class="line">       call_args[<span class="string">&#x27;backup_id&#x27;</span>] = backup_id</span><br><span class="line">       backup_info = Backup.get_by_id(context, backup_id)</span><br><span class="line">       <span class="keyword">if</span> <span class="keyword">not</span> backup_info.is_done_successfuly:</span><br><span class="line">           <span class="keyword">raise</span> exception.BackupNotCompleteError(</span><br><span class="line">               backup_id=backup_id, state=backup_info.state)</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> backup_info.size &gt; target_size:</span><br><span class="line">           <span class="keyword">raise</span> exception.BackupTooLarge(</span><br><span class="line">               backup_size=backup_info.size, disk_size=target_size)</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> <span class="keyword">not</span> backup_info.check_swift_object_exist(</span><br><span class="line">               context,</span><br><span class="line">               verify_checksum=CONF.verify_swift_checksum_on_restore):</span><br><span class="line">           <span class="keyword">raise</span> exception.BackupFileNotFound(</span><br><span class="line">               location=backup_info.location)</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (backup_info.datastore_version_id</span><br><span class="line">               <span class="keyword">and</span> backup_info.datastore.name != datastore.name):</span><br><span class="line">           <span class="keyword">raise</span> exception.BackupDatastoreMismatchError(</span><br><span class="line">               datastore1=backup_info.datastore.name,</span><br><span class="line">               datastore2=datastore.name)</span><br><span class="line"></span><br><span class="line">   <span class="comment"># 启动一个实例作为另一个实例的副本。（用户启动复制。）</span></span><br><span class="line">   <span class="keyword">if</span> slave_of_id:</span><br><span class="line">       call_args[<span class="string">&#x27;replica_of&#x27;</span>] = slave_of_id</span><br><span class="line">       call_args[<span class="string">&#x27;replica_count&#x27;</span>] = replica_count</span><br><span class="line">       replication_support = datastore_cfg.replication_strategy</span><br><span class="line">       <span class="keyword">if</span> <span class="keyword">not</span> replication_support:</span><br><span class="line">           <span class="keyword">raise</span> exception.ReplicationNotSupported(</span><br><span class="line">               datastore=datastore.name)</span><br><span class="line">       <span class="keyword">try</span>:</span><br><span class="line">           <span class="comment"># looking for replica source</span></span><br><span class="line">           replica_source = DBInstance.find_by(</span><br><span class="line">               context,</span><br><span class="line">               <span class="built_in">id</span>=slave_of_id,</span><br><span class="line">               deleted=<span class="literal">False</span>)</span><br><span class="line">           <span class="keyword">if</span> replica_source.slave_of_id:</span><br><span class="line">               <span class="keyword">raise</span> exception.Forbidden(</span><br><span class="line">                   _(<span class="string">&quot;Cannot create a replica of a replica %(id)s.&quot;</span>)</span><br><span class="line">                   % &#123;<span class="string">&#x27;id&#x27;</span>: slave_of_id&#125;)</span><br><span class="line">           <span class="comment"># load the replica source status to check if</span></span><br><span class="line">           <span class="comment"># source is available</span></span><br><span class="line">           load_simple_instance_server_status(</span><br><span class="line">               context,</span><br><span class="line">               replica_source)</span><br><span class="line">           replica_source_instance = Instance(</span><br><span class="line">               context, replica_source,</span><br><span class="line">               <span class="literal">None</span>,</span><br><span class="line">               InstanceServiceStatus.find_by(</span><br><span class="line">                   context,</span><br><span class="line">                   instance_id=slave_of_id))</span><br><span class="line">           replica_source_instance.validate_can_perform_action()</span><br><span class="line">       <span class="keyword">except</span> exception.ModelNotFoundError:</span><br><span class="line">           LOG.exception(</span><br><span class="line">               _(<span class="string">&quot;Cannot create a replica of %(id)s &quot;</span></span><br><span class="line">                 <span class="string">&quot;as that instance could not be found.&quot;</span>),</span><br><span class="line">               &#123;<span class="string">&#x27;id&#x27;</span>: slave_of_id&#125;)</span><br><span class="line">           <span class="keyword">raise</span> exception.NotFound(uuid=slave_of_id)</span><br><span class="line">   <span class="keyword">elif</span> replica_count <span class="keyword">and</span> replica_count != <span class="number">1</span>:</span><br><span class="line">       <span class="keyword">raise</span> exception.Forbidden(_(</span><br><span class="line">           <span class="string">&quot;Replica count only valid when creating replicas. Cannot &quot;</span></span><br><span class="line">           <span class="string">&quot;create %(count)d instances.&quot;</span>) % &#123;<span class="string">&#x27;count&#x27;</span>: replica_count&#125;)</span><br><span class="line">   multi_replica = slave_of_id <span class="keyword">and</span> replica_count <span class="keyword">and</span> replica_count &gt; <span class="number">1</span></span><br><span class="line">   instance_count = replica_count <span class="keyword">if</span> multi_replica <span class="keyword">else</span> <span class="number">1</span></span><br><span class="line">   <span class="keyword">if</span> locality:</span><br><span class="line">       call_args[<span class="string">&#x27;locality&#x27;</span>] = locality</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> <span class="keyword">not</span> nics:</span><br><span class="line">       nics = []</span><br><span class="line">   <span class="keyword">if</span> CONF.default_neutron_networks:</span><br><span class="line">       nics = [&#123;<span class="string">&quot;net-id&quot;</span>: net_id&#125;</span><br><span class="line">               <span class="keyword">for</span> net_id <span class="keyword">in</span> CONF.default_neutron_networks] + nics</span><br><span class="line">   <span class="keyword">if</span> nics:</span><br><span class="line">       call_args[<span class="string">&#x27;nics&#x27;</span>] = nics</span><br><span class="line">   <span class="keyword">if</span> cluster_config:</span><br><span class="line">       call_args[<span class="string">&#x27;cluster_id&#x27;</span>] = cluster_config.get(<span class="string">&quot;id&quot;</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> <span class="keyword">not</span> modules:</span><br><span class="line">       modules = []</span><br><span class="line">   module_ids = [mod[<span class="string">&#x27;id&#x27;</span>] <span class="keyword">for</span> mod <span class="keyword">in</span> modules]</span><br><span class="line">   modules = module_models.Modules.load_by_ids(context, module_ids)</span><br><span class="line">   auto_apply_modules = module_models.Modules.load_auto_apply(</span><br><span class="line">       context, datastore.<span class="built_in">id</span>, datastore_version.<span class="built_in">id</span>)</span><br><span class="line">   <span class="keyword">for</span> aa_module <span class="keyword">in</span> auto_apply_modules:</span><br><span class="line">       <span class="keyword">if</span> aa_module.<span class="built_in">id</span> <span class="keyword">not</span> <span class="keyword">in</span> module_ids:</span><br><span class="line">           modules.append(aa_module)</span><br><span class="line">   module_models.Modules.validate(</span><br><span class="line">       modules, datastore.<span class="built_in">id</span>, datastore_version.<span class="built_in">id</span>)</span><br><span class="line">   module_list = module_views.convert_modules_to_list(modules)</span><br><span class="line"></span><br><span class="line">   <span class="keyword">def</span> <span class="title function_">_create_resources</span>():</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> cluster_config:</span><br><span class="line">           cluster_id = cluster_config.get(<span class="string">&quot;id&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">           shard_id = cluster_config.get(<span class="string">&quot;shard_id&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">           instance_type = cluster_config.get(<span class="string">&quot;instance_type&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">       <span class="keyword">else</span>:</span><br><span class="line">           cluster_id = shard_id = instance_type = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">       ids = []</span><br><span class="line">       names = []</span><br><span class="line">       root_passwords = []</span><br><span class="line">       root_password = <span class="literal">None</span></span><br><span class="line">       <span class="keyword">for</span> instance_index <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, instance_count):</span><br><span class="line">           <span class="comment"># 实例的创建被记录在基础设施数据库中，</span></span><br><span class="line">           <span class="comment"># 并且该实例被标记为InstanceTasks.BUILDING状态</span></span><br><span class="line">           db_info = DBInstance.create(</span><br><span class="line">               name=name, flavor_id=flavor_id, tenant_id=context.tenant,</span><br><span class="line">               volume_size=volume_size,</span><br><span class="line">               datastore_version_id=datastore_version.<span class="built_in">id</span>,</span><br><span class="line">               task_status=InstanceTasks.BUILDING,</span><br><span class="line">               configuration_id=configuration_id,</span><br><span class="line">               slave_of_id=slave_of_id, cluster_id=cluster_id,</span><br><span class="line">               shard_id=shard_id, <span class="built_in">type</span>=instance_type,</span><br><span class="line">               region_id=region_name)</span><br><span class="line">           LOG.debug(<span class="string">&quot;Tenant %(tenant)s created new Trove instance &quot;</span></span><br><span class="line">                     <span class="string">&quot;%(db)s in region %(region)s.&quot;</span>,</span><br><span class="line">                     &#123;<span class="string">&#x27;tenant&#x27;</span>: context.tenant, <span class="string">&#x27;db&#x27;</span>: db_info.<span class="built_in">id</span>,</span><br><span class="line">                      <span class="string">&#x27;region&#x27;</span>: region_name&#125;)</span><br><span class="line"></span><br><span class="line">           instance_id = db_info.<span class="built_in">id</span></span><br><span class="line">           cls.add_instance_modules(context, instance_id, modules)</span><br><span class="line">           instance_name = name</span><br><span class="line">           ids.append(instance_id)</span><br><span class="line">           names.append(instance_name)</span><br><span class="line">           root_passwords.append(<span class="literal">None</span>)</span><br><span class="line">           <span class="comment"># change the name to be name + replica_number if more than one</span></span><br><span class="line">           <span class="keyword">if</span> multi_replica:</span><br><span class="line">               replica_number = instance_index + <span class="number">1</span></span><br><span class="line">               names[instance_index] += <span class="string">&#x27;-&#x27;</span> + <span class="built_in">str</span>(replica_number)</span><br><span class="line">               <span class="built_in">setattr</span>(db_info, <span class="string">&#x27;name&#x27;</span>, names[instance_index])</span><br><span class="line">               db_info.save()</span><br><span class="line"></span><br><span class="line">           <span class="comment"># if a configuration group is associated with an instance,</span></span><br><span class="line">           <span class="comment"># generate an overrides dict to pass into the instance creation</span></span><br><span class="line">           <span class="comment"># method</span></span><br><span class="line"></span><br><span class="line">           config = Configuration(context, configuration_id)</span><br><span class="line">           overrides = config.get_configuration_overrides()</span><br><span class="line">           service_status = InstanceServiceStatus.create(</span><br><span class="line">               instance_id=instance_id,</span><br><span class="line">               status=tr_instance.ServiceStatuses.NEW)</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> CONF.trove_dns_support:</span><br><span class="line">               dns_client = create_dns_client(context)</span><br><span class="line">               hostname = dns_client.determine_hostname(instance_id)</span><br><span class="line">               db_info.hostname = hostname</span><br><span class="line">               db_info.save()</span><br><span class="line">           <span class="comment"># 如果用户需要指定一个root密码，则必须在启动时指定。</span></span><br><span class="line">           <span class="comment"># root密码在这时生成。</span></span><br><span class="line">           <span class="keyword">if</span> cls.get_root_on_create(</span><br><span class="line">                   datastore_version.manager) <span class="keyword">and</span> <span class="keyword">not</span> backup_id:</span><br><span class="line">               root_password = utils.generate_random_password()</span><br><span class="line">               root_passwords[instance_index] = root_password</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> instance_count &gt; <span class="number">1</span>:</span><br><span class="line">           instance_id = ids</span><br><span class="line">           instance_name = names</span><br><span class="line">           root_password = root_passwords</span><br><span class="line"></span><br><span class="line">       <span class="comment"># Trove API发送一个请求给Trove task manager来做其余的工作。</span></span><br><span class="line">       <span class="comment"># 将用户请求的实例的上下文和用户端提供的所有参数都传递给task manager。</span></span><br><span class="line">       task_api.API(context).create_instance(</span><br><span class="line">           instance_id, instance_name, flavor, image_id, databases, users,</span><br><span class="line">           datastore_version.manager, datastore_version.packages,</span><br><span class="line">           volume_size, backup_id, availability_zone, root_password,</span><br><span class="line">           nics, overrides, slave_of_id, cluster_config,</span><br><span class="line">           volume_type=volume_type, modules=module_list,</span><br><span class="line">           locality=locality)</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> SimpleInstance(context, db_info, service_status,</span><br><span class="line">                             root_password, locality=locality)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> StartNotification(context, **call_args):</span><br><span class="line">    <span class="keyword">return</span> run_with_quotas(context.tenant, deltas, _create_resources)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Trove API发送请求到task manager。在trove.taskmanager.api.py文件中。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">create_instance</span>(<span class="params">self, instance_id, name, flavor,</span></span><br><span class="line"><span class="params">                       image_id, databases, users, datastore_manager,</span></span><br><span class="line"><span class="params">                       packages, volume_size, backup_id=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                       availability_zone=<span class="literal">None</span>, root_password=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                       nics=<span class="literal">None</span>, overrides=<span class="literal">None</span>, slave_of_id=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                       cluster_config=<span class="literal">None</span>, volume_type=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                       modules=<span class="literal">None</span>, locality=<span class="literal">None</span></span>):</span><br><span class="line"></span><br><span class="line">       LOG.debug(<span class="string">&quot;Making async call to create instance %s &quot;</span>, instance_id)</span><br><span class="line">       version = self.API_BASE_VERSION</span><br><span class="line">       self._cast(<span class="string">&quot;create_instance&quot;</span>, version=version,</span><br><span class="line">                  instance_id=instance_id, name=name,</span><br><span class="line">                  flavor=self._transform_obj(flavor),</span><br><span class="line">                  image_id=image_id,</span><br><span class="line">                  databases=databases,</span><br><span class="line">                  users=users,</span><br><span class="line">                  datastore_manager=datastore_manager,</span><br><span class="line">                  packages=packages,</span><br><span class="line">                  volume_size=volume_size,</span><br><span class="line">                  backup_id=backup_id,</span><br><span class="line">                  availability_zone=availability_zone,</span><br><span class="line">                  root_password=root_password,</span><br><span class="line">                  nics=nics,</span><br><span class="line">                  overrides=overrides,</span><br><span class="line">                  slave_of_id=slave_of_id,</span><br><span class="line">                  cluster_config=cluster_config,</span><br><span class="line">                  volume_type=volume_type,</span><br><span class="line">                  modules=modules, locality=locality)</span><br></pre></td></tr></table></figure>
<p>该api得到了被提供的所有信息，并发送一个异步_cast()调用到task manager。</p>
<div class="alert danger no-icon"><p>_cast()是异步请求。<br>call()是同步请求。</p>
</div>

<p>程序进入到trove.taskmanager.manager.py文件下，并执行下面的create_instance方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_create_instance</span>(<span class="params">self, context, instance_id, name, flavor,</span></span><br><span class="line"><span class="params">                     image_id, databases, users, datastore_manager,</span></span><br><span class="line"><span class="params">                     packages, volume_size, backup_id, availability_zone,</span></span><br><span class="line"><span class="params">                     root_password, nics, overrides, slave_of_id,</span></span><br><span class="line"><span class="params">                     cluster_config, volume_type, modules, locality</span>):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建现有实例的副本</span></span><br><span class="line">    <span class="keyword">if</span> slave_of_id:</span><br><span class="line">        self._create_replication_slave(context, instance_id, name,</span><br><span class="line">                                       flavor, image_id, databases, users,</span><br><span class="line">                                       datastore_manager, packages,</span><br><span class="line">                                       volume_size,</span><br><span class="line">                                       availability_zone, root_password,</span><br><span class="line">                                       nics, overrides, slave_of_id,</span><br><span class="line">                                       backup_id, volume_type, modules)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(instance_id) <span class="keyword">in</span> [<span class="built_in">list</span>]:</span><br><span class="line">            <span class="keyword">raise</span> AttributeError(_(</span><br><span class="line">                <span class="string">&quot;Cannot create multiple non-replica instances.&quot;</span>))</span><br><span class="line">        instance_tasks = FreshInstanceTasks.load(context, instance_id)</span><br><span class="line"></span><br><span class="line">        scheduler_hints = srv_grp.ServerGroup.build_scheduler_hint(</span><br><span class="line">            context, locality, instance_id)</span><br><span class="line">        instance_tasks.create_instance(flavor, image_id, databases, users,</span><br><span class="line">                                       datastore_manager, packages,</span><br><span class="line">                                       volume_size, backup_id,</span><br><span class="line">                                       availability_zone, root_password,</span><br><span class="line">                                       nics, overrides, cluster_config,</span><br><span class="line">                                       <span class="literal">None</span>, volume_type, modules,</span><br><span class="line">                                       scheduler_hints)</span><br><span class="line">        timeout = (CONF.restore_usage_timeout <span class="keyword">if</span> backup_id</span><br><span class="line">                   <span class="keyword">else</span> CONF.usage_timeout)</span><br><span class="line">        instance_tasks.wait_for_instance(timeout, flavor)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_instance</span>(<span class="params">self, context, instance_id, name, flavor,</span></span><br><span class="line"><span class="params">                    image_id, databases, users, datastore_manager,</span></span><br><span class="line"><span class="params">                    packages, volume_size, backup_id, availability_zone,</span></span><br><span class="line"><span class="params">                    root_password, nics, overrides, slave_of_id,</span></span><br><span class="line"><span class="params">                    cluster_config, volume_type, modules, locality</span>):</span><br><span class="line">    <span class="keyword">with</span> EndNotification(context,</span><br><span class="line">                         instance_id=(instance_id[<span class="number">0</span>]</span><br><span class="line">                                      <span class="keyword">if</span> <span class="built_in">isinstance</span>(instance_id, <span class="built_in">list</span>)</span><br><span class="line">                                      <span class="keyword">else</span> instance_id)):</span><br><span class="line">        self._create_instance(context, instance_id, name, flavor,</span><br><span class="line">                              image_id, databases, users,</span><br><span class="line">                              datastore_manager, packages, volume_size,</span><br><span class="line">                              backup_id, availability_zone,</span><br><span class="line">                              root_password, nics, overrides, slave_of_id,</span><br><span class="line">                              cluster_config, volume_type, modules,</span><br><span class="line">                              locality)</span><br></pre></td></tr></table></figure>
<p>在第24行代码中，instance_tasks在trove.taskmanager.models.py中。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FreshInstanceTasks</span>(FreshInstance, NotifyMixin, ConfigurationMixin):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_instance</span>(<span class="params">self, flavor, image_id, databases, users,</span></span><br><span class="line"><span class="params">                        datastore_manager, packages, volume_size,</span></span><br><span class="line"><span class="params">                        backup_id, availability_zone, root_password, nics,</span></span><br><span class="line"><span class="params">                        overrides, cluster_config, snapshot, volume_type,</span></span><br><span class="line"><span class="params">                        modules, scheduler_hints</span>):</span><br><span class="line">        <span class="comment"># It is the caller&#x27;s responsibility to ensure that</span></span><br><span class="line">        <span class="comment"># FreshInstanceTasks.wait_for_instance is called after</span></span><br><span class="line">        <span class="comment"># create_instance to ensure that the proper usage event gets sent</span></span><br><span class="line"></span><br><span class="line">        LOG.info(_(<span class="string">&quot;Creating instance %s.&quot;</span>), self.<span class="built_in">id</span>)</span><br><span class="line">        security_groups = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> CONF.trove_security_groups_support:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                security_groups = self._create_secgroup(datastore_manager)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                msg = (_(<span class="string">&quot;Error creating security group for instance: %s&quot;</span>) %</span><br><span class="line">                       self.<span class="built_in">id</span>)</span><br><span class="line">                err = inst_models.InstanceTasks.BUILDING_ERROR_SEC_GROUP</span><br><span class="line">                self._log_and_raise(e, msg, err)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                LOG.debug(<span class="string">&quot;Successfully created security group for &quot;</span></span><br><span class="line">                          <span class="string">&quot;instance: %s&quot;</span>, self.<span class="built_in">id</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 获取发送到guest的文件。（下面会讲到）</span></span><br><span class="line">        files = self.get_injected_files(datastore_manager)</span><br><span class="line"></span><br><span class="line">        cinder_volume_type = volume_type <span class="keyword">or</span> CONF.cinder_volume_type</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 根据系统的配置，可以单独调用两种种方法来创建服务器和卷。</span></span><br><span class="line">        <span class="comment"># 分别是使用Nova创建实例和卷、单独创建Nova实例和卷。</span></span><br><span class="line">        <span class="comment"># 两种方法，配置文件都被一起传入（Nova调用注入）。</span></span><br><span class="line">        <span class="keyword">if</span> use_nova_server_volume:</span><br><span class="line">            volume_info = self._create_server_volume(</span><br><span class="line">                            flavor[<span class="string">&#x27;id&#x27;</span>],</span><br><span class="line">                            image_id,</span><br><span class="line">                            security_groups,</span><br><span class="line">                            datastore_manager,</span><br><span class="line">                            volume_size,</span><br><span class="line">                            availability_zone,</span><br><span class="line">                            nics,</span><br><span class="line">                            files,</span><br><span class="line">                            scheduler_hints)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            volume_info = self._create_server_volume_individually(</span><br><span class="line">                            flavor[<span class="string">&#x27;id&#x27;</span>],</span><br><span class="line">                            image_id,</span><br><span class="line">                            security_groups,</span><br><span class="line">                            datastore_manager,</span><br><span class="line">                            volume_size,</span><br><span class="line">                            availability_zone,</span><br><span class="line">                            nics,</span><br><span class="line">                            files,</span><br><span class="line">                            cinder_volume_type,</span><br><span class="line">                            scheduler_hints)</span><br><span class="line"></span><br><span class="line">        config = self._render_config(flavor)</span><br><span class="line"></span><br><span class="line">        backup_info = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> backup_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            backup = bkup_models.Backup.get_by_id(self.context, backup_id)</span><br><span class="line">            backup_info = &#123;<span class="string">&#x27;id&#x27;</span>: backup_id,</span><br><span class="line">                           <span class="string">&#x27;instance_id&#x27;</span>: backup.instance_id,</span><br><span class="line">                           <span class="string">&#x27;location&#x27;</span>: backup.location,</span><br><span class="line">                           <span class="string">&#x27;type&#x27;</span>: backup.backup_type,</span><br><span class="line">                           <span class="string">&#x27;checksum&#x27;</span>: backup.checksum,</span><br><span class="line">                           &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 最终转换为调用guest agent的prepare()方法。</span></span><br><span class="line">        self._guest_prepare(flavor[<span class="string">&#x27;ram&#x27;</span>], volume_info,</span><br><span class="line">                            packages, databases, users, backup_info,</span><br><span class="line">                            config.config_contents, root_password,</span><br><span class="line">                            overrides,</span><br><span class="line">                            cluster_config, snapshot, modules)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> root_password:</span><br><span class="line">            self.report_root_enabled()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.db_info.task_status.is_error:</span><br><span class="line">            self.reset_task_status()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># when DNS is supported, we attempt to add this after the</span></span><br><span class="line">        <span class="comment"># instance is prepared.  Otherwise, if DNS fails, instances</span></span><br><span class="line">        <span class="comment"># end up in a poorer state and there&#x27;s no tooling around</span></span><br><span class="line">        <span class="comment"># re-sending the prepare call; retrying DNS is much easier.</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self._create_dns_entry()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            msg = _(<span class="string">&quot;Error creating DNS entry for instance: %s&quot;</span>) % self.<span class="built_in">id</span></span><br><span class="line">            err = inst_models.InstanceTasks.BUILDING_ERROR_DNS</span><br><span class="line">            self._log_and_raise(e, msg, err)</span><br></pre></td></tr></table></figure>
<p>get_injected_files()在第28行代码中被调用。该方法是执行创建工作流程中最为关键的部分。其生成的配置文件将在启动时被发送到guest实例，并提供给guest agent后续操作的信息。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 构建files集合。</span></span><br><span class="line"><span class="comment"># 包含了guest_info和trove-guestagent.conf这两个文件。</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_injected_files</span>(<span class="params">self, datastore_manager</span>):</span><br><span class="line">    injected_config_location = CONF.get(<span class="string">&#x27;injected_config_location&#x27;</span>)</span><br><span class="line">    guest_info = CONF.get(<span class="string">&#x27;guest_info&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;/&#x27;</span> <span class="keyword">in</span> guest_info):</span><br><span class="line">        <span class="comment"># Set guest_info_file to exactly guest_info from the conf file.</span></span><br><span class="line">        <span class="comment"># This should be /etc/guest_info for pre-Kilo compatibility.</span></span><br><span class="line">        guest_info_file = guest_info</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        guest_info_file = os.path.join(injected_config_location,</span><br><span class="line">                                       guest_info)</span><br><span class="line"></span><br><span class="line">    files = &#123;guest_info_file: (</span><br><span class="line">        <span class="string">&quot;[DEFAULT]\n&quot;</span></span><br><span class="line">        <span class="string">&quot;guest_id=%s\n&quot;</span></span><br><span class="line">        <span class="string">&quot;datastore_manager=%s\n&quot;</span></span><br><span class="line">        <span class="string">&quot;tenant_id=%s\n&quot;</span></span><br><span class="line">        % (self.<span class="built_in">id</span>, datastore_manager, self.tenant_id))&#125;</span><br><span class="line"></span><br><span class="line">    instance_key = get_instance_encryption_key(self.<span class="built_in">id</span>)</span><br><span class="line">    <span class="keyword">if</span> instance_key:</span><br><span class="line">        files = &#123;guest_info_file: (</span><br><span class="line">            <span class="string">&quot;%s&quot;</span></span><br><span class="line">            <span class="string">&quot;instance_rpc_encr_key=%s\n&quot;</span> % (</span><br><span class="line">                files.get(guest_info_file),</span><br><span class="line">                instance_key))&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> os.path.isfile(CONF.get(<span class="string">&#x27;guest_config&#x27;</span>)):</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(CONF.get(<span class="string">&#x27;guest_config&#x27;</span>), <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            files[os.path.join(injected_config_location,</span><br><span class="line">                               <span class="string">&quot;trove-guestagent.conf&quot;</span>)] = f.read()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> files</span><br></pre></td></tr></table></figure>
<p>_create_server_volume在trove.taskmanager.manager.py文件下的_create_instance中被调用(第36行代码)。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_create_server_volume</span>(<span class="params">self, flavor_id, image_id, security_groups,</span></span><br><span class="line"><span class="params">                          datastore_manager, volume_size,</span></span><br><span class="line"><span class="params">                          availability_zone, nics, files,</span></span><br><span class="line"><span class="params">                          scheduler_hints</span>):</span><br><span class="line">    LOG.debug(<span class="string">&quot;Begin _create_server_volume for id: %s&quot;</span>, self.<span class="built_in">id</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 准备用户的数据。</span></span><br><span class="line">        userdata = self._prepare_userdata(datastore_manager)</span><br><span class="line">        name = self.hostname <span class="keyword">or</span> self.name</span><br><span class="line">        volume_desc = (<span class="string">&quot;datastore volume for %s&quot;</span> % self.<span class="built_in">id</span>)</span><br><span class="line">        volume_name = (<span class="string">&quot;datastore-%s&quot;</span> % self.<span class="built_in">id</span>)</span><br><span class="line">        volume_ref = &#123;<span class="string">&#x27;size&#x27;</span>: volume_size, <span class="string">&#x27;name&#x27;</span>: volume_name,</span><br><span class="line">                      <span class="string">&#x27;description&#x27;</span>: volume_desc&#125;</span><br><span class="line">        config_drive = CONF.use_nova_server_config_drive</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 调用Nova（公共API）创建一个实例。</span></span><br><span class="line">        server = self.nova_client.servers.create(</span><br><span class="line">            name, image_id, flavor_id,</span><br><span class="line">            files=files, volume=volume_ref,</span><br><span class="line">            security_groups=security_groups,</span><br><span class="line">            availability_zone=availability_zone,</span><br><span class="line">            nics=nics, config_drive=config_drive,</span><br><span class="line">            userdata=userdata, scheduler_hints=scheduler_hints)</span><br><span class="line">        server_dict = server._info</span><br><span class="line">        LOG.debug(<span class="string">&quot;Created new compute instance %(server_id)s &quot;</span></span><br><span class="line">                  <span class="string">&quot;for id: %(id)s\nServer response: %(response)s&quot;</span>,</span><br><span class="line">                  &#123;<span class="string">&#x27;server_id&#x27;</span>: server.<span class="built_in">id</span>, <span class="string">&#x27;id&#x27;</span>: self.<span class="built_in">id</span>,</span><br><span class="line">                   <span class="string">&#x27;response&#x27;</span>: server_dict&#125;)</span><br><span class="line"></span><br><span class="line">        volume_id = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">for</span> volume <span class="keyword">in</span> server_dict.get(<span class="string">&#x27;os:volumes&#x27;</span>, []):</span><br><span class="line">            volume_id = volume.get(<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Record the server ID and volume ID in case something goes wrong.</span></span><br><span class="line">        self.update_db(compute_instance_id=server.<span class="built_in">id</span>, volume_id=volume_id)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        msg = _(<span class="string">&quot;Error creating server and volume for &quot;</span></span><br><span class="line">                <span class="string">&quot;instance %s&quot;</span>) % self.<span class="built_in">id</span></span><br><span class="line">        LOG.debug(<span class="string">&quot;End _create_server_volume for id: %s&quot;</span>, self.<span class="built_in">id</span>)</span><br><span class="line">        err = inst_models.InstanceTasks.BUILDING_ERROR_SERVER</span><br><span class="line">        self._log_and_raise(e, msg, err)</span><br><span class="line"></span><br><span class="line">    device_path = self.device_path</span><br><span class="line">    mount_point = CONF.get(datastore_manager).mount_point</span><br><span class="line">    volume_info = &#123;<span class="string">&#x27;device_path&#x27;</span>: device_path, <span class="string">&#x27;mount_point&#x27;</span>: mount_point&#125;</span><br><span class="line">    LOG.debug(<span class="string">&quot;End _create_server_volume for id: %s&quot;</span>, self.<span class="built_in">id</span>)</span><br><span class="line">    <span class="keyword">return</span> volume_info</span><br></pre></td></tr></table></figure>

<p>_prepare_userdata在上面的第9行被调用。其目的是生成不许传递给Nova的用户数据。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_prepare_userdata</span>(<span class="params">self, datastore_manager</span>):</span><br><span class="line">    userdata = <span class="literal">None</span></span><br><span class="line">    cloudinit = os.path.join(CONF.get(<span class="string">&#x27;cloudinit_location&#x27;</span>),</span><br><span class="line">                             <span class="string">&quot;%s.cloudinit&quot;</span> % datastore_manager)</span><br><span class="line">    <span class="keyword">if</span> os.path.isfile(cloudinit):</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(cloudinit, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            userdata = f.read()</span><br><span class="line">    <span class="keyword">return</span> userdata</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>由get_injected_files()生成配置文件，根据设定的方式传递到guest agent。</p>
<p>最后，guest agent调用prepare()方法，在trove.guestagent.api.py文件中。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">prepare</span>(<span class="params">self, memory_mb, packages, databases, users,</span></span><br><span class="line"><span class="params">            device_path=<span class="string">&#x27;/dev/vdb&#x27;</span>, mount_point=<span class="string">&#x27;/mnt/volume&#x27;</span>,</span></span><br><span class="line"><span class="params">            backup_info=<span class="literal">None</span>, config_contents=<span class="literal">None</span>, root_password=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">            overrides=<span class="literal">None</span>, cluster_config=<span class="literal">None</span>, snapshot=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">            modules=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Make an asynchronous call to prepare the guest</span></span><br><span class="line"><span class="string">       as a database container optionally includes a backup id for restores</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    LOG.debug(<span class="string">&quot;Sending the call to prepare the Guest.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    version = self.API_BASE_VERSION</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Taskmanager is a publisher, guestagent is a consumer. Usually</span></span><br><span class="line">    <span class="comment"># consumer creates a queue, but in this case we have to make sure</span></span><br><span class="line">    <span class="comment"># &quot;prepare&quot; doesn&#x27;t get lost if for some reason guest was delayed and</span></span><br><span class="line">    <span class="comment"># didn&#x27;t create a queue on time.</span></span><br><span class="line">    <span class="comment"># 初始化与guest沟通的进程间的通信（IPC）。</span></span><br><span class="line">    self._create_guest_queue()</span><br><span class="line"></span><br><span class="line">    packages = packages.split()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 发送prepare()到队列中。</span></span><br><span class="line">    <span class="comment"># 一旦实例启动并连接到这个消息队列，则这个prepare()调用将被</span></span><br><span class="line">    <span class="comment"># guest实例上的guest agent获取。</span></span><br><span class="line">    self._cast(</span><br><span class="line">        <span class="string">&quot;prepare&quot;</span>, version=version, packages=packages,</span><br><span class="line">        databases=databases, memory_mb=memory_mb, users=users,</span><br><span class="line">        device_path=device_path, mount_point=mount_point,</span><br><span class="line">        backup_info=backup_info, config_contents=config_contents,</span><br><span class="line">        root_password=root_password, overrides=overrides,</span><br><span class="line">        cluster_config=cluster_config, snapshot=snapshot, modules=modules)</span><br></pre></td></tr></table></figure>
<p>prepare()方法在每个guest agent都可以找到实现方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">do_prepare</span>(<span class="params">self, context, packages, databases, memory_mb, users,</span></span><br><span class="line"><span class="params">               device_path, mount_point, backup_info,</span></span><br><span class="line"><span class="params">               config_contents, root_password, overrides,</span></span><br><span class="line"><span class="params">               cluster_config, snapshot</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;This is called from prepare in the base class.&quot;&quot;&quot;</span></span><br><span class="line">    app = self.mysql_app(self.mysql_app_status.get())</span><br><span class="line">    app.install_if_needed(packages)</span><br><span class="line">    <span class="keyword">if</span> device_path:</span><br><span class="line">        <span class="comment"># stop and do not update database</span></span><br><span class="line">        app.stop_db(</span><br><span class="line">            do_not_start_on_reboot=self.volume_do_not_start_on_reboot)</span><br><span class="line">        device = volume.VolumeDevice(device_path)</span><br><span class="line">        <span class="comment"># unmount if device is already mounted</span></span><br><span class="line">        device.unmount_device(device_path)</span><br><span class="line">        device.<span class="built_in">format</span>()</span><br><span class="line">        <span class="keyword">if</span> os.path.exists(mount_point):</span><br><span class="line">            <span class="comment"># rsync existing data to a &quot;data&quot; sub-directory</span></span><br><span class="line">            <span class="comment"># on the new volume</span></span><br><span class="line">            device.migrate_data(mount_point, target_subdir=<span class="string">&quot;data&quot;</span>)</span><br><span class="line">        <span class="comment"># mount the volume</span></span><br><span class="line">        device.mount(mount_point)</span><br><span class="line">        operating_system.chown(mount_point, service.MYSQL_OWNER,</span><br><span class="line">                               service.MYSQL_OWNER,</span><br><span class="line">                               recursive=<span class="literal">False</span>, as_root=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        LOG.debug(<span class="string">&quot;Mounted the volume at %s.&quot;</span>, mount_point)</span><br><span class="line">        <span class="comment"># We need to temporarily update the default my.cnf so that</span></span><br><span class="line">        <span class="comment"># mysql will start after the volume is mounted. Later on it</span></span><br><span class="line">        <span class="comment"># will be changed based on the config template</span></span><br><span class="line">        <span class="comment"># (see MySqlApp.secure()) and restart.</span></span><br><span class="line">        app.set_data_dir(mount_point + <span class="string">&#x27;/data&#x27;</span>)</span><br><span class="line">        app.start_mysql()</span><br><span class="line">    <span class="keyword">if</span> backup_info:</span><br><span class="line">        self._perform_restore(backup_info, context,</span><br><span class="line">                              mount_point + <span class="string">&quot;/data&quot;</span>, app)</span><br><span class="line">    app.secure(config_contents)</span><br><span class="line">    enable_root_on_restore = (backup_info <span class="keyword">and</span></span><br><span class="line">                              self.mysql_admin().is_root_enabled())</span><br><span class="line">    <span class="keyword">if</span> enable_root_on_restore:</span><br><span class="line">        app.secure_root(secure_remote_root=<span class="literal">False</span>)</span><br><span class="line">        self.mysql_app_status.get().report_root(context, <span class="string">&#x27;root&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        app.secure_root(secure_remote_root=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> snapshot:</span><br><span class="line">        self.attach_replica(context, snapshot, snapshot[<span class="string">&#x27;config&#x27;</span>])</span><br></pre></td></tr></table></figure>
<p>在prepare()调用完成后，guest数据库就可以使用了。</p>

            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-none-link" href="/tags/Trove/" rel="tag">Trove</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2018/09/20/%E4%B9%98%E9%A3%8E%E7%A0%B4%E6%B5%AA%E7%9A%84Docker%EF%BC%88%E4%BA%8C%EF%BC%89/"
                    data-tooltip="乘风破浪的Docker（二）"
                    aria-label="PREVIOUS: 乘风破浪的Docker（二）"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2018/09/15/%E5%B8%AD%E6%85%95%E8%93%89%E2%80%94%E2%80%94%E6%97%A0%E6%80%A8%E7%9A%84%E9%9D%92%E6%98%A5/"
                    data-tooltip="席慕蓉——无怨的青春"
                    aria-label="NEXT: 席慕蓉——无怨的青春"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="http://service.weibo.com/share/share.php?&amp;title=https://wangkuntian.github.io/2018/09/19/%E6%BA%90%E7%A0%81%E7%9C%8BTrove%EF%BC%88%E4%B8%80%EF%BC%89/"
                    title="Share on Weibo"
                    aria-label="Share on Weibo"
                >
                    <i class="fab fa-weibo" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=https://wangkuntian.github.io/2018/09/19/%E6%BA%90%E7%A0%81%E7%9C%8BTrove%EF%BC%88%E4%B8%80%EF%BC%89/&amp;title=源码看Trove（一）"
                    title="Share on QQ"
                    aria-label="Share on QQ"
                >
                    <i class="fab fa-qq" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://wangkuntian.github.io/2018/09/19/%E6%BA%90%E7%A0%81%E7%9C%8BTrove%EF%BC%88%E4%B8%80%EF%BC%89/"
                    title="Share on Qzone"
                    aria-label="Share on Qzone"
                >
                    <i class="fa fa-star" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
        
    </div>
</article>

<div class="main-content-wrap">
    
        
            <script src="//cdn.jsdelivr.net/npm/@waline/client"></script>
阅读量：<span id="2018/09/19/源码看Trove（一）/" class="waline-visitor-count"></span>
<div id="vcomments"></div>
<script>
    new Waline({
        el: "#vcomments",
        serverURL: "https://blog-api-nu-nine.vercel.app/",
        lang: "zh-cn",
        visitor: true,
        emoji: [
            "https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/bilibili",
            "https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/qq",
        ],
        placeholder: "ヾﾉ≧∀≦)o来啊，快活啊!",
        dark: "auto",
        meta: ["nick", "mail", "link"],
        requiredMeta: [],
        wordLimit: "200",
        pageSize: "10",
        highlight: "hanabi",
        copyright: true,
        avatar: "wavatar",
    });
</script>
  
        
    
</div>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2024 Wang kuntian. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2018/09/20/%E4%B9%98%E9%A3%8E%E7%A0%B4%E6%B5%AA%E7%9A%84Docker%EF%BC%88%E4%BA%8C%EF%BC%89/"
                    data-tooltip="乘风破浪的Docker（二）"
                    aria-label="PREVIOUS: 乘风破浪的Docker（二）"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2018/09/15/%E5%B8%AD%E6%85%95%E8%93%89%E2%80%94%E2%80%94%E6%97%A0%E6%80%A8%E7%9A%84%E9%9D%92%E6%98%A5/"
                    data-tooltip="席慕蓉——无怨的青春"
                    aria-label="NEXT: 席慕蓉——无怨的青春"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="http://service.weibo.com/share/share.php?&amp;title=https://wangkuntian.github.io/2018/09/19/%E6%BA%90%E7%A0%81%E7%9C%8BTrove%EF%BC%88%E4%B8%80%EF%BC%89/"
                    title="Share on Weibo"
                    aria-label="Share on Weibo"
                >
                    <i class="fab fa-weibo" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=https://wangkuntian.github.io/2018/09/19/%E6%BA%90%E7%A0%81%E7%9C%8BTrove%EF%BC%88%E4%B8%80%EF%BC%89/&amp;title=源码看Trove（一）"
                    title="Share on QQ"
                    aria-label="Share on QQ"
                >
                    <i class="fab fa-qq" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://wangkuntian.github.io/2018/09/19/%E6%BA%90%E7%A0%81%E7%9C%8BTrove%EF%BC%88%E4%B8%80%EF%BC%89/"
                    title="Share on Qzone"
                    aria-label="Share on Qzone"
                >
                    <i class="fa fa-star" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="4">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="http://service.weibo.com/share/share.php?&amp;title=https://wangkuntian.github.io/2018/09/19/%E6%BA%90%E7%A0%81%E7%9C%8BTrove%EF%BC%88%E4%B8%80%EF%BC%89/"
                        aria-label="Share on Weibo"
                    >
                        <i class="fab fa-weibo" aria-hidden="true"></i><span>Share on Weibo</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="http://connect.qq.com/widget/shareqq/index.html?url=https://wangkuntian.github.io/2018/09/19/%E6%BA%90%E7%A0%81%E7%9C%8BTrove%EF%BC%88%E4%B8%80%EF%BC%89/&amp;title=源码看Trove（一）"
                        aria-label="Share on QQ"
                    >
                        <i class="fab fa-qq" aria-hidden="true"></i><span>Share on QQ</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://wangkuntian.github.io/2018/09/19/%E6%BA%90%E7%A0%81%E7%9C%8BTrove%EF%BC%88%E4%B8%80%EF%BC%89/"
                        aria-label="Share on Qzone"
                    >
                        <i class="fa fa-star" aria-hidden="true"></i><span>Share on Qzone</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/faker.jpg" alt="Author&#39;s picture"/>
        
            <h4 id="about-card-name">Wang kuntian</h4>
        
            <div id="about-card-bio"><p>Hi</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Software Engineer</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                Beijing
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover-v1.2.0.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/script-ndtc2tx33sr3grlppafri7aw03fwgxbruphsl7cntcdkym8tusuknerf6c0g.min.js"></script>

<!--SCRIPTS END-->


    




    <script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"display":{"superSample":2.5,"width":180,"height":400,"position":"right","hOffset":0,"vOffset":40},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.2},"dialog":{"enable":true,"hitokoto":false},"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/hibiki.model.json"},"log":false});</script></body>
</html>
