
<!DOCTYPE html>
<html lang="zh-en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Wang kuntian&#39;s Blog">
    <title>Neutron-Server源码分析 - Wang kuntian&#39;s Blog</title>
    <meta name="author" content="Wang kuntian">
    
        <meta name="keywords" content="Neutron">
    
    
        <link rel="icon" href="https://wangkuntian.github.io/assets/images/favicon.png">
    
    
        
            <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
        
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Wang kuntian","sameAs":["https://github.com/wangkuntian","mailto:wangkuntian1994@163.com"],"image":"faker.jpg"},"articleBody":"\n\n\n介绍neutron-server提供了一个公开的Neutron API的Web服务器，并将所有Web服务调用传递给Neutron插件进行处理。\n版本Rocky\n服务启动neutron-server的本质是一个Python Web Server Gateway Interface（WSGI），是通过eventlet来实现服务的异步并发模型的。实际工作时，通过serve_wsgi()方法来构造NeutronApiService实例，通过该实例生成eventlet.Greenpool()来运行WSGI App来响应客户端请求。\nneutron的所有服务（services）的启动入口都定义在setup.cfg文件中的console_scripts。\nneutron-server服务启动方法。\n1234# setup.py[entry_points]console_scripts =     neutron-server = neutron.cmd.eventlet.server:main\n\n查看neutron.cmd.eventlet.server.main()方法。\n12345678910111213# neutron/cmd/eventlet/server/__init__.pyfrom neutron import serverfrom neutron.server import rpc_eventletfrom neutron.server import wsgi_eventletdef main():    server.boot_server(wsgi_eventlet.eventlet_wsgi_server)def main_rpc_eventlet():    server.boot_server(rpc_eventlet.eventlet_rpc_server)\n\n查看wsgi_eventlet.eventlet_wsgi_server方法。\n12345678910111213141516171819202122232425262728293031323334# neutron/server/wsgi_eventlet.pydef eventlet_wsgi_server():    # 启动wsigi服务    neutron_api = service.serve_wsgi(service.NeutronApiService)    start_api_and_rpc_workers(neutron_api)def start_api_and_rpc_workers(neutron_api):    try:        worker_launcher = service.start_all_workers()        # 创建eventlet.GreenPool()        pool = eventlet.GreenPool()        # 创建api_thread用来监听api命令        # 当命令到达时，通过wsgi服务路由到neutron.api.v2.base中的Controller中去处理。        api_thread = pool.spawn(neutron_api.wait)        # 创建plugin_workers_thread与rpc_work相关联，监听topics中的消息队列的请求，        # 完成neutron内部组件之间的通信        plugin_workers_thread = pool.spawn(worker_launcher.wait)        # api and other workers should die together. When one dies,        # kill the other.        api_thread.link(lambda gt: plugin_workers_thread.kill())        plugin_workers_thread.link(lambda gt: api_thread.kill())        pool.waitall()    except NotImplementedError:        LOG.info(&quot;RPC was already started in parent process by &quot;                 &quot;plugin.&quot;)        neutron_api.wait()\n\nWSGI AppWSGI App 启动查看NeutronApiService类和serve_wsgi()方法。\n12345678910111213141516171819202122232425262728# neutron/service.pyclass NeutronApiService(WsgiService):    &quot;&quot;&quot;Class for neutron-api service.&quot;&quot;&quot;    def __init__(self, app_name):        profiler.setup(&#x27;neutron-server&#x27;, cfg.CONF.host)        super(NeutronApiService, self).__init__(app_name)    @classmethod    def create(cls, app_name=&#x27;neutron&#x27;):        # Setup logging early        config.setup_logging()        service = cls(app_name)        return servicedef serve_wsgi(cls):    try:        service = cls.create()        service.start()    except Exception:        with excutils.save_and_reraise_exception():            LOG.exception(&#x27;Unrecoverable error: please check log &#x27;                          &#x27;for details.&#x27;)    registry.publish(resources.PROCESS, events.BEFORE_SPAWN, service)    return service\n\n查看NeutronApiService的基类WsgiService。上面serve_wsgi方法中service.start()调用就是WsgiService中的start()方法。\n123456789101112131415161718192021# neutron/service.pyclass WsgiService(object):    &quot;&quot;&quot;Base class for WSGI based services.    For each api you define, you must also define these flags:    :&lt;api&gt;_listen: The address on which to listen    :&lt;api&gt;_listen_port: The port on which to listen    &quot;&quot;&quot;    def __init__(self, app_name):        self.app_name = app_name        self.wsgi_app = None    def start(self):        self.wsgi_app = _run_wsgi(self.app_name)    def wait(self):        self.wsgi_app.wait()\n\n查看_run_wsgi()方法。\n12345678910111213141516171819# neutron/service.py# 通过调用load_paste_app()方法生成app，并调用run_wsgi_app()方法来启动app。def _run_wsgi(app_name):    app = config.load_paste_app(app_name)    if not app:        LOG.error(&#x27;No known API applications configured.&#x27;)        return    return run_wsgi_app(app)def run_wsgi_app(app):    server = wsgi.Server(&quot;Neutron&quot;)    server.start(app, cfg.CONF.bind_port, cfg.CONF.bind_host,                 workers=_get_api_workers())    LOG.info(&quot;Neutron service started, listening on %(host)s:%(port)s&quot;,             &#123;&#x27;host&#x27;: cfg.CONF.bind_host, &#x27;port&#x27;: cfg.CONF.bind_port&#125;)    return server\n\n查看load_paste_app()方法，从注释可以了解，该方法从配置文件构造并返回一个WSGI App。根据追踪，该配置文件主要是/etc/neutron/api-paste.ini，server通过解析该文件来指定WSGI App的实现。\n12345678910111213141516# neutron/common/config.pydef load_paste_app(app_name):    &quot;&quot;&quot;Builds and returns a WSGI app from a paste config file.    :param app_name: Name of the application to load    &quot;&quot;&quot;    # 加载WSGI的配置文件    loader = wsgi.Loader(cfg.CONF)    # Log the values of registered opts    if cfg.CONF.debug:        cfg.CONF.log_opt_values(LOG, logging.DEBUG)    app = loader.load_app(app_name)    return app\n\nLoader类的load_app()方法中，调用paste模块库deploy来实现对api-paste.ini中配置信息的解析和app的实现。\n123456789101112131415161718192021222324252627282930313233343536373839# oslo_service/wsgi.pyclass Loader(object):    &quot;&quot;&quot;Used to load WSGI applications from paste configurations.&quot;&quot;&quot;    def __init__(self, conf):        &quot;&quot;&quot;Initialize the loader, and attempt to find the config.        :param conf: Application config        :returns: None        &quot;&quot;&quot;        conf.register_opts(_options.wsgi_opts)        self.config_path = None        config_path = conf.api_paste_config        if not os.path.isabs(config_path):            self.config_path = conf.find_file(config_path)        elif os.path.exists(config_path):            self.config_path = config_path        if not self.config_path:            raise ConfigNotFound(path=config_path)    def load_app(self, name):        &quot;&quot;&quot;Return the paste URLMap wrapped WSGI application.        :param name: Name of the application to load.        :returns: Paste URLMap object wrapping the requested application.        :raises: PasteAppNotFound        &quot;&quot;&quot;        try:            LOG.debug(&quot;Loading app %(name)s from %(path)s&quot;,                      &#123;&#x27;name&#x27;: name, &#x27;path&#x27;: self.config_path&#125;)            return deploy.loadapp(&quot;config:%s&quot; % self.config_path, name=name)        except LookupError:            LOG.exception(&quot;Couldn&#x27;t lookup app: %s&quot;, name)            raise PasteAppNotFound(name=name, path=self.config_path)\n\nPasteDeployment是一种机制或者说是一种设计模式，它用于在应用WSGI Application和Server提供一个联系的桥梁，并且为用户提供一个接口，当配置好PasteDeployment之后，用户只需调用loadapp方法就可以使用现有的WSGI Application，而保持了WSGI Application对用户的透明性。\n\n\nWSGI 配置文件追踪配置文件加载。首先查看neutron/service.py文件。\n123# neutron/service.pyfrom neutron import wsgi\n\n找到neutron/wsgi.py文件\n123# neutron/wsgi.pywsgi_config.register_socket_opts()\n\nregister_socket_opts()方法注册WSGI和socket的配置项\n12345# neutron/conf/wsgi.pydef register_socket_opts(cfg=cfg.CONF):    cfg.register_opts(socket_opts)    wsgi.register_opts(cfg)\n\noslo.serivce中的wsgi.py文件。\n123456# oslo_service/wsgi.pydef register_opts(conf):    &quot;&quot;&quot;Registers WSGI config options.&quot;&quot;&quot;    return conf.register_opts(_options.wsgi_opts)\n\n_options.wsgi_opts定义WSGI的配置项。其中api_paste_config默认是api-paste.ini，一般位于/etc/neutron/目录下。\n1234567891011121314151617181920212223242526272829303132333435363738# oslo_service/_options.pywsgi_opts = [    cfg.StrOpt(&#x27;api_paste_config&#x27;,               default=&quot;api-paste.ini&quot;,               help=&#x27;File name for the paste.deploy config for api service&#x27;),    cfg.StrOpt(&#x27;wsgi_log_format&#x27;,               default=&#x27;%(client_ip)s &quot;%(request_line)s&quot; status: &#x27;                       &#x27;%(status_code)s  len: %(body_length)s time:&#x27;                       &#x27; %(wall_seconds).7f&#x27;,               help=&#x27;A python format string that is used as the template to &#x27;                    &#x27;generate log lines. The following values can be&#x27;                    &#x27;formatted into it: client_ip, date_time, request_line, &#x27;                    &#x27;status_code, body_length, wall_seconds.&#x27;),    cfg.IntOpt(&#x27;tcp_keepidle&#x27;,               default=600,               help=&quot;Sets the value of TCP_KEEPIDLE in seconds for each &quot;                    &quot;server socket. Not supported on OS X.&quot;),    cfg.IntOpt(&#x27;wsgi_default_pool_size&#x27;,               default=100,               help=&quot;Size of the pool of greenthreads used by wsgi&quot;),    cfg.IntOpt(&#x27;max_header_line&#x27;,               default=16384,               help=&quot;Maximum line size of message headers to be accepted. &quot;                    &quot;max_header_line may need to be increased when using &quot;                    &quot;large tokens (typically those generated when keystone &quot;                    &quot;is configured to use PKI tokens with big service &quot;                    &quot;catalogs).&quot;),    cfg.BoolOpt(&#x27;wsgi_keep_alive&#x27;,                default=True,                help=&quot;If False, closes the client socket connection &quot;                     &quot;explicitly.&quot;),    cfg.IntOpt(&#x27;client_socket_timeout&#x27;, default=900,               help=&quot;Timeout for client connections&#x27; socket operations. &quot;                    &quot;If an incoming connection is idle for this number of &quot;                    &quot;seconds it will be closed. A value of &#x27;0&#x27; means &quot;                    &quot;wait forever.&quot;),    ]\n\napi-paste.ini文件的主要内容。\n123456789101112131415161718192021222324252627282930313233343536373839404142434445464748# /etc/api-paste.ini[composite:neutron]use = egg:Paste#urlmap/: neutronversions_composite/v2.0: neutronapi_v2_0[composite:neutronapi_v2_0]use = call:neutron.auth:pipeline_factorynoauth = cors http_proxy_to_wsgi request_id catch_errors extensions neutronapiapp_v2_0keystone = cors http_proxy_to_wsgi request_id catch_errors authtoken keystonecontext extensions neutronapiapp_v2_0[composite:neutronversions_composite]use = call:neutron.auth:pipeline_factorynoauth = cors http_proxy_to_wsgi neutronversionskeystone = cors http_proxy_to_wsgi neutronversions[filter:request_id]paste.filter_factory = oslo_middleware:RequestId.factory[filter:catch_errors]paste.filter_factory = oslo_middleware:CatchErrors.factory[filter:cors]paste.filter_factory = oslo_middleware.cors:filter_factoryoslo_config_project = neutron[filter:http_proxy_to_wsgi]paste.filter_factory = oslo_middleware.http_proxy_to_wsgi:HTTPProxyToWSGI.factory[filter:keystonecontext]paste.filter_factory = neutron.auth:NeutronKeystoneContext.factory[filter:authtoken]paste.filter_factory = keystonemiddleware.auth_token:filter_factory[filter:extensions]paste.filter_factory = neutron.api.extensions:plugin_aware_extension_middleware_factory[app:neutronversions]paste.app_factory = neutron.pecan_wsgi.app:versions_factory[app:neutronapiapp_v2_0]paste.app_factory = neutron.api.v2.router:APIRouter.factory[filter:osprofiler]paste.filter_factory = osprofiler.web:WsgiMiddleware.factory\n\nAPIRouter查看neutron/api/v2/router.py文件。\n1234567891011121314# neutron/api/v2/router.pyfrom neutron.pecan_wsgi import app as pecan_appdef APIRouter(**local_config):    return pecan_app.v2_factory(None, **local_config)def _factory(global_config, **local_config):    return pecan_app.v2_factory(global_config, **local_config)setattr(APIRouter, &#x27;factory&#x27;, _factory)\n\n查看v2_factory()方法。\n123456789101112131415161718192021222324# /neutron/peacn_wsig/app.pydef v2_factory(global_config, **local_config):    # Processing Order:    #   As request enters lower priority called before higher.    #   Response from controller is passed from higher priority to lower.    app_hooks = [        hooks.UserFilterHook(),  # priority 90        hooks.ContextHook(),  # priority 95        hooks.ExceptionTranslationHook(),  # priority 100        hooks.BodyValidationHook(),  # priority 120        hooks.OwnershipValidationHook(),  # priority 125        hooks.QuotaEnforcementHook(),  # priority 130        hooks.NotifierHook(),  # priority 135        hooks.QueryParametersHook(),  # priority 139        hooks.PolicyHook(),  # priority 140    ]    app = pecan.make_app(root.V2Controller(),                         debug=False,                         force_canonical=False,                         hooks=app_hooks,                         guess_content_type_from_ext=True)    startup.initialize_all()    return app\n\n查看root.V2Controller()类。\n12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273# neutron/pecan_wsgi/controllers/root.pyclass V2Controller(object):    # Same data structure as neutron.api.versions.Versions for API backward    # compatibility    version_info = &#123;        &#x27;id&#x27;: &#x27;v2.0&#x27;,        &#x27;status&#x27;: &#x27;CURRENT&#x27;    &#125;    _load_version_info(version_info)    # NOTE(blogan): Paste deploy handled the routing to the legacy extension    # controller.  If the extensions filter is removed from the api-paste.ini    # then this controller will be routed to  This means operators had    # the ability to turn off the extensions controller via tha api-paste but    # will not be able to turn it off with the pecan switch.    extensions = ext_ctrl.ExtensionsController()    @utils.expose(generic=True)    def index(self):        if not pecan.request.path_url.endswith(&#x27;/&#x27;):            pecan.abort(404)        layout = []        for name, collection in _CORE_RESOURCES.items():            href = urlparse.urljoin(pecan.request.path_url, collection)            resource = &#123;&#x27;name&#x27;: name,                        &#x27;collection&#x27;: collection,                        &#x27;links&#x27;: [&#123;&#x27;rel&#x27;: &#x27;self&#x27;,                                   &#x27;href&#x27;: href&#125;]&#125;            layout.append(resource)        return &#123;&#x27;resources&#x27;: layout&#125;    @utils.when(index, method=&#x27;HEAD&#x27;)    @utils.when(index, method=&#x27;POST&#x27;)    @utils.when(index, method=&#x27;PATCH&#x27;)    @utils.when(index, method=&#x27;PUT&#x27;)    @utils.when(index, method=&#x27;DELETE&#x27;)    def not_supported(self):        pecan.abort(405)    @utils.expose()    def _lookup(self, collection, *remainder):        # if collection exists in the extension to service plugins map then        # we are assuming that collection is the service plugin and        # needs to be remapped.        # Example: https://neutron.endpoint/v2.0/lbaas/loadbalancers        if (remainder and                manager.NeutronManager.get_resources_for_path_prefix(                    collection)):            collection = remainder[0]            remainder = remainder[1:]        controller = manager.NeutronManager.get_controller_for_resource(            collection)        if not controller:            LOG.warning(&quot;No controller found for: %s - returning response &quot;                        &quot;code 404&quot;, collection)            pecan.abort(404)        # Store resource and collection names in pecan request context so that        # hooks can leverage them if necessary. The following code uses        # attributes from the controller instance to ensure names have been        # properly sanitized (eg: replacing dashes with underscores)        request.context[&#x27;resource&#x27;] = controller.resource        request.context[&#x27;collection&#x27;] = controller.collection        # NOTE(blogan): initialize a dict to store the ids of the items walked        # in the path for example: /networks/1234 would cause uri_identifiers        # to contain: &#123;&#x27;network_id&#x27;: &#x27;1234&#x27;&#125;        # This is for backwards compatibility with legacy extensions that        # defined their own controllers and expected kwargs to be passed in        # with the uri_identifiers        request.context[&#x27;uri_identifiers&#x27;] = &#123;&#125;        return controller, remainder\n\n插件加载查看startup.initialize_all()方法。\n123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101# neutron/pecan_wsgi/startup.pyRESOURCES = &#123;&#x27;network&#x27;: &#x27;networks&#x27;,             &#x27;subnet&#x27;: &#x27;subnets&#x27;,             &#x27;subnetpool&#x27;: &#x27;subnetpools&#x27;,             &#x27;port&#x27;: &#x27;ports&#x27;&#125;def initialize_all():    # NeutronManager初始化    manager.init()    ext_mgr = extensions.PluginAwareExtensionManager.get_instance()    ext_mgr.extend_resources(&quot;2.0&quot;, attributes.RESOURCES)    # At this stage we have a fully populated resource attribute map;    # build Pecan controllers and routes for all core resources    plugin = directory.get_plugin()    for resource, collection in RESOURCES.items():        resource_registry.register_resource_by_name(resource)        new_controller = res_ctrl.CollectionsController(collection, resource,                                                        plugin=plugin)        manager.NeutronManager.set_controller_for_resource(            collection, new_controller)        manager.NeutronManager.set_plugin_for_resource(collection, plugin)    pecanized_resources = ext_mgr.get_pecan_resources()    for pec_res in pecanized_resources:        manager.NeutronManager.set_controller_for_resource(            pec_res.collection, pec_res.controller)        manager.NeutronManager.set_plugin_for_resource(            pec_res.collection, pec_res.plugin)    # Now build Pecan Controllers and routes for all extensions    resources = ext_mgr.get_resources()    # Extensions controller is already defined, we don&#x27;t need it.    resources.pop(0)    for ext_res in resources:        path_prefix = ext_res.path_prefix.strip(&#x27;/&#x27;)        collection = ext_res.collection        # Retrieving the parent resource.  It is expected the format of        # the parent resource to be:        # &#123;&#x27;collection_name&#x27;: &#x27;name-of-collection&#x27;,        #  &#x27;member_name&#x27;: &#x27;name-of-resource&#x27;&#125;        # collection_name does not appear to be used in the legacy code        # inside the controller logic, so we can assume we do not need it.        parent = ext_res.parent or &#123;&#125;        parent_resource = parent.get(&#x27;member_name&#x27;)        collection_key = collection        if parent_resource:            collection_key = &#x27;/&#x27;.join([parent_resource, collection])        collection_actions = ext_res.collection_actions        member_actions = ext_res.member_actions        if manager.NeutronManager.get_controller_for_resource(collection_key):            # This is a collection that already has a pecan controller, we            # do not need to do anything else            continue        legacy_controller = getattr(ext_res.controller, &#x27;controller&#x27;,                                    ext_res.controller)        new_controller = None        if isinstance(legacy_controller, base.Controller):            resource = legacy_controller.resource            plugin = legacy_controller.plugin            attr_info = legacy_controller.attr_info            member_actions = legacy_controller.member_actions            pagination = legacy_controller.allow_pagination            sorting = legacy_controller.allow_sorting            # NOTE(blogan): legacy_controller and ext_res both can both have            # member_actions.  the member_actions for ext_res are strictly for            # routing, while member_actions for legacy_controller are used for            # handling the request once the routing has found the controller.            # They&#x27;re always the same so we will just use the ext_res            # member_action.            new_controller = res_ctrl.CollectionsController(                collection, resource, resource_info=attr_info,                parent_resource=parent_resource, member_actions=member_actions,                plugin=plugin, allow_pagination=pagination,                allow_sorting=sorting, collection_actions=collection_actions)            # new_controller.collection has replaced hyphens with underscores            manager.NeutronManager.set_plugin_for_resource(                new_controller.collection, plugin)            if path_prefix:                manager.NeutronManager.add_resource_for_path_prefix(                    collection, path_prefix)        else:            new_controller = utils.ShimCollectionsController(                collection, None, legacy_controller,                collection_actions=collection_actions,                member_actions=member_actions,                action_status=ext_res.controller.action_status,                collection_methods=ext_res.collection_methods)        manager.NeutronManager.set_controller_for_resource(            collection_key, new_controller)    # Certain policy checks require that the extensions are loaded    # and the RESOURCE_ATTRIBUTE_MAP populated before they can be    # properly initialized. This can only be claimed with certainty    # once this point in the code has been reached. In the event    # that the policies have been initialized before this point,    # calling reset will cause the next policy check to    # re-initialize with all of the required data in place.    policy.reset()\nNeutronManager初始化1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556# neutron/manager.py@six.add_metaclass(profiler.TracedMeta)class NeutronManager(object):    &quot;&quot;&quot;Neutron&#x27;s Manager class.    Neutron&#x27;s Manager class is responsible for parsing a config file and    instantiating the correct plugin that concretely implements    neutron_plugin_base class.    &quot;&quot;&quot;    # TODO(armax): use of the singleton pattern for this class is vestigial,    # and it is mainly relied on by the unit tests. It is safer to get rid    # of it once the entire codebase (neutron + subprojects) has switched    # entirely to using the plugins directory.    _instance = None    __trace_args__ = &#123;&quot;name&quot;: &quot;rpc&quot;&#125;    def __init__(self, options=None, config_file=None):        # Store instances of already loaded plugins to avoid instantiate same        # plugin more than once        self._loaded_plugins = &#123;&#125;        # If no options have been provided, create an empty dict        if not options:            options = &#123;&#125;        msg = validate_pre_plugin_load()        if msg:            LOG.critical(msg)            raise Exception(msg)        # NOTE(jkoelker) Testing for the subclass with the __subclasshook__        #                breaks tach monitoring. It has been removed        #                intentionally to allow v2 plugins to be monitored        #                for performance metrics.        # ml2        plugin_provider = cfg.CONF.core_plugin        LOG.info(&quot;Loading core plugin: %s&quot;, plugin_provider)        # NOTE(armax): keep hold of the actual plugin object        # CORE_PLUGINS_NAMESPACE = &#x27;neutron.core_plugins&#x27;        plugin = self._get_plugin_instance(CORE_PLUGINS_NAMESPACE,                                           plugin_provider)        directory.add_plugin(lib_const.CORE, plugin)        msg = validate_post_plugin_load()        if msg:            LOG.critical(msg)            raise Exception(msg)        # load services from the core plugin first        self._load_services_from_core_plugin(plugin)        self._load_service_plugins()        # Used by pecan WSGI        self.resource_plugin_mappings = &#123;&#125;        self.resource_controller_mappings = &#123;&#125;        self.path_prefix_resource_mappings = defaultdict(list)\n\nml2插件加载_get_plugin_instance()方法，该方法加载neutron的核心插件ml2。\n123456789101112131415161718192021222324252627@staticmethod    def load_class_for_provider(namespace, plugin_provider):        &quot;&quot;&quot;Loads plugin using alias or class name        :param namespace: namespace where alias is defined        :param plugin_provider: plugin alias or class name        :returns: plugin that is loaded        :raises ImportError: if fails to load plugin        &quot;&quot;&quot;        try:            return runtime.load_class_by_alias_or_classname(namespace,                                                            plugin_provider)        except ImportError:            with excutils.save_and_reraise_exception():                LOG.error(&quot;Plugin &#x27;%s&#x27; not found.&quot;, plugin_provider)    def _get_plugin_class(self, namespace, plugin_provider):        return self.load_class_for_provider(namespace, plugin_provider)    def _get_plugin_instance(self, namespace, plugin_provider):        plugin_class = self._get_plugin_class(namespace, plugin_provider)        plugin_inst = self._loaded_plugins.get(plugin_class)        if not plugin_inst:            plugin_inst = plugin_class()            self._loaded_plugins[plugin_class] = plugin_inst        return plugin_inst\n\nsetup.cfg文件中的entry_points里定义neutron.core_plugins的实现类。\n123[entry_points]neutron.core_plugins =    ml2 = neutron.plugins.ml2.plugin:Ml2Plugin\n\nMl2Plugin()类。\n123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354# neutron/plugins/ml2/plugin.py@resource_extend.has_resource_extenders@registry.has_registry_receiversclass Ml2Plugin(db_base_plugin_v2.NeutronDbPluginV2,                dvr_mac_db.DVRDbMixin,                external_net_db.External_net_db_mixin,                sg_db_rpc.SecurityGroupServerRpcMixin,                agentschedulers_db.AZDhcpAgentSchedulerDbMixin,                addr_pair_db.AllowedAddressPairsMixin,                vlantransparent_db.Vlantransparent_db_mixin,                extradhcpopt_db.ExtraDhcpOptMixin,                address_scope_db.AddressScopeDbMixin,                subnet_service_type_mixin.SubnetServiceTypeMixin):    @resource_registry.tracked_resources(        network=models_v2.Network,        port=models_v2.Port,        subnet=models_v2.Subnet,        subnetpool=models_v2.SubnetPool,        security_group=sg_models.SecurityGroup,        security_group_rule=sg_models.SecurityGroupRule)    def __init__(self):        # First load drivers, then initialize DB, then initialize drivers        # TypeManager初始化        self.type_manager = managers.TypeManager()        # ExtensionManager初始化        self.extension_manager = managers.ExtensionManager()        # MechanismManager初始化        self.mechanism_manager = managers.MechanismManager()        NeutronDbPluginV2初始化        super(Ml2Plugin, self).__init__()        # type_driver初始化        self.type_manager.initialize()        # extension_driver初始化        self.extension_manager.initialize()        # mechanism_driver初始化        self.mechanism_manager.initialize()        # DHCP组件初始化        self._setup_dhcp()        # rpc_notifier初始化        self._start_rpc_notifiers()        self.add_agent_status_check_worker(self.agent_health_check)        self.add_workers(self.mechanism_manager.get_workers())        self._verify_service_plugins_requirements()        LOG.info(&quot;Modular L2 Plugin initialization complete&quot;)\n\nTypeManager初始化TypeManager类\n12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667# neutron/plugins/ml2/managers.pyclass TypeManager(stevedore.named.NamedExtensionManager):    &quot;&quot;&quot;Manage network segment types using drivers.&quot;&quot;&quot;    def __init__(self):        # Mapping from type name to DriverManager        self.drivers = &#123;&#125;        LOG.info(&quot;Configured type driver names: %s&quot;,                 cfg.CONF.ml2.type_drivers)        super(TypeManager, self).__init__(&#x27;neutron.ml2.type_drivers&#x27;,                                          cfg.CONF.ml2.type_drivers,                                          invoke_on_load=True)        LOG.info(&quot;Loaded type driver names: %s&quot;, self.names())        # 注册type_driver        self._register_types()        # tenant_network_type和external_network_type        # 必须是conf.ml2.type_drivers中定义的        # 检查tenant_network_types        self._check_tenant_network_types(cfg.CONF.ml2.tenant_network_types)        # 检查external_network_type，默认为空        self._check_external_network_type(cfg.CONF.ml2.external_network_type)        def _register_types(self):        for ext in self:            # type_driver对应实现类的get_type()            # 例如：vxlan的实现类是neutron.plugins.ml2.drivers.type_vxlan:VxlanTypeDriver            # VxlanTypeDriver中的get_type()方法返回的是vxlan。            network_type = ext.obj.get_type()            if network_type in self.drivers:                LOG.error(&quot;Type driver &#x27;%(new_driver)s&#x27; ignored because&quot;                          &quot; type driver &#x27;%(old_driver)s&#x27; is already&quot;                          &quot; registered for type &#x27;%(type)s&#x27;&quot;,                          &#123;&#x27;new_driver&#x27;: ext.name,                           &#x27;old_driver&#x27;: self.drivers[network_type].name,                           &#x27;type&#x27;: network_type&#125;)            else:                self.drivers[network_type] = ext        LOG.info(&quot;Registered types: %s&quot;, self.drivers.keys())        def _check_tenant_network_types(self, types):        self.tenant_network_types = []        for network_type in types:            if network_type in self.drivers:                self.tenant_network_types.append(network_type)            else:                LOG.error(&quot;No type driver for tenant network_type: %s. &quot;                          &quot;Service terminated!&quot;, network_type)                raise SystemExit(1)        LOG.info(&quot;Tenant network_types: %s&quot;, self.tenant_network_types)    def _check_external_network_type(self, ext_network_type):        if ext_network_type and ext_network_type not in self.drivers:            LOG.error(&quot;No type driver for external network_type: %s. &quot;                      &quot;Service terminated!&quot;, ext_network_type)            raise SystemExit(1)        def initialize(self):        for network_type, driver in self.drivers.items():            LOG.info(&quot;Initializing driver for type &#x27;%s&#x27;&quot;, network_type)            # 初识化每一个type_driver            driver.obj.initialize()\n\ntype_drivers插件的初始化方法，在setup.cfg文件中的entry_points里面定义。\n12345678[entrypoint]neutron.ml2.type_drivers =    flat = neutron.plugins.ml2.drivers.type_flat:FlatTypeDriver    local = neutron.plugins.ml2.drivers.type_local:LocalTypeDriver    vlan = neutron.plugins.ml2.drivers.type_vlan:VlanTypeDriver    geneve = neutron.plugins.ml2.drivers.type_geneve:GeneveTypeDriver    gre = neutron.plugins.ml2.drivers.type_gre:GreTypeDriver    vxlan = neutron.plugins.ml2.drivers.type_vxlan:VxlanTypeDriver\n\nExtensionManager初始化1234567891011121314151617181920212223242526272829303132333435# neutron/plugins/ml2/managers.pyclass ExtensionManager(stevedore.named.NamedExtensionManager):    &quot;&quot;&quot;Manage extension drivers using drivers.&quot;&quot;&quot;    def __init__(self):        # Ordered list of extension drivers, defining        # the order in which the drivers are called.        self.ordered_ext_drivers = []        LOG.info(&quot;Configured extension driver names: %s&quot;,                 cfg.CONF.ml2.extension_drivers)        super(ExtensionManager, self).__init__(&#x27;neutron.ml2.extension_drivers&#x27;,                                               cfg.CONF.ml2.extension_drivers,                                               invoke_on_load=True,                                               name_order=True)        LOG.info(&quot;Loaded extension driver names: %s&quot;, self.names())        self._register_drivers()    def _register_drivers(self):        &quot;&quot;&quot;Register all extension drivers.        This method should only be called once in the ExtensionManager        constructor.        &quot;&quot;&quot;        for ext in self:            self.ordered_ext_drivers.append(ext)        LOG.info(&quot;Registered extension drivers: %s&quot;,                 [driver.name for driver in self.ordered_ext_drivers])        def initialize(self):        # Initialize each driver in the list.        for driver in self.ordered_ext_drivers:            LOG.info(&quot;Initializing extension driver &#x27;%s&#x27;&quot;, driver.name)            driver.obj.initialize()\n\nextension_driver的初始化方法定义在setup.cfg文件中的entry_points里面。\n12345678neutron.ml2.extension_drivers =    test = neutron.tests.unit.plugins.ml2.drivers.ext_test:TestExtensionDriver    testdb = neutron.tests.unit.plugins.ml2.drivers.ext_test:TestDBExtensionDriver    port_security = neutron.plugins.ml2.extensions.port_security:PortSecurityExtensionDriver    qos = neutron.plugins.ml2.extensions.qos:QosExtensionDriver    dns = neutron.plugins.ml2.extensions.dns_integration:DNSExtensionDriverML2    data_plane_status = neutron.plugins.ml2.extensions.data_plane_status:DataPlaneStatusExtensionDriver    dns_domain_ports = neutron.plugins.ml2.extensions.dns_integration:DNSDomainPortsExtensionDriver\n\nMechanismManager初始化1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253# neutron/plugins/ml2/managers.pyclass MechanismManager(stevedore.named.NamedExtensionManager):    &quot;&quot;&quot;Manage networking mechanisms using drivers.&quot;&quot;&quot;    def __init__(self):        # Registered mechanism drivers, keyed by name.        self.mech_drivers = &#123;&#125;        # Ordered list of mechanism drivers, defining        # the order in which the drivers are called.        self.ordered_mech_drivers = []        LOG.info(&quot;Configured mechanism driver names: %s&quot;,                 cfg.CONF.ml2.mechanism_drivers)        super(MechanismManager, self).__init__(            &#x27;neutron.ml2.mechanism_drivers&#x27;,            cfg.CONF.ml2.mechanism_drivers,            invoke_on_load=True,            name_order=True,            on_missing_entrypoints_callback=self._driver_not_found,            on_load_failure_callback=self._driver_not_loaded        )        LOG.info(&quot;Loaded mechanism driver names: %s&quot;, self.names())        self._register_mechanisms()        self.host_filtering_supported = self.is_host_filtering_supported()        if not self.host_filtering_supported:            LOG.info(&quot;No mechanism drivers provide segment reachability &quot;                     &quot;information for agent scheduling.&quot;)    def _driver_not_found(self, names):        msg = (_(&quot;The following mechanism drivers were not found: %s&quot;)               % names)        LOG.critical(msg)        raise SystemExit(msg)    def _driver_not_loaded(self, manager, entrypoint, exception):        LOG.critical(&quot;The &#x27;%(entrypoint)s&#x27; entrypoint could not be&quot;                     &quot; loaded for the following reason: &#x27;%(reason)s&#x27;.&quot;,                     &#123;&#x27;entrypoint&#x27;: entrypoint,                      &#x27;reason&#x27;: exception&#125;)        raise SystemExit(str(exception))    def _register_mechanisms(self):        &quot;&quot;&quot;Register all mechanism drivers.        This method should only be called once in the MechanismManager        constructor.        &quot;&quot;&quot;        for ext in self:            self.mech_drivers[ext.name] = ext            self.ordered_mech_drivers.append(ext)        LOG.info(&quot;Registered mechanism drivers: %s&quot;,                 [driver.name for driver in self.ordered_mech_drivers])\n\nmechanism_driver的初始化方法定义在setup.cfg文件中的entry_points里。\n12345678910neutron.ml2.mechanism_drivers =    logger = neutron.tests.unit.plugins.ml2.drivers.mechanism_logger:LoggerMechanismDriver    test = neutron.tests.unit.plugins.ml2.drivers.mechanism_test:TestMechanismDriver    linuxbridge = neutron.plugins.ml2.drivers.linuxbridge.mech_driver.mech_linuxbridge:LinuxbridgeMechanismDriver    macvtap = neutron.plugins.ml2.drivers.macvtap.mech_driver.mech_macvtap:MacvtapMechanismDriver    openvswitch = neutron.plugins.ml2.drivers.openvswitch.mech_driver.mech_openvswitch:OpenvswitchMechanismDriver    l2population = neutron.plugins.ml2.drivers.l2pop.mech_driver:L2populationMechanismDriver    sriovnicswitch = neutron.plugins.ml2.drivers.mech_sriov.mech_driver.mech_driver:SriovNicSwitchMechanismDriver    fake_agent = neutron.tests.unit.plugins.ml2.drivers.mech_fake_agent:FakeAgentMechanismDriver    faulty_agent = neutron.tests.unit.plugins.ml2.drivers.mech_faulty_agent:FaultyAgentMechanismDriver\n\nNeutronDbPluginV2初始化1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859# neutron/db/db_base_plugin_v2.py@registry.has_registry_receiversclass NeutronDbPluginV2(db_base_plugin_common.DbBasePluginCommon,                        neutron_plugin_base_v2.NeutronPluginBaseV2,                        rbac_mixin.RbacPluginMixin,                        stattr_db.StandardAttrDescriptionMixin):    &quot;&quot;&quot;V2 Neutron plugin interface implementation using SQLAlchemy models.    Whenever a non-read call happens the plugin will call an event handler    class method (e.g., network_created()).  The result is that this class    can be sub-classed by other classes that add custom behaviors on certain    events.    &quot;&quot;&quot;    # This attribute specifies whether the plugin supports or not    # bulk/pagination/sorting operations. Name mangling is used in    # order to ensure it is qualified by class    __native_bulk_support = True    __native_pagination_support = True    __native_sorting_support = True    # This attribute specifies whether the plugin supports or not    # filter validations. Name mangling is used in    # order to ensure it is qualified by class    __filter_validation_support = False    def has_native_datastore(self):        return True    def __new__(cls, *args, **kwargs):        model_query.register_hook(            models_v2.Port,            &quot;port&quot;,            query_hook=None,            filter_hook=_port_filter_hook,            result_filters=None)        return super(NeutronDbPluginV2, cls).__new__(cls, *args, **kwargs)    def __init__(self):        # 设置IP管理后端        self.set_ipam_backend()        # notify_nova_on_port_status_changes默认为True        # 在port状态更新时是否给Nova发送通知        if cfg.CONF.notify_nova_on_port_status_changes:            # Import nova conditionally to support the use case of Neutron            # being used outside of an OpenStack context.            from neutron.notifiers import nova            # NOTE(arosen) These event listeners are here to hook into when            # port status changes and notify nova about their change.            self.nova_notifier = nova.Notifier.get_instance()            lib_db_api.sqla_listen(models_v2.Port, &#x27;after_insert&#x27;,                                   self.nova_notifier.send_port_status)            lib_db_api.sqla_listen(models_v2.Port, &#x27;after_update&#x27;,                                   self.nova_notifier.send_port_status)            lib_db_api.sqla_listen(                models_v2.Port.status, &#x27;set&#x27;,                self.nova_notifier.record_port_status_changed)\n\nDirver初始化Type_Driver初始化1234567# neutron/plugins/ml2/managers.py# TypeManager    def initialize(self):        for network_type, driver in self.drivers.items():            LOG.info(&quot;Initializing driver for type &#x27;%s&#x27;&quot;, network_type)            driver.obj.initialize()\n例如type_driver vxlan的初始化。\n1234567891011121314151617181920# neutron/plugins/ml2/drivers/type_vxlan.pyclass VxlanTypeDriver(type_tunnel.EndpointTunnelTypeDriver):    def __init__(self):        super(VxlanTypeDriver, self).__init__(            vxlan_obj.VxlanAllocation, vxlan_obj.VxlanEndpoint)    def get_type(self):        return p_const.TYPE_VXLAN    def initialize(self):        try:            # 初始化vxlan的vni范围            self._initialize(cfg.CONF.ml2_type_vxlan.vni_ranges)        except n_exc.NetworkTunnelRangeError:            LOG.exception(&quot;Failed to parse vni_ranges. &quot;                          &quot;Service terminated!&quot;)            raise SystemExit()\n\nExtension_Driver初始化12345678# neutron/plugins/ml2/managers.py# ExtensionManager    def initialize(self):        # Initialize each driver in the list.        for driver in self.ordered_ext_drivers:            LOG.info(&quot;Initializing extension driver &#x27;%s&#x27;&quot;, driver.name)            driver.obj.initialize()\n例如extension_driver qos的初始化。\n1234567# neutron/plugins/ml2/extensions/qos.pyclass QosExtensionDriver(api.ExtensionDriver):    def initialize(self):        self.core_ext_handler = qos_core.QosCoreResourceExtension()        LOG.debug(&quot;QosExtensionDriver initialization complete&quot;)\n\nMechanism_Driver初始化1234567# neutron/plugins/ml2/managers.py# MechanismManager    def initialize(self):        for driver in self.ordered_mech_drivers:            LOG.info(&quot;Initializing mechanism driver &#x27;%s&#x27;&quot;, driver.name)            driver.obj.initialize()\n\nDHCP组件初始化12345678910# neutron/plugins/ml2/plugin.py# Ml2Plugin    def _setup_dhcp(self):        &quot;&quot;&quot;Initialize components to support DHCP.&quot;&quot;&quot;        self.network_scheduler = importutils.import_object(            # 默认是neutron.scheduler.dhcp_agent_scheduler.WeightScheduler            cfg.CONF.network_scheduler_driver        )        self.add_periodic_dhcp_agent_status_check()\n查看WeightScheduler。\n123456# neutron/scheduler/dhcp_agent_scheduler.pyclass WeightScheduler(base_scheduler.BaseWeightScheduler, AutoScheduler):    def __init__(self):        super(WeightScheduler, self).__init__(DhcpFilter())\n\n查看WeightScheduler的基类BaseWeightScheduler。\n12345678910111213# neutron/scheduler/base_scheduler.pyclass BaseWeightScheduler(BaseScheduler):    &quot;&quot;&quot;Choose agents based on load.&quot;&quot;&quot;    def __init__(self, resource_filter):        self.resource_filter = resource_filter    def select(self, plugin, context, resource_hostable_agents,               resource_hosted_agents, num_agents_needed):        chosen_agents = sorted(resource_hostable_agents,                           key=attrgetter(&#x27;load&#x27;))[0:num_agents_needed]        return chosen_agents\n\n查看add_periodic_dhcp_agent_status_check()方法。\n12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697# neutron/db/agentschedulers_db.py# DhcpAgentSchedulerDbMixin    def add_periodic_dhcp_agent_status_check(self):        # allow_automatic_dhcp_failover默认为True        # 当Agent离线时，是否自动将网络移除        if not cfg.CONF.allow_automatic_dhcp_failover:            LOG.info(&quot;Skipping periodic DHCP agent status check because &quot;                     &quot;automatic network rescheduling is disabled.&quot;)            return        self.add_agent_status_check_worker(            self.remove_networks_from_down_agents        )    def add_agent_status_check_worker(self, function):        # TODO(enikanorov): make interval configurable rather than computed        # agent_down_time默认是75秒        interval = max(cfg.CONF.agent_down_time // 2, 1)        # add random initial delay to allow agents to check in after the        # neutron server first starts. random to offset multiple servers        initial_delay = random.randint(interval, interval * 2)        check_worker = neutron_worker.PeriodicWorker(function, interval,                                                     initial_delay)        self.add_worker(check_worker)        def remove_networks_from_down_agents(self):        &quot;&quot;&quot;Remove networks from down DHCP agents if admin state is up.        Reschedule them if configured so.        &quot;&quot;&quot;        agent_dead_limit = self.agent_dead_limit_seconds()        self.wait_down_agents(&#x27;DHCP&#x27;, agent_dead_limit)        cutoff = self.get_cutoff_time(agent_dead_limit)        context = ncontext.get_admin_context()        try:            down_bindings = network.NetworkDhcpAgentBinding.get_down_bindings(                context, cutoff)            dhcp_notifier = self.agent_notifiers.get(constants.AGENT_TYPE_DHCP)            dead_bindings = [b for b in                             self._filter_bindings(context, down_bindings)]            agents = self.get_agent_objects(                context, &#123;&#x27;agent_type&#x27;: [constants.AGENT_TYPE_DHCP]&#125;)            if not agents:                # No agents configured so nothing to do.                return            active_agents = [agent for agent in agents if                             self.is_eligible_agent(context, True, agent)]            if not active_agents:                LOG.warning(&quot;No DHCP agents available, &quot;                            &quot;skipping rescheduling&quot;)                return            for binding in dead_bindings:                LOG.warning(&quot;Removing network %(network)s from agent &quot;                            &quot;%(agent)s because the agent did not report &quot;                            &quot;to the server in the last %(dead_time)s &quot;                            &quot;seconds.&quot;,                            &#123;&#x27;network&#x27;: binding.network_id,                             &#x27;agent&#x27;: binding.dhcp_agent_id,                             &#x27;dead_time&#x27;: agent_dead_limit&#125;)                # save binding object to avoid ObjectDeletedError                # in case binding is concurrently deleted from the DB                saved_binding = &#123;&#x27;net&#x27;: binding.network_id,                                 &#x27;agent&#x27;: binding.dhcp_agent_id&#125;                try:                    # do not notify agent if it considered dead                    # so when it is restarted it won&#x27;t see network delete                    # notifications on its queue                    self.remove_network_from_dhcp_agent(context,                                                        binding.dhcp_agent_id,                                                        binding.network_id,                                                        notify=False)                except das_exc.NetworkNotHostedByDhcpAgent:                    # measures against concurrent operation                    LOG.debug(&quot;Network %(net)s already removed from DHCP &quot;                              &quot;agent %(agent)s&quot;,                              saved_binding)                    # still continue and allow concurrent scheduling attempt                except Exception:                    LOG.exception(&quot;Unexpected exception occurred while &quot;                                  &quot;removing network %(net)s from agent &quot;                                  &quot;%(agent)s&quot;,                                  saved_binding)                if cfg.CONF.network_auto_schedule:                    self._schedule_network(                        context, saved_binding[&#x27;net&#x27;], dhcp_notifier)        except Exception:            # we want to be thorough and catch whatever is raised            # to avoid loop abortion            LOG.exception(&quot;Exception encountered during network &quot;                          &quot;rescheduling&quot;)\n\nRPC_Notifier初始化1234567891011# neutron/plugins/ml2/plugin.py# Ml2Plugin    @log_helpers.log_method_call    def _start_rpc_notifiers(self):        &quot;&quot;&quot;Initialize RPC notifiers for agents.&quot;&quot;&quot;        self.ovo_notifier = ovo_rpc.OVOServerRpcInterface()        self.notifier = rpc.AgentNotifierApi(topics.AGENT)        self.agent_notifiers[const.AGENT_TYPE_DHCP] = (            dhcp_rpc_agent_api.DhcpAgentNotifyAPI()        )\n\n123456789101112131415161718192021222324252627# neutron/plugins/ml2/ovo_rpc.pyclass OVOServerRpcInterface(object):    &quot;&quot;&quot;ML2 server-side RPC interface.    Generates RPC callback notifications on ML2 object changes.    &quot;&quot;&quot;    def __init__(self):        self._rpc_pusher = resources_rpc.ResourcesPushRpcApi()        self._setup_change_handlers()        LOG.debug(&quot;ML2 OVO RPC backend initialized.&quot;)    def _setup_change_handlers(self):        &quot;&quot;&quot;Setup all of the local callback listeners for resource changes.&quot;&quot;&quot;        resource_objclass_map = &#123;            resources.PORT: ports.Port,            resources.SUBNET: subnet.Subnet,            resources.NETWORK: network.Network,            resources.SECURITY_GROUP: securitygroup.SecurityGroup,            resources.SECURITY_GROUP_RULE: securitygroup.SecurityGroupRule,        &#125;        self._resource_handlers = &#123;            res: _ObjectChangeHandler(res, obj_class, self._rpc_pusher)            for res, obj_class in resource_objclass_map.items()        &#125;\n\n12345678910111213141516# neutron/api/rpc/handlers/resources_rpc.pyclass ResourcesPushRpcApi(object):    &quot;&quot;&quot;Plugin-side RPC for plugin-to-agents interaction.    This interface is designed to push versioned object updates to interested    agents using fanout topics.    This class implements the caller side of an rpc interface.  The receiver    side can be found below: ResourcesPushRpcCallback.    &quot;&quot;&quot;    def __init__(self):        target = oslo_messaging.Target(            namespace=constants.RPC_NAMESPACE_RESOURCES)        self.client = n_rpc.get_client(target)\n\nNeutron Callback System\n123456789101112131415161718# neutron/plugins/ml2/ovo_rpc.pyclass _ObjectChangeHandler(object):    def __init__(self, resource, object_class, resource_push_api):        self._resource = resource        self._obj_class = object_class        self._resource_push_api = resource_push_api        self._resources_to_push = &#123;&#125;        # NOTE(annp): uWSGI seems not happy with eventlet.GreenPool.        # So switching to ThreadPool        self._worker_pool = futurist.ThreadPoolExecutor()        self.fts = []        self._semantic_warned = False        for event in (events.AFTER_CREATE, events.AFTER_UPDATE,                      events.AFTER_DELETE):            registry.subscribe(self.handle_event, resource, event)","dateCreated":"2019-10-14T18:34:58+08:00","dateModified":"2023-09-21T10:44:59+08:00","datePublished":"2019-10-14T18:34:58+08:00","description":"Neutron-Server源码分析","headline":"Neutron-Server源码分析","image":[null,"images/PROJECT-Vayne.jpg"],"mainEntityOfPage":{"@type":"WebPage","@id":"https://wangkuntian.github.io/2019/10/14/Neutron-Server%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},"publisher":{"@type":"Organization","name":"Wang kuntian","sameAs":["https://github.com/wangkuntian","mailto:wangkuntian1994@163.com"],"image":"faker.jpg","logo":{"@type":"ImageObject","url":"faker.jpg"}},"url":"https://wangkuntian.github.io/2019/10/14/Neutron-Server%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/","keywords":"Neutron","thumbnailUrl":"images/PROJECT-Vayne.jpg"}</script>
    <meta name="description" content="Neutron-Server源码分析">
<meta property="og:type" content="blog">
<meta property="og:title" content="Neutron-Server源码分析">
<meta property="og:url" content="https://wangkuntian.github.io/2019/10/14/Neutron-Server%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="Wang kuntian&#39;s Blog">
<meta property="og:description" content="Neutron-Server源码分析">
<meta property="og:locale" content="zh_EN">
<meta property="article:published_time" content="2019-10-14T10:34:58.000Z">
<meta property="article:modified_time" content="2023-09-21T02:44:59.967Z">
<meta property="article:author" content="Wang kuntian">
<meta property="article:tag" content="Neutron">
<meta name="twitter:card" content="summary">
    
    
        
    
    
        <meta property="og:image" content="https://wangkuntian.github.io/assets/images/faker.jpg"/>
    
    
    
        <meta property="og:image" content="https://wangkuntian.github.io/2019/10/14/Neutron-Server%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/images/PROJECT-Vayne.jpg"/>
        <meta class="swiftype" name="image" data-type="enum" content="https://wangkuntian.github.io/2019/10/14/Neutron-Server%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/images/PROJECT-Vayne.jpg"/>
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/style-bkzaqwnhdy35ne9gawopbfxp7lltc7yhde0uckf6kikurfjo9ztq2v5apuqa.min.css">

    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-136102260-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-136102260-1');
    </script>


    

    
        
    
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --></head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="4">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            Wang kuntian&#39;s Blog
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="Öffne den Link: /#about"
            >
        
        
            <img class="header-picture" src="/assets/images/faker.jpg" alt="Author&#39;s picture"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="4">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="Lesen Sie mehr über den Autor"
                >
                    <img class="sidebar-profile-picture" src="/assets/images/faker.jpg" alt="Author&#39;s picture"/>
                </a>
                <h4 class="sidebar-profile-name">Wang kuntian</h4>
                
                    <h5 class="sidebar-profile-bio"><p>Hi</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="Home"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="Categories"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="Tags"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="Archives"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link open-algolia-search"
                            href="#search"
                            
                            rel="noopener"
                            title="Search"
                        >
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Search</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="About"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/wangkuntian"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="mailto:wangkuntian1994@163.com"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Mail"
                        >
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Mail</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/atom.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
        <div class="post-header-cover
                    text-center
                    post-header-cover--full"
             style="background-image:url('/images/PROJECT-Vayne.jpg');"
             data-behavior="4">
            
                <div class="post-header main-content-wrap text-center">
    
        <h1 class="post-title">
            Neutron-Server源码分析
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2019-10-14T18:34:58+08:00">
	
		    Oct 14, 2019
    	
    </time>
    
</div>

    
</div>

            
        </div>

            <div id="main" data-behavior="4"
                 class="hasCover
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <!-- excerpt -->
<h1 id="table-of-contents">目录</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%89%88%E6%9C%AC"><span class="toc-text">版本</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8"><span class="toc-text">服务启动</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#WSGI-App"><span class="toc-text">WSGI App</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#WSGI-App-%E5%90%AF%E5%8A%A8"><span class="toc-text">WSGI App 启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WSGI-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">WSGI 配置文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#APIRouter"><span class="toc-text">APIRouter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%92%E4%BB%B6%E5%8A%A0%E8%BD%BD"><span class="toc-text">插件加载</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NeutronManager%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">NeutronManager初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ml2%E6%8F%92%E4%BB%B6%E5%8A%A0%E8%BD%BD"><span class="toc-text">ml2插件加载</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#TypeManager%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">TypeManager初始化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ExtensionManager%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">ExtensionManager初始化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#MechanismManager%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">MechanismManager初始化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#NeutronDbPluginV2%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">NeutronDbPluginV2初始化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Dirver%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">Dirver初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Type-Driver%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">Type_Driver初始化</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Extension-Driver%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">Extension_Driver初始化</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Mechanism-Driver%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">Mechanism_Driver初始化</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#DHCP%E7%BB%84%E4%BB%B6%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">DHCP组件初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#RPC-Notifier%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">RPC_Notifier初始化</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></li></ol>

<h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>neutron-server提供了一个公开的Neutron API的Web服务器，并将所有Web服务调用传递给Neutron插件进行处理。</p>
<h1 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h1><p><strong>Rocky</strong></p>
<h1 id="服务启动"><a href="#服务启动" class="headerlink" title="服务启动"></a>服务启动</h1><p>neutron-server的本质是一个Python Web Server Gateway Interface（WSGI），是通过eventlet来实现服务的异步并发模型的。实际工作时，通过serve_wsgi()方法来构造NeutronApiService实例，通过该实例生成eventlet.Greenpool()来运行WSGI App来响应客户端请求。</p>
<p>neutron的所有服务（services）的启动入口都定义在setup.cfg文件中的console_scripts。</p>
<p>neutron-server服务启动方法。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># setup.py</span></span><br><span class="line">[<span class="string">entry_points</span>]</span><br><span class="line"><span class="string">console_scripts</span> <span class="string">=</span> </span><br><span class="line">    <span class="string">neutron-server</span> <span class="string">=</span> <span class="string">neutron.cmd.eventlet.server:main</span></span><br></pre></td></tr></table></figure>

<p>查看neutron.cmd.eventlet.server.main()方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/cmd/eventlet/server/__init__.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> neutron <span class="keyword">import</span> server</span><br><span class="line"><span class="keyword">from</span> neutron.server <span class="keyword">import</span> rpc_eventlet</span><br><span class="line"><span class="keyword">from</span> neutron.server <span class="keyword">import</span> wsgi_eventlet</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    server.boot_server(wsgi_eventlet.eventlet_wsgi_server)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main_rpc_eventlet</span>():</span><br><span class="line">    server.boot_server(rpc_eventlet.eventlet_rpc_server)</span><br></pre></td></tr></table></figure>

<p>查看wsgi_eventlet.eventlet_wsgi_server方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/server/wsgi_eventlet.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">eventlet_wsgi_server</span>():</span><br><span class="line">    <span class="comment"># 启动wsigi服务</span></span><br><span class="line">    neutron_api = service.serve_wsgi(service.NeutronApiService)</span><br><span class="line">    start_api_and_rpc_workers(neutron_api)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">start_api_and_rpc_workers</span>(<span class="params">neutron_api</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        worker_launcher = service.start_all_workers()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 创建eventlet.GreenPool()</span></span><br><span class="line">        pool = eventlet.GreenPool()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 创建api_thread用来监听api命令</span></span><br><span class="line">        <span class="comment"># 当命令到达时，通过wsgi服务路由到neutron.api.v2.base中的Controller中去处理。</span></span><br><span class="line">        api_thread = pool.spawn(neutron_api.wait)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 创建plugin_workers_thread与rpc_work相关联，监听topics中的消息队列的请求，</span></span><br><span class="line">        <span class="comment"># 完成neutron内部组件之间的通信</span></span><br><span class="line">        plugin_workers_thread = pool.spawn(worker_launcher.wait)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># api and other workers should die together. When one dies,</span></span><br><span class="line">        <span class="comment"># kill the other.</span></span><br><span class="line">        api_thread.link(<span class="keyword">lambda</span> gt: plugin_workers_thread.kill())</span><br><span class="line">        plugin_workers_thread.link(<span class="keyword">lambda</span> gt: api_thread.kill())</span><br><span class="line"></span><br><span class="line">        pool.waitall()</span><br><span class="line">    <span class="keyword">except</span> NotImplementedError:</span><br><span class="line">        LOG.info(<span class="string">&quot;RPC was already started in parent process by &quot;</span></span><br><span class="line">                 <span class="string">&quot;plugin.&quot;</span>)</span><br><span class="line"></span><br><span class="line">        neutron_api.wait()</span><br></pre></td></tr></table></figure>

<h2 id="WSGI-App"><a href="#WSGI-App" class="headerlink" title="WSGI App"></a>WSGI App</h2><h3 id="WSGI-App-启动"><a href="#WSGI-App-启动" class="headerlink" title="WSGI App 启动"></a>WSGI App 启动</h3><p>查看NeutronApiService类和serve_wsgi()方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/service.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NeutronApiService</span>(<span class="title class_ inherited__">WsgiService</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Class for neutron-api service.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, app_name</span>):</span><br><span class="line">        profiler.setup(<span class="string">&#x27;neutron-server&#x27;</span>, cfg.CONF.host)</span><br><span class="line">        <span class="built_in">super</span>(NeutronApiService, self).__init__(app_name)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">cls, app_name=<span class="string">&#x27;neutron&#x27;</span></span>):</span><br><span class="line">        <span class="comment"># Setup logging early</span></span><br><span class="line">        config.setup_logging()</span><br><span class="line">        service = cls(app_name)</span><br><span class="line">        <span class="keyword">return</span> service</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">serve_wsgi</span>(<span class="params">cls</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        service = cls.create()</span><br><span class="line">        service.start()</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">with</span> excutils.save_and_reraise_exception():</span><br><span class="line">            LOG.exception(<span class="string">&#x27;Unrecoverable error: please check log &#x27;</span></span><br><span class="line">                          <span class="string">&#x27;for details.&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    registry.publish(resources.PROCESS, events.BEFORE_SPAWN, service)</span><br><span class="line">    <span class="keyword">return</span> service</span><br></pre></td></tr></table></figure>

<p>查看NeutronApiService的基类WsgiService。上面serve_wsgi方法中service.start()调用就是WsgiService中的start()方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/service.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WsgiService</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Base class for WSGI based services.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    For each api you define, you must also define these flags:</span></span><br><span class="line"><span class="string">    :&lt;api&gt;_listen: The address on which to listen</span></span><br><span class="line"><span class="string">    :&lt;api&gt;_listen_port: The port on which to listen</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, app_name</span>):</span><br><span class="line">        self.app_name = app_name</span><br><span class="line">        self.wsgi_app = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">start</span>(<span class="params">self</span>):</span><br><span class="line">        self.wsgi_app = _run_wsgi(self.app_name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">wait</span>(<span class="params">self</span>):</span><br><span class="line">        self.wsgi_app.wait()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>查看_run_wsgi()方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/service.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过调用load_paste_app()方法生成app，并调用run_wsgi_app()方法来启动app。</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_run_wsgi</span>(<span class="params">app_name</span>):</span><br><span class="line">    app = config.load_paste_app(app_name)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> app:</span><br><span class="line">        LOG.error(<span class="string">&#x27;No known API applications configured.&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">return</span> run_wsgi_app(app)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_wsgi_app</span>(<span class="params">app</span>):</span><br><span class="line">    server = wsgi.Server(<span class="string">&quot;Neutron&quot;</span>)</span><br><span class="line">    server.start(app, cfg.CONF.bind_port, cfg.CONF.bind_host,</span><br><span class="line">                 workers=_get_api_workers())</span><br><span class="line">    LOG.info(<span class="string">&quot;Neutron service started, listening on %(host)s:%(port)s&quot;</span>,</span><br><span class="line">             &#123;<span class="string">&#x27;host&#x27;</span>: cfg.CONF.bind_host, <span class="string">&#x27;port&#x27;</span>: cfg.CONF.bind_port&#125;)</span><br><span class="line">    <span class="keyword">return</span> server</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>查看load_paste_app()方法，从注释可以了解，该方法从配置文件构造并返回一个WSGI App。根据追踪，该配置文件主要是/etc/neutron/api-paste.ini，server通过解析该文件来指定WSGI App的实现。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/common/config.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_paste_app</span>(<span class="params">app_name</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Builds and returns a WSGI app from a paste config file.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param app_name: Name of the application to load</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 加载WSGI的配置文件</span></span><br><span class="line">    loader = wsgi.Loader(cfg.CONF)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Log the values of registered opts</span></span><br><span class="line">    <span class="keyword">if</span> cfg.CONF.debug:</span><br><span class="line">        cfg.CONF.log_opt_values(LOG, logging.DEBUG)</span><br><span class="line">    app = loader.load_app(app_name)</span><br><span class="line">    <span class="keyword">return</span> app</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Loader类的load_app()方法中，调用paste模块库deploy来实现对api-paste.ini中配置信息的解析和app的实现。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># oslo_service/wsgi.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Loader</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Used to load WSGI applications from paste configurations.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, conf</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Initialize the loader, and attempt to find the config.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param conf: Application config</span></span><br><span class="line"><span class="string">        :returns: None</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        conf.register_opts(_options.wsgi_opts)</span><br><span class="line">        self.config_path = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        config_path = conf.api_paste_config</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.isabs(config_path):</span><br><span class="line">            self.config_path = conf.find_file(config_path)</span><br><span class="line">        <span class="keyword">elif</span> os.path.exists(config_path):</span><br><span class="line">            self.config_path = config_path</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.config_path:</span><br><span class="line">            <span class="keyword">raise</span> ConfigNotFound(path=config_path)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_app</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Return the paste URLMap wrapped WSGI application.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param name: Name of the application to load.</span></span><br><span class="line"><span class="string">        :returns: Paste URLMap object wrapping the requested application.</span></span><br><span class="line"><span class="string">        :raises: PasteAppNotFound</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            LOG.debug(<span class="string">&quot;Loading app %(name)s from %(path)s&quot;</span>,</span><br><span class="line">                      &#123;<span class="string">&#x27;name&#x27;</span>: name, <span class="string">&#x27;path&#x27;</span>: self.config_path&#125;)</span><br><span class="line">            <span class="keyword">return</span> deploy.loadapp(<span class="string">&quot;config:%s&quot;</span> % self.config_path, name=name)</span><br><span class="line">        <span class="keyword">except</span> LookupError:</span><br><span class="line">            LOG.exception(<span class="string">&quot;Couldn&#x27;t lookup app: %s&quot;</span>, name)</span><br><span class="line">            <span class="keyword">raise</span> PasteAppNotFound(name=name, path=self.config_path)</span><br></pre></td></tr></table></figure>

<div class="alert info no-icon"><p>PasteDeployment是一种机制或者说是一种设计模式，它用于在应用WSGI Application和Server提供一个联系的桥梁，并且为用户提供一个接口，当配置好PasteDeployment之后，用户只需调用loadapp方法就可以使用现有的WSGI Application，而保持了WSGI Application对用户的透明性。</p>
</div>

<h3 id="WSGI-配置文件"><a href="#WSGI-配置文件" class="headerlink" title="WSGI 配置文件"></a>WSGI 配置文件</h3><p>追踪配置文件加载。首先查看neutron/service.py文件。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/service.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> neutron <span class="keyword">import</span> wsgi</span><br></pre></td></tr></table></figure>

<p>找到neutron/wsgi.py文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/wsgi.py</span></span><br><span class="line"></span><br><span class="line">wsgi_config.register_socket_opts()</span><br></pre></td></tr></table></figure>

<p>register_socket_opts()方法注册WSGI和socket的配置项</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/conf/wsgi.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register_socket_opts</span>(<span class="params">cfg=cfg.CONF</span>):</span><br><span class="line">    cfg.register_opts(socket_opts)</span><br><span class="line">    wsgi.register_opts(cfg)</span><br></pre></td></tr></table></figure>

<p>oslo.serivce中的wsgi.py文件。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># oslo_service/wsgi.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register_opts</span>(<span class="params">conf</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Registers WSGI config options.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> conf.register_opts(_options.wsgi_opts)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>_options.wsgi_opts定义WSGI的配置项。其中api_paste_config默认是api-paste.ini，一般位于/etc/neutron/目录下。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># oslo_service/_options.py</span></span><br><span class="line"></span><br><span class="line">wsgi_opts = [</span><br><span class="line">    cfg.StrOpt(<span class="string">&#x27;api_paste_config&#x27;</span>,</span><br><span class="line">               default=<span class="string">&quot;api-paste.ini&quot;</span>,</span><br><span class="line">               <span class="built_in">help</span>=<span class="string">&#x27;File name for the paste.deploy config for api service&#x27;</span>),</span><br><span class="line">    cfg.StrOpt(<span class="string">&#x27;wsgi_log_format&#x27;</span>,</span><br><span class="line">               default=<span class="string">&#x27;%(client_ip)s &quot;%(request_line)s&quot; status: &#x27;</span></span><br><span class="line">                       <span class="string">&#x27;%(status_code)s  len: %(body_length)s time:&#x27;</span></span><br><span class="line">                       <span class="string">&#x27; %(wall_seconds).7f&#x27;</span>,</span><br><span class="line">               <span class="built_in">help</span>=<span class="string">&#x27;A python format string that is used as the template to &#x27;</span></span><br><span class="line">                    <span class="string">&#x27;generate log lines. The following values can be&#x27;</span></span><br><span class="line">                    <span class="string">&#x27;formatted into it: client_ip, date_time, request_line, &#x27;</span></span><br><span class="line">                    <span class="string">&#x27;status_code, body_length, wall_seconds.&#x27;</span>),</span><br><span class="line">    cfg.IntOpt(<span class="string">&#x27;tcp_keepidle&#x27;</span>,</span><br><span class="line">               default=<span class="number">600</span>,</span><br><span class="line">               <span class="built_in">help</span>=<span class="string">&quot;Sets the value of TCP_KEEPIDLE in seconds for each &quot;</span></span><br><span class="line">                    <span class="string">&quot;server socket. Not supported on OS X.&quot;</span>),</span><br><span class="line">    cfg.IntOpt(<span class="string">&#x27;wsgi_default_pool_size&#x27;</span>,</span><br><span class="line">               default=<span class="number">100</span>,</span><br><span class="line">               <span class="built_in">help</span>=<span class="string">&quot;Size of the pool of greenthreads used by wsgi&quot;</span>),</span><br><span class="line">    cfg.IntOpt(<span class="string">&#x27;max_header_line&#x27;</span>,</span><br><span class="line">               default=<span class="number">16384</span>,</span><br><span class="line">               <span class="built_in">help</span>=<span class="string">&quot;Maximum line size of message headers to be accepted. &quot;</span></span><br><span class="line">                    <span class="string">&quot;max_header_line may need to be increased when using &quot;</span></span><br><span class="line">                    <span class="string">&quot;large tokens (typically those generated when keystone &quot;</span></span><br><span class="line">                    <span class="string">&quot;is configured to use PKI tokens with big service &quot;</span></span><br><span class="line">                    <span class="string">&quot;catalogs).&quot;</span>),</span><br><span class="line">    cfg.BoolOpt(<span class="string">&#x27;wsgi_keep_alive&#x27;</span>,</span><br><span class="line">                default=<span class="literal">True</span>,</span><br><span class="line">                <span class="built_in">help</span>=<span class="string">&quot;If False, closes the client socket connection &quot;</span></span><br><span class="line">                     <span class="string">&quot;explicitly.&quot;</span>),</span><br><span class="line">    cfg.IntOpt(<span class="string">&#x27;client_socket_timeout&#x27;</span>, default=<span class="number">900</span>,</span><br><span class="line">               <span class="built_in">help</span>=<span class="string">&quot;Timeout for client connections&#x27; socket operations. &quot;</span></span><br><span class="line">                    <span class="string">&quot;If an incoming connection is idle for this number of &quot;</span></span><br><span class="line">                    <span class="string">&quot;seconds it will be closed. A value of &#x27;0&#x27; means &quot;</span></span><br><span class="line">                    <span class="string">&quot;wait forever.&quot;</span>),</span><br><span class="line">    ]</span><br></pre></td></tr></table></figure>

<p>api-paste.ini文件的主要内容。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/api-paste.ini</span></span><br><span class="line"></span><br><span class="line">[<span class="string">composite:neutron</span>]</span><br><span class="line"><span class="string">use</span> <span class="string">=</span> <span class="string">egg:Paste#urlmap</span></span><br><span class="line"><span class="string">/:</span> <span class="string">neutronversions_composite</span></span><br><span class="line"><span class="string">/v2.0:</span> <span class="string">neutronapi_v2_0</span></span><br><span class="line"></span><br><span class="line">[<span class="string">composite:neutronapi_v2_0</span>]</span><br><span class="line"><span class="string">use</span> <span class="string">=</span> <span class="string">call:neutron.auth:pipeline_factory</span></span><br><span class="line"><span class="string">noauth</span> <span class="string">=</span> <span class="string">cors</span> <span class="string">http_proxy_to_wsgi</span> <span class="string">request_id</span> <span class="string">catch_errors</span> <span class="string">extensions</span> <span class="string">neutronapiapp_v2_0</span></span><br><span class="line"><span class="string">keystone</span> <span class="string">=</span> <span class="string">cors</span> <span class="string">http_proxy_to_wsgi</span> <span class="string">request_id</span> <span class="string">catch_errors</span> <span class="string">authtoken</span> <span class="string">keystonecontext</span> <span class="string">extensions</span> <span class="string">neutronapiapp_v2_0</span></span><br><span class="line"></span><br><span class="line">[<span class="string">composite:neutronversions_composite</span>]</span><br><span class="line"><span class="string">use</span> <span class="string">=</span> <span class="string">call:neutron.auth:pipeline_factory</span></span><br><span class="line"><span class="string">noauth</span> <span class="string">=</span> <span class="string">cors</span> <span class="string">http_proxy_to_wsgi</span> <span class="string">neutronversions</span></span><br><span class="line"><span class="string">keystone</span> <span class="string">=</span> <span class="string">cors</span> <span class="string">http_proxy_to_wsgi</span> <span class="string">neutronversions</span></span><br><span class="line"></span><br><span class="line">[<span class="string">filter:request_id</span>]</span><br><span class="line"><span class="string">paste.filter_factory</span> <span class="string">=</span> <span class="string">oslo_middleware:RequestId.factory</span></span><br><span class="line"></span><br><span class="line">[<span class="string">filter:catch_errors</span>]</span><br><span class="line"><span class="string">paste.filter_factory</span> <span class="string">=</span> <span class="string">oslo_middleware:CatchErrors.factory</span></span><br><span class="line"></span><br><span class="line">[<span class="string">filter:cors</span>]</span><br><span class="line"><span class="string">paste.filter_factory</span> <span class="string">=</span> <span class="string">oslo_middleware.cors:filter_factory</span></span><br><span class="line"><span class="string">oslo_config_project</span> <span class="string">=</span> <span class="string">neutron</span></span><br><span class="line"></span><br><span class="line">[<span class="string">filter:http_proxy_to_wsgi</span>]</span><br><span class="line"><span class="string">paste.filter_factory</span> <span class="string">=</span> <span class="string">oslo_middleware.http_proxy_to_wsgi:HTTPProxyToWSGI.factory</span></span><br><span class="line"></span><br><span class="line">[<span class="string">filter:keystonecontext</span>]</span><br><span class="line"><span class="string">paste.filter_factory</span> <span class="string">=</span> <span class="string">neutron.auth:NeutronKeystoneContext.factory</span></span><br><span class="line"></span><br><span class="line">[<span class="string">filter:authtoken</span>]</span><br><span class="line"><span class="string">paste.filter_factory</span> <span class="string">=</span> <span class="string">keystonemiddleware.auth_token:filter_factory</span></span><br><span class="line"></span><br><span class="line">[<span class="string">filter:extensions</span>]</span><br><span class="line"><span class="string">paste.filter_factory</span> <span class="string">=</span> <span class="string">neutron.api.extensions:plugin_aware_extension_middleware_factory</span></span><br><span class="line"></span><br><span class="line">[<span class="string">app:neutronversions</span>]</span><br><span class="line"><span class="string">paste.app_factory</span> <span class="string">=</span> <span class="string">neutron.pecan_wsgi.app:versions_factory</span></span><br><span class="line"></span><br><span class="line">[<span class="string">app:neutronapiapp_v2_0</span>]</span><br><span class="line"><span class="string">paste.app_factory</span> <span class="string">=</span> <span class="string">neutron.api.v2.router:APIRouter.factory</span></span><br><span class="line"></span><br><span class="line">[<span class="string">filter:osprofiler</span>]</span><br><span class="line"><span class="string">paste.filter_factory</span> <span class="string">=</span> <span class="string">osprofiler.web:WsgiMiddleware.factory</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="APIRouter"><a href="#APIRouter" class="headerlink" title="APIRouter"></a>APIRouter</h2><p>查看neutron/api/v2/router.py文件。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/api/v2/router.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> neutron.pecan_wsgi <span class="keyword">import</span> app <span class="keyword">as</span> pecan_app</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">APIRouter</span>(<span class="params">**local_config</span>):</span><br><span class="line">    <span class="keyword">return</span> pecan_app.v2_factory(<span class="literal">None</span>, **local_config)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_factory</span>(<span class="params">global_config, **local_config</span>):</span><br><span class="line">    <span class="keyword">return</span> pecan_app.v2_factory(global_config, **local_config)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">setattr</span>(APIRouter, <span class="string">&#x27;factory&#x27;</span>, _factory)</span><br></pre></td></tr></table></figure>

<p>查看v2_factory()方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /neutron/peacn_wsig/app.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">v2_factory</span>(<span class="params">global_config, **local_config</span>):</span><br><span class="line">    <span class="comment"># Processing Order:</span></span><br><span class="line">    <span class="comment">#   As request enters lower priority called before higher.</span></span><br><span class="line">    <span class="comment">#   Response from controller is passed from higher priority to lower.</span></span><br><span class="line">    app_hooks = [</span><br><span class="line">        hooks.UserFilterHook(),  <span class="comment"># priority 90</span></span><br><span class="line">        hooks.ContextHook(),  <span class="comment"># priority 95</span></span><br><span class="line">        hooks.ExceptionTranslationHook(),  <span class="comment"># priority 100</span></span><br><span class="line">        hooks.BodyValidationHook(),  <span class="comment"># priority 120</span></span><br><span class="line">        hooks.OwnershipValidationHook(),  <span class="comment"># priority 125</span></span><br><span class="line">        hooks.QuotaEnforcementHook(),  <span class="comment"># priority 130</span></span><br><span class="line">        hooks.NotifierHook(),  <span class="comment"># priority 135</span></span><br><span class="line">        hooks.QueryParametersHook(),  <span class="comment"># priority 139</span></span><br><span class="line">        hooks.PolicyHook(),  <span class="comment"># priority 140</span></span><br><span class="line">    ]</span><br><span class="line">    app = pecan.make_app(root.V2Controller(),</span><br><span class="line">                         debug=<span class="literal">False</span>,</span><br><span class="line">                         force_canonical=<span class="literal">False</span>,</span><br><span class="line">                         hooks=app_hooks,</span><br><span class="line">                         guess_content_type_from_ext=<span class="literal">True</span>)</span><br><span class="line">    startup.initialize_all()</span><br><span class="line">    <span class="keyword">return</span> app</span><br></pre></td></tr></table></figure>

<p>查看root.V2Controller()类。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/pecan_wsgi/controllers/root.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">V2Controller</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Same data structure as neutron.api.versions.Versions for API backward</span></span><br><span class="line">    <span class="comment"># compatibility</span></span><br><span class="line">    version_info = &#123;</span><br><span class="line">        <span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;v2.0&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;status&#x27;</span>: <span class="string">&#x27;CURRENT&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    _load_version_info(version_info)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># NOTE(blogan): Paste deploy handled the routing to the legacy extension</span></span><br><span class="line">    <span class="comment"># controller.  If the extensions filter is removed from the api-paste.ini</span></span><br><span class="line">    <span class="comment"># then this controller will be routed to  This means operators had</span></span><br><span class="line">    <span class="comment"># the ability to turn off the extensions controller via tha api-paste but</span></span><br><span class="line">    <span class="comment"># will not be able to turn it off with the pecan switch.</span></span><br><span class="line">    extensions = ext_ctrl.ExtensionsController()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @utils.expose(<span class="params">generic=<span class="literal">True</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">index</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> pecan.request.path_url.endswith(<span class="string">&#x27;/&#x27;</span>):</span><br><span class="line">            pecan.abort(<span class="number">404</span>)</span><br><span class="line"></span><br><span class="line">        layout = []</span><br><span class="line">        <span class="keyword">for</span> name, collection <span class="keyword">in</span> _CORE_RESOURCES.items():</span><br><span class="line">            href = urlparse.urljoin(pecan.request.path_url, collection)</span><br><span class="line">            resource = &#123;<span class="string">&#x27;name&#x27;</span>: name,</span><br><span class="line">                        <span class="string">&#x27;collection&#x27;</span>: collection,</span><br><span class="line">                        <span class="string">&#x27;links&#x27;</span>: [&#123;<span class="string">&#x27;rel&#x27;</span>: <span class="string">&#x27;self&#x27;</span>,</span><br><span class="line">                                   <span class="string">&#x27;href&#x27;</span>: href&#125;]&#125;</span><br><span class="line">            layout.append(resource)</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&#x27;resources&#x27;</span>: layout&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">    @utils.when(<span class="params">index, method=<span class="string">&#x27;HEAD&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">    @utils.when(<span class="params">index, method=<span class="string">&#x27;POST&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">    @utils.when(<span class="params">index, method=<span class="string">&#x27;PATCH&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">    @utils.when(<span class="params">index, method=<span class="string">&#x27;PUT&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">    @utils.when(<span class="params">index, method=<span class="string">&#x27;DELETE&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">not_supported</span>(<span class="params">self</span>):</span><br><span class="line">        pecan.abort(<span class="number">405</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @utils.expose()</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_lookup</span>(<span class="params">self, collection, *remainder</span>):</span><br><span class="line">        <span class="comment"># if collection exists in the extension to service plugins map then</span></span><br><span class="line">        <span class="comment"># we are assuming that collection is the service plugin and</span></span><br><span class="line">        <span class="comment"># needs to be remapped.</span></span><br><span class="line">        <span class="comment"># Example: https://neutron.endpoint/v2.0/lbaas/loadbalancers</span></span><br><span class="line">        <span class="keyword">if</span> (remainder <span class="keyword">and</span></span><br><span class="line">                manager.NeutronManager.get_resources_for_path_prefix(</span><br><span class="line">                    collection)):</span><br><span class="line">            collection = remainder[<span class="number">0</span>]</span><br><span class="line">            remainder = remainder[<span class="number">1</span>:]</span><br><span class="line">        controller = manager.NeutronManager.get_controller_for_resource(</span><br><span class="line">            collection)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> controller:</span><br><span class="line">            LOG.warning(<span class="string">&quot;No controller found for: %s - returning response &quot;</span></span><br><span class="line">                        <span class="string">&quot;code 404&quot;</span>, collection)</span><br><span class="line">            pecan.abort(<span class="number">404</span>)</span><br><span class="line">        <span class="comment"># Store resource and collection names in pecan request context so that</span></span><br><span class="line">        <span class="comment"># hooks can leverage them if necessary. The following code uses</span></span><br><span class="line">        <span class="comment"># attributes from the controller instance to ensure names have been</span></span><br><span class="line">        <span class="comment"># properly sanitized (eg: replacing dashes with underscores)</span></span><br><span class="line">        request.context[<span class="string">&#x27;resource&#x27;</span>] = controller.resource</span><br><span class="line">        request.context[<span class="string">&#x27;collection&#x27;</span>] = controller.collection</span><br><span class="line">        <span class="comment"># NOTE(blogan): initialize a dict to store the ids of the items walked</span></span><br><span class="line">        <span class="comment"># in the path for example: /networks/1234 would cause uri_identifiers</span></span><br><span class="line">        <span class="comment"># to contain: &#123;&#x27;network_id&#x27;: &#x27;1234&#x27;&#125;</span></span><br><span class="line">        <span class="comment"># This is for backwards compatibility with legacy extensions that</span></span><br><span class="line">        <span class="comment"># defined their own controllers and expected kwargs to be passed in</span></span><br><span class="line">        <span class="comment"># with the uri_identifiers</span></span><br><span class="line">        request.context[<span class="string">&#x27;uri_identifiers&#x27;</span>] = &#123;&#125;</span><br><span class="line">        <span class="keyword">return</span> controller, remainder</span><br></pre></td></tr></table></figure>

<h2 id="插件加载"><a href="#插件加载" class="headerlink" title="插件加载"></a>插件加载</h2><p>查看startup.initialize_all()方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/pecan_wsgi/startup.py</span></span><br><span class="line"></span><br><span class="line">RESOURCES = &#123;<span class="string">&#x27;network&#x27;</span>: <span class="string">&#x27;networks&#x27;</span>,</span><br><span class="line">             <span class="string">&#x27;subnet&#x27;</span>: <span class="string">&#x27;subnets&#x27;</span>,</span><br><span class="line">             <span class="string">&#x27;subnetpool&#x27;</span>: <span class="string">&#x27;subnetpools&#x27;</span>,</span><br><span class="line">             <span class="string">&#x27;port&#x27;</span>: <span class="string">&#x27;ports&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">initialize_all</span>():</span><br><span class="line">    <span class="comment"># NeutronManager初始化</span></span><br><span class="line">    manager.init()</span><br><span class="line">    ext_mgr = extensions.PluginAwareExtensionManager.get_instance()</span><br><span class="line">    ext_mgr.extend_resources(<span class="string">&quot;2.0&quot;</span>, attributes.RESOURCES)</span><br><span class="line">    <span class="comment"># At this stage we have a fully populated resource attribute map;</span></span><br><span class="line">    <span class="comment"># build Pecan controllers and routes for all core resources</span></span><br><span class="line">    plugin = directory.get_plugin()</span><br><span class="line">    <span class="keyword">for</span> resource, collection <span class="keyword">in</span> RESOURCES.items():</span><br><span class="line">        resource_registry.register_resource_by_name(resource)</span><br><span class="line">        new_controller = res_ctrl.CollectionsController(collection, resource,</span><br><span class="line">                                                        plugin=plugin)</span><br><span class="line">        manager.NeutronManager.set_controller_for_resource(</span><br><span class="line">            collection, new_controller)</span><br><span class="line">        manager.NeutronManager.set_plugin_for_resource(collection, plugin)</span><br><span class="line"></span><br><span class="line">    pecanized_resources = ext_mgr.get_pecan_resources()</span><br><span class="line">    <span class="keyword">for</span> pec_res <span class="keyword">in</span> pecanized_resources:</span><br><span class="line">        manager.NeutronManager.set_controller_for_resource(</span><br><span class="line">            pec_res.collection, pec_res.controller)</span><br><span class="line">        manager.NeutronManager.set_plugin_for_resource(</span><br><span class="line">            pec_res.collection, pec_res.plugin)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Now build Pecan Controllers and routes for all extensions</span></span><br><span class="line">    resources = ext_mgr.get_resources()</span><br><span class="line">    <span class="comment"># Extensions controller is already defined, we don&#x27;t need it.</span></span><br><span class="line">    resources.pop(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">for</span> ext_res <span class="keyword">in</span> resources:</span><br><span class="line">        path_prefix = ext_res.path_prefix.strip(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">        collection = ext_res.collection</span><br><span class="line">        <span class="comment"># Retrieving the parent resource.  It is expected the format of</span></span><br><span class="line">        <span class="comment"># the parent resource to be:</span></span><br><span class="line">        <span class="comment"># &#123;&#x27;collection_name&#x27;: &#x27;name-of-collection&#x27;,</span></span><br><span class="line">        <span class="comment">#  &#x27;member_name&#x27;: &#x27;name-of-resource&#x27;&#125;</span></span><br><span class="line">        <span class="comment"># collection_name does not appear to be used in the legacy code</span></span><br><span class="line">        <span class="comment"># inside the controller logic, so we can assume we do not need it.</span></span><br><span class="line">        parent = ext_res.parent <span class="keyword">or</span> &#123;&#125;</span><br><span class="line">        parent_resource = parent.get(<span class="string">&#x27;member_name&#x27;</span>)</span><br><span class="line">        collection_key = collection</span><br><span class="line">        <span class="keyword">if</span> parent_resource:</span><br><span class="line">            collection_key = <span class="string">&#x27;/&#x27;</span>.join([parent_resource, collection])</span><br><span class="line">        collection_actions = ext_res.collection_actions</span><br><span class="line">        member_actions = ext_res.member_actions</span><br><span class="line">        <span class="keyword">if</span> manager.NeutronManager.get_controller_for_resource(collection_key):</span><br><span class="line">            <span class="comment"># This is a collection that already has a pecan controller, we</span></span><br><span class="line">            <span class="comment"># do not need to do anything else</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        legacy_controller = <span class="built_in">getattr</span>(ext_res.controller, <span class="string">&#x27;controller&#x27;</span>,</span><br><span class="line">                                    ext_res.controller)</span><br><span class="line">        new_controller = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(legacy_controller, base.Controller):</span><br><span class="line">            resource = legacy_controller.resource</span><br><span class="line">            plugin = legacy_controller.plugin</span><br><span class="line">            attr_info = legacy_controller.attr_info</span><br><span class="line">            member_actions = legacy_controller.member_actions</span><br><span class="line">            pagination = legacy_controller.allow_pagination</span><br><span class="line">            sorting = legacy_controller.allow_sorting</span><br><span class="line">            <span class="comment"># NOTE(blogan): legacy_controller and ext_res both can both have</span></span><br><span class="line">            <span class="comment"># member_actions.  the member_actions for ext_res are strictly for</span></span><br><span class="line">            <span class="comment"># routing, while member_actions for legacy_controller are used for</span></span><br><span class="line">            <span class="comment"># handling the request once the routing has found the controller.</span></span><br><span class="line">            <span class="comment"># They&#x27;re always the same so we will just use the ext_res</span></span><br><span class="line">            <span class="comment"># member_action.</span></span><br><span class="line">            new_controller = res_ctrl.CollectionsController(</span><br><span class="line">                collection, resource, resource_info=attr_info,</span><br><span class="line">                parent_resource=parent_resource, member_actions=member_actions,</span><br><span class="line">                plugin=plugin, allow_pagination=pagination,</span><br><span class="line">                allow_sorting=sorting, collection_actions=collection_actions)</span><br><span class="line">            <span class="comment"># new_controller.collection has replaced hyphens with underscores</span></span><br><span class="line">            manager.NeutronManager.set_plugin_for_resource(</span><br><span class="line">                new_controller.collection, plugin)</span><br><span class="line">            <span class="keyword">if</span> path_prefix:</span><br><span class="line">                manager.NeutronManager.add_resource_for_path_prefix(</span><br><span class="line">                    collection, path_prefix)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            new_controller = utils.ShimCollectionsController(</span><br><span class="line">                collection, <span class="literal">None</span>, legacy_controller,</span><br><span class="line">                collection_actions=collection_actions,</span><br><span class="line">                member_actions=member_actions,</span><br><span class="line">                action_status=ext_res.controller.action_status,</span><br><span class="line">                collection_methods=ext_res.collection_methods)</span><br><span class="line"></span><br><span class="line">        manager.NeutronManager.set_controller_for_resource(</span><br><span class="line">            collection_key, new_controller)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Certain policy checks require that the extensions are loaded</span></span><br><span class="line">    <span class="comment"># and the RESOURCE_ATTRIBUTE_MAP populated before they can be</span></span><br><span class="line">    <span class="comment"># properly initialized. This can only be claimed with certainty</span></span><br><span class="line">    <span class="comment"># once this point in the code has been reached. In the event</span></span><br><span class="line">    <span class="comment"># that the policies have been initialized before this point,</span></span><br><span class="line">    <span class="comment"># calling reset will cause the next policy check to</span></span><br><span class="line">    <span class="comment"># re-initialize with all of the required data in place.</span></span><br><span class="line">    policy.reset()</span><br></pre></td></tr></table></figure>
<h3 id="NeutronManager初始化"><a href="#NeutronManager初始化" class="headerlink" title="NeutronManager初始化"></a>NeutronManager初始化</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/manager.py</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@six.add_metaclass(<span class="params">profiler.TracedMeta</span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NeutronManager</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Neutron&#x27;s Manager class.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Neutron&#x27;s Manager class is responsible for parsing a config file and</span></span><br><span class="line"><span class="string">    instantiating the correct plugin that concretely implements</span></span><br><span class="line"><span class="string">    neutron_plugin_base class.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># TODO(armax): use of the singleton pattern for this class is vestigial,</span></span><br><span class="line">    <span class="comment"># and it is mainly relied on by the unit tests. It is safer to get rid</span></span><br><span class="line">    <span class="comment"># of it once the entire codebase (neutron + subprojects) has switched</span></span><br><span class="line">    <span class="comment"># entirely to using the plugins directory.</span></span><br><span class="line">    _instance = <span class="literal">None</span></span><br><span class="line">    __trace_args__ = &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;rpc&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, options=<span class="literal">None</span>, config_file=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="comment"># Store instances of already loaded plugins to avoid instantiate same</span></span><br><span class="line">        <span class="comment"># plugin more than once</span></span><br><span class="line">        self._loaded_plugins = &#123;&#125;</span><br><span class="line">        <span class="comment"># If no options have been provided, create an empty dict</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> options:</span><br><span class="line">            options = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        msg = validate_pre_plugin_load()</span><br><span class="line">        <span class="keyword">if</span> msg:</span><br><span class="line">            LOG.critical(msg)</span><br><span class="line">            <span class="keyword">raise</span> Exception(msg)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># NOTE(jkoelker) Testing for the subclass with the __subclasshook__</span></span><br><span class="line">        <span class="comment">#                breaks tach monitoring. It has been removed</span></span><br><span class="line">        <span class="comment">#                intentionally to allow v2 plugins to be monitored</span></span><br><span class="line">        <span class="comment">#                for performance metrics.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># ml2</span></span><br><span class="line">        plugin_provider = cfg.CONF.core_plugin</span><br><span class="line">        LOG.info(<span class="string">&quot;Loading core plugin: %s&quot;</span>, plugin_provider)</span><br><span class="line">        <span class="comment"># NOTE(armax): keep hold of the actual plugin object</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># CORE_PLUGINS_NAMESPACE = &#x27;neutron.core_plugins&#x27;</span></span><br><span class="line">        plugin = self._get_plugin_instance(CORE_PLUGINS_NAMESPACE,</span><br><span class="line">                                           plugin_provider)</span><br><span class="line">        directory.add_plugin(lib_const.CORE, plugin)</span><br><span class="line">        msg = validate_post_plugin_load()</span><br><span class="line">        <span class="keyword">if</span> msg:</span><br><span class="line">            LOG.critical(msg)</span><br><span class="line">            <span class="keyword">raise</span> Exception(msg)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># load services from the core plugin first</span></span><br><span class="line">        self._load_services_from_core_plugin(plugin)</span><br><span class="line">        self._load_service_plugins()</span><br><span class="line">        <span class="comment"># Used by pecan WSGI</span></span><br><span class="line">        self.resource_plugin_mappings = &#123;&#125;</span><br><span class="line">        self.resource_controller_mappings = &#123;&#125;</span><br><span class="line">        self.path_prefix_resource_mappings = defaultdict(<span class="built_in">list</span>)</span><br></pre></td></tr></table></figure>

<h4 id="ml2插件加载"><a href="#ml2插件加载" class="headerlink" title="ml2插件加载"></a>ml2插件加载</h4><p>_get_plugin_instance()方法，该方法加载neutron的核心插件ml2。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_class_for_provider</span>(<span class="params">namespace, plugin_provider</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Loads plugin using alias or class name</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param namespace: namespace where alias is defined</span></span><br><span class="line"><span class="string">        :param plugin_provider: plugin alias or class name</span></span><br><span class="line"><span class="string">        :returns: plugin that is loaded</span></span><br><span class="line"><span class="string">        :raises ImportError: if fails to load plugin</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> runtime.load_class_by_alias_or_classname(namespace,</span><br><span class="line">                                                            plugin_provider)</span><br><span class="line">        <span class="keyword">except</span> ImportError:</span><br><span class="line">            <span class="keyword">with</span> excutils.save_and_reraise_exception():</span><br><span class="line">                LOG.error(<span class="string">&quot;Plugin &#x27;%s&#x27; not found.&quot;</span>, plugin_provider)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_plugin_class</span>(<span class="params">self, namespace, plugin_provider</span>):</span><br><span class="line">        <span class="keyword">return</span> self.load_class_for_provider(namespace, plugin_provider)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_plugin_instance</span>(<span class="params">self, namespace, plugin_provider</span>):</span><br><span class="line">        plugin_class = self._get_plugin_class(namespace, plugin_provider)</span><br><span class="line">        plugin_inst = self._loaded_plugins.get(plugin_class)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> plugin_inst:</span><br><span class="line">            plugin_inst = plugin_class()</span><br><span class="line">            self._loaded_plugins[plugin_class] = plugin_inst</span><br><span class="line">        <span class="keyword">return</span> plugin_inst</span><br></pre></td></tr></table></figure>

<p>setup.cfg文件中的entry_points里定义neutron.core_plugins的实现类。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">entry_points</span>]</span><br><span class="line"><span class="string">neutron.core_plugins</span> <span class="string">=</span></span><br><span class="line">    <span class="string">ml2</span> <span class="string">=</span> <span class="string">neutron.plugins.ml2.plugin:Ml2Plugin</span></span><br></pre></td></tr></table></figure>

<p>Ml2Plugin()类。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/plugins/ml2/plugin.py</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@resource_extend.has_resource_extenders</span></span><br><span class="line"><span class="meta">@registry.has_registry_receivers</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Ml2Plugin</span>(db_base_plugin_v2.NeutronDbPluginV2,</span><br><span class="line">                dvr_mac_db.DVRDbMixin,</span><br><span class="line">                external_net_db.External_net_db_mixin,</span><br><span class="line">                sg_db_rpc.SecurityGroupServerRpcMixin,</span><br><span class="line">                agentschedulers_db.AZDhcpAgentSchedulerDbMixin,</span><br><span class="line">                addr_pair_db.AllowedAddressPairsMixin,</span><br><span class="line">                vlantransparent_db.Vlantransparent_db_mixin,</span><br><span class="line">                extradhcpopt_db.ExtraDhcpOptMixin,</span><br><span class="line">                address_scope_db.AddressScopeDbMixin,</span><br><span class="line">                subnet_service_type_mixin.SubnetServiceTypeMixin):</span><br><span class="line"></span><br><span class="line"><span class="meta">    @resource_registry.tracked_resources(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="meta">        network=models_v2.Network,</span></span></span><br><span class="line"><span class="params"><span class="meta">        port=models_v2.Port,</span></span></span><br><span class="line"><span class="params"><span class="meta">        subnet=models_v2.Subnet,</span></span></span><br><span class="line"><span class="params"><span class="meta">        subnetpool=models_v2.SubnetPool,</span></span></span><br><span class="line"><span class="params"><span class="meta">        security_group=sg_models.SecurityGroup,</span></span></span><br><span class="line"><span class="params"><span class="meta">        security_group_rule=sg_models.SecurityGroupRule</span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># First load drivers, then initialize DB, then initialize drivers</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># TypeManager初始化</span></span><br><span class="line">        self.type_manager = managers.TypeManager()</span><br><span class="line">        <span class="comment"># ExtensionManager初始化</span></span><br><span class="line">        self.extension_manager = managers.ExtensionManager()</span><br><span class="line">        <span class="comment"># MechanismManager初始化</span></span><br><span class="line">        self.mechanism_manager = managers.MechanismManager()</span><br><span class="line"></span><br><span class="line">        NeutronDbPluginV2初始化</span><br><span class="line">        <span class="built_in">super</span>(Ml2Plugin, self).__init__()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># type_driver初始化</span></span><br><span class="line">        self.type_manager.initialize()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># extension_driver初始化</span></span><br><span class="line">        self.extension_manager.initialize()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># mechanism_driver初始化</span></span><br><span class="line">        self.mechanism_manager.initialize()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># DHCP组件初始化</span></span><br><span class="line">        self._setup_dhcp()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># rpc_notifier初始化</span></span><br><span class="line">        self._start_rpc_notifiers()</span><br><span class="line">        self.add_agent_status_check_worker(self.agent_health_check)</span><br><span class="line">        self.add_workers(self.mechanism_manager.get_workers())</span><br><span class="line">        self._verify_service_plugins_requirements()</span><br><span class="line">        LOG.info(<span class="string">&quot;Modular L2 Plugin initialization complete&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="TypeManager初始化"><a href="#TypeManager初始化" class="headerlink" title="TypeManager初始化"></a>TypeManager初始化</h5><p>TypeManager类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/plugins/ml2/managers.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TypeManager</span>(stevedore.named.NamedExtensionManager):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Manage network segment types using drivers.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># Mapping from type name to DriverManager</span></span><br><span class="line">        self.drivers = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        LOG.info(<span class="string">&quot;Configured type driver names: %s&quot;</span>,</span><br><span class="line">                 cfg.CONF.ml2.type_drivers)</span><br><span class="line">        <span class="built_in">super</span>(TypeManager, self).__init__(<span class="string">&#x27;neutron.ml2.type_drivers&#x27;</span>,</span><br><span class="line">                                          cfg.CONF.ml2.type_drivers,</span><br><span class="line">                                          invoke_on_load=<span class="literal">True</span>)</span><br><span class="line">        LOG.info(<span class="string">&quot;Loaded type driver names: %s&quot;</span>, self.names())</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 注册type_driver</span></span><br><span class="line">        self._register_types()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># tenant_network_type和external_network_type</span></span><br><span class="line">        <span class="comment"># 必须是conf.ml2.type_drivers中定义的</span></span><br><span class="line">        <span class="comment"># 检查tenant_network_types</span></span><br><span class="line">        self._check_tenant_network_types(cfg.CONF.ml2.tenant_network_types)</span><br><span class="line">        <span class="comment"># 检查external_network_type，默认为空</span></span><br><span class="line">        self._check_external_network_type(cfg.CONF.ml2.external_network_type)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_register_types</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">for</span> ext <span class="keyword">in</span> self:</span><br><span class="line"></span><br><span class="line">            <span class="comment"># type_driver对应实现类的get_type()</span></span><br><span class="line">            <span class="comment"># 例如：vxlan的实现类是neutron.plugins.ml2.drivers.type_vxlan:VxlanTypeDriver</span></span><br><span class="line">            <span class="comment"># VxlanTypeDriver中的get_type()方法返回的是vxlan。</span></span><br><span class="line">            network_type = ext.obj.get_type()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> network_type <span class="keyword">in</span> self.drivers:</span><br><span class="line">                LOG.error(<span class="string">&quot;Type driver &#x27;%(new_driver)s&#x27; ignored because&quot;</span></span><br><span class="line">                          <span class="string">&quot; type driver &#x27;%(old_driver)s&#x27; is already&quot;</span></span><br><span class="line">                          <span class="string">&quot; registered for type &#x27;%(type)s&#x27;&quot;</span>,</span><br><span class="line">                          &#123;<span class="string">&#x27;new_driver&#x27;</span>: ext.name,</span><br><span class="line">                           <span class="string">&#x27;old_driver&#x27;</span>: self.drivers[network_type].name,</span><br><span class="line">                           <span class="string">&#x27;type&#x27;</span>: network_type&#125;)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.drivers[network_type] = ext</span><br><span class="line">        LOG.info(<span class="string">&quot;Registered types: %s&quot;</span>, self.drivers.keys())</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_check_tenant_network_types</span>(<span class="params">self, types</span>):</span><br><span class="line">        self.tenant_network_types = []</span><br><span class="line">        <span class="keyword">for</span> network_type <span class="keyword">in</span> types:</span><br><span class="line">            <span class="keyword">if</span> network_type <span class="keyword">in</span> self.drivers:</span><br><span class="line">                self.tenant_network_types.append(network_type)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                LOG.error(<span class="string">&quot;No type driver for tenant network_type: %s. &quot;</span></span><br><span class="line">                          <span class="string">&quot;Service terminated!&quot;</span>, network_type)</span><br><span class="line">                <span class="keyword">raise</span> SystemExit(<span class="number">1</span>)</span><br><span class="line">        LOG.info(<span class="string">&quot;Tenant network_types: %s&quot;</span>, self.tenant_network_types)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_check_external_network_type</span>(<span class="params">self, ext_network_type</span>):</span><br><span class="line">        <span class="keyword">if</span> ext_network_type <span class="keyword">and</span> ext_network_type <span class="keyword">not</span> <span class="keyword">in</span> self.drivers:</span><br><span class="line">            LOG.error(<span class="string">&quot;No type driver for external network_type: %s. &quot;</span></span><br><span class="line">                      <span class="string">&quot;Service terminated!&quot;</span>, ext_network_type)</span><br><span class="line">            <span class="keyword">raise</span> SystemExit(<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">initialize</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">for</span> network_type, driver <span class="keyword">in</span> self.drivers.items():</span><br><span class="line">            LOG.info(<span class="string">&quot;Initializing driver for type &#x27;%s&#x27;&quot;</span>, network_type)</span><br><span class="line">            <span class="comment"># 初识化每一个type_driver</span></span><br><span class="line">            driver.obj.initialize()</span><br></pre></td></tr></table></figure>

<p>type_drivers插件的初始化方法，在setup.cfg文件中的entry_points里面定义。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">entrypoint</span>]</span><br><span class="line"><span class="string">neutron.ml2.type_drivers</span> <span class="string">=</span></span><br><span class="line">    <span class="string">flat</span> <span class="string">=</span> <span class="string">neutron.plugins.ml2.drivers.type_flat:FlatTypeDriver</span></span><br><span class="line">    <span class="string">local</span> <span class="string">=</span> <span class="string">neutron.plugins.ml2.drivers.type_local:LocalTypeDriver</span></span><br><span class="line">    <span class="string">vlan</span> <span class="string">=</span> <span class="string">neutron.plugins.ml2.drivers.type_vlan:VlanTypeDriver</span></span><br><span class="line">    <span class="string">geneve</span> <span class="string">=</span> <span class="string">neutron.plugins.ml2.drivers.type_geneve:GeneveTypeDriver</span></span><br><span class="line">    <span class="string">gre</span> <span class="string">=</span> <span class="string">neutron.plugins.ml2.drivers.type_gre:GreTypeDriver</span></span><br><span class="line">    <span class="string">vxlan</span> <span class="string">=</span> <span class="string">neutron.plugins.ml2.drivers.type_vxlan:VxlanTypeDriver</span></span><br></pre></td></tr></table></figure>

<h5 id="ExtensionManager初始化"><a href="#ExtensionManager初始化" class="headerlink" title="ExtensionManager初始化"></a>ExtensionManager初始化</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/plugins/ml2/managers.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ExtensionManager</span>(stevedore.named.NamedExtensionManager):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Manage extension drivers using drivers.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># Ordered list of extension drivers, defining</span></span><br><span class="line">        <span class="comment"># the order in which the drivers are called.</span></span><br><span class="line">        self.ordered_ext_drivers = []</span><br><span class="line"></span><br><span class="line">        LOG.info(<span class="string">&quot;Configured extension driver names: %s&quot;</span>,</span><br><span class="line">                 cfg.CONF.ml2.extension_drivers)</span><br><span class="line">        <span class="built_in">super</span>(ExtensionManager, self).__init__(<span class="string">&#x27;neutron.ml2.extension_drivers&#x27;</span>,</span><br><span class="line">                                               cfg.CONF.ml2.extension_drivers,</span><br><span class="line">                                               invoke_on_load=<span class="literal">True</span>,</span><br><span class="line">                                               name_order=<span class="literal">True</span>)</span><br><span class="line">        LOG.info(<span class="string">&quot;Loaded extension driver names: %s&quot;</span>, self.names())</span><br><span class="line">        self._register_drivers()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_register_drivers</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Register all extension drivers.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        This method should only be called once in the ExtensionManager</span></span><br><span class="line"><span class="string">        constructor.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> ext <span class="keyword">in</span> self:</span><br><span class="line">            self.ordered_ext_drivers.append(ext)</span><br><span class="line">        LOG.info(<span class="string">&quot;Registered extension drivers: %s&quot;</span>,</span><br><span class="line">                 [driver.name <span class="keyword">for</span> driver <span class="keyword">in</span> self.ordered_ext_drivers])</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">initialize</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># Initialize each driver in the list.</span></span><br><span class="line">        <span class="keyword">for</span> driver <span class="keyword">in</span> self.ordered_ext_drivers:</span><br><span class="line">            LOG.info(<span class="string">&quot;Initializing extension driver &#x27;%s&#x27;&quot;</span>, driver.name)</span><br><span class="line">            driver.obj.initialize()</span><br></pre></td></tr></table></figure>

<p>extension_driver的初始化方法定义在setup.cfg文件中的entry_points里面。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">neutron.ml2.extension_drivers</span> <span class="string">=</span></span><br><span class="line">    <span class="string">test</span> <span class="string">=</span> <span class="string">neutron.tests.unit.plugins.ml2.drivers.ext_test:TestExtensionDriver</span></span><br><span class="line">    <span class="string">testdb</span> <span class="string">=</span> <span class="string">neutron.tests.unit.plugins.ml2.drivers.ext_test:TestDBExtensionDriver</span></span><br><span class="line">    <span class="string">port_security</span> <span class="string">=</span> <span class="string">neutron.plugins.ml2.extensions.port_security:PortSecurityExtensionDriver</span></span><br><span class="line">    <span class="string">qos</span> <span class="string">=</span> <span class="string">neutron.plugins.ml2.extensions.qos:QosExtensionDriver</span></span><br><span class="line">    <span class="string">dns</span> <span class="string">=</span> <span class="string">neutron.plugins.ml2.extensions.dns_integration:DNSExtensionDriverML2</span></span><br><span class="line">    <span class="string">data_plane_status</span> <span class="string">=</span> <span class="string">neutron.plugins.ml2.extensions.data_plane_status:DataPlaneStatusExtensionDriver</span></span><br><span class="line">    <span class="string">dns_domain_ports</span> <span class="string">=</span> <span class="string">neutron.plugins.ml2.extensions.dns_integration:DNSDomainPortsExtensionDriver</span></span><br></pre></td></tr></table></figure>

<h5 id="MechanismManager初始化"><a href="#MechanismManager初始化" class="headerlink" title="MechanismManager初始化"></a>MechanismManager初始化</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/plugins/ml2/managers.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MechanismManager</span>(stevedore.named.NamedExtensionManager):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Manage networking mechanisms using drivers.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># Registered mechanism drivers, keyed by name.</span></span><br><span class="line">        self.mech_drivers = &#123;&#125;</span><br><span class="line">        <span class="comment"># Ordered list of mechanism drivers, defining</span></span><br><span class="line">        <span class="comment"># the order in which the drivers are called.</span></span><br><span class="line">        self.ordered_mech_drivers = []</span><br><span class="line"></span><br><span class="line">        LOG.info(<span class="string">&quot;Configured mechanism driver names: %s&quot;</span>,</span><br><span class="line">                 cfg.CONF.ml2.mechanism_drivers)</span><br><span class="line">        <span class="built_in">super</span>(MechanismManager, self).__init__(</span><br><span class="line">            <span class="string">&#x27;neutron.ml2.mechanism_drivers&#x27;</span>,</span><br><span class="line">            cfg.CONF.ml2.mechanism_drivers,</span><br><span class="line">            invoke_on_load=<span class="literal">True</span>,</span><br><span class="line">            name_order=<span class="literal">True</span>,</span><br><span class="line">            on_missing_entrypoints_callback=self._driver_not_found,</span><br><span class="line">            on_load_failure_callback=self._driver_not_loaded</span><br><span class="line">        )</span><br><span class="line">        LOG.info(<span class="string">&quot;Loaded mechanism driver names: %s&quot;</span>, self.names())</span><br><span class="line">        self._register_mechanisms()</span><br><span class="line">        self.host_filtering_supported = self.is_host_filtering_supported()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.host_filtering_supported:</span><br><span class="line">            LOG.info(<span class="string">&quot;No mechanism drivers provide segment reachability &quot;</span></span><br><span class="line">                     <span class="string">&quot;information for agent scheduling.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_driver_not_found</span>(<span class="params">self, names</span>):</span><br><span class="line">        msg = (_(<span class="string">&quot;The following mechanism drivers were not found: %s&quot;</span>)</span><br><span class="line">               % names)</span><br><span class="line">        LOG.critical(msg)</span><br><span class="line">        <span class="keyword">raise</span> SystemExit(msg)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_driver_not_loaded</span>(<span class="params">self, manager, entrypoint, exception</span>):</span><br><span class="line">        LOG.critical(<span class="string">&quot;The &#x27;%(entrypoint)s&#x27; entrypoint could not be&quot;</span></span><br><span class="line">                     <span class="string">&quot; loaded for the following reason: &#x27;%(reason)s&#x27;.&quot;</span>,</span><br><span class="line">                     &#123;<span class="string">&#x27;entrypoint&#x27;</span>: entrypoint,</span><br><span class="line">                      <span class="string">&#x27;reason&#x27;</span>: exception&#125;)</span><br><span class="line">        <span class="keyword">raise</span> SystemExit(<span class="built_in">str</span>(exception))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_register_mechanisms</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Register all mechanism drivers.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        This method should only be called once in the MechanismManager</span></span><br><span class="line"><span class="string">        constructor.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> ext <span class="keyword">in</span> self:</span><br><span class="line">            self.mech_drivers[ext.name] = ext</span><br><span class="line">            self.ordered_mech_drivers.append(ext)</span><br><span class="line">        LOG.info(<span class="string">&quot;Registered mechanism drivers: %s&quot;</span>,</span><br><span class="line">                 [driver.name <span class="keyword">for</span> driver <span class="keyword">in</span> self.ordered_mech_drivers])</span><br></pre></td></tr></table></figure>

<p>mechanism_driver的初始化方法定义在setup.cfg文件中的entry_points里。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">neutron.ml2.mechanism_drivers</span> <span class="string">=</span></span><br><span class="line">    <span class="string">logger</span> <span class="string">=</span> <span class="string">neutron.tests.unit.plugins.ml2.drivers.mechanism_logger:LoggerMechanismDriver</span></span><br><span class="line">    <span class="string">test</span> <span class="string">=</span> <span class="string">neutron.tests.unit.plugins.ml2.drivers.mechanism_test:TestMechanismDriver</span></span><br><span class="line">    <span class="string">linuxbridge</span> <span class="string">=</span> <span class="string">neutron.plugins.ml2.drivers.linuxbridge.mech_driver.mech_linuxbridge:LinuxbridgeMechanismDriver</span></span><br><span class="line">    <span class="string">macvtap</span> <span class="string">=</span> <span class="string">neutron.plugins.ml2.drivers.macvtap.mech_driver.mech_macvtap:MacvtapMechanismDriver</span></span><br><span class="line">    <span class="string">openvswitch</span> <span class="string">=</span> <span class="string">neutron.plugins.ml2.drivers.openvswitch.mech_driver.mech_openvswitch:OpenvswitchMechanismDriver</span></span><br><span class="line">    <span class="string">l2population</span> <span class="string">=</span> <span class="string">neutron.plugins.ml2.drivers.l2pop.mech_driver:L2populationMechanismDriver</span></span><br><span class="line">    <span class="string">sriovnicswitch</span> <span class="string">=</span> <span class="string">neutron.plugins.ml2.drivers.mech_sriov.mech_driver.mech_driver:SriovNicSwitchMechanismDriver</span></span><br><span class="line">    <span class="string">fake_agent</span> <span class="string">=</span> <span class="string">neutron.tests.unit.plugins.ml2.drivers.mech_fake_agent:FakeAgentMechanismDriver</span></span><br><span class="line">    <span class="string">faulty_agent</span> <span class="string">=</span> <span class="string">neutron.tests.unit.plugins.ml2.drivers.mech_faulty_agent:FaultyAgentMechanismDriver</span></span><br></pre></td></tr></table></figure>

<h5 id="NeutronDbPluginV2初始化"><a href="#NeutronDbPluginV2初始化" class="headerlink" title="NeutronDbPluginV2初始化"></a>NeutronDbPluginV2初始化</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/db/db_base_plugin_v2.py</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@registry.has_registry_receivers</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NeutronDbPluginV2</span>(db_base_plugin_common.DbBasePluginCommon,</span><br><span class="line">                        neutron_plugin_base_v2.NeutronPluginBaseV2,</span><br><span class="line">                        rbac_mixin.RbacPluginMixin,</span><br><span class="line">                        stattr_db.StandardAttrDescriptionMixin):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;V2 Neutron plugin interface implementation using SQLAlchemy models.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Whenever a non-read call happens the plugin will call an event handler</span></span><br><span class="line"><span class="string">    class method (e.g., network_created()).  The result is that this class</span></span><br><span class="line"><span class="string">    can be sub-classed by other classes that add custom behaviors on certain</span></span><br><span class="line"><span class="string">    events.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># This attribute specifies whether the plugin supports or not</span></span><br><span class="line">    <span class="comment"># bulk/pagination/sorting operations. Name mangling is used in</span></span><br><span class="line">    <span class="comment"># order to ensure it is qualified by class</span></span><br><span class="line">    __native_bulk_support = <span class="literal">True</span></span><br><span class="line">    __native_pagination_support = <span class="literal">True</span></span><br><span class="line">    __native_sorting_support = <span class="literal">True</span></span><br><span class="line">    <span class="comment"># This attribute specifies whether the plugin supports or not</span></span><br><span class="line">    <span class="comment"># filter validations. Name mangling is used in</span></span><br><span class="line">    <span class="comment"># order to ensure it is qualified by class</span></span><br><span class="line">    __filter_validation_support = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">has_native_datastore</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__new__</span>(<span class="params">cls, *args, **kwargs</span>):</span><br><span class="line">        model_query.register_hook(</span><br><span class="line">            models_v2.Port,</span><br><span class="line">            <span class="string">&quot;port&quot;</span>,</span><br><span class="line">            query_hook=<span class="literal">None</span>,</span><br><span class="line">            filter_hook=_port_filter_hook,</span><br><span class="line">            result_filters=<span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>(NeutronDbPluginV2, cls).__new__(cls, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 设置IP管理后端</span></span><br><span class="line">        self.set_ipam_backend()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># notify_nova_on_port_status_changes默认为True</span></span><br><span class="line">        <span class="comment"># 在port状态更新时是否给Nova发送通知</span></span><br><span class="line">        <span class="keyword">if</span> cfg.CONF.notify_nova_on_port_status_changes:</span><br><span class="line">            <span class="comment"># Import nova conditionally to support the use case of Neutron</span></span><br><span class="line">            <span class="comment"># being used outside of an OpenStack context.</span></span><br><span class="line">            <span class="keyword">from</span> neutron.notifiers <span class="keyword">import</span> nova</span><br><span class="line">            <span class="comment"># NOTE(arosen) These event listeners are here to hook into when</span></span><br><span class="line">            <span class="comment"># port status changes and notify nova about their change.</span></span><br><span class="line">            self.nova_notifier = nova.Notifier.get_instance()</span><br><span class="line">            lib_db_api.sqla_listen(models_v2.Port, <span class="string">&#x27;after_insert&#x27;</span>,</span><br><span class="line">                                   self.nova_notifier.send_port_status)</span><br><span class="line">            lib_db_api.sqla_listen(models_v2.Port, <span class="string">&#x27;after_update&#x27;</span>,</span><br><span class="line">                                   self.nova_notifier.send_port_status)</span><br><span class="line">            lib_db_api.sqla_listen(</span><br><span class="line">                models_v2.Port.status, <span class="string">&#x27;set&#x27;</span>,</span><br><span class="line">                self.nova_notifier.record_port_status_changed)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="Dirver初始化"><a href="#Dirver初始化" class="headerlink" title="Dirver初始化"></a>Dirver初始化</h5><h6 id="Type-Driver初始化"><a href="#Type-Driver初始化" class="headerlink" title="Type_Driver初始化"></a>Type_Driver初始化</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/plugins/ml2/managers.py</span></span><br><span class="line"><span class="comment"># TypeManager</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">initialize</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">for</span> network_type, driver <span class="keyword">in</span> self.drivers.items():</span><br><span class="line">            LOG.info(<span class="string">&quot;Initializing driver for type &#x27;%s&#x27;&quot;</span>, network_type)</span><br><span class="line">            driver.obj.initialize()</span><br></pre></td></tr></table></figure>
<p>例如type_driver vxlan的初始化。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/plugins/ml2/drivers/type_vxlan.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VxlanTypeDriver</span>(type_tunnel.EndpointTunnelTypeDriver):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(VxlanTypeDriver, self).__init__(</span><br><span class="line">            vxlan_obj.VxlanAllocation, vxlan_obj.VxlanEndpoint)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_type</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> p_const.TYPE_VXLAN</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">initialize</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 初始化vxlan的vni范围</span></span><br><span class="line">            self._initialize(cfg.CONF.ml2_type_vxlan.vni_ranges)</span><br><span class="line">        <span class="keyword">except</span> n_exc.NetworkTunnelRangeError:</span><br><span class="line">            LOG.exception(<span class="string">&quot;Failed to parse vni_ranges. &quot;</span></span><br><span class="line">                          <span class="string">&quot;Service terminated!&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span> SystemExit()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="Extension-Driver初始化"><a href="#Extension-Driver初始化" class="headerlink" title="Extension_Driver初始化"></a>Extension_Driver初始化</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/plugins/ml2/managers.py</span></span><br><span class="line"><span class="comment"># ExtensionManager</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">initialize</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># Initialize each driver in the list.</span></span><br><span class="line">        <span class="keyword">for</span> driver <span class="keyword">in</span> self.ordered_ext_drivers:</span><br><span class="line">            LOG.info(<span class="string">&quot;Initializing extension driver &#x27;%s&#x27;&quot;</span>, driver.name)</span><br><span class="line">            driver.obj.initialize()</span><br></pre></td></tr></table></figure>
<p>例如extension_driver qos的初始化。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/plugins/ml2/extensions/qos.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">QosExtensionDriver</span>(api.ExtensionDriver):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">initialize</span>(<span class="params">self</span>):</span><br><span class="line">        self.core_ext_handler = qos_core.QosCoreResourceExtension()</span><br><span class="line">        LOG.debug(<span class="string">&quot;QosExtensionDriver initialization complete&quot;</span>)</span><br></pre></td></tr></table></figure>

<h6 id="Mechanism-Driver初始化"><a href="#Mechanism-Driver初始化" class="headerlink" title="Mechanism_Driver初始化"></a>Mechanism_Driver初始化</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/plugins/ml2/managers.py</span></span><br><span class="line"><span class="comment"># MechanismManager</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">initialize</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">for</span> driver <span class="keyword">in</span> self.ordered_mech_drivers:</span><br><span class="line">            LOG.info(<span class="string">&quot;Initializing mechanism driver &#x27;%s&#x27;&quot;</span>, driver.name)</span><br><span class="line">            driver.obj.initialize()</span><br></pre></td></tr></table></figure>

<h5 id="DHCP组件初始化"><a href="#DHCP组件初始化" class="headerlink" title="DHCP组件初始化"></a>DHCP组件初始化</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/plugins/ml2/plugin.py</span></span><br><span class="line"><span class="comment"># Ml2Plugin</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_setup_dhcp</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Initialize components to support DHCP.&quot;&quot;&quot;</span></span><br><span class="line">        self.network_scheduler = importutils.import_object(</span><br><span class="line">            <span class="comment"># 默认是neutron.scheduler.dhcp_agent_scheduler.WeightScheduler</span></span><br><span class="line">            cfg.CONF.network_scheduler_driver</span><br><span class="line">        )</span><br><span class="line">        self.add_periodic_dhcp_agent_status_check()</span><br></pre></td></tr></table></figure>
<p>查看WeightScheduler。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/scheduler/dhcp_agent_scheduler.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WeightScheduler</span>(base_scheduler.BaseWeightScheduler, AutoScheduler):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(WeightScheduler, self).__init__(DhcpFilter())</span><br></pre></td></tr></table></figure>

<p>查看WeightScheduler的基类BaseWeightScheduler。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/scheduler/base_scheduler.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BaseWeightScheduler</span>(<span class="title class_ inherited__">BaseScheduler</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Choose agents based on load.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, resource_filter</span>):</span><br><span class="line">        self.resource_filter = resource_filter</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">select</span>(<span class="params">self, plugin, context, resource_hostable_agents,</span></span><br><span class="line"><span class="params">               resource_hosted_agents, num_agents_needed</span>):</span><br><span class="line">        chosen_agents = <span class="built_in">sorted</span>(resource_hostable_agents,</span><br><span class="line">                           key=attrgetter(<span class="string">&#x27;load&#x27;</span>))[<span class="number">0</span>:num_agents_needed]</span><br><span class="line">        <span class="keyword">return</span> chosen_agents</span><br></pre></td></tr></table></figure>

<p>查看add_periodic_dhcp_agent_status_check()方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/db/agentschedulers_db.py</span></span><br><span class="line"><span class="comment"># DhcpAgentSchedulerDbMixin</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_periodic_dhcp_agent_status_check</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># allow_automatic_dhcp_failover默认为True</span></span><br><span class="line">        <span class="comment"># 当Agent离线时，是否自动将网络移除</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> cfg.CONF.allow_automatic_dhcp_failover:</span><br><span class="line">            LOG.info(<span class="string">&quot;Skipping periodic DHCP agent status check because &quot;</span></span><br><span class="line">                     <span class="string">&quot;automatic network rescheduling is disabled.&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        self.add_agent_status_check_worker(</span><br><span class="line">            self.remove_networks_from_down_agents</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_agent_status_check_worker</span>(<span class="params">self, function</span>):</span><br><span class="line">        <span class="comment"># TODO(enikanorov): make interval configurable rather than computed</span></span><br><span class="line">        <span class="comment"># agent_down_time默认是75秒</span></span><br><span class="line">        interval = <span class="built_in">max</span>(cfg.CONF.agent_down_time // <span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># add random initial delay to allow agents to check in after the</span></span><br><span class="line">        <span class="comment"># neutron server first starts. random to offset multiple servers</span></span><br><span class="line">        initial_delay = random.randint(interval, interval * <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        check_worker = neutron_worker.PeriodicWorker(function, interval,</span><br><span class="line">                                                     initial_delay)</span><br><span class="line">        self.add_worker(check_worker)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">remove_networks_from_down_agents</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Remove networks from down DHCP agents if admin state is up.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Reschedule them if configured so.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        agent_dead_limit = self.agent_dead_limit_seconds()</span><br><span class="line">        self.wait_down_agents(<span class="string">&#x27;DHCP&#x27;</span>, agent_dead_limit)</span><br><span class="line">        cutoff = self.get_cutoff_time(agent_dead_limit)</span><br><span class="line"></span><br><span class="line">        context = ncontext.get_admin_context()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            down_bindings = network.NetworkDhcpAgentBinding.get_down_bindings(</span><br><span class="line">                context, cutoff)</span><br><span class="line">            dhcp_notifier = self.agent_notifiers.get(constants.AGENT_TYPE_DHCP)</span><br><span class="line">            dead_bindings = [b <span class="keyword">for</span> b <span class="keyword">in</span></span><br><span class="line">                             self._filter_bindings(context, down_bindings)]</span><br><span class="line">            agents = self.get_agent_objects(</span><br><span class="line">                context, &#123;<span class="string">&#x27;agent_type&#x27;</span>: [constants.AGENT_TYPE_DHCP]&#125;)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> agents:</span><br><span class="line">                <span class="comment"># No agents configured so nothing to do.</span></span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            active_agents = [agent <span class="keyword">for</span> agent <span class="keyword">in</span> agents <span class="keyword">if</span></span><br><span class="line">                             self.is_eligible_agent(context, <span class="literal">True</span>, agent)]</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> active_agents:</span><br><span class="line">                LOG.warning(<span class="string">&quot;No DHCP agents available, &quot;</span></span><br><span class="line">                            <span class="string">&quot;skipping rescheduling&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">for</span> binding <span class="keyword">in</span> dead_bindings:</span><br><span class="line">                LOG.warning(<span class="string">&quot;Removing network %(network)s from agent &quot;</span></span><br><span class="line">                            <span class="string">&quot;%(agent)s because the agent did not report &quot;</span></span><br><span class="line">                            <span class="string">&quot;to the server in the last %(dead_time)s &quot;</span></span><br><span class="line">                            <span class="string">&quot;seconds.&quot;</span>,</span><br><span class="line">                            &#123;<span class="string">&#x27;network&#x27;</span>: binding.network_id,</span><br><span class="line">                             <span class="string">&#x27;agent&#x27;</span>: binding.dhcp_agent_id,</span><br><span class="line">                             <span class="string">&#x27;dead_time&#x27;</span>: agent_dead_limit&#125;)</span><br><span class="line">                <span class="comment"># save binding object to avoid ObjectDeletedError</span></span><br><span class="line">                <span class="comment"># in case binding is concurrently deleted from the DB</span></span><br><span class="line">                saved_binding = &#123;<span class="string">&#x27;net&#x27;</span>: binding.network_id,</span><br><span class="line">                                 <span class="string">&#x27;agent&#x27;</span>: binding.dhcp_agent_id&#125;</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="comment"># do not notify agent if it considered dead</span></span><br><span class="line">                    <span class="comment"># so when it is restarted it won&#x27;t see network delete</span></span><br><span class="line">                    <span class="comment"># notifications on its queue</span></span><br><span class="line">                    self.remove_network_from_dhcp_agent(context,</span><br><span class="line">                                                        binding.dhcp_agent_id,</span><br><span class="line">                                                        binding.network_id,</span><br><span class="line">                                                        notify=<span class="literal">False</span>)</span><br><span class="line">                <span class="keyword">except</span> das_exc.NetworkNotHostedByDhcpAgent:</span><br><span class="line">                    <span class="comment"># measures against concurrent operation</span></span><br><span class="line">                    LOG.debug(<span class="string">&quot;Network %(net)s already removed from DHCP &quot;</span></span><br><span class="line">                              <span class="string">&quot;agent %(agent)s&quot;</span>,</span><br><span class="line">                              saved_binding)</span><br><span class="line">                    <span class="comment"># still continue and allow concurrent scheduling attempt</span></span><br><span class="line">                <span class="keyword">except</span> Exception:</span><br><span class="line">                    LOG.exception(<span class="string">&quot;Unexpected exception occurred while &quot;</span></span><br><span class="line">                                  <span class="string">&quot;removing network %(net)s from agent &quot;</span></span><br><span class="line">                                  <span class="string">&quot;%(agent)s&quot;</span>,</span><br><span class="line">                                  saved_binding)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> cfg.CONF.network_auto_schedule:</span><br><span class="line">                    self._schedule_network(</span><br><span class="line">                        context, saved_binding[<span class="string">&#x27;net&#x27;</span>], dhcp_notifier)</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            <span class="comment"># we want to be thorough and catch whatever is raised</span></span><br><span class="line">            <span class="comment"># to avoid loop abortion</span></span><br><span class="line">            LOG.exception(<span class="string">&quot;Exception encountered during network &quot;</span></span><br><span class="line">                          <span class="string">&quot;rescheduling&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="RPC-Notifier初始化"><a href="#RPC-Notifier初始化" class="headerlink" title="RPC_Notifier初始化"></a>RPC_Notifier初始化</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/plugins/ml2/plugin.py</span></span><br><span class="line"><span class="comment"># Ml2Plugin</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @log_helpers.log_method_call</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_start_rpc_notifiers</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Initialize RPC notifiers for agents.&quot;&quot;&quot;</span></span><br><span class="line">        self.ovo_notifier = ovo_rpc.OVOServerRpcInterface()</span><br><span class="line">        self.notifier = rpc.AgentNotifierApi(topics.AGENT)</span><br><span class="line">        self.agent_notifiers[const.AGENT_TYPE_DHCP] = (</span><br><span class="line">            dhcp_rpc_agent_api.DhcpAgentNotifyAPI()</span><br><span class="line">        )</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/plugins/ml2/ovo_rpc.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OVOServerRpcInterface</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ML2 server-side RPC interface.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Generates RPC callback notifications on ML2 object changes.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self._rpc_pusher = resources_rpc.ResourcesPushRpcApi()</span><br><span class="line">        self._setup_change_handlers()</span><br><span class="line">        LOG.debug(<span class="string">&quot;ML2 OVO RPC backend initialized.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_setup_change_handlers</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Setup all of the local callback listeners for resource changes.&quot;&quot;&quot;</span></span><br><span class="line">        resource_objclass_map = &#123;</span><br><span class="line">            resources.PORT: ports.Port,</span><br><span class="line">            resources.SUBNET: subnet.Subnet,</span><br><span class="line">            resources.NETWORK: network.Network,</span><br><span class="line">            resources.SECURITY_GROUP: securitygroup.SecurityGroup,</span><br><span class="line">            resources.SECURITY_GROUP_RULE: securitygroup.SecurityGroupRule,</span><br><span class="line">        &#125;</span><br><span class="line">        self._resource_handlers = &#123;</span><br><span class="line">            res: _ObjectChangeHandler(res, obj_class, self._rpc_pusher)</span><br><span class="line">            <span class="keyword">for</span> res, obj_class <span class="keyword">in</span> resource_objclass_map.items()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/api/rpc/handlers/resources_rpc.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ResourcesPushRpcApi</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Plugin-side RPC for plugin-to-agents interaction.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    This interface is designed to push versioned object updates to interested</span></span><br><span class="line"><span class="string">    agents using fanout topics.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    This class implements the caller side of an rpc interface.  The receiver</span></span><br><span class="line"><span class="string">    side can be found below: ResourcesPushRpcCallback.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        target = oslo_messaging.Target(</span><br><span class="line">            namespace=constants.RPC_NAMESPACE_RESOURCES)</span><br><span class="line">        self.client = n_rpc.get_client(target)</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://docs.openstack.org/neutron-lib/latest/contributor/callbacks.html">Neutron Callback System</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/plugins/ml2/ovo_rpc.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">_ObjectChangeHandler</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, resource, object_class, resource_push_api</span>):</span><br><span class="line">        self._resource = resource</span><br><span class="line">        self._obj_class = object_class</span><br><span class="line">        self._resource_push_api = resource_push_api</span><br><span class="line">        self._resources_to_push = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># NOTE(annp): uWSGI seems not happy with eventlet.GreenPool.</span></span><br><span class="line">        <span class="comment"># So switching to ThreadPool</span></span><br><span class="line">        self._worker_pool = futurist.ThreadPoolExecutor()</span><br><span class="line">        self.fts = []</span><br><span class="line"></span><br><span class="line">        self._semantic_warned = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">for</span> event <span class="keyword">in</span> (events.AFTER_CREATE, events.AFTER_UPDATE,</span><br><span class="line">                      events.AFTER_DELETE):</span><br><span class="line">            registry.subscribe(self.handle_event, resource, event)</span><br></pre></td></tr></table></figure>
            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-none-link" href="/tags/Neutron/" rel="tag">Neutron</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2019/10/17/Neutron-Metering-Agent%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"
                    data-tooltip="Neutron-Metering-Agent源码分析"
                    aria-label="PREVIOUS: Neutron-Metering-Agent源码分析"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2019/09/27/OpenStack-Senlin%E8%87%AA%E5%8A%A8%E4%BC%B8%E7%BC%A9/"
                    data-tooltip="OpenStack Senlin自动伸缩"
                    aria-label="NEXT: OpenStack Senlin自动伸缩"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="http://service.weibo.com/share/share.php?&amp;title=https://wangkuntian.github.io/2019/10/14/Neutron-Server%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"
                    title="Share on Weibo"
                    aria-label="Share on Weibo"
                >
                    <i class="fab fa-weibo" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=https://wangkuntian.github.io/2019/10/14/Neutron-Server%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/&amp;title=Neutron-Server源码分析"
                    title="Share on QQ"
                    aria-label="Share on QQ"
                >
                    <i class="fab fa-qq" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://wangkuntian.github.io/2019/10/14/Neutron-Server%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"
                    title="Share on Qzone"
                    aria-label="Share on Qzone"
                >
                    <i class="fa fa-star" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#table-of-contents" aria-label="目录">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
        
    </div>
</article>

<div class="main-content-wrap">
    
        
            <script src="//cdn.jsdelivr.net/npm/@waline/client"></script>
阅读量：<span id="2019/10/14/Neutron-Server源码分析/" class="waline-visitor-count"></span>
<div id="vcomments"></div>
<script>
    new Waline({
        el: "#vcomments",
        serverURL: "https://blog-api-nu-nine.vercel.app/",
        lang: "zh-cn",
        visitor: true,
        emoji: [
            "https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/bilibili",
            "https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/qq",
        ],
        placeholder: "ヾﾉ≧∀≦)o来啊，快活啊!",
        dark: "auto",
        meta: ["nick", "mail", "link"],
        requiredMeta: [],
        wordLimit: "200",
        pageSize: "10",
        highlight: "hanabi",
        copyright: true,
        avatar: "wavatar",
    });
</script>
  
        
    
</div>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2024 Wang kuntian. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2019/10/17/Neutron-Metering-Agent%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"
                    data-tooltip="Neutron-Metering-Agent源码分析"
                    aria-label="PREVIOUS: Neutron-Metering-Agent源码分析"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2019/09/27/OpenStack-Senlin%E8%87%AA%E5%8A%A8%E4%BC%B8%E7%BC%A9/"
                    data-tooltip="OpenStack Senlin自动伸缩"
                    aria-label="NEXT: OpenStack Senlin自动伸缩"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="http://service.weibo.com/share/share.php?&amp;title=https://wangkuntian.github.io/2019/10/14/Neutron-Server%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"
                    title="Share on Weibo"
                    aria-label="Share on Weibo"
                >
                    <i class="fab fa-weibo" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=https://wangkuntian.github.io/2019/10/14/Neutron-Server%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/&amp;title=Neutron-Server源码分析"
                    title="Share on QQ"
                    aria-label="Share on QQ"
                >
                    <i class="fab fa-qq" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://wangkuntian.github.io/2019/10/14/Neutron-Server%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"
                    title="Share on Qzone"
                    aria-label="Share on Qzone"
                >
                    <i class="fa fa-star" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#table-of-contents" aria-label="目录">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="4">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="http://service.weibo.com/share/share.php?&amp;title=https://wangkuntian.github.io/2019/10/14/Neutron-Server%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"
                        aria-label="Share on Weibo"
                    >
                        <i class="fab fa-weibo" aria-hidden="true"></i><span>Share on Weibo</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="http://connect.qq.com/widget/shareqq/index.html?url=https://wangkuntian.github.io/2019/10/14/Neutron-Server%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/&amp;title=Neutron-Server源码分析"
                        aria-label="Share on QQ"
                    >
                        <i class="fab fa-qq" aria-hidden="true"></i><span>Share on QQ</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://wangkuntian.github.io/2019/10/14/Neutron-Server%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"
                        aria-label="Share on Qzone"
                    >
                        <i class="fa fa-star" aria-hidden="true"></i><span>Share on Qzone</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/faker.jpg" alt="Author&#39;s picture"/>
        
            <h4 id="about-card-name">Wang kuntian</h4>
        
            <div id="about-card-bio"><p>Hi</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Software Engineer</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                Beijing
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover-v1.2.0.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/script-ndtc2tx33sr3grlppafri7aw03fwgxbruphsl7cntcdkym8tusuknerf6c0g.min.js"></script>

<!--SCRIPTS END-->


    




    <script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"display":{"superSample":2.5,"width":180,"height":400,"position":"right","hOffset":0,"vOffset":40},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.2},"dialog":{"enable":true,"hitokoto":false},"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/hibiki.model.json"},"log":false});</script></body>
</html>
