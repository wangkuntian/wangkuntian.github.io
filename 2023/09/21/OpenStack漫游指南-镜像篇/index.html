
<!DOCTYPE html>
<html lang="zh-en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Wang kuntian&#39;s Blog">
    <title>OpenStack漫游指南--镜像篇 - Wang kuntian&#39;s Blog</title>
    <meta name="author" content="Wang kuntian">
    
        <meta name="keywords" content="OpenStack,镜像">
    
    
        <link rel="icon" href="https://wangkuntian.github.io/assets/images/favicon.png">
    
    
        
            <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
        
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Wang kuntian","sameAs":["https://github.com/wangkuntian","mailto:wangkuntian1994@163.com"],"image":"faker.jpg"},"articleBody":"\n\n\n\n镜像制作镜像制作在云环境是必不可少的步骤，主要分为手动制作和自动化脚本制作两种。\n手动制作以制作一个uos-server 1060a系统镜像为例，简要梳理手动制作一个OpenStack可用镜像的流程。本地系统也使用了uos-server 1060a。\n准备系统ISO此处准备1060a系统ISO（下载地址）：uniontechos-server-20-1060a-amd64-RC4-20230421-0106.iso \n安装系统可以使用virt-manager直接在图形化界面操作或者virt-install命令在命令行启动。\n使用virt-manager安装时和常规图形界面创建虚拟机操作步骤一致。\n使用命令行安装时参考命令如下，首先创建名为1060a，大小为10G的qcow2格式空镜像。\n1qemu-img create -f qcow2 1060a.qcow2 10G\n然后使用准备好的ISO和镜像，创建名为1060a的虚拟机\n123456sudo virt-install --virt-type kvm --name 1060a --ram 4096 \\--cdrom=uniontechos-server-20-1060a-amd64-RC4-20230421-0106.iso \\--disk 1060a.qcow2,bus=virtio,size=10,format=qcow2 \\--network network=default \\--graphics vnc,listen=0.0.0.0 \\--os-type=linux --os-variant=generic\n\n安装时注意两点\n\n设置网络状态为ON（打开）。默认Ethernet设置为OFF（关闭）。修改为ON（打开）。并且，确认IPv4设置的方法为“自动（DHCP）” 。\n在使用lvm分区时应该将swap分区删除，只保留“/”和“/boot”分区；在使用标准分区时只保留“/”分区即可。\n\n安装完成后卸载CD-ROM设备使用virt-manager时，直接在图形化界面删除。也可通过命令行操作。先使用virsh命令查看相应设备。\n1virsh dumpxml 1060a\n\n1234567891011&lt;domain&gt;  &lt;name&gt;1060a&lt;/name&gt;...    &lt;disk type=&#x27;block&#x27; device=&#x27;cdrom&#x27;&gt;      &lt;driver name=&#x27;qemu&#x27; type=&#x27;raw&#x27;/&gt;      &lt;target dev=&#x27;hda&#x27; bus=&#x27;ide&#x27;/&gt;      &lt;readonly/&gt;      &lt;address type=&#x27;drive&#x27; controller=&#x27;0&#x27; bus=&#x27;1&#x27; target=&#x27;0&#x27; unit=&#x27;0&#x27;/&gt;&lt;/disk&gt;...&lt;/domain&gt;\n\n然后再利用命令行卸载，并重启虚拟机。\n12virsh attach-disk --type cdrom --mode readonly 1060a &quot;&quot; hdvirsh reboot 1060a\n\n配置镜像进入镜像系统内部，完成如下操作。\n安装ACPI服务acpid是一个用户空间的服务进程, 用来处理电源相关事件。libvirt可以通过向guest虚拟机发送acpid事件触发电源操作，使虚拟机安全关机、重启等操作。\n12dnf install acpid -ysystemctl enable acpid\n\n安装cloud-initcloud-init是虚拟机第一次启动时执行的脚本，主要负责从metadata服务中拉取配置信息，完成虚拟机的初始化工作，比如设置主机名、初始化密码以及注入密钥等。\n1dnf install cloud-init -y\n\n编辑/etc/cloud/cloud.cfg配置文件，允许root通过password ssh登录。\n12disable_root: 0ssh_pwauth: 1\n\n如上配置便于非生产环境使用，生产环境建议disable_root设为1，ssh_pwauth设为0。不开启密码登录功能，使用密钥登录更安全；同时不开启root远程登录。\n修改root密码（可选），编辑/etc/cloud/cloud.cfg配置文件。\n12345# 注意：新版本cloud-ini的chpasswd中的list已经被users取代，可以通过指定type，改变密码的类型，默认是hash。chpasswd:   expire: false   list: |     root:qwe123!@#\n\n关闭cloud-init网络配置，网络配置应该由openstack控制，所以关闭。\n12network:  config: disabled\n\n配置自动扩容，安装cloud-utils-growpart以允许根分区自动扩容。\n1dnf install cloud-utils-growpart -y\n\n编辑cloud-init配置文件。\n1234567891011#cloud-configgrowpart:  mode: auto  devices: [/dev/vda2]  ignore_growroot_disabled: falsebootcmd:- [cloud-init-per,once,mygrowpart,growpart,/dev/vda,2]- [cloud-init-per,once,mypartprobe,partprobe,-s,/dev/vda2]- [cloud-init-per,once,mypvresize,pvresize,/dev/vda2]- [cloud-init-per,once,mylvextend,lvextend,-l,+100%FREE,/dev/mapper/uos-root]- [cloud-init-per,once,myxfs_growfs,xfs_growfs,/dev/mapper/uos-root]\n\n需要根据具体环境情况修改配置文件，例如1050a中是uniontechos-root，而1060a中是uos-root。如果是非lvm分区安装，需要改成下面所示。\n123bootcmd:  - [ cloud-init-per, once, grow-partition, growpart, /dev/vda, 1 ]  - [ cloud-init-per, once, resize-filesystem, xfs_growfs, /dev/vda1 ]\n\n正确设置字符集，否则执行growpart会出错。\n1LANG=en_US.UTF-8\n\n禁用firewalld1systemctl disable firewalld.service\n\n禁用zeroconf1echo &quot;NOZEROCONF=yes&quot; &gt;&gt; /etc/sysconfig/network\n\n配置console编辑 /etc/default/grub文件，配置GRUB_CMDLINE_LINUX选项。删除“rhgb quiet”，添加“console=tty0 console=ttyS0,115200n8”。使nova能够获取console log。\n12GRUB_CMDLINE_LINUX=&quot;crashkernel=auto elevator=none console=tty0 console=ttyS0,115200n8&quot;GRUB_CMDLINE_LINUX=&quot;crashkernel=auto rd.lvm.lv=uniontechos/root elevator=none console=tty0 console=ttyS0,115200n8&quot;\n\n运行如下命令，保存更改：\n1grub2-mkconfig -o /boot/grub2/grub.cfg\n\n启用serial-getty服务，使用户可以通过virsh console进入虚拟机。\n12systemctl enable serial-getty@ttyS0.servicesystemctl start serial-getty@ttyS0.service\n\n配置qemu-guest-agent服务qemu-guest-agent类似于VMware tools，主要⽤于辅助Hypervisor实现对Guest的管理。通过qemu-guest-agent，openstack可以使用命令行直接修改管理员账户的密码。\n安装服务\n1dnf install -y qemu-guest-agent\n\n启用服务\n1systemctl enable qemu-guest-agent\n\n注意，在openstack创建镜像时要指定镜像的属性hw_qemu_guest_agent=yes。\n1openstack image set --property hw_qemu_guest_agent=yes d1d3c1ad-7292-4e64-87a1-4a6069ec4056\n\n使用openstack命令修改管理员密码。\n1openstack server set --root-password test-1060a\n\n禁用自动退出123vim /etc/profileexport TMOUT=0source /etc/profile\n\n删除网络配置文件uos采用NetworkManager进行网络的管理，如果遇到同名的网络设备时，系统在第一次启动时会跳过连接流程。\n1rm -f /etc/sysconfig/network-scripts/ifcfg-enp0s3 \n\n关闭虚拟机在虚拟机内部，以root用户运行：poweroff\n清理（移除mac地址等信息）在宿主机上运行。\n1sudo virt-sysprep -d 1060a\n\n此时将1060a对应的qcow2文件拷贝走即可使用。\n镜像压缩qemu-img命令可以用来降低镜像大小，回收实际内容为零的空间\n1qemu-img convert -p -c -O qcow2 1060a.qcow2 uniontechos-server-20-1060a-amd64-RC4-20230421-0106-minimal.qcow2\n\n脚本自动化构建diskimage-builder（简称为DIB）是一个用于自动构建自定义的操作系统镜像的工具，以便在云和其他环境中使用。\n构建docker容器利用docker容器来搭建镜像的环境，这里选择centos镜像，同时将本地目录和容器内的文件目录做一个映射。\n1docker run -itd --privileged=true --name centos -v $PWD:/root centos:7 /sbin/init\n\n\n安装依赖环境进入容器内安装DIB的依赖环境。\n12345docker exec -it centos bashyum updateyum install -y epel-release yum install -y python3 git sudo        # DIB需要Python3支持pip3 install -U pip setuptools wheel\n\n安装qemu-img和kpartx。\n12apt-get install qemu-utils kpartx squashfs-tools e4fsprogs # ubuntuyum install -y qemu-img kpartx squashfs-tools e4fsprogs  # centos\n\nDIB从github将DIB下载下来。\n1git clone https://github.com/openstack/diskimage-builder.git\n\n\n切换到最近的tag上，我这里是3.7.0。\n12cd diskimge-buildergit checkout -b v3.7.0 3.7.0\n\n\n设置虚环境\n12pip install virtualenvmkdir venv &amp;&amp; cd venv &amp;&amp; virtualenv -p /usr/bin/python3 diskimage-builder\n\n\n安装diskimage-builder。\n1cd /root/diskimage-builder &amp;&amp; /root/venv/diskimage-builder/bin/pip install -e .\n\n测试12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061[root@centos-linux ~]# disk-image-create -hUsage: disk-image-create [OPTION]... [ELEMENT]...Options:    -a i386|amd64|armhf|arm64 -- set the architecture of the image(default amd64)    -o imagename -- set the imagename of the output image file(default image)    -t qcow2,tar,tgz,squashfs,vhd,docker,aci,raw -- set the image types of the output image files (default qcow2)       File types should be comma separated. VHD outputting requires the vhd-util       executable be in your PATH. ACI outputting requires the ACI_MANIFEST       environment variable be a path to a manifest file.    -x -- turn on tracing (use -x -x for very detailed tracing).    -u -- uncompressed; do not compress the image - larger but faster    -c -- clear environment before starting work    --logfile -- save run output to given logfile (implies DIB_QUIET=1)    --checksum -- generate MD5 and SHA256 checksum files for the created image    --image-size size -- image size in GB for the created image    --image-extra-size size -- extra image size in GB for the created image    --image-cache directory -- location for cached images(default ~/.cache/image-create)    --max-online-resize size -- max number of filesystem blocks to support when resizing.       Useful if you want a really large root partition when the image is deployed.       Using a very large value may run into a known bug in resize2fs.       Setting the value to 274877906944 will get you a 1PB root file system.       Making this value unnecessarily large will consume extra disk space       on the root partition with extra file system inodes.    --min-tmpfs size -- minimum size in GB needed in tmpfs to build the image    --mkfs-journal-size -- filesystem journal size in MB to pass to mkfs.    --mkfs-options -- option flags to be passed directly to mkfs.       Options should be passed as a single string value.    --no-tmpfs -- do not use tmpfs to speed image build    --offline -- do not update cached resources    --qemu-img-options -- option flags to be passed directly to qemu-img.       Options need to be comma separated, and follow the key=value pattern.    --root-label label -- label for the root filesystem.  Defaults to &#x27;cloudimg-rootfs&#x27;.    --ramdisk-element -- specify the main element to be used for building ramdisks.       Defaults to &#x27;ramdisk&#x27;.  Should be set to &#x27;dracut-ramdisk&#x27; for platforms such       as RHEL and CentOS that do not package busybox.    --install-type -- specify the default installation type. Defaults to &#x27;source&#x27;. Set to &#x27;package&#x27; to use package based installations by default.    --docker-target -- specify the repo and tag to use if the output type is docker. Defaults to the value of output imagename    -n skip the default inclusion of the &#x27;base&#x27; element    -p package[,p2...] [-p p3] -- extra packages to install in the image.  Runs once, after &#x27;install.d&#x27; phase.  Can be specified multiple times    -h|--help -- display this help and exit    --version -- display version and exitEnvironment Variables:  (this is not a complete list)  * ELEMENTS_PATH: specify external locations for the elements.  As for $PATH  * DIB_NO_TIMESTAMP: no timestamp prefix on output.  Useful if capturing output  * DIB_QUIET: 1=do not output log output to stdout; 0=always ouptut to stdout.  See --logfileNOTE: At least one distribution root element must be specified.NOTE: If using the VHD output format you need to have a patched version of vhd-util installed for the image      to be bootable. The patch is available here: https://github.com/emonty/vhd-util/blob/master/debian/patches/citrix      and a PPA with the patched tool is available here: https://launchpad.net/~openstack-ci-core/+archive/ubuntu/vhd-utilExamples:    disk-image-create -a amd64 -o ubuntu-amd64 vm ubuntu    export ELEMENTS_PATH=~/source/tripleo-image-elements/elements    disk-image-create -a amd64 -o fedora-amd64-heat-cfntools vm fedora heat-cfntools\n\n创建ubuntu镜像。\n1/root/venv/diskimage-builder/bin/disk-image-create -a amd64 -o ubuntu-amd64 vm ubuntu\n\n\n镜像修改密码修改镜像密码往往是一个比较令人头疼的问题。针对从centos、ubuntu官网上下载的镜像可以在创建完实例后，通过qemu-guest-agent服务修改root密码。需要提前设置镜像的属性打开qemu-guest-agent服务。\n1openstack image set --property hw_qemu_guest_agent=yes &lt;image_id&gt;\n\n然后使用openstack命令修改管理员密码。\n1openstack server set --root-password &lt;server_id&gt;\n\n这样做有几个缺点，每当创建完实例后都需要执行root修改密码操作，而且往往root用户不能直接使用ssh登录，只能通过vnc的方式先连接到实例，再修改ssh的配置，才能远程登录。但好在这些官方的镜像往往都采用cloud-init的方式，可以通过修改cloud-init的配置文件修改root登录。\n使用guestfish在计算节点（运行libvirtd服务的节点）上，使用guestfish命令。\n12# 安装依赖包yum install -y libguestfs-tools\n\n执行guestfish命令。\n12345678guestfish --rw -a CentOS-Stream-GenericCloud-9-x86_64.qcow2&gt;&lt;fs&gt; run100% ⟦▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒⟧ 00:00&gt;&lt;fs&gt; list-filesystems/dev/sda1: xfs&gt;&lt;fs&gt; mount /dev/sda1 /&gt;&lt;fs&gt; vi /etc/cloud/cloud.cfg           # 编辑cloud-init的配置文件&gt;&lt;fs&gt; vi /etc/ssh/sshd_config           # 编辑sshd服务的配置文件\n\n编辑cloud-init的配置文件/etc/cloud/cloud.cfg。\n12345678910# 打开root登录disable_root: false# 打开ssh 密码登录ssh_pwauth: true# 修改root密码。# 注意：新版本cloud-ini的chpasswd中的list已经被users取代，可以通过指定type，改变密码的类型，默认是hash。chpasswd:   expire: false   list: |     root:centos\n\n还可以直接修改/etc/shadow来修改密码。shadow文件一般由下面9个字段组成。\n1用户名:加密密码:最后一次修改时间:最小修改时间间隔:密码有效期:密码需要变更前的警告天数:密码过期后的宽限时间:账号失效时间:保留字段\n例如。\n1root:$1$w07Q2CQS$6aSP5uit0/sLG6p1uzaOc.:19527:0:99999:7:::\n$1$w07Q2CQS$6aSP5uit0/sLG6p1uzaOc.即使加密的密码。其中密码的开头部分，$1$表示使用MD5算法，$2a$表示使用Blowfish算法，”$2y$”是另一算法长度的Blowfish,”$5$”表示SHA-256算法，而”$6$”表示SHA-512算法。\n目前Linux的密码采用的是SHA512散列加密算法，原来采用的是MD5或DES加密算法。SHA512散列加密算法的加密等级更高，也更加安全。\n使用openssl命令，可简单的生成MD5加密。\n12openssl passwd -1 &#x27;qwe123!@#&#x27;$1$i7sJan8C$kE9Lin.FiytHTz4QtNjal0\n\n使用python的crypt模块，可生成SHA512加密。\n12python3 -c &quot;import crypt;print(crypt.crypt(&#x27;qwe123\\!\\@\\#&#x27;))&quot;$6$acVoXs6xgUiLxnhS$uyTSoX42qCE6FqqldpLyfV4mDHhI7j2qIL56WiKYKpSFnPRziBOMhgEhgGB/12XKZJNceamTkEk6mfd3/vpgT.\n\n编辑ssh的配置文件/etc/ssh/sshd_config。\n12PermitRootLogin yesPasswordAuthentication yes\n\n保存退出。\n1&gt;&lt;fs&gt; quit\n\n使用virt-customize在计算节点（运行libvirtd服务的节点）上，安装依赖包。\n1yum install -y libguestfs-tools\n\n使用virt-customize命令。\n1sudo virt-customize -a CentOS-Stream-GenericCloud-9-x86_64.qcow2 --root-password password:123456\n如果出现下面的错误。\n123456789101112131415[   0.0] Examining the guest ...virt-customize: error: libguestfs error: could not create appliance throughlibvirt.Try running qemu directly without libvirt using this environment variable:export LIBGUESTFS_BACKEND=directOriginal error from libvirt: Cannot access storage file&#x27;/root/CentOS-Stream-GenericCloud-9-x86_64.qcow2&#x27; (as uid:107, gid:107):权限不够 [code=38 int1=13]If reporting bugs, run virt-customize with debugging enabled and includethe complete output:  virt-customize -v -x [...]\n\n执行下面的操作，修改libvirtd的权限。\n12345cat &gt;&gt; /etc/libvirt/qemu.conf &lt;&lt; EOFuser = &quot;root&quot;group = &quot;root&quot;EOFsystemctl restart libvirtd.service\n\n使用horizonhorizon界面支持用户在创建云主机时注入密码，仅针对开启qemu-guest-agent服务的镜像。\n传送门\n\n\n修改horizon的local_settings.py文件。\n1234OPENSTACK_HYPERVISOR_FEATURES = &#123;    ...    &#x27;can_set_password&#x27;: True,&#125;\n\n修改/etc/nova/nova.conf，kolla部署的nova修改/etc/kolla/nova-compute/nova.conf。\n12[libvirt]inject_password=true\n\n重启horizon和nova-compute服务。\n1systemctl restart httpd nova-compute\n\n查看horizon界面。\n\n\n上传镜像使用OpenStack命令上传镜像。\n1234openstack image create --disk-format qcow2 \\--container-format bare --public \\--file ./CentOS-Stream-GenericCloud-9-x86_64.qcow2 \\CentOS-Stream-GenericCloud-9-x86_64\n\n使用ISO启动实例UOS镜像使用uos镜像创建一个实例，创建时选择不从volume启动。实例ID为a06135f1-4aa9-405d-910d-e398d83c5ecc，其中libvirtd的xml如下。\n12345678910111213141516171819202122&lt;domain type=&#x27;kvm&#x27; id=&#x27;63&#x27;&gt;  &lt;name&gt;instance-0000138b&lt;/name&gt;  &lt;uuid&gt;a06135f1-4aa9-405d-910d-e398d83c5ecc&lt;/uuid&gt;  ...  &lt;devices&gt;    &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;    &lt;disk type=&#x27;file&#x27; device=&#x27;cdrom&#x27;&gt;      &lt;driver name=&#x27;qemu&#x27; type=&#x27;qcow2&#x27; cache=&#x27;none&#x27;/&gt;      &lt;source file=&#x27;/var/lib/nova/instances/a06135f1-4aa9-405d-910d-e398d83c5ecc/disk&#x27; index=&#x27;1&#x27;/&gt;      &lt;backingStore type=&#x27;file&#x27; index=&#x27;2&#x27;&gt;        &lt;format type=&#x27;raw&#x27;/&gt;        &lt;source file=&#x27;/var/lib/nova/instances/_base/5318b1004ad87ba4770212c2f6b1c9fc32f23787&#x27;/&gt;        &lt;backingStore/&gt;      &lt;/backingStore&gt;      &lt;target dev=&#x27;hda&#x27; bus=&#x27;ide&#x27;/&gt;      &lt;readonly/&gt;      &lt;alias name=&#x27;ide0-0-0&#x27;/&gt;      &lt;address type=&#x27;drive&#x27; controller=&#x27;0&#x27; bus=&#x27;0&#x27; target=&#x27;0&#x27; unit=&#x27;0&#x27;/&gt;    &lt;/disk&gt;    ...  &lt;/devices&gt;&lt;/domain&gt;\n\nnova表中block_device_mapping记录了磁盘的映射关系。\n123456789101112131415161718192021222324252627select * from block_device_mapping where instance_uuid=&quot;a06135f1-4aa9-405d-910d-e398d83c5ecc&quot; \\G*************************** 1. row ***************************           created_at: 2023-05-11 08:52:48           updated_at: 2023-05-11 08:52:49           deleted_at: NULL                   id: 8740          device_name: /dev/hdadelete_on_termination: 1          snapshot_id: NULL            volume_id: NULL          volume_size: NULL            no_device: 0      connection_info: NULL        instance_uuid: a06135f1-4aa9-405d-910d-e398d83c5ecc              deleted: 0          source_type: image     destination_type: local         guest_format: NULL          device_type: disk             disk_bus: NULL           boot_index: 0             image_id: 17200200-24d9-4872-b973-af7a85a12c53                  tag: NULL        attachment_id: NULL                 uuid: edf44737-4835-47ff-b641-a17e15822ad0          volume_type: NULL1 row in set (0.000 sec)\n\n此时实例进入安装界面，但是没有磁盘。新建一块磁盘用于安装系统。\n12345678910111213141516171819202122232425openstack volume create --size 100 --availability-zone nova --bootable wkt-uos-desktop-test-without-volume+---------------------+--------------------------------------+| Field               | Value                                |+---------------------+--------------------------------------+| attachments         | []                                   || availability_zone   | nova                                 || bootable            | false                                || consistencygroup_id | None                                 || created_at          | 2023-05-11T09:01:06.000000           || description         | None                                 || encrypted           | False                                || id                  | 304d88ac-3460-4c5d-950d-f17528b97e1a || migration_status    | None                                 || multiattach         | False                                || name                | wkt-uos-desktop-test-without-volume  || properties          |                                      || replication_status  | None                                 || size                | 100                                  || snapshot_id         | None                                 || source_volid        | None                                 || status              | creating                             || type                | __DEFAULT__                          || updated_at          | None                                 || user_id             | 24d08826a98140ce8e2ade2606ff9ad8     |+---------------------+--------------------------------------+\n\n等待磁盘创建完成后，添加到实例上。\n1openstack server add volume a06135f1-4aa9-405d-910d-e398d83c5ecc 304d88ac-3460-4c5d-950d-f17528b97e1a\n\n此时block_device_mapping表中为。\n12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152select * from block_device_mapping where instance_uuid=&quot;a06135f1-4aa9-405d-910d-e398d83c5ecc&quot; \\G*************************** 1. row ***************************           created_at: 2023-05-11 08:52:48           updated_at: 2023-05-11 08:52:49           deleted_at: NULL                   id: 8740          device_name: /dev/hdadelete_on_termination: 1          snapshot_id: NULL            volume_id: NULL          volume_size: NULL            no_device: 0      connection_info: NULL        instance_uuid: a06135f1-4aa9-405d-910d-e398d83c5ecc              deleted: 0          source_type: image     destination_type: local         guest_format: NULL          device_type: disk             disk_bus: NULL           boot_index: 0             image_id: 17200200-24d9-4872-b973-af7a85a12c53                  tag: NULL        attachment_id: NULL                 uuid: edf44737-4835-47ff-b641-a17e15822ad0          volume_type: NULL*************************** 2. row ***************************           created_at: 2023-05-11 09:03:21           updated_at: 2023-05-11 09:03:28           deleted_at: NULL                   id: 8741          device_name: /dev/vdadelete_on_termination: 0          snapshot_id: NULL            volume_id: 304d88ac-3460-4c5d-950d-f17528b97e1a          volume_size: 100            no_device: NULL      connection_info: &#123;&quot;driver_volume_type&quot;: &quot;iscsi&quot;, &quot;data&quot;: &#123;&quot;target_discovered&quot;: false, &quot;target_portal&quot;: &quot;10.10.15.12:3260&quot;, &quot;target_iqn&quot;: &quot;iqn.2010-10.org.openstack:volume-304d88ac-3460-4c5d-950d-f17528b97e1a&quot;, &quot;target_lun&quot;: 0, &quot;volume_id&quot;: &quot;304d88ac-3460-4c5d-950d-f17528b97e1a&quot;, &quot;auth_method&quot;: &quot;CHAP&quot;, &quot;auth_username&quot;: &quot;h8e7h5iC5kMjFVJN6rfD&quot;, &quot;auth_password&quot;: &quot;wNmMTBsTMBs8dV67&quot;, &quot;encrypted&quot;: false, &quot;qos_specs&quot;: null, &quot;access_mode&quot;: &quot;rw&quot;, &quot;device_path&quot;: &quot;/dev/sdf&quot;&#125;, &quot;status&quot;: &quot;reserved&quot;, &quot;instance&quot;: &quot;a06135f1-4aa9-405d-910d-e398d83c5ecc&quot;, &quot;attached_at&quot;: &quot;&quot;, &quot;detached_at&quot;: &quot;&quot;, &quot;volume_id&quot;: &quot;304d88ac-3460-4c5d-950d-f17528b97e1a&quot;, &quot;serial&quot;: &quot;304d88ac-3460-4c5d-950d-f17528b97e1a&quot;&#125;        instance_uuid: a06135f1-4aa9-405d-910d-e398d83c5ecc              deleted: 0          source_type: volume     destination_type: volume         guest_format: NULL          device_type: NULL             disk_bus: NULL           boot_index: NULL             image_id: NULL                  tag: NULL        attachment_id: 12cb3da5-a87f-4035-a0f9-c31a1306ce72                 uuid: f1f7a8e6-b59b-4fde-a37d-af020979d4a4          volume_type: NULL2 rows in set (0.001 sec)\n\n此时实例的xml文件已经改变，可以看到新增了一块磁盘，但是系统界面看不到。\n1234567891011121314151617181920212223242526272829303132&lt;domain type=&#x27;kvm&#x27; id=&#x27;63&#x27;&gt;  &lt;name&gt;instance-0000138b&lt;/name&gt;  &lt;uuid&gt;a06135f1-4aa9-405d-910d-e398d83c5ecc&lt;/uuid&gt;  ...  &lt;devices&gt;    &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;    &lt;disk type=&#x27;file&#x27; device=&#x27;cdrom&#x27;&gt;      &lt;driver name=&#x27;qemu&#x27; type=&#x27;qcow2&#x27; cache=&#x27;none&#x27;/&gt;      &lt;source file=&#x27;/var/lib/nova/instances/a06135f1-4aa9-405d-910d-e398d83c5ecc/disk&#x27; index=&#x27;1&#x27;/&gt;      &lt;backingStore type=&#x27;file&#x27; index=&#x27;2&#x27;&gt;        &lt;format type=&#x27;raw&#x27;/&gt;        &lt;source file=&#x27;/var/lib/nova/instances/_base/5318b1004ad87ba4770212c2f6b1c9fc32f23787&#x27;/&gt;        &lt;backingStore/&gt;      &lt;/backingStore&gt;      &lt;target dev=&#x27;hda&#x27; bus=&#x27;ide&#x27;/&gt;      &lt;readonly/&gt;      &lt;alias name=&#x27;ide0-0-0&#x27;/&gt;      &lt;address type=&#x27;drive&#x27; controller=&#x27;0&#x27; bus=&#x27;0&#x27; target=&#x27;0&#x27; unit=&#x27;0&#x27;/&gt;    &lt;/disk&gt;    &lt;disk type=&#x27;block&#x27; device=&#x27;disk&#x27;&gt;      &lt;driver name=&#x27;qemu&#x27; type=&#x27;raw&#x27; cache=&#x27;none&#x27; io=&#x27;native&#x27;/&gt;      &lt;source dev=&#x27;/dev/sdf&#x27; index=&#x27;3&#x27;/&gt;      &lt;backingStore/&gt;      &lt;target dev=&#x27;vda&#x27; bus=&#x27;virtio&#x27;/&gt;      &lt;serial&gt;304d88ac-3460-4c5d-950d-f17528b97e1a&lt;/serial&gt;      &lt;alias name=&#x27;virtio-disk0&#x27;/&gt;      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x06&#x27; function=&#x27;0x0&#x27;/&gt;    &lt;/disk&gt;    ...  &lt;/devices&gt;&lt;/domain&gt;\n\n将实例硬重启。\n1openstack server reboot --hard a06135f1-4aa9-405d-910d-e398d83c5ecc\n\n可以看到xml文件中disk的index发生了变化。\n12345678910111213141516171819202122&lt;disk type=&#x27;file&#x27; device=&#x27;cdrom&#x27;&gt;  &lt;driver name=&#x27;qemu&#x27; type=&#x27;qcow2&#x27; cache=&#x27;none&#x27;/&gt;  &lt;source file=&#x27;/var/lib/nova/instances/a06135f1-4aa9-405d-910d-e398d83c5ecc/disk&#x27; index=&#x27;2&#x27;/&gt;  &lt;backingStore type=&#x27;file&#x27; index=&#x27;3&#x27;&gt;    &lt;format type=&#x27;raw&#x27;/&gt;    &lt;source file=&#x27;/var/lib/nova/instances/_base/5318b1004ad87ba4770212c2f6b1c9fc32f23787&#x27;/&gt;    &lt;backingStore/&gt;  &lt;/backingStore&gt;  &lt;target dev=&#x27;hda&#x27; bus=&#x27;ide&#x27;/&gt;  &lt;readonly/&gt;  &lt;alias name=&#x27;ide0-0-0&#x27;/&gt;  &lt;address type=&#x27;drive&#x27; controller=&#x27;0&#x27; bus=&#x27;0&#x27; target=&#x27;0&#x27; unit=&#x27;0&#x27;/&gt;&lt;/disk&gt;&lt;disk type=&#x27;block&#x27; device=&#x27;disk&#x27;&gt;  &lt;driver name=&#x27;qemu&#x27; type=&#x27;raw&#x27; cache=&#x27;none&#x27; io=&#x27;native&#x27;/&gt;  &lt;source dev=&#x27;/dev/sdf&#x27; index=&#x27;1&#x27;/&gt;  &lt;backingStore/&gt;  &lt;target dev=&#x27;vda&#x27; bus=&#x27;virtio&#x27;/&gt;  &lt;serial&gt;304d88ac-3460-4c5d-950d-f17528b97e1a&lt;/serial&gt;  &lt;alias name=&#x27;virtio-disk0&#x27;/&gt;  &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x04&#x27; function=&#x27;0x0&#x27;/&gt;&lt;/disk&gt;\n\n这时进入系统的安装界面可以看到多了一块磁盘，然后进行系统的安装。系统安装完成的最后，会提示用户重启，用户点击重启后，又进入到系统的安装界面。此时及时进行硬重启也不解决问题，依旧进入系统的安装界面。\n通过修改block_device_mapping表，尝试修改实例磁盘的启动顺序。\n12345# 先将安装完系统的盘的boot_index设置为0。update block_device_mapping set boot_index=0 where id=8741;# 然后将安装盘的boot_index设置为空。update block_device_mapping set boot_index=NULL where id=8740;\n最后将实例硬重启。\n1openstack server reboot --hard a06135f1-4aa9-405d-910d-e398d83c5ecc\n\n查看xml文件，可以看到boot的设备由cdrom变为hd。\n123456789101112131415161718&lt;domain type=&#x27;kvm&#x27; id=&#x27;66&#x27;&gt;  &lt;name&gt;instance-0000138b&lt;/name&gt;  &lt;uuid&gt;a06135f1-4aa9-405d-910d-e398d83c5ecc&lt;/uuid&gt;  ...  &lt;devices&gt;    &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;    &lt;disk type=&#x27;block&#x27; device=&#x27;disk&#x27;&gt;      &lt;driver name=&#x27;qemu&#x27; type=&#x27;raw&#x27; cache=&#x27;none&#x27; io=&#x27;native&#x27;/&gt;      &lt;source dev=&#x27;/dev/sdf&#x27; index=&#x27;1&#x27;/&gt;      &lt;backingStore/&gt;      &lt;target dev=&#x27;vda&#x27; bus=&#x27;virtio&#x27;/&gt;      &lt;serial&gt;304d88ac-3460-4c5d-950d-f17528b97e1a&lt;/serial&gt;      &lt;alias name=&#x27;virtio-disk0&#x27;/&gt;      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x04&#x27; function=&#x27;0x0&#x27;/&gt;    &lt;/disk&gt;    ...  &lt;/devices&gt;&lt;/domain&gt;\n\n此时可以正常进入系统。\nWindows镜像首先windows系统安装时需要virtio的驱动来读取磁盘信息，所以先以virtio的镜像创建一个volume。\n12345678910111213141516171819202122232425openstack volume create --size 1 --image virtio-win-0.1.225 --availability-zone nova wkt-virtio-win-0.1.225+---------------------+--------------------------------------+| Field               | Value                                |+---------------------+--------------------------------------+| attachments         | []                                   || availability_zone   | nova                                 || bootable            | false                                || consistencygroup_id | None                                 || created_at          | 2023-05-11T09:45:32.000000           || description         | None                                 || encrypted           | False                                || id                  | 07476fea-b4bc-4bfc-86d4-84520a954ce6 || migration_status    | None                                 || multiattach         | False                                || name                | wkt-virtio-win-0.1.225               || properties          |                                      || replication_status  | None                                 || size                | 1                                    || snapshot_id         | None                                 || source_volid        | None                                 || status              | creating                             || type                | __DEFAULT__                          || updated_at          | None                                 || user_id             | 24d08826a98140ce8e2ade2606ff9ad8     |+---------------------+--------------------------------------+\n\n等到volume状态变为可用时，创建windows实例。\n1234567nova boot --availability-zone cloud \\--flavor 8-8-0 \\--image 60f8adab-fceb-47a2-a32a-f19d2351177e \\--nic net-id=7b6c69b5-bfa5-4145-901c-26979103da77 \\--block-device id=eb2006ba-6416-4b68-b8bf-b358589fba34,source=image,dest=volume,bus=ide,type=cdrom,size=1 \\wkt-windows-test\n\n实例的ID是5ace35d4-7195-465e-afca-2c81279bb677。\n查看block_device_mapping表的映射关系。\n12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152select * from block_device_mapping where instance_uuid=&quot;5ace35d4-7195-465e-afca-2c81279bb677&quot; \\G*************************** 1. row ***************************           created_at: 2023-05-12 02:10:28           updated_at: 2023-05-12 02:10:28           deleted_at: NULL                   id: 8746          device_name: /dev/hdadelete_on_termination: 1          snapshot_id: NULL            volume_id: NULL          volume_size: NULL            no_device: 0      connection_info: NULL        instance_uuid: 5ace35d4-7195-465e-afca-2c81279bb677              deleted: 0          source_type: image     destination_type: local         guest_format: NULL          device_type: NULL             disk_bus: NULL           boot_index: 0             image_id: 60f8adab-fceb-47a2-a32a-f19d2351177e                  tag: NULL        attachment_id: NULL                 uuid: 6de66a02-6efb-4ce0-89a1-fa477f976909          volume_type: NULL*************************** 2. row ***************************           created_at: 2023-05-12 02:10:28           updated_at: 2023-05-12 02:11:02           deleted_at: NULL                   id: 8747          device_name: /dev/hdbdelete_on_termination: 0          snapshot_id: NULL            volume_id: c5f26969-397c-491b-8ee6-a2e9df1f9b42          volume_size: 1            no_device: 0      connection_info: &#123;&quot;driver_volume_type&quot;: &quot;iscsi&quot;, &quot;data&quot;: &#123;&quot;target_discovered&quot;: false, &quot;target_portal&quot;: &quot;10.10.15.12:3260&quot;, &quot;target_iqn&quot;: &quot;iqn.2010-10.org.openstack:volume-c5f26969-397c-491b-8ee6-a2e9df1f9b42&quot;, &quot;target_lun&quot;: 0, &quot;volume_id&quot;: &quot;c5f26969-397c-491b-8ee6-a2e9df1f9b42&quot;, &quot;auth_method&quot;: &quot;CHAP&quot;, &quot;auth_username&quot;: &quot;MDksZ4gonTVKwayfr2fB&quot;, &quot;auth_password&quot;: &quot;jjEXzRGtzbFKiB6m&quot;, &quot;encrypted&quot;: false, &quot;qos_specs&quot;: null, &quot;access_mode&quot;: &quot;rw&quot;, &quot;device_path&quot;: &quot;/dev/sdg&quot;&#125;, &quot;status&quot;: &quot;reserved&quot;, &quot;instance&quot;: &quot;5ace35d4-7195-465e-afca-2c81279bb677&quot;, &quot;attached_at&quot;: &quot;&quot;, &quot;detached_at&quot;: &quot;&quot;, &quot;volume_id&quot;: &quot;c5f26969-397c-491b-8ee6-a2e9df1f9b42&quot;, &quot;serial&quot;: &quot;c5f26969-397c-491b-8ee6-a2e9df1f9b42&quot;&#125;        instance_uuid: 5ace35d4-7195-465e-afca-2c81279bb677              deleted: 0          source_type: image     destination_type: volume         guest_format: NULL          device_type: cdrom             disk_bus: ide           boot_index: NULL             image_id: eb2006ba-6416-4b68-b8bf-b358589fba34                  tag: NULL        attachment_id: c45a1ce7-16b0-4319-90d0-2a08463cc220                 uuid: 94a9eb85-e31b-41cd-bf07-431d7a6f9534          volume_type: NULL2 rows in set (0.000 sec)\n\nxml配置文件。\n1234567891011121314151617181920212223242526272829303132&lt;domain type=&#x27;kvm&#x27; id=&#x27;69&#x27;&gt;  &lt;name&gt;instance-0000138e&lt;/name&gt;  &lt;uuid&gt;5ace35d4-7195-465e-afca-2c81279bb677&lt;/uuid&gt;  ...  &lt;devices&gt;    &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;    &lt;disk type=&#x27;file&#x27; device=&#x27;cdrom&#x27;&gt;      &lt;driver name=&#x27;qemu&#x27; type=&#x27;qcow2&#x27; cache=&#x27;none&#x27;/&gt;      &lt;source file=&#x27;/var/lib/nova/instances/5ace35d4-7195-465e-afca-2c81279bb677/disk&#x27; index=&#x27;2&#x27;/&gt;      &lt;backingStore type=&#x27;file&#x27; index=&#x27;3&#x27;&gt;        &lt;format type=&#x27;raw&#x27;/&gt;        &lt;source file=&#x27;/var/lib/nova/instances/_base/77a37f6c71682eba3d2f883c4736edd52b431752&#x27;/&gt;        &lt;backingStore/&gt;      &lt;/backingStore&gt;      &lt;target dev=&#x27;hda&#x27; bus=&#x27;ide&#x27;/&gt;      &lt;readonly/&gt;      &lt;alias name=&#x27;ide0-0-0&#x27;/&gt;      &lt;address type=&#x27;drive&#x27; controller=&#x27;0&#x27; bus=&#x27;0&#x27; target=&#x27;0&#x27; unit=&#x27;0&#x27;/&gt;    &lt;/disk&gt;    &lt;disk type=&#x27;block&#x27; device=&#x27;cdrom&#x27;&gt;      &lt;driver name=&#x27;qemu&#x27; type=&#x27;raw&#x27; cache=&#x27;none&#x27; io=&#x27;native&#x27;/&gt;      &lt;source dev=&#x27;/dev/sdg&#x27; index=&#x27;1&#x27;/&gt;      &lt;backingStore/&gt;      &lt;target dev=&#x27;hdb&#x27; bus=&#x27;ide&#x27;/&gt;      &lt;readonly/&gt;      &lt;serial&gt;c5f26969-397c-491b-8ee6-a2e9df1f9b42&lt;/serial&gt;      &lt;alias name=&#x27;ide0-0-1&#x27;/&gt;      &lt;address type=&#x27;drive&#x27; controller=&#x27;0&#x27; bus=&#x27;0&#x27; target=&#x27;0&#x27; unit=&#x27;1&#x27;/&gt;    &lt;/disk&gt;    ...  &lt;/devices&gt;&lt;/domain&gt;\n\n添加系统盘。\n12345678910111213141516171819202122232425openstack volume create --size 100 --availability-zone nova --bootable wkt-windows-test-volume+---------------------+--------------------------------------+| Field               | Value                                |+---------------------+--------------------------------------+| attachments         | []                                   || availability_zone   | nova                                 || bootable            | false                                || consistencygroup_id | None                                 || created_at          | 2023-05-12T02:16:56.000000           || description         | None                                 || encrypted           | False                                || id                  | d1e96c3b-7a2a-478d-ab98-de94aefcbc0e || migration_status    | None                                 || multiattach         | False                                || name                | wkt-windows-test-volume              || properties          |                                      || replication_status  | None                                 || size                | 100                                  || snapshot_id         | None                                 || source_volid        | None                                 || status              | creating                             || type                | __DEFAULT__                          || updated_at          | None                                 || user_id             | 24d08826a98140ce8e2ade2606ff9ad8     |+---------------------+--------------------------------------+\n\n等待磁盘创建完成后，添加到实例上。\n1openstack server add volume 5ace35d4-7195-465e-afca-2c81279bb677 d1e96c3b-7a2a-478d-ab98-de94aefcbc0e\n\n查看\n1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677select * from block_device_mapping where instance_uuid=&quot;5ace35d4-7195-465e-afca-2c81279bb677&quot; \\G*************************** 1. row ***************************           created_at: 2023-05-12 02:10:28           updated_at: 2023-05-12 02:10:28           deleted_at: NULL                   id: 8746          device_name: /dev/hdadelete_on_termination: 1          snapshot_id: NULL            volume_id: NULL          volume_size: NULL            no_device: 0      connection_info: NULL        instance_uuid: 5ace35d4-7195-465e-afca-2c81279bb677              deleted: 0          source_type: image     destination_type: local         guest_format: NULL          device_type: NULL             disk_bus: NULL           boot_index: 0             image_id: 60f8adab-fceb-47a2-a32a-f19d2351177e                  tag: NULL        attachment_id: NULL                 uuid: 6de66a02-6efb-4ce0-89a1-fa477f976909          volume_type: NULL*************************** 2. row ***************************           created_at: 2023-05-12 02:10:28           updated_at: 2023-05-12 02:11:02           deleted_at: NULL                   id: 8747          device_name: /dev/hdbdelete_on_termination: 0          snapshot_id: NULL            volume_id: c5f26969-397c-491b-8ee6-a2e9df1f9b42          volume_size: 1            no_device: 0      connection_info: &#123;&quot;driver_volume_type&quot;: &quot;iscsi&quot;, &quot;data&quot;: &#123;&quot;target_discovered&quot;: false, &quot;target_portal&quot;: &quot;10.10.15.12:3260&quot;, &quot;target_iqn&quot;: &quot;iqn.2010-10.org.openstack:volume-c5f26969-397c-491b-8ee6-a2e9df1f9b42&quot;, &quot;target_lun&quot;: 0, &quot;volume_id&quot;: &quot;c5f26969-397c-491b-8ee6-a2e9df1f9b42&quot;, &quot;auth_method&quot;: &quot;CHAP&quot;, &quot;auth_username&quot;: &quot;MDksZ4gonTVKwayfr2fB&quot;, &quot;auth_password&quot;: &quot;jjEXzRGtzbFKiB6m&quot;, &quot;encrypted&quot;: false, &quot;qos_specs&quot;: null, &quot;access_mode&quot;: &quot;rw&quot;, &quot;device_path&quot;: &quot;/dev/sdg&quot;&#125;, &quot;status&quot;: &quot;reserved&quot;, &quot;instance&quot;: &quot;5ace35d4-7195-465e-afca-2c81279bb677&quot;, &quot;attached_at&quot;: &quot;&quot;, &quot;detached_at&quot;: &quot;&quot;, &quot;volume_id&quot;: &quot;c5f26969-397c-491b-8ee6-a2e9df1f9b42&quot;, &quot;serial&quot;: &quot;c5f26969-397c-491b-8ee6-a2e9df1f9b42&quot;&#125;        instance_uuid: 5ace35d4-7195-465e-afca-2c81279bb677              deleted: 0          source_type: image     destination_type: volume         guest_format: NULL          device_type: cdrom             disk_bus: ide           boot_index: NULL             image_id: eb2006ba-6416-4b68-b8bf-b358589fba34                  tag: NULL        attachment_id: c45a1ce7-16b0-4319-90d0-2a08463cc220                 uuid: 94a9eb85-e31b-41cd-bf07-431d7a6f9534          volume_type: NULL*************************** 3. row ***************************           created_at: 2023-05-12 02:19:10           updated_at: 2023-05-12 02:19:11           deleted_at: NULL                   id: 8748          device_name: /dev/vdadelete_on_termination: 0          snapshot_id: NULL            volume_id: d1e96c3b-7a2a-478d-ab98-de94aefcbc0e          volume_size: NULL            no_device: NULL      connection_info: NULL        instance_uuid: 5ace35d4-7195-465e-afca-2c81279bb677              deleted: 0          source_type: volume     destination_type: volume         guest_format: NULL          device_type: NULL             disk_bus: NULL           boot_index: NULL             image_id: NULL                  tag: NULL        attachment_id: 418d9322-eef3-4b15-9ca0-fbda0d7c9140                 uuid: b5f6b25d-44f3-416e-aab3-3ce350607d4a          volume_type: NULL3 rows in set (0.001 sec)\n\nxml配置文件。\n1234567891011121314151617181920212223242526272829303132333435363738394041&lt;domain type=&#x27;kvm&#x27; id=&#x27;69&#x27;&gt;  &lt;name&gt;instance-0000138e&lt;/name&gt;  &lt;uuid&gt;5ace35d4-7195-465e-afca-2c81279bb677&lt;/uuid&gt;  ...  &lt;devices&gt;    &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;    &lt;disk type=&#x27;file&#x27; device=&#x27;cdrom&#x27;&gt;      &lt;driver name=&#x27;qemu&#x27; type=&#x27;qcow2&#x27; cache=&#x27;none&#x27;/&gt;      &lt;source file=&#x27;/var/lib/nova/instances/5ace35d4-7195-465e-afca-2c81279bb677/disk&#x27; index=&#x27;2&#x27;/&gt;      &lt;backingStore type=&#x27;file&#x27; index=&#x27;3&#x27;&gt;        &lt;format type=&#x27;raw&#x27;/&gt;        &lt;source file=&#x27;/var/lib/nova/instances/_base/77a37f6c71682eba3d2f883c4736edd52b431752&#x27;/&gt;        &lt;backingStore/&gt;      &lt;/backingStore&gt;      &lt;target dev=&#x27;hda&#x27; bus=&#x27;ide&#x27;/&gt;      &lt;readonly/&gt;      &lt;alias name=&#x27;ide0-0-0&#x27;/&gt;      &lt;address type=&#x27;drive&#x27; controller=&#x27;0&#x27; bus=&#x27;0&#x27; target=&#x27;0&#x27; unit=&#x27;0&#x27;/&gt;    &lt;/disk&gt;    &lt;disk type=&#x27;block&#x27; device=&#x27;cdrom&#x27;&gt;      &lt;driver name=&#x27;qemu&#x27; type=&#x27;raw&#x27; cache=&#x27;none&#x27; io=&#x27;native&#x27;/&gt;      &lt;source dev=&#x27;/dev/sdg&#x27; index=&#x27;1&#x27;/&gt;      &lt;backingStore/&gt;      &lt;target dev=&#x27;hdb&#x27; bus=&#x27;ide&#x27;/&gt;      &lt;readonly/&gt;      &lt;serial&gt;c5f26969-397c-491b-8ee6-a2e9df1f9b42&lt;/serial&gt;      &lt;alias name=&#x27;ide0-0-1&#x27;/&gt;      &lt;address type=&#x27;drive&#x27; controller=&#x27;0&#x27; bus=&#x27;0&#x27; target=&#x27;0&#x27; unit=&#x27;1&#x27;/&gt;    &lt;/disk&gt;    &lt;disk type=&#x27;block&#x27; device=&#x27;disk&#x27;&gt;      &lt;driver name=&#x27;qemu&#x27; type=&#x27;raw&#x27; cache=&#x27;none&#x27; io=&#x27;native&#x27;/&gt;      &lt;source dev=&#x27;/dev/sdh&#x27; index=&#x27;4&#x27;/&gt;      &lt;backingStore/&gt;      &lt;target dev=&#x27;vda&#x27; bus=&#x27;virtio&#x27;/&gt;      &lt;serial&gt;d1e96c3b-7a2a-478d-ab98-de94aefcbc0e&lt;/serial&gt;      &lt;alias name=&#x27;virtio-disk0&#x27;/&gt;      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x06&#x27; function=&#x27;0x0&#x27;/&gt;    &lt;/disk&gt;    ...  &lt;/devices&gt;&lt;/domain&gt;\n\n硬重启实例5ace35d4-7195-465e-afca-2c81279bb677。\n1openstack server reboot --hard 5ace35d4-7195-465e-afca-2c81279bb677\n\n1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677select * from block_device_mapping where instance_uuid=&quot;5ace35d4-7195-465e-afca-2c81279bb677&quot; \\G*************************** 1. row ***************************           created_at: 2023-05-12 02:10:28           updated_at: 2023-05-12 02:10:28           deleted_at: NULL                   id: 8746          device_name: /dev/hdadelete_on_termination: 1          snapshot_id: NULL            volume_id: NULL          volume_size: NULL            no_device: 0      connection_info: NULL        instance_uuid: 5ace35d4-7195-465e-afca-2c81279bb677              deleted: 0          source_type: image     destination_type: local         guest_format: NULL          device_type: NULL             disk_bus: NULL           boot_index: 0             image_id: 60f8adab-fceb-47a2-a32a-f19d2351177e                  tag: NULL        attachment_id: NULL                 uuid: 6de66a02-6efb-4ce0-89a1-fa477f976909          volume_type: NULL*************************** 2. row ***************************           created_at: 2023-05-12 02:10:28           updated_at: 2023-05-12 02:22:46           deleted_at: NULL                   id: 8747          device_name: /dev/hdbdelete_on_termination: 0          snapshot_id: NULL            volume_id: c5f26969-397c-491b-8ee6-a2e9df1f9b42          volume_size: 1            no_device: 0      connection_info: &#123;&quot;driver_volume_type&quot;: &quot;iscsi&quot;, &quot;data&quot;: &#123;&quot;target_discovered&quot;: false, &quot;target_portal&quot;: &quot;10.10.15.12:3260&quot;, &quot;target_iqn&quot;: &quot;iqn.2010-10.org.openstack:volume-c5f26969-397c-491b-8ee6-a2e9df1f9b42&quot;, &quot;target_lun&quot;: 0, &quot;volume_id&quot;: &quot;c5f26969-397c-491b-8ee6-a2e9df1f9b42&quot;, &quot;auth_method&quot;: &quot;CHAP&quot;, &quot;auth_username&quot;: &quot;MDksZ4gonTVKwayfr2fB&quot;, &quot;auth_password&quot;: &quot;jjEXzRGtzbFKiB6m&quot;, &quot;encrypted&quot;: false, &quot;qos_specs&quot;: null, &quot;access_mode&quot;: &quot;rw&quot;, &quot;device_path&quot;: &quot;/dev/sdh&quot;&#125;, &quot;status&quot;: &quot;reserved&quot;, &quot;instance&quot;: &quot;5ace35d4-7195-465e-afca-2c81279bb677&quot;, &quot;attached_at&quot;: &quot;&quot;, &quot;detached_at&quot;: &quot;&quot;, &quot;volume_id&quot;: &quot;c5f26969-397c-491b-8ee6-a2e9df1f9b42&quot;, &quot;serial&quot;: &quot;c5f26969-397c-491b-8ee6-a2e9df1f9b42&quot;&#125;        instance_uuid: 5ace35d4-7195-465e-afca-2c81279bb677              deleted: 0          source_type: image     destination_type: volume         guest_format: NULL          device_type: cdrom             disk_bus: ide           boot_index: NULL             image_id: eb2006ba-6416-4b68-b8bf-b358589fba34                  tag: NULL        attachment_id: c45a1ce7-16b0-4319-90d0-2a08463cc220                 uuid: 94a9eb85-e31b-41cd-bf07-431d7a6f9534          volume_type: NULL*************************** 3. row ***************************           created_at: 2023-05-12 02:19:10           updated_at: 2023-05-12 02:22:45           deleted_at: NULL                   id: 8748          device_name: /dev/vdadelete_on_termination: 0          snapshot_id: NULL            volume_id: d1e96c3b-7a2a-478d-ab98-de94aefcbc0e          volume_size: 100            no_device: NULL      connection_info: &#123;&quot;driver_volume_type&quot;: &quot;iscsi&quot;, &quot;data&quot;: &#123;&quot;target_discovered&quot;: false, &quot;target_portal&quot;: &quot;10.10.15.12:3260&quot;, &quot;target_iqn&quot;: &quot;iqn.2010-10.org.openstack:volume-d1e96c3b-7a2a-478d-ab98-de94aefcbc0e&quot;, &quot;target_lun&quot;: 0, &quot;volume_id&quot;: &quot;d1e96c3b-7a2a-478d-ab98-de94aefcbc0e&quot;, &quot;auth_method&quot;: &quot;CHAP&quot;, &quot;auth_username&quot;: &quot;7KCnU2hmY9nkUuAoM5Nc&quot;, &quot;auth_password&quot;: &quot;4SMDpNsTFFmzjJi5&quot;, &quot;encrypted&quot;: false, &quot;qos_specs&quot;: null, &quot;access_mode&quot;: &quot;rw&quot;, &quot;device_path&quot;: &quot;/dev/sdg&quot;&#125;, &quot;status&quot;: &quot;reserved&quot;, &quot;instance&quot;: &quot;5ace35d4-7195-465e-afca-2c81279bb677&quot;, &quot;attached_at&quot;: &quot;&quot;, &quot;detached_at&quot;: &quot;&quot;, &quot;volume_id&quot;: &quot;d1e96c3b-7a2a-478d-ab98-de94aefcbc0e&quot;, &quot;serial&quot;: &quot;d1e96c3b-7a2a-478d-ab98-de94aefcbc0e&quot;&#125;        instance_uuid: 5ace35d4-7195-465e-afca-2c81279bb677              deleted: 0          source_type: volume     destination_type: volume         guest_format: NULL          device_type: disk             disk_bus: virtio           boot_index: NULL             image_id: NULL                  tag: NULL        attachment_id: 418d9322-eef3-4b15-9ca0-fbda0d7c9140                 uuid: b5f6b25d-44f3-416e-aab3-3ce350607d4a          volume_type: NULL3 rows in set (0.001 sec)\n\n123456789101112131415161718192021222324252627282930313233343536373839404142&lt;domain type=&#x27;kvm&#x27; id=&#x27;70&#x27;&gt;  &lt;name&gt;instance-0000138e&lt;/name&gt;  &lt;uuid&gt;5ace35d4-7195-465e-afca-2c81279bb677&lt;/uuid&gt;  ...  &lt;devices&gt;    &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;    &lt;disk type=&#x27;file&#x27; device=&#x27;cdrom&#x27;&gt;      &lt;driver name=&#x27;qemu&#x27; type=&#x27;qcow2&#x27; cache=&#x27;none&#x27;/&gt;      &lt;source file=&#x27;/var/lib/nova/instances/5ace35d4-7195-465e-afca-2c81279bb677/disk&#x27; index=&#x27;3&#x27;/&gt;      &lt;backingStore type=&#x27;file&#x27; index=&#x27;4&#x27;&gt;        &lt;format type=&#x27;raw&#x27;/&gt;        &lt;source file=&#x27;/var/lib/nova/instances/_base/77a37f6c71682eba3d2f883c4736edd52b431752&#x27;/&gt;        &lt;backingStore/&gt;      &lt;/backingStore&gt;      &lt;target dev=&#x27;hda&#x27; bus=&#x27;ide&#x27;/&gt;      &lt;readonly/&gt;      &lt;alias name=&#x27;ide0-0-0&#x27;/&gt;      &lt;address type=&#x27;drive&#x27; controller=&#x27;0&#x27; bus=&#x27;0&#x27; target=&#x27;0&#x27; unit=&#x27;0&#x27;/&gt;    &lt;/disk&gt;    &lt;disk type=&#x27;block&#x27; device=&#x27;cdrom&#x27;&gt;      &lt;driver name=&#x27;qemu&#x27; type=&#x27;raw&#x27; cache=&#x27;none&#x27; io=&#x27;native&#x27;/&gt;      &lt;source dev=&#x27;/dev/sdh&#x27; index=&#x27;2&#x27;/&gt;      &lt;backingStore/&gt;      &lt;target dev=&#x27;hdb&#x27; bus=&#x27;ide&#x27;/&gt;      &lt;readonly/&gt;      &lt;serial&gt;c5f26969-397c-491b-8ee6-a2e9df1f9b42&lt;/serial&gt;      &lt;alias name=&#x27;ide0-0-1&#x27;/&gt;      &lt;address type=&#x27;drive&#x27; controller=&#x27;0&#x27; bus=&#x27;0&#x27; target=&#x27;0&#x27; unit=&#x27;1&#x27;/&gt;    &lt;/disk&gt;    &lt;disk type=&#x27;block&#x27; device=&#x27;disk&#x27;&gt;      &lt;driver name=&#x27;qemu&#x27; type=&#x27;raw&#x27; cache=&#x27;none&#x27; io=&#x27;native&#x27;/&gt;      &lt;source dev=&#x27;/dev/sdg&#x27; index=&#x27;1&#x27;/&gt;      &lt;backingStore/&gt;      &lt;target dev=&#x27;vda&#x27; bus=&#x27;virtio&#x27;/&gt;      &lt;serial&gt;d1e96c3b-7a2a-478d-ab98-de94aefcbc0e&lt;/serial&gt;      &lt;alias name=&#x27;virtio-disk0&#x27;/&gt;      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x04&#x27; function=&#x27;0x0&#x27;/&gt;    &lt;/disk&gt;    ...  &lt;/devices&gt;&lt;/domain&gt;\n\n进入系统的安装界面后开始安装windows系统。安装完成后，在实例内部重启系统，会进入系统安装界面，硬重启后解决。\n1234567891011121314151617181920212223242526272829303132333435363738394041&lt;domain type=&#x27;kvm&#x27; id=&#x27;70&#x27;&gt;  &lt;name&gt;instance-0000138e&lt;/name&gt;  &lt;uuid&gt;5ace35d4-7195-465e-afca-2c81279bb677&lt;/uuid&gt;  ...  &lt;devices&gt;    &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;    &lt;disk type=&#x27;file&#x27; device=&#x27;cdrom&#x27;&gt;      &lt;driver name=&#x27;qemu&#x27; type=&#x27;qcow2&#x27; cache=&#x27;none&#x27;/&gt;      &lt;source file=&#x27;/var/lib/nova/instances/5ace35d4-7195-465e-afca-2c81279bb677/disk&#x27; index=&#x27;3&#x27;/&gt;      &lt;backingStore type=&#x27;file&#x27; index=&#x27;4&#x27;&gt;        &lt;format type=&#x27;raw&#x27;/&gt;        &lt;source file=&#x27;/var/lib/nova/instances/_base/77a37f6c71682eba3d2f883c4736edd52b431752&#x27;/&gt;        &lt;backingStore/&gt;      &lt;/backingStore&gt;      &lt;target dev=&#x27;hda&#x27; bus=&#x27;ide&#x27;/&gt;      &lt;readonly/&gt;      &lt;alias name=&#x27;ide0-0-0&#x27;/&gt;      &lt;address type=&#x27;drive&#x27; controller=&#x27;0&#x27; bus=&#x27;0&#x27; target=&#x27;0&#x27; unit=&#x27;0&#x27;/&gt;    &lt;/disk&gt;    &lt;disk type=&#x27;block&#x27; device=&#x27;cdrom&#x27;&gt;      &lt;driver name=&#x27;qemu&#x27; type=&#x27;raw&#x27; cache=&#x27;none&#x27; io=&#x27;native&#x27;/&gt;      &lt;source dev=&#x27;/dev/sdh&#x27; index=&#x27;2&#x27;/&gt;      &lt;backingStore/&gt;      &lt;target dev=&#x27;hdb&#x27; bus=&#x27;ide&#x27;/&gt;      &lt;readonly/&gt;      &lt;serial&gt;c5f26969-397c-491b-8ee6-a2e9df1f9b42&lt;/serial&gt;      &lt;alias name=&#x27;ide0-0-1&#x27;/&gt;      &lt;address type=&#x27;drive&#x27; controller=&#x27;0&#x27; bus=&#x27;0&#x27; target=&#x27;0&#x27; unit=&#x27;1&#x27;/&gt;    &lt;/disk&gt;    &lt;disk type=&#x27;block&#x27; device=&#x27;disk&#x27;&gt;      &lt;driver name=&#x27;qemu&#x27; type=&#x27;raw&#x27; cache=&#x27;none&#x27; io=&#x27;native&#x27;/&gt;      &lt;source dev=&#x27;/dev/sdg&#x27; index=&#x27;1&#x27;/&gt;      &lt;backingStore/&gt;      &lt;target dev=&#x27;vda&#x27; bus=&#x27;virtio&#x27;/&gt;      &lt;serial&gt;d1e96c3b-7a2a-478d-ab98-de94aefcbc0e&lt;/serial&gt;      &lt;alias name=&#x27;virtio-disk0&#x27;/&gt;      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x04&#x27; function=&#x27;0x0&#x27;/&gt;    &lt;/disk&gt;    ...  &lt;/devices&gt;&lt;/domain&gt;\n\nUbuntu镜像创建磁盘。\n12345678910111213141516171819202122232425openstack volume create --size 100 --availability-zone nova --bootable wkt-ubuntu-test-volume+---------------------+--------------------------------------+| Field               | Value                                |+---------------------+--------------------------------------+| attachments         | []                                   || availability_zone   | nova                                 || bootable            | false                                || consistencygroup_id | None                                 || created_at          | 2023-05-12T06:50:54.000000           || description         | None                                 || encrypted           | False                                || id                  | 9275c580-6679-4f60-810b-06ca11ae8742 || migration_status    | None                                 || multiattach         | False                                || name                | wkt-ubuntu-test-volume               || properties          |                                      || replication_status  | None                                 || size                | 100                                  || snapshot_id         | None                                 || source_volid        | None                                 || status              | creating                             || type                | __DEFAULT__                          || updated_at          | None                                 || user_id             | 24d08826a98140ce8e2ade2606ff9ad8     |+---------------------+--------------------------------------+\n\n创建实例，ID是dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361。\n12345openstack server create --availability-zone cloud \\--flavor 8-8-0 \\--image 82f524ed-4d97-445f-b527-f5299c5d0b3b \\--network 7b6c69b5-bfa5-4145-901c-26979103da77 \\wkt-ubuntu-test\n\n查看block_device_mapping表。\n123456789101112131415161718192021222324252627select * from block_device_mapping where instance_uuid=&quot;dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361&quot; \\G*************************** 1. row ***************************           created_at: 2023-05-12 06:54:05           updated_at: 2023-05-12 06:54:06           deleted_at: NULL                   id: 8751          device_name: /dev/hdadelete_on_termination: 1          snapshot_id: NULL            volume_id: NULL          volume_size: NULL            no_device: 0      connection_info: NULL        instance_uuid: dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361              deleted: 0          source_type: image     destination_type: local         guest_format: NULL          device_type: disk             disk_bus: NULL           boot_index: 0             image_id: 82f524ed-4d97-445f-b527-f5299c5d0b3b                  tag: NULL        attachment_id: NULL                 uuid: 8e57c44d-9fb5-44d9-807d-ae4c675a1c91          volume_type: NULL1 row in set (0.001 sec)\n\nxml配置文件。\n123456789101112131415161718192021&lt;domain type=&#x27;kvm&#x27; id=&#x27;73&#x27;&gt;  &lt;name&gt;instance-00001391&lt;/name&gt;  ...  &lt;devices&gt;    &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;    &lt;disk type=&#x27;file&#x27; device=&#x27;cdrom&#x27;&gt;      &lt;driver name=&#x27;qemu&#x27; type=&#x27;qcow2&#x27; cache=&#x27;none&#x27;/&gt;      &lt;source file=&#x27;/var/lib/nova/instances/dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361/disk&#x27; index=&#x27;1&#x27;/&gt;      &lt;backingStore type=&#x27;file&#x27; index=&#x27;2&#x27;&gt;        &lt;format type=&#x27;raw&#x27;/&gt;        &lt;source file=&#x27;/var/lib/nova/instances/_base/d2db90ced7b2064373138e505ea3ed5a0b6374c7&#x27;/&gt;        &lt;backingStore/&gt;      &lt;/backingStore&gt;      &lt;target dev=&#x27;hda&#x27; bus=&#x27;ide&#x27;/&gt;      &lt;readonly/&gt;      &lt;alias name=&#x27;ide0-0-0&#x27;/&gt;      &lt;address type=&#x27;drive&#x27; controller=&#x27;0&#x27; bus=&#x27;0&#x27; target=&#x27;0&#x27; unit=&#x27;0&#x27;/&gt;    &lt;/disk&gt;    ...  &lt;/devices&gt;&lt;/domain&gt;\n\n添加磁盘。\n1openstack server add volume dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361 9275c580-6679-4f60-810b-06ca11ae8742\n\n查看block_device_mapping表。\n12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152select * from block_device_mapping where instance_uuid=&quot;dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361&quot; \\G*************************** 1. row ***************************           created_at: 2023-05-12 06:54:05           updated_at: 2023-05-12 06:54:06           deleted_at: NULL                   id: 8751          device_name: /dev/hdadelete_on_termination: 1          snapshot_id: NULL            volume_id: NULL          volume_size: NULL            no_device: 0      connection_info: NULL        instance_uuid: dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361              deleted: 0          source_type: image     destination_type: local         guest_format: NULL          device_type: disk             disk_bus: NULL           boot_index: 0             image_id: 82f524ed-4d97-445f-b527-f5299c5d0b3b                  tag: NULL        attachment_id: NULL                 uuid: 8e57c44d-9fb5-44d9-807d-ae4c675a1c91          volume_type: NULL*************************** 2. row ***************************           created_at: 2023-05-12 07:00:52           updated_at: 2023-05-12 07:00:58           deleted_at: NULL                   id: 8752          device_name: /dev/vdadelete_on_termination: 0          snapshot_id: NULL            volume_id: 9275c580-6679-4f60-810b-06ca11ae8742          volume_size: 100            no_device: NULL      connection_info: &#123;&quot;driver_volume_type&quot;: &quot;iscsi&quot;, &quot;data&quot;: &#123;&quot;target_discovered&quot;: false, &quot;target_portal&quot;: &quot;10.10.15.12:3260&quot;, &quot;target_iqn&quot;: &quot;iqn.2010-10.org.openstack:volume-9275c580-6679-4f60-810b-06ca11ae8742&quot;, &quot;target_lun&quot;: 0, &quot;volume_id&quot;: &quot;9275c580-6679-4f60-810b-06ca11ae8742&quot;, &quot;auth_method&quot;: &quot;CHAP&quot;, &quot;auth_username&quot;: &quot;WEXNsUK3tjc7fB7Y7NoH&quot;, &quot;auth_password&quot;: &quot;CHpWUeYpQTmA4UMQ&quot;, &quot;encrypted&quot;: false, &quot;qos_specs&quot;: null, &quot;access_mode&quot;: &quot;rw&quot;, &quot;device_path&quot;: &quot;/dev/sdi&quot;&#125;, &quot;status&quot;: &quot;reserved&quot;, &quot;instance&quot;: &quot;dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361&quot;, &quot;attached_at&quot;: &quot;&quot;, &quot;detached_at&quot;: &quot;&quot;, &quot;volume_id&quot;: &quot;9275c580-6679-4f60-810b-06ca11ae8742&quot;, &quot;serial&quot;: &quot;9275c580-6679-4f60-810b-06ca11ae8742&quot;&#125;        instance_uuid: dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361              deleted: 0          source_type: volume     destination_type: volume         guest_format: NULL          device_type: NULL             disk_bus: NULL           boot_index: NULL             image_id: NULL                  tag: NULL        attachment_id: 95e2231a-919a-4a3e-8b2f-7549756fb293                 uuid: 5158750e-4680-4a13-990b-6ee735087162          volume_type: NULL2 rows in set (0.000 sec)\n\nxml配置文件\n12345678910111213141516171819202122232425262728293031&lt;domain type=&#x27;kvm&#x27; id=&#x27;73&#x27;&gt;  &lt;name&gt;instance-00001391&lt;/name&gt;  &lt;uuid&gt;dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361&lt;/uuid&gt;  ...  &lt;devices&gt;    &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;    &lt;disk type=&#x27;file&#x27; device=&#x27;cdrom&#x27;&gt;      &lt;driver name=&#x27;qemu&#x27; type=&#x27;qcow2&#x27; cache=&#x27;none&#x27;/&gt;      &lt;source file=&#x27;/var/lib/nova/instances/dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361/disk&#x27; index=&#x27;1&#x27;/&gt;      &lt;backingStore type=&#x27;file&#x27; index=&#x27;2&#x27;&gt;        &lt;format type=&#x27;raw&#x27;/&gt;        &lt;source file=&#x27;/var/lib/nova/instances/_base/d2db90ced7b2064373138e505ea3ed5a0b6374c7&#x27;/&gt;        &lt;backingStore/&gt;      &lt;/backingStore&gt;      &lt;target dev=&#x27;hda&#x27; bus=&#x27;ide&#x27;/&gt;      &lt;readonly/&gt;      &lt;alias name=&#x27;ide0-0-0&#x27;/&gt;      &lt;address type=&#x27;drive&#x27; controller=&#x27;0&#x27; bus=&#x27;0&#x27; target=&#x27;0&#x27; unit=&#x27;0&#x27;/&gt;    &lt;/disk&gt;    &lt;disk type=&#x27;block&#x27; device=&#x27;disk&#x27;&gt;      &lt;driver name=&#x27;qemu&#x27; type=&#x27;raw&#x27; cache=&#x27;none&#x27; io=&#x27;native&#x27;/&gt;      &lt;source dev=&#x27;/dev/sdi&#x27; index=&#x27;3&#x27;/&gt;      &lt;backingStore/&gt;      &lt;target dev=&#x27;vda&#x27; bus=&#x27;virtio&#x27;/&gt;      &lt;serial&gt;9275c580-6679-4f60-810b-06ca11ae8742&lt;/serial&gt;      &lt;alias name=&#x27;virtio-disk0&#x27;/&gt;      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x06&#x27; function=&#x27;0x0&#x27;/&gt;    &lt;/disk&gt;    ...  &lt;/devices&gt;&lt;/domain&gt;\n\n将实例硬重启。\n1openstack server reboot --hard dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361\n\n查看block_device_mapping表。\n12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152select * from block_device_mapping where instance_uuid=&quot;dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361&quot; \\G*************************** 1. row ***************************           created_at: 2023-05-12 06:54:05           updated_at: 2023-05-12 06:54:06           deleted_at: NULL                   id: 8751          device_name: /dev/hdadelete_on_termination: 1          snapshot_id: NULL            volume_id: NULL          volume_size: NULL            no_device: 0      connection_info: NULL        instance_uuid: dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361              deleted: 0          source_type: image     destination_type: local         guest_format: NULL          device_type: disk             disk_bus: NULL           boot_index: 0             image_id: 82f524ed-4d97-445f-b527-f5299c5d0b3b                  tag: NULL        attachment_id: NULL                 uuid: 8e57c44d-9fb5-44d9-807d-ae4c675a1c91          volume_type: NULL*************************** 2. row ***************************           created_at: 2023-05-12 07:00:52           updated_at: 2023-05-12 07:04:11           deleted_at: NULL                   id: 8752          device_name: /dev/vdadelete_on_termination: 0          snapshot_id: NULL            volume_id: 9275c580-6679-4f60-810b-06ca11ae8742          volume_size: 100            no_device: NULL      connection_info: &#123;&quot;driver_volume_type&quot;: &quot;iscsi&quot;, &quot;data&quot;: &#123;&quot;target_discovered&quot;: false, &quot;target_portal&quot;: &quot;10.10.15.12:3260&quot;, &quot;target_iqn&quot;: &quot;iqn.2010-10.org.openstack:volume-9275c580-6679-4f60-810b-06ca11ae8742&quot;, &quot;target_lun&quot;: 0, &quot;volume_id&quot;: &quot;9275c580-6679-4f60-810b-06ca11ae8742&quot;, &quot;auth_method&quot;: &quot;CHAP&quot;, &quot;auth_username&quot;: &quot;WEXNsUK3tjc7fB7Y7NoH&quot;, &quot;auth_password&quot;: &quot;CHpWUeYpQTmA4UMQ&quot;, &quot;encrypted&quot;: false, &quot;qos_specs&quot;: null, &quot;access_mode&quot;: &quot;rw&quot;, &quot;device_path&quot;: &quot;/dev/sdi&quot;&#125;, &quot;status&quot;: &quot;reserved&quot;, &quot;instance&quot;: &quot;dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361&quot;, &quot;attached_at&quot;: &quot;&quot;, &quot;detached_at&quot;: &quot;&quot;, &quot;volume_id&quot;: &quot;9275c580-6679-4f60-810b-06ca11ae8742&quot;, &quot;serial&quot;: &quot;9275c580-6679-4f60-810b-06ca11ae8742&quot;&#125;        instance_uuid: dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361              deleted: 0          source_type: volume     destination_type: volume         guest_format: NULL          device_type: disk             disk_bus: virtio           boot_index: NULL             image_id: NULL                  tag: NULL        attachment_id: 95e2231a-919a-4a3e-8b2f-7549756fb293                 uuid: 5158750e-4680-4a13-990b-6ee735087162          volume_type: NULL2 rows in set (0.000 sec)\n\nxml配置文件。\n12345678910111213141516171819202122232425262728293031&lt;domain type=&#x27;kvm&#x27; id=&#x27;74&#x27;&gt;  &lt;name&gt;instance-00001391&lt;/name&gt;  &lt;uuid&gt;dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361&lt;/uuid&gt;  ...  &lt;devices&gt;    &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;    &lt;disk type=&#x27;file&#x27; device=&#x27;cdrom&#x27;&gt;      &lt;driver name=&#x27;qemu&#x27; type=&#x27;qcow2&#x27; cache=&#x27;none&#x27;/&gt;      &lt;source file=&#x27;/var/lib/nova/instances/dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361/disk&#x27; index=&#x27;2&#x27;/&gt;      &lt;backingStore type=&#x27;file&#x27; index=&#x27;3&#x27;&gt;        &lt;format type=&#x27;raw&#x27;/&gt;        &lt;source file=&#x27;/var/lib/nova/instances/_base/d2db90ced7b2064373138e505ea3ed5a0b6374c7&#x27;/&gt;        &lt;backingStore/&gt;      &lt;/backingStore&gt;      &lt;target dev=&#x27;hda&#x27; bus=&#x27;ide&#x27;/&gt;      &lt;readonly/&gt;      &lt;alias name=&#x27;ide0-0-0&#x27;/&gt;      &lt;address type=&#x27;drive&#x27; controller=&#x27;0&#x27; bus=&#x27;0&#x27; target=&#x27;0&#x27; unit=&#x27;0&#x27;/&gt;    &lt;/disk&gt;    &lt;disk type=&#x27;block&#x27; device=&#x27;disk&#x27;&gt;      &lt;driver name=&#x27;qemu&#x27; type=&#x27;raw&#x27; cache=&#x27;none&#x27; io=&#x27;native&#x27;/&gt;      &lt;source dev=&#x27;/dev/sdi&#x27; index=&#x27;1&#x27;/&gt;      &lt;backingStore/&gt;      &lt;target dev=&#x27;vda&#x27; bus=&#x27;virtio&#x27;/&gt;      &lt;serial&gt;9275c580-6679-4f60-810b-06ca11ae8742&lt;/serial&gt;      &lt;alias name=&#x27;virtio-disk0&#x27;/&gt;      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x04&#x27; function=&#x27;0x0&#x27;/&gt;    &lt;/disk&gt;    ...  &lt;/devices&gt;&lt;/domain&gt;\n\n更改block_device_mapping。\n1234567update block_device_mapping set boot_index=NULL where id=8751;Query OK, 1 row affected (0.002 sec)Rows matched: 1  Changed: 1  Warnings: 0MariaDB [nova]&gt; update block_device_mapping set boot_index=0 where id=8752;Query OK, 1 row affected (0.002 sec)Rows matched: 1  Changed: 1  Warnings: 0\n\n硬重启实例后，xml配置文件已修改。\n123456789101112131415161718&lt;domain type=&#x27;kvm&#x27; id=&#x27;75&#x27;&gt;  &lt;name&gt;instance-00001391&lt;/name&gt;  &lt;uuid&gt;dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361&lt;/uuid&gt;  ...  &lt;devices&gt;    &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;    &lt;disk type=&#x27;block&#x27; device=&#x27;disk&#x27;&gt;      &lt;driver name=&#x27;qemu&#x27; type=&#x27;raw&#x27; cache=&#x27;none&#x27; io=&#x27;native&#x27;/&gt;      &lt;source dev=&#x27;/dev/sdi&#x27; index=&#x27;1&#x27;/&gt;      &lt;backingStore/&gt;      &lt;target dev=&#x27;vda&#x27; bus=&#x27;virtio&#x27;/&gt;      &lt;serial&gt;9275c580-6679-4f60-810b-06ca11ae8742&lt;/serial&gt;      &lt;alias name=&#x27;virtio-disk0&#x27;/&gt;      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x04&#x27; function=&#x27;0x0&#x27;/&gt;    &lt;/disk&gt;    ...  &lt;/devices&gt;&lt;/domain&gt;","dateCreated":"2023-09-21T13:40:11+08:00","dateModified":"2023-12-25T17:33:39+08:00","datePublished":"2023-09-21T13:40:11+08:00","description":"OpenStack关于镜像的那些事儿","headline":"OpenStack漫游指南--镜像篇","image":["covers/LOL/Ezreal/Pulsefire-Ezreal.jpg","covers/LOL/Ezreal/Pulsefire-Ezreal.jpg"],"mainEntityOfPage":{"@type":"WebPage","@id":"https://wangkuntian.github.io/2023/09/21/OpenStack%E6%BC%AB%E6%B8%B8%E6%8C%87%E5%8D%97-%E9%95%9C%E5%83%8F%E7%AF%87/"},"publisher":{"@type":"Organization","name":"Wang kuntian","sameAs":["https://github.com/wangkuntian","mailto:wangkuntian1994@163.com"],"image":"faker.jpg","logo":{"@type":"ImageObject","url":"faker.jpg"}},"url":"https://wangkuntian.github.io/2023/09/21/OpenStack%E6%BC%AB%E6%B8%B8%E6%8C%87%E5%8D%97-%E9%95%9C%E5%83%8F%E7%AF%87/","keywords":"OpenStack, 镜像","thumbnailUrl":"covers/LOL/Ezreal/Pulsefire-Ezreal.jpg"}</script>
    <meta name="description" content="OpenStack关于镜像的那些事儿">
<meta property="og:type" content="blog">
<meta property="og:title" content="OpenStack漫游指南--镜像篇">
<meta property="og:url" content="https://wangkuntian.github.io/2023/09/21/OpenStack%E6%BC%AB%E6%B8%B8%E6%8C%87%E5%8D%97-%E9%95%9C%E5%83%8F%E7%AF%87/index.html">
<meta property="og:site_name" content="Wang kuntian&#39;s Blog">
<meta property="og:description" content="OpenStack关于镜像的那些事儿">
<meta property="og:locale" content="zh_EN">
<meta property="og:image" content="https://wangkuntian.github.io/2023/09/21/OpenStack%E6%BC%AB%E6%B8%B8%E6%8C%87%E5%8D%97-%E9%95%9C%E5%83%8F%E7%AF%87/images/docker-run.png">
<meta property="og:image" content="https://wangkuntian.github.io/2023/09/21/OpenStack%E6%BC%AB%E6%B8%B8%E6%8C%87%E5%8D%97-%E9%95%9C%E5%83%8F%E7%AF%87/images/git-clone.png">
<meta property="og:image" content="https://wangkuntian.github.io/2023/09/21/OpenStack%E6%BC%AB%E6%B8%B8%E6%8C%87%E5%8D%97-%E9%95%9C%E5%83%8F%E7%AF%87/images/git-status.png">
<meta property="og:image" content="https://wangkuntian.github.io/2023/09/21/OpenStack%E6%BC%AB%E6%B8%B8%E6%8C%87%E5%8D%97-%E9%95%9C%E5%83%8F%E7%AF%87/images/virtualenv.png">
<meta property="og:image" content="https://wangkuntian.github.io/2023/09/21/OpenStack%E6%BC%AB%E6%B8%B8%E6%8C%87%E5%8D%97-%E9%95%9C%E5%83%8F%E7%AF%87/images/horizon.png">
<meta property="article:published_time" content="2023-09-21T05:40:11.000Z">
<meta property="article:modified_time" content="2023-12-25T09:33:39.756Z">
<meta property="article:author" content="Wang kuntian">
<meta property="article:tag" content="OpenStack">
<meta property="article:tag" content="镜像">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://wangkuntian.github.io/2023/09/21/OpenStack%E6%BC%AB%E6%B8%B8%E6%8C%87%E5%8D%97-%E9%95%9C%E5%83%8F%E7%AF%87/images/docker-run.png">
    
    
        
    
    
        <meta property="og:image" content="https://wangkuntian.github.io/assets/images/faker.jpg"/>
    
    
        <meta property="og:image" content="https://wangkuntian.github.io/2023/09/21/OpenStack%E6%BC%AB%E6%B8%B8%E6%8C%87%E5%8D%97-%E9%95%9C%E5%83%8F%E7%AF%87/covers/LOL/Ezreal/Pulsefire-Ezreal.jpg"/>
        <meta class="swiftype" name="image" data-type="enum" content="https://wangkuntian.github.io/2023/09/21/OpenStack%E6%BC%AB%E6%B8%B8%E6%8C%87%E5%8D%97-%E9%95%9C%E5%83%8F%E7%AF%87/covers/LOL/Ezreal/Pulsefire-Ezreal.jpg"/>
    
    
        <meta property="og:image" content="https://wangkuntian.github.io/2023/09/21/OpenStack%E6%BC%AB%E6%B8%B8%E6%8C%87%E5%8D%97-%E9%95%9C%E5%83%8F%E7%AF%87/covers/LOL/Ezreal/Pulsefire-Ezreal.jpg"/>
        <meta class="swiftype" name="image" data-type="enum" content="https://wangkuntian.github.io/2023/09/21/OpenStack%E6%BC%AB%E6%B8%B8%E6%8C%87%E5%8D%97-%E9%95%9C%E5%83%8F%E7%AF%87/covers/LOL/Ezreal/Pulsefire-Ezreal.jpg"/>
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/style-bkzaqwnhdy35ne9gawopbfxp7lltc7yhde0uckf6kikurfjo9ztq2v5apuqa.min.css">

    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-136102260-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-136102260-1');
    </script>


    

    
        
    
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --></head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="4">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            Wang kuntian&#39;s Blog
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="Öffne den Link: /#about"
            >
        
        
            <img class="header-picture" src="/assets/images/faker.jpg" alt="Author&#39;s picture"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="4">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="Lesen Sie mehr über den Autor"
                >
                    <img class="sidebar-profile-picture" src="/assets/images/faker.jpg" alt="Author&#39;s picture"/>
                </a>
                <h4 class="sidebar-profile-name">Wang kuntian</h4>
                
                    <h5 class="sidebar-profile-bio"><p>Hi</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="Home"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="Categories"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="Tags"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="Archives"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link open-algolia-search"
                            href="#search"
                            
                            rel="noopener"
                            title="Search"
                        >
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Search</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="About"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/wangkuntian"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="mailto:wangkuntian1994@163.com"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Mail"
                        >
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Mail</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/atom.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
        <div class="post-header-cover
                    text-center
                    post-header-cover--full"
             style="background-image:url('/covers/LOL/Ezreal/Pulsefire-Ezreal.jpg');"
             data-behavior="4">
            
                <div class="post-header main-content-wrap text-center">
    
        <h1 class="post-title">
            OpenStack漫游指南--镜像篇
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2023-09-21T13:40:11+08:00">
	
		    Sep 21, 2023
    	
    </time>
    
</div>

    
</div>

            
        </div>

            <div id="main" data-behavior="4"
                 class="hasCover
                        hasCoverMetaIn
                        hasCoverCaption">
                
<article class="post">
    
        <span class="post-header-cover-caption caption">Pulsefire Ezreal</span>
    
    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <!-- excerpt -->

<h1 id="table-of-contents">目录</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%95%9C%E5%83%8F%E5%88%B6%E4%BD%9C"><span class="toc-text">镜像制作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8%E5%88%B6%E4%BD%9C"><span class="toc-text">手动制作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E7%B3%BB%E7%BB%9FISO"><span class="toc-text">准备系统ISO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E7%B3%BB%E7%BB%9F"><span class="toc-text">安装系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%AE%8C%E6%88%90%E5%90%8E"><span class="toc-text">安装完成后</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%B8%E8%BD%BDCD-ROM%E8%AE%BE%E5%A4%87"><span class="toc-text">卸载CD-ROM设备</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E9%95%9C%E5%83%8F"><span class="toc-text">配置镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%89%E8%A3%85ACPI%E6%9C%8D%E5%8A%A1"><span class="toc-text">安装ACPI服务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%89%E8%A3%85cloud-init"><span class="toc-text">安装cloud-init</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%A6%81%E7%94%A8firewalld"><span class="toc-text">禁用firewalld</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%A6%81%E7%94%A8zeroconf"><span class="toc-text">禁用zeroconf</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEconsole"><span class="toc-text">配置console</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEqemu-guest-agent%E6%9C%8D%E5%8A%A1"><span class="toc-text">配置qemu-guest-agent服务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%A6%81%E7%94%A8%E8%87%AA%E5%8A%A8%E9%80%80%E5%87%BA"><span class="toc-text">禁用自动退出</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">删除网络配置文件</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%97%AD%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-text">关闭虚拟机</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B8%85%E7%90%86%EF%BC%88%E7%A7%BB%E9%99%A4mac%E5%9C%B0%E5%9D%80%E7%AD%89%E4%BF%A1%E6%81%AF%EF%BC%89"><span class="toc-text">清理（移除mac地址等信息）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%95%9C%E5%83%8F%E5%8E%8B%E7%BC%A9"><span class="toc-text">镜像压缩</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%84%9A%E6%9C%AC%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA"><span class="toc-text">脚本自动化构建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E5%BB%BAdocker%E5%AE%B9%E5%99%A8"><span class="toc-text">构建docker容器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-text">安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96%E7%8E%AF%E5%A2%83"><span class="toc-text">依赖环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DIB"><span class="toc-text">DIB</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-text">测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%95%9C%E5%83%8F%E4%BF%AE%E6%94%B9"><span class="toc-text">镜像修改</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E4%BF%AE%E6%94%B9"><span class="toc-text">密码修改</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8guestfish"><span class="toc-text">使用guestfish</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8virt-customize"><span class="toc-text">使用virt-customize</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8horizon"><span class="toc-text">使用horizon</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E9%95%9C%E5%83%8F"><span class="toc-text">上传镜像</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8ISO%E5%90%AF%E5%8A%A8%E5%AE%9E%E4%BE%8B"><span class="toc-text">使用ISO启动实例</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#UOS%E9%95%9C%E5%83%8F"><span class="toc-text">UOS镜像</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows%E9%95%9C%E5%83%8F"><span class="toc-text">Windows镜像</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ubuntu%E9%95%9C%E5%83%8F"><span class="toc-text">Ubuntu镜像</span></a></li></ol></li></ol>

<h1 id="镜像制作"><a href="#镜像制作" class="headerlink" title="镜像制作"></a>镜像制作</h1><p>镜像制作在云环境是必不可少的步骤，主要分为手动制作和自动化脚本制作两种。</p>
<h2 id="手动制作"><a href="#手动制作" class="headerlink" title="手动制作"></a>手动制作</h2><p>以制作一个uos-server 1060a系统镜像为例，简要梳理手动制作一个OpenStack可用镜像的流程。本地系统也使用了uos-server 1060a。</p>
<h3 id="准备系统ISO"><a href="#准备系统ISO" class="headerlink" title="准备系统ISO"></a>准备系统ISO</h3><p>此处准备1060a系统ISO（<a target="_blank" rel="noopener" href="https://cdimage.uniontech.com/server-dev/1060/a/RC/RC4/amd64/uniontechos-server-20-1060a-amd64-RC4-20230421-0106.iso">下载地址</a>）：uniontechos-server-20-1060a-amd64-RC4-20230421-0106.iso </p>
<h3 id="安装系统"><a href="#安装系统" class="headerlink" title="安装系统"></a>安装系统</h3><p>可以使用virt-manager直接在图形化界面操作或者virt-install命令在命令行启动。</p>
<p>使用virt-manager安装时和常规图形界面创建虚拟机操作步骤一致。</p>
<p>使用命令行安装时参考命令如下，首先创建名为1060a，大小为10G的qcow2格式空镜像。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-img create -f qcow2 1060a.qcow2 10G</span><br></pre></td></tr></table></figure>
<p>然后使用准备好的ISO和镜像，创建名为1060a的虚拟机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo virt-install --virt-type kvm --name 1060a --ram 4096 \</span><br><span class="line">--cdrom=uniontechos-server-20-1060a-amd64-RC4-20230421-0106.iso \</span><br><span class="line">--disk 1060a.qcow2,bus=virtio,size=10,format=qcow2 \</span><br><span class="line">--network network=default \</span><br><span class="line">--graphics vnc,listen=0.0.0.0 \</span><br><span class="line">--os-type=linux --os-variant=generic</span><br></pre></td></tr></table></figure>

<p>安装时注意两点</p>
<ol>
<li>设置网络状态为ON（打开）。默认Ethernet设置为OFF（关闭）。修改为ON（打开）。并且，确认IPv4设置的方法为“自动（DHCP）” 。</li>
<li>在使用lvm分区时应该将swap分区删除，只保留“/”和“/boot”分区；在使用标准分区时只保留“/”分区即可。</li>
</ol>
<h3 id="安装完成后"><a href="#安装完成后" class="headerlink" title="安装完成后"></a>安装完成后</h3><h4 id="卸载CD-ROM设备"><a href="#卸载CD-ROM设备" class="headerlink" title="卸载CD-ROM设备"></a>卸载CD-ROM设备</h4><p>使用virt-manager时，直接在图形化界面删除。也可通过命令行操作。先使用virsh命令查看相应设备。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virsh dumpxml 1060a</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">domain</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>1060a<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">...</span><br><span class="line">    <span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">&#x27;block&#x27;</span> <span class="attr">device</span>=<span class="string">&#x27;cdrom&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;qemu&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;raw&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;hda&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;ide&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">readonly</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;drive&#x27;</span> <span class="attr">controller</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">target</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;/<span class="name">domain</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后再利用命令行卸载，并重启虚拟机。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">virsh attach-disk --<span class="built_in">type</span> cdrom --mode <span class="built_in">readonly</span> 1060a <span class="string">&quot;&quot;</span> hd</span><br><span class="line">virsh reboot 1060a</span><br></pre></td></tr></table></figure>

<h4 id="配置镜像"><a href="#配置镜像" class="headerlink" title="配置镜像"></a>配置镜像</h4><p>进入镜像系统内部，完成如下操作。</p>
<h5 id="安装ACPI服务"><a href="#安装ACPI服务" class="headerlink" title="安装ACPI服务"></a>安装ACPI服务</h5><p>acpid是一个用户空间的服务进程, 用来处理电源相关事件。libvirt可以通过向guest虚拟机发送acpid事件触发电源操作，使虚拟机安全关机、重启等操作。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dnf install acpid -y</span><br><span class="line">systemctl <span class="built_in">enable</span> acpid</span><br></pre></td></tr></table></figure>

<h5 id="安装cloud-init"><a href="#安装cloud-init" class="headerlink" title="安装cloud-init"></a>安装cloud-init</h5><p>cloud-init是虚拟机第一次启动时执行的脚本，主要负责从metadata服务中拉取配置信息，完成虚拟机的初始化工作，比如设置主机名、初始化密码以及注入密钥等。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install cloud-init -y</span><br></pre></td></tr></table></figure>

<p>编辑/etc/cloud/cloud.cfg配置文件，允许root通过password ssh登录。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">disable_root:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">ssh_pwauth:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>如上配置便于非生产环境使用，生产环境建议disable_root设为1，ssh_pwauth设为0。不开启密码登录功能，使用密钥登录更安全；同时不开启root远程登录。</p>
<p>修改root密码（可选），编辑/etc/cloud/cloud.cfg配置文件。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意：新版本cloud-ini的chpasswd中的list已经被users取代，可以通过指定type，改变密码的类型，默认是hash。</span></span><br><span class="line"><span class="attr">chpasswd:</span></span><br><span class="line">   <span class="attr">expire:</span> <span class="literal">false</span></span><br><span class="line">   <span class="attr">list:</span> <span class="string">|</span></span><br><span class="line">     <span class="string">root:qwe123!@#</span></span><br></pre></td></tr></table></figure>

<p>关闭cloud-init网络配置，网络配置应该由openstack控制，所以关闭。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">network:</span></span><br><span class="line">  <span class="attr">config:</span> <span class="string">disabled</span></span><br></pre></td></tr></table></figure>

<p>配置自动扩容，安装cloud-utils-growpart以允许根分区自动扩容。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install cloud-utils-growpart -y</span><br></pre></td></tr></table></figure>

<p>编辑cloud-init配置文件。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cloud-config</span></span><br><span class="line"><span class="attr">growpart:</span></span><br><span class="line">  <span class="attr">mode:</span> <span class="string">auto</span></span><br><span class="line">  <span class="attr">devices:</span> [<span class="string">/dev/vda2</span>]</span><br><span class="line">  <span class="attr">ignore_growroot_disabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">bootcmd:</span></span><br><span class="line"><span class="bullet">-</span> [<span class="string">cloud-init-per</span>,<span class="string">once</span>,<span class="string">mygrowpart</span>,<span class="string">growpart</span>,<span class="string">/dev/vda</span>,<span class="number">2</span>]</span><br><span class="line"><span class="bullet">-</span> [<span class="string">cloud-init-per</span>,<span class="string">once</span>,<span class="string">mypartprobe</span>,<span class="string">partprobe</span>,<span class="string">-s</span>,<span class="string">/dev/vda2</span>]</span><br><span class="line"><span class="bullet">-</span> [<span class="string">cloud-init-per</span>,<span class="string">once</span>,<span class="string">mypvresize</span>,<span class="string">pvresize</span>,<span class="string">/dev/vda2</span>]</span><br><span class="line"><span class="bullet">-</span> [<span class="string">cloud-init-per</span>,<span class="string">once</span>,<span class="string">mylvextend</span>,<span class="string">lvextend</span>,<span class="string">-l</span>,<span class="string">+100%FREE</span>,<span class="string">/dev/mapper/uos-root</span>]</span><br><span class="line"><span class="bullet">-</span> [<span class="string">cloud-init-per</span>,<span class="string">once</span>,<span class="string">myxfs_growfs</span>,<span class="string">xfs_growfs</span>,<span class="string">/dev/mapper/uos-root</span>]</span><br></pre></td></tr></table></figure>

<p>需要根据具体环境情况修改配置文件，例如1050a中是uniontechos-root，而1060a中是uos-root。<br>如果是非lvm分区安装，需要改成下面所示。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">bootcmd:</span></span><br><span class="line">  <span class="bullet">-</span> [ <span class="string">cloud-init-per</span>, <span class="string">once</span>, <span class="string">grow-partition</span>, <span class="string">growpart</span>, <span class="string">/dev/vda</span>, <span class="number">1</span> ]</span><br><span class="line">  <span class="bullet">-</span> [ <span class="string">cloud-init-per</span>, <span class="string">once</span>, <span class="string">resize-filesystem</span>, <span class="string">xfs_growfs</span>, <span class="string">/dev/vda1</span> ]</span><br></pre></td></tr></table></figure>

<p>正确设置字符集，否则执行growpart会出错。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LANG=en_US.UTF-8</span><br></pre></td></tr></table></figure>

<h5 id="禁用firewalld"><a href="#禁用firewalld" class="headerlink" title="禁用firewalld"></a>禁用firewalld</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">disable</span> firewalld.service</span><br></pre></td></tr></table></figure>

<h5 id="禁用zeroconf"><a href="#禁用zeroconf" class="headerlink" title="禁用zeroconf"></a>禁用zeroconf</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;NOZEROCONF=yes&quot;</span> &gt;&gt; /etc/sysconfig/network</span><br></pre></td></tr></table></figure>

<h5 id="配置console"><a href="#配置console" class="headerlink" title="配置console"></a>配置console</h5><p>编辑 /etc/default/grub文件，配置GRUB_CMDLINE_LINUX选项。删除“rhgb quiet”，添加“console=tty0 console=ttyS0,115200n8”。使nova能够获取console log。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GRUB_CMDLINE_LINUX=<span class="string">&quot;crashkernel=auto elevator=none console=tty0 console=ttyS0,115200n8&quot;</span></span><br><span class="line">GRUB_CMDLINE_LINUX=<span class="string">&quot;crashkernel=auto rd.lvm.lv=uniontechos/root elevator=none console=tty0 console=ttyS0,115200n8&quot;</span></span><br></pre></td></tr></table></figure>

<p>运行如下命令，保存更改：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grub2-mkconfig -o /boot/grub2/grub.cfg</span><br></pre></td></tr></table></figure>

<p>启用serial-getty服务，使用户可以通过virsh console进入虚拟机。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> serial-getty@ttyS0.service</span><br><span class="line">systemctl start serial-getty@ttyS0.service</span><br></pre></td></tr></table></figure>

<h5 id="配置qemu-guest-agent服务"><a href="#配置qemu-guest-agent服务" class="headerlink" title="配置qemu-guest-agent服务"></a>配置qemu-guest-agent服务</h5><p>qemu-guest-agent类似于VMware tools，主要⽤于辅助Hypervisor实现对Guest的管理。通过qemu-guest-agent，openstack可以使用命令行直接修改管理员账户的密码。</p>
<p>安装服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install -y qemu-guest-agent</span><br></pre></td></tr></table></figure>

<p>启用服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> qemu-guest-agent</span><br></pre></td></tr></table></figure>

<p>注意，在openstack创建镜像时要指定镜像的属性hw_qemu_guest_agent=yes。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack image <span class="built_in">set</span> --property hw_qemu_guest_agent=<span class="built_in">yes</span> d1d3c1ad-7292-4e64-87a1-4a6069ec4056</span><br></pre></td></tr></table></figure>

<p>使用openstack命令修改管理员密码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack server <span class="built_in">set</span> --root-password test-1060a</span><br></pre></td></tr></table></figure>

<h5 id="禁用自动退出"><a href="#禁用自动退出" class="headerlink" title="禁用自动退出"></a>禁用自动退出</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/profile</span><br><span class="line"><span class="built_in">export</span> TMOUT=0</span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>

<h5 id="删除网络配置文件"><a href="#删除网络配置文件" class="headerlink" title="删除网络配置文件"></a>删除网络配置文件</h5><p>uos采用NetworkManager进行网络的管理，如果遇到同名的网络设备时，系统在第一次启动时会跳过连接流程。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -f /etc/sysconfig/network-scripts/ifcfg-enp0s3 </span><br></pre></td></tr></table></figure>

<h4 id="关闭虚拟机"><a href="#关闭虚拟机" class="headerlink" title="关闭虚拟机"></a>关闭虚拟机</h4><p>在虚拟机内部，以root用户运行：<br>poweroff</p>
<h5 id="清理（移除mac地址等信息）"><a href="#清理（移除mac地址等信息）" class="headerlink" title="清理（移除mac地址等信息）"></a>清理（移除mac地址等信息）</h5><p>在宿主机上运行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo virt-sysprep -d 1060a</span><br></pre></td></tr></table></figure>

<p>此时将1060a对应的qcow2文件拷贝走即可使用。</p>
<h5 id="镜像压缩"><a href="#镜像压缩" class="headerlink" title="镜像压缩"></a>镜像压缩</h5><p>qemu-img命令可以用来降低镜像大小，回收实际内容为零的空间</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-img convert -p -c -O qcow2 1060a.qcow2 uniontechos-server-20-1060a-amd64-RC4-20230421-0106-minimal.qcow2</span><br></pre></td></tr></table></figure>

<h2 id="脚本自动化构建"><a href="#脚本自动化构建" class="headerlink" title="脚本自动化构建"></a>脚本自动化构建</h2><p><a target="_blank" rel="noopener" href="https://docs.openstack.org/diskimage-builder/latest/">diskimage-builder</a>（简称为DIB）是一个用于自动构建自定义的操作系统镜像的工具，以便在云和其他环境中使用。</p>
<h3 id="构建docker容器"><a href="#构建docker容器" class="headerlink" title="构建docker容器"></a>构建docker容器</h3><p>利用docker容器来搭建镜像的环境，这里选择centos镜像，同时将本地目录和容器内的文件目录做一个映射。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -itd --privileged=<span class="literal">true</span> --name centos -v <span class="variable">$PWD</span>:/root centos:7 /sbin/init</span><br></pre></td></tr></table></figure>
<div class="figure " style="width:;"><a class="fancybox" href="images/docker-run.png" title="" data-caption="" data-fancybox="default"><img class="fig-img" src="images/docker-run.png" alt=""></a></div>

<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><h4 id="依赖环境"><a href="#依赖环境" class="headerlink" title="依赖环境"></a>依赖环境</h4><p>进入容器内安装DIB的依赖环境。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it centos bash</span><br><span class="line">yum update</span><br><span class="line">yum install -y epel-release </span><br><span class="line">yum install -y python3 git sudo        <span class="comment"># DIB需要Python3支持</span></span><br><span class="line">pip3 install -U pip setuptools wheel</span><br></pre></td></tr></table></figure>

<p>安装qemu-img和kpartx。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get install qemu-utils kpartx squashfs-tools e4fsprogs <span class="comment"># ubuntu</span></span><br><span class="line">yum install -y qemu-img kpartx squashfs-tools e4fsprogs  <span class="comment"># centos</span></span><br></pre></td></tr></table></figure>

<h4 id="DIB"><a href="#DIB" class="headerlink" title="DIB"></a>DIB</h4><p>从github将DIB下载下来。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/openstack/diskimage-builder.git</span><br></pre></td></tr></table></figure>
<div class="figure " style="width:;"><a class="fancybox" href="images/git-clone.png" title="" data-caption="" data-fancybox="default"><img class="fig-img" src="images/git-clone.png" alt=""></a></div>

<p>切换到最近的tag上，我这里是3.7.0。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> diskimge-builder</span><br><span class="line">git checkout -b v3.7.0 3.7.0</span><br></pre></td></tr></table></figure>
<div class="figure " style="width:;"><a class="fancybox" href="images/git-status.png" title="" data-caption="" data-fancybox="default"><img class="fig-img" src="images/git-status.png" alt=""></a></div>

<p>设置虚环境</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install virtualenv</span><br><span class="line"><span class="built_in">mkdir</span> venv &amp;&amp; <span class="built_in">cd</span> venv &amp;&amp; virtualenv -p /usr/bin/python3 diskimage-builder</span><br></pre></td></tr></table></figure>
<div class="figure " style="width:;"><a class="fancybox" href="images/virtualenv.png" title="" data-caption="" data-fancybox="default"><img class="fig-img" src="images/virtualenv.png" alt=""></a></div>

<p>安装diskimage-builder。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /root/diskimage-builder &amp;&amp; /root/venv/diskimage-builder/bin/pip install -e .</span><br></pre></td></tr></table></figure>

<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">[root@centos-linux ~]<span class="comment"># disk-image-create -h</span></span><br><span class="line">Usage: disk-image-create [OPTION]... [ELEMENT]...</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">    -a i386|amd64|armhf|arm64 -- <span class="built_in">set</span> the architecture of the image(default amd64)</span><br><span class="line">    -o imagename -- <span class="built_in">set</span> the imagename of the output image file(default image)</span><br><span class="line">    -t qcow2,tar,tgz,squashfs,vhd,docker,aci,raw -- <span class="built_in">set</span> the image types of the output image files (default qcow2)</span><br><span class="line">       File types should be comma separated. VHD outputting requires the vhd-util</span><br><span class="line">       executable be <span class="keyword">in</span> your PATH. ACI outputting requires the ACI_MANIFEST</span><br><span class="line">       environment variable be a path to a manifest file.</span><br><span class="line">    -x -- turn on tracing (use -x -x <span class="keyword">for</span> very detailed tracing).</span><br><span class="line">    -u -- uncompressed; <span class="keyword">do</span> not compress the image - larger but faster</span><br><span class="line">    -c -- clear environment before starting work</span><br><span class="line">    --logfile -- save run output to given logfile (implies DIB_QUIET=1)</span><br><span class="line">    --checksum -- generate MD5 and SHA256 checksum files <span class="keyword">for</span> the created image</span><br><span class="line">    --image-size size -- image size <span class="keyword">in</span> GB <span class="keyword">for</span> the created image</span><br><span class="line">    --image-extra-size size -- extra image size <span class="keyword">in</span> GB <span class="keyword">for</span> the created image</span><br><span class="line">    --image-cache directory -- location <span class="keyword">for</span> cached images(default ~/.cache/image-create)</span><br><span class="line">    --max-online-resize size -- max number of filesystem blocks to support when resizing.</span><br><span class="line">       Useful <span class="keyword">if</span> you want a really large root partition when the image is deployed.</span><br><span class="line">       Using a very large value may run into a known bug <span class="keyword">in</span> resize2fs.</span><br><span class="line">       Setting the value to 274877906944 will get you a 1PB root file system.</span><br><span class="line">       Making this value unnecessarily large will consume extra disk space</span><br><span class="line">       on the root partition with extra file system inodes.</span><br><span class="line">    --min-tmpfs size -- minimum size <span class="keyword">in</span> GB needed <span class="keyword">in</span> tmpfs to build the image</span><br><span class="line">    --mkfs-journal-size -- filesystem journal size <span class="keyword">in</span> MB to pass to mkfs.</span><br><span class="line">    --mkfs-options -- option flags to be passed directly to mkfs.</span><br><span class="line">       Options should be passed as a single string value.</span><br><span class="line">    --no-tmpfs -- <span class="keyword">do</span> not use tmpfs to speed image build</span><br><span class="line">    --offline -- <span class="keyword">do</span> not update cached resources</span><br><span class="line">    --qemu-img-options -- option flags to be passed directly to qemu-img.</span><br><span class="line">       Options need to be comma separated, and follow the key=value pattern.</span><br><span class="line">    --root-label label -- label <span class="keyword">for</span> the root filesystem.  Defaults to <span class="string">&#x27;cloudimg-rootfs&#x27;</span>.</span><br><span class="line">    --ramdisk-element -- specify the main element to be used <span class="keyword">for</span> building ramdisks.</span><br><span class="line">       Defaults to <span class="string">&#x27;ramdisk&#x27;</span>.  Should be <span class="built_in">set</span> to <span class="string">&#x27;dracut-ramdisk&#x27;</span> <span class="keyword">for</span> platforms such</span><br><span class="line">       as RHEL and CentOS that <span class="keyword">do</span> not package busybox.</span><br><span class="line">    --install-type -- specify the default installation <span class="built_in">type</span>. Defaults to <span class="string">&#x27;source&#x27;</span>. Set to <span class="string">&#x27;package&#x27;</span> to use package based installations by default.</span><br><span class="line">    --docker-target -- specify the repo and tag to use <span class="keyword">if</span> the output <span class="built_in">type</span> is docker. Defaults to the value of output imagename</span><br><span class="line">    -n skip the default inclusion of the <span class="string">&#x27;base&#x27;</span> element</span><br><span class="line">    -p package[,p2...] [-p p3] -- extra packages to install <span class="keyword">in</span> the image.  Runs once, after <span class="string">&#x27;install.d&#x27;</span> phase.  Can be specified multiple <span class="built_in">times</span></span><br><span class="line">    -h|--<span class="built_in">help</span> -- display this <span class="built_in">help</span> and <span class="built_in">exit</span></span><br><span class="line">    --version -- display version and <span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line">Environment Variables:</span><br><span class="line">  (this is not a complete list)</span><br><span class="line"></span><br><span class="line">  * ELEMENTS_PATH: specify external locations <span class="keyword">for</span> the elements.  As <span class="keyword">for</span> <span class="variable">$PATH</span></span><br><span class="line">  * DIB_NO_TIMESTAMP: no timestamp prefix on output.  Useful <span class="keyword">if</span> capturing output</span><br><span class="line">  * DIB_QUIET: 1=<span class="keyword">do</span> not output <span class="built_in">log</span> output to stdout; 0=always ouptut to stdout.  See --logfile</span><br><span class="line"></span><br><span class="line">NOTE: At least one distribution root element must be specified.</span><br><span class="line"></span><br><span class="line">NOTE: If using the VHD output format you need to have a patched version of vhd-util installed <span class="keyword">for</span> the image</span><br><span class="line">      to be bootable. The patch is available here: https://github.com/emonty/vhd-util/blob/master/debian/patches/citrix</span><br><span class="line">      and a PPA with the patched tool is available here: https://launchpad.net/~openstack-ci-core/+archive/ubuntu/vhd-util</span><br><span class="line"></span><br><span class="line">Examples:</span><br><span class="line">    disk-image-create -a amd64 -o ubuntu-amd64 vm ubuntu</span><br><span class="line">    <span class="built_in">export</span> ELEMENTS_PATH=~/source/tripleo-image-elements/elements</span><br><span class="line">    disk-image-create -a amd64 -o fedora-amd64-heat-cfntools vm fedora heat-cfntools</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>创建ubuntu镜像。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/root/venv/diskimage-builder/bin/disk-image-create -a amd64 -o ubuntu-amd64 vm ubuntu</span><br></pre></td></tr></table></figure>


<h1 id="镜像修改"><a href="#镜像修改" class="headerlink" title="镜像修改"></a>镜像修改</h1><h2 id="密码修改"><a href="#密码修改" class="headerlink" title="密码修改"></a>密码修改</h2><p>镜像密码往往是一个比较令人头疼的问题。针对从centos、ubuntu官网上下载的镜像可以在创建完实例后，通过qemu-guest-agent服务修改root密码。需要提前设置镜像的属性打开qemu-guest-agent服务。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack image <span class="built_in">set</span> --property hw_qemu_guest_agent=<span class="built_in">yes</span> &lt;image_id&gt;</span><br></pre></td></tr></table></figure>

<p>然后使用openstack命令修改管理员密码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack server <span class="built_in">set</span> --root-password &lt;server_id&gt;</span><br></pre></td></tr></table></figure>

<p>这样做有几个缺点，每当创建完实例后都需要执行root修改密码操作，而且往往root用户不能直接使用ssh登录，只能通过vnc的方式先连接到实例，再修改ssh的配置，才能远程登录。但好在这些官方的镜像往往都采用cloud-init的方式，可以通过修改cloud-init的配置文件修改root登录。</p>
<h3 id="使用guestfish"><a href="#使用guestfish" class="headerlink" title="使用guestfish"></a>使用guestfish</h3><p>在计算节点（运行libvirtd服务的节点）上，使用guestfish命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装依赖包</span></span><br><span class="line">yum install -y libguestfs-tools</span><br></pre></td></tr></table></figure>

<p>执行guestfish命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">guestfish --rw -a CentOS-Stream-GenericCloud-9-x86_64.qcow2</span><br><span class="line">&gt;&lt;fs&gt; run</span><br><span class="line">100% ⟦▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒⟧ 00:00</span><br><span class="line">&gt;&lt;fs&gt; list-filesystems</span><br><span class="line">/dev/sda1: xfs</span><br><span class="line">&gt;&lt;fs&gt; mount /dev/sda1 /</span><br><span class="line">&gt;&lt;fs&gt; vi /etc/cloud/cloud.cfg           <span class="comment"># 编辑cloud-init的配置文件</span></span><br><span class="line">&gt;&lt;fs&gt; vi /etc/ssh/sshd_config           <span class="comment"># 编辑sshd服务的配置文件</span></span><br></pre></td></tr></table></figure>

<p>编辑cloud-init的配置文件/etc/cloud/cloud.cfg。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 打开root登录</span></span><br><span class="line"><span class="attr">disable_root:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># 打开ssh 密码登录</span></span><br><span class="line"><span class="attr">ssh_pwauth:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 修改root密码。</span></span><br><span class="line"><span class="comment"># 注意：新版本cloud-ini的chpasswd中的list已经被users取代，可以通过指定type，改变密码的类型，默认是hash。</span></span><br><span class="line"><span class="attr">chpasswd:</span></span><br><span class="line">   <span class="attr">expire:</span> <span class="literal">false</span></span><br><span class="line">   <span class="attr">list:</span> <span class="string">|</span></span><br><span class="line">     <span class="string">root:centos</span></span><br></pre></td></tr></table></figure>

<p>还可以直接修改/etc/shadow来修改密码。shadow文件一般由下面9个字段组成。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">用户名:加密密码:最后一次修改时间:最小修改时间间隔:密码有效期:密码需要变更前的警告天数:密码过期后的宽限时间:账号失效时间:保留字段</span><br></pre></td></tr></table></figure>
<p>例如。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root:$1$w07Q2CQS<span class="variable">$6aSP5uit0</span>/sLG6p1uzaOc.:19527:0:99999:7:::</span><br></pre></td></tr></table></figure>
<p>$1$w07Q2CQS$6aSP5uit0/sLG6p1uzaOc.即使加密的密码。其中密码的开头部分，$1$表示使用MD5算法，$2a$表示使用Blowfish算法，”$2y$”是另一算法长度的Blowfish,”$5$”表示SHA-256算法，而”$6$”表示SHA-512算法。</p>
<p>目前Linux的密码采用的是SHA512散列加密算法，原来采用的是MD5或DES加密算法。SHA512散列加密算法的加密等级更高，也更加安全。</p>
<p>使用openssl命令，可简单的生成MD5加密。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl passwd -1 <span class="string">&#x27;qwe123!@#&#x27;</span></span><br><span class="line">$1$i7sJan8C<span class="variable">$kE9Lin</span>.FiytHTz4QtNjal0</span><br></pre></td></tr></table></figure>

<p>使用python的crypt模块，可生成SHA512加密。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python3 -c <span class="string">&quot;import crypt;print(crypt.crypt(&#x27;qwe123\!\@\#&#x27;))&quot;</span></span><br><span class="line">$6$acVoXs6xgUiLxnhS<span class="variable">$uyTSoX42qCE6FqqldpLyfV4mDHhI7j2qIL56WiKYKpSFnPRziBOMhgEhgGB</span>/12XKZJNceamTkEk6mfd3/vpgT.</span><br></pre></td></tr></table></figure>

<p>编辑ssh的配置文件/etc/ssh/sshd_config。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PermitRootLogin <span class="built_in">yes</span></span><br><span class="line">PasswordAuthentication <span class="built_in">yes</span></span><br></pre></td></tr></table></figure>

<p>保存退出。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;&lt;fs&gt; quit</span><br></pre></td></tr></table></figure>

<h3 id="使用virt-customize"><a href="#使用virt-customize" class="headerlink" title="使用virt-customize"></a>使用virt-customize</h3><p>在计算节点（运行libvirtd服务的节点）上，安装依赖包。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y libguestfs-tools</span><br></pre></td></tr></table></figure>

<p>使用virt-customize命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo virt-customize -a CentOS-Stream-GenericCloud-9-x86_64.qcow2 --root-password password:123456</span><br></pre></td></tr></table></figure>
<p>如果出现下面的错误。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[   0.0] Examining the guest ...</span><br><span class="line">virt-customize: error: libguestfs error: could not create appliance through</span><br><span class="line">libvirt.</span><br><span class="line"></span><br><span class="line">Try running qemu directly without libvirt using this environment variable:</span><br><span class="line">export LIBGUESTFS_BACKEND=direct</span><br><span class="line"></span><br><span class="line">Original error from libvirt: Cannot access storage file</span><br><span class="line">&#x27;/root/CentOS-Stream-GenericCloud-9-x86_64.qcow2&#x27; (as uid:107, gid:107):</span><br><span class="line">权限不够 [code=38 int1=13]</span><br><span class="line"></span><br><span class="line">If reporting bugs, run virt-customize with debugging enabled and include</span><br><span class="line">the complete output:</span><br><span class="line"></span><br><span class="line">  virt-customize -v -x [...]</span><br></pre></td></tr></table></figure>

<p>执行下面的操作，修改libvirtd的权限。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;&gt; /etc/libvirt/qemu.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">user = &quot;root&quot;</span></span><br><span class="line"><span class="string">group = &quot;root&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">systemctl restart libvirtd.service</span><br></pre></td></tr></table></figure>

<h3 id="使用horizon"><a href="#使用horizon" class="headerlink" title="使用horizon"></a>使用horizon</h3><p>horizon界面支持用户在创建云主机时注入密码，仅针对开启qemu-guest-agent服务的镜像。</p>
<div class="alert info no-icon"><p><a target="_blank" rel="noopener" href="https://docs.openstack.org/nova/latest/admin/admin-password-injection.html">传送门</a></p>
</div>

<p>修改horizon的local_settings.py文件。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">OPENSTACK_HYPERVISOR_FEATURES = &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">&#x27;can_set_password&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改/etc/nova/nova.conf，kolla部署的nova修改/etc/kolla/nova-compute/nova.conf。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[libvirt]</span></span><br><span class="line"><span class="attr">inject_password</span>=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>重启horizon和nova-compute服务。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart httpd nova-compute</span><br></pre></td></tr></table></figure>

<p>查看horizon界面。</p>
<div class="figure center" style="width:;"><a class="fancybox" href="images/horizon.png" title="" data-caption="" data-fancybox="default"><img class="fig-img" src="images/horizon.png" alt=""></a></div>

<h1 id="上传镜像"><a href="#上传镜像" class="headerlink" title="上传镜像"></a>上传镜像</h1><p>使用OpenStack命令上传镜像。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openstack image create --disk-format qcow2 \</span><br><span class="line">--container-format bare --public \</span><br><span class="line">--file ./CentOS-Stream-GenericCloud-9-x86_64.qcow2 \</span><br><span class="line">CentOS-Stream-GenericCloud-9-x86_64</span><br></pre></td></tr></table></figure>

<h1 id="使用ISO启动实例"><a href="#使用ISO启动实例" class="headerlink" title="使用ISO启动实例"></a>使用ISO启动实例</h1><h2 id="UOS镜像"><a href="#UOS镜像" class="headerlink" title="UOS镜像"></a>UOS镜像</h2><p>使用uos镜像创建一个实例，创建时选择不从volume启动。实例ID为a06135f1-4aa9-405d-910d-e398d83c5ecc，其中libvirtd的xml如下。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">domain</span> <span class="attr">type</span>=<span class="string">&#x27;kvm&#x27;</span> <span class="attr">id</span>=<span class="string">&#x27;63&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>instance-0000138b<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>a06135f1-4aa9-405d-910d-e398d83c5ecc<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="tag">&lt;<span class="name">devices</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">emulator</span>&gt;</span>/usr/libexec/qemu-kvm<span class="tag">&lt;/<span class="name">emulator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">&#x27;file&#x27;</span> <span class="attr">device</span>=<span class="string">&#x27;cdrom&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;qemu&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;qcow2&#x27;</span> <span class="attr">cache</span>=<span class="string">&#x27;none&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">file</span>=<span class="string">&#x27;/var/lib/nova/instances/a06135f1-4aa9-405d-910d-e398d83c5ecc/disk&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">backingStore</span> <span class="attr">type</span>=<span class="string">&#x27;file&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;2&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">format</span> <span class="attr">type</span>=<span class="string">&#x27;raw&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">source</span> <span class="attr">file</span>=<span class="string">&#x27;/var/lib/nova/instances/_base/5318b1004ad87ba4770212c2f6b1c9fc32f23787&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">backingStore</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">backingStore</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;hda&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;ide&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">readonly</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;ide0-0-0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;drive&#x27;</span> <span class="attr">controller</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">target</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">  <span class="tag">&lt;/<span class="name">devices</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">domain</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>nova表中block_device_mapping记录了磁盘的映射关系。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * from block_device_mapping <span class="built_in">where</span> instance_uuid=<span class="string">&quot;a06135f1-4aa9-405d-910d-e398d83c5ecc&quot;</span> \G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           created_at: 2023-05-11 08:52:48</span><br><span class="line">           updated_at: 2023-05-11 08:52:49</span><br><span class="line">           deleted_at: NULL</span><br><span class="line">                   <span class="built_in">id</span>: 8740</span><br><span class="line">          device_name: /dev/hda</span><br><span class="line">delete_on_termination: 1</span><br><span class="line">          snapshot_id: NULL</span><br><span class="line">            volume_id: NULL</span><br><span class="line">          volume_size: NULL</span><br><span class="line">            no_device: 0</span><br><span class="line">      connection_info: NULL</span><br><span class="line">        instance_uuid: a06135f1-4aa9-405d-910d-e398d83c5ecc</span><br><span class="line">              deleted: 0</span><br><span class="line">          source_type: image</span><br><span class="line">     destination_type: <span class="built_in">local</span></span><br><span class="line">         guest_format: NULL</span><br><span class="line">          device_type: disk</span><br><span class="line">             disk_bus: NULL</span><br><span class="line">           boot_index: 0</span><br><span class="line">             image_id: 17200200-24d9-4872-b973-af7a85a12c53</span><br><span class="line">                  tag: NULL</span><br><span class="line">        attachment_id: NULL</span><br><span class="line">                 uuid: edf44737-4835-47ff-b641-a17e15822ad0</span><br><span class="line">          volume_type: NULL</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.000 sec)</span><br></pre></td></tr></table></figure>

<p>此时实例进入安装界面，但是没有磁盘。新建一块磁盘用于安装系统。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">openstack volume create --size 100 --availability-zone nova --bootable wkt-uos-desktop-test-without-volume</span><br><span class="line">+---------------------+--------------------------------------+</span><br><span class="line">| Field               | Value                                |</span><br><span class="line">+---------------------+--------------------------------------+</span><br><span class="line">| attachments         | []                                   |</span><br><span class="line">| availability_zone   | nova                                 |</span><br><span class="line">| bootable            | <span class="literal">false</span>                                |</span><br><span class="line">| consistencygroup_id | None                                 |</span><br><span class="line">| created_at          | 2023-05-11T09:01:06.000000           |</span><br><span class="line">| description         | None                                 |</span><br><span class="line">| encrypted           | False                                |</span><br><span class="line">| <span class="built_in">id</span>                  | 304d88ac-3460-4c5d-950d-f17528b97e1a |</span><br><span class="line">| migration_status    | None                                 |</span><br><span class="line">| multiattach         | False                                |</span><br><span class="line">| name                | wkt-uos-desktop-test-without-volume  |</span><br><span class="line">| properties          |                                      |</span><br><span class="line">| replication_status  | None                                 |</span><br><span class="line">| size                | 100                                  |</span><br><span class="line">| snapshot_id         | None                                 |</span><br><span class="line">| source_volid        | None                                 |</span><br><span class="line">| status              | creating                             |</span><br><span class="line">| <span class="built_in">type</span>                | __DEFAULT__                          |</span><br><span class="line">| updated_at          | None                                 |</span><br><span class="line">| user_id             | 24d08826a98140ce8e2ade2606ff9ad8     |</span><br><span class="line">+---------------------+--------------------------------------+</span><br></pre></td></tr></table></figure>

<p>等待磁盘创建完成后，添加到实例上。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack server add volume a06135f1-4aa9-405d-910d-e398d83c5ecc 304d88ac-3460-4c5d-950d-f17528b97e1a</span><br></pre></td></tr></table></figure>

<p>此时block_device_mapping表中为。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * from block_device_mapping <span class="built_in">where</span> instance_uuid=<span class="string">&quot;a06135f1-4aa9-405d-910d-e398d83c5ecc&quot;</span> \G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           created_at: 2023-05-11 08:52:48</span><br><span class="line">           updated_at: 2023-05-11 08:52:49</span><br><span class="line">           deleted_at: NULL</span><br><span class="line">                   <span class="built_in">id</span>: 8740</span><br><span class="line">          device_name: /dev/hda</span><br><span class="line">delete_on_termination: 1</span><br><span class="line">          snapshot_id: NULL</span><br><span class="line">            volume_id: NULL</span><br><span class="line">          volume_size: NULL</span><br><span class="line">            no_device: 0</span><br><span class="line">      connection_info: NULL</span><br><span class="line">        instance_uuid: a06135f1-4aa9-405d-910d-e398d83c5ecc</span><br><span class="line">              deleted: 0</span><br><span class="line">          source_type: image</span><br><span class="line">     destination_type: <span class="built_in">local</span></span><br><span class="line">         guest_format: NULL</span><br><span class="line">          device_type: disk</span><br><span class="line">             disk_bus: NULL</span><br><span class="line">           boot_index: 0</span><br><span class="line">             image_id: 17200200-24d9-4872-b973-af7a85a12c53</span><br><span class="line">                  tag: NULL</span><br><span class="line">        attachment_id: NULL</span><br><span class="line">                 uuid: edf44737-4835-47ff-b641-a17e15822ad0</span><br><span class="line">          volume_type: NULL</span><br><span class="line">*************************** 2. row ***************************</span><br><span class="line">           created_at: 2023-05-11 09:03:21</span><br><span class="line">           updated_at: 2023-05-11 09:03:28</span><br><span class="line">           deleted_at: NULL</span><br><span class="line">                   <span class="built_in">id</span>: 8741</span><br><span class="line">          device_name: /dev/vda</span><br><span class="line">delete_on_termination: 0</span><br><span class="line">          snapshot_id: NULL</span><br><span class="line">            volume_id: 304d88ac-3460-4c5d-950d-f17528b97e1a</span><br><span class="line">          volume_size: 100</span><br><span class="line">            no_device: NULL</span><br><span class="line">      connection_info: &#123;<span class="string">&quot;driver_volume_type&quot;</span>: <span class="string">&quot;iscsi&quot;</span>, <span class="string">&quot;data&quot;</span>: &#123;<span class="string">&quot;target_discovered&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;target_portal&quot;</span>: <span class="string">&quot;10.10.15.12:3260&quot;</span>, <span class="string">&quot;target_iqn&quot;</span>: <span class="string">&quot;iqn.2010-10.org.openstack:volume-304d88ac-3460-4c5d-950d-f17528b97e1a&quot;</span>, <span class="string">&quot;target_lun&quot;</span>: 0, <span class="string">&quot;volume_id&quot;</span>: <span class="string">&quot;304d88ac-3460-4c5d-950d-f17528b97e1a&quot;</span>, <span class="string">&quot;auth_method&quot;</span>: <span class="string">&quot;CHAP&quot;</span>, <span class="string">&quot;auth_username&quot;</span>: <span class="string">&quot;h8e7h5iC5kMjFVJN6rfD&quot;</span>, <span class="string">&quot;auth_password&quot;</span>: <span class="string">&quot;wNmMTBsTMBs8dV67&quot;</span>, <span class="string">&quot;encrypted&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;qos_specs&quot;</span>: null, <span class="string">&quot;access_mode&quot;</span>: <span class="string">&quot;rw&quot;</span>, <span class="string">&quot;device_path&quot;</span>: <span class="string">&quot;/dev/sdf&quot;</span>&#125;, <span class="string">&quot;status&quot;</span>: <span class="string">&quot;reserved&quot;</span>, <span class="string">&quot;instance&quot;</span>: <span class="string">&quot;a06135f1-4aa9-405d-910d-e398d83c5ecc&quot;</span>, <span class="string">&quot;attached_at&quot;</span>: <span class="string">&quot;&quot;</span>, <span class="string">&quot;detached_at&quot;</span>: <span class="string">&quot;&quot;</span>, <span class="string">&quot;volume_id&quot;</span>: <span class="string">&quot;304d88ac-3460-4c5d-950d-f17528b97e1a&quot;</span>, <span class="string">&quot;serial&quot;</span>: <span class="string">&quot;304d88ac-3460-4c5d-950d-f17528b97e1a&quot;</span>&#125;</span><br><span class="line">        instance_uuid: a06135f1-4aa9-405d-910d-e398d83c5ecc</span><br><span class="line">              deleted: 0</span><br><span class="line">          source_type: volume</span><br><span class="line">     destination_type: volume</span><br><span class="line">         guest_format: NULL</span><br><span class="line">          device_type: NULL</span><br><span class="line">             disk_bus: NULL</span><br><span class="line">           boot_index: NULL</span><br><span class="line">             image_id: NULL</span><br><span class="line">                  tag: NULL</span><br><span class="line">        attachment_id: 12cb3da5-a87f-4035-a0f9-c31a1306ce72</span><br><span class="line">                 uuid: f1f7a8e6-b59b-4fde-a37d-af020979d4a4</span><br><span class="line">          volume_type: NULL</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.001 sec)</span><br></pre></td></tr></table></figure>

<p>此时实例的xml文件已经改变，可以看到新增了一块磁盘，但是系统界面看不到。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">domain</span> <span class="attr">type</span>=<span class="string">&#x27;kvm&#x27;</span> <span class="attr">id</span>=<span class="string">&#x27;63&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>instance-0000138b<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>a06135f1-4aa9-405d-910d-e398d83c5ecc<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="tag">&lt;<span class="name">devices</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">emulator</span>&gt;</span>/usr/libexec/qemu-kvm<span class="tag">&lt;/<span class="name">emulator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">&#x27;file&#x27;</span> <span class="attr">device</span>=<span class="string">&#x27;cdrom&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;qemu&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;qcow2&#x27;</span> <span class="attr">cache</span>=<span class="string">&#x27;none&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">file</span>=<span class="string">&#x27;/var/lib/nova/instances/a06135f1-4aa9-405d-910d-e398d83c5ecc/disk&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">backingStore</span> <span class="attr">type</span>=<span class="string">&#x27;file&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;2&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">format</span> <span class="attr">type</span>=<span class="string">&#x27;raw&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">source</span> <span class="attr">file</span>=<span class="string">&#x27;/var/lib/nova/instances/_base/5318b1004ad87ba4770212c2f6b1c9fc32f23787&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">backingStore</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">backingStore</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;hda&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;ide&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">readonly</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;ide0-0-0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;drive&#x27;</span> <span class="attr">controller</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">target</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">&#x27;block&#x27;</span> <span class="attr">device</span>=<span class="string">&#x27;disk&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;qemu&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;raw&#x27;</span> <span class="attr">cache</span>=<span class="string">&#x27;none&#x27;</span> <span class="attr">io</span>=<span class="string">&#x27;native&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">dev</span>=<span class="string">&#x27;/dev/sdf&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;3&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">backingStore</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;vda&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">serial</span>&gt;</span>304d88ac-3460-4c5d-950d-f17528b97e1a<span class="tag">&lt;/<span class="name">serial</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;virtio-disk0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x06&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">  <span class="tag">&lt;/<span class="name">devices</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">domain</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>将实例硬重启。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack server reboot --hard a06135f1-4aa9-405d-910d-e398d83c5ecc</span><br></pre></td></tr></table></figure>

<p>可以看到xml文件中disk的index发生了变化。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">&#x27;file&#x27;</span> <span class="attr">device</span>=<span class="string">&#x27;cdrom&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;qemu&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;qcow2&#x27;</span> <span class="attr">cache</span>=<span class="string">&#x27;none&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">source</span> <span class="attr">file</span>=<span class="string">&#x27;/var/lib/nova/instances/a06135f1-4aa9-405d-910d-e398d83c5ecc/disk&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">backingStore</span> <span class="attr">type</span>=<span class="string">&#x27;file&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;3&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">format</span> <span class="attr">type</span>=<span class="string">&#x27;raw&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">source</span> <span class="attr">file</span>=<span class="string">&#x27;/var/lib/nova/instances/_base/5318b1004ad87ba4770212c2f6b1c9fc32f23787&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">backingStore</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">backingStore</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;hda&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;ide&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">readonly</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;ide0-0-0&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;drive&#x27;</span> <span class="attr">controller</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">target</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">&#x27;block&#x27;</span> <span class="attr">device</span>=<span class="string">&#x27;disk&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;qemu&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;raw&#x27;</span> <span class="attr">cache</span>=<span class="string">&#x27;none&#x27;</span> <span class="attr">io</span>=<span class="string">&#x27;native&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">source</span> <span class="attr">dev</span>=<span class="string">&#x27;/dev/sdf&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">backingStore</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;vda&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">serial</span>&gt;</span>304d88ac-3460-4c5d-950d-f17528b97e1a<span class="tag">&lt;/<span class="name">serial</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;virtio-disk0&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x04&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这时进入系统的安装界面可以看到多了一块磁盘，然后进行系统的安装。系统安装完成的最后，会提示用户重启，用户点击重启后，又进入到系统的安装界面。此时及时进行硬重启也不解决问题，依旧进入系统的安装界面。</p>
<p>通过修改block_device_mapping表，尝试修改实例磁盘的启动顺序。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先将安装完系统的盘的boot_index设置为0。</span></span><br><span class="line">update block_device_mapping <span class="built_in">set</span> boot_index=0 <span class="built_in">where</span> <span class="built_in">id</span>=8741;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 然后将安装盘的boot_index设置为空。</span></span><br><span class="line">update block_device_mapping <span class="built_in">set</span> boot_index=NULL <span class="built_in">where</span> <span class="built_in">id</span>=8740;</span><br></pre></td></tr></table></figure>
<p>最后将实例硬重启。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack server reboot --hard a06135f1-4aa9-405d-910d-e398d83c5ecc</span><br></pre></td></tr></table></figure>

<p>查看xml文件，可以看到boot的设备由cdrom变为hd。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">domain</span> <span class="attr">type</span>=<span class="string">&#x27;kvm&#x27;</span> <span class="attr">id</span>=<span class="string">&#x27;66&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>instance-0000138b<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>a06135f1-4aa9-405d-910d-e398d83c5ecc<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="tag">&lt;<span class="name">devices</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">emulator</span>&gt;</span>/usr/libexec/qemu-kvm<span class="tag">&lt;/<span class="name">emulator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">&#x27;block&#x27;</span> <span class="attr">device</span>=<span class="string">&#x27;disk&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;qemu&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;raw&#x27;</span> <span class="attr">cache</span>=<span class="string">&#x27;none&#x27;</span> <span class="attr">io</span>=<span class="string">&#x27;native&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">dev</span>=<span class="string">&#x27;/dev/sdf&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">backingStore</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;vda&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">serial</span>&gt;</span>304d88ac-3460-4c5d-950d-f17528b97e1a<span class="tag">&lt;/<span class="name">serial</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;virtio-disk0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x04&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">  <span class="tag">&lt;/<span class="name">devices</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">domain</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>此时可以正常进入系统。</p>
<h2 id="Windows镜像"><a href="#Windows镜像" class="headerlink" title="Windows镜像"></a>Windows镜像</h2><p>首先windows系统安装时需要virtio的驱动来读取磁盘信息，所以先以virtio的镜像创建一个volume。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">openstack volume create --size 1 --image virtio-win-0.1.225 --availability-zone nova wkt-virtio-win-0.1.225</span><br><span class="line">+---------------------+--------------------------------------+</span><br><span class="line">| Field               | Value                                |</span><br><span class="line">+---------------------+--------------------------------------+</span><br><span class="line">| attachments         | []                                   |</span><br><span class="line">| availability_zone   | nova                                 |</span><br><span class="line">| bootable            | <span class="literal">false</span>                                |</span><br><span class="line">| consistencygroup_id | None                                 |</span><br><span class="line">| created_at          | 2023-05-11T09:45:32.000000           |</span><br><span class="line">| description         | None                                 |</span><br><span class="line">| encrypted           | False                                |</span><br><span class="line">| <span class="built_in">id</span>                  | 07476fea-b4bc-4bfc-86d4-84520a954ce6 |</span><br><span class="line">| migration_status    | None                                 |</span><br><span class="line">| multiattach         | False                                |</span><br><span class="line">| name                | wkt-virtio-win-0.1.225               |</span><br><span class="line">| properties          |                                      |</span><br><span class="line">| replication_status  | None                                 |</span><br><span class="line">| size                | 1                                    |</span><br><span class="line">| snapshot_id         | None                                 |</span><br><span class="line">| source_volid        | None                                 |</span><br><span class="line">| status              | creating                             |</span><br><span class="line">| <span class="built_in">type</span>                | __DEFAULT__                          |</span><br><span class="line">| updated_at          | None                                 |</span><br><span class="line">| user_id             | 24d08826a98140ce8e2ade2606ff9ad8     |</span><br><span class="line">+---------------------+--------------------------------------+</span><br></pre></td></tr></table></figure>

<p>等到volume状态变为可用时，创建windows实例。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">nova boot --availability-zone cloud \</span><br><span class="line">--flavor 8-8-0 \</span><br><span class="line">--image 60f8adab-fceb-47a2-a32a-f19d2351177e \</span><br><span class="line">--nic net-id=7b6c69b5-bfa5-4145-901c-26979103da77 \</span><br><span class="line">--block-device <span class="built_in">id</span>=eb2006ba-6416-4b68-b8bf-b358589fba34,<span class="built_in">source</span>=image,dest=volume,bus=ide,<span class="built_in">type</span>=cdrom,size=1 \</span><br><span class="line">wkt-windows-test</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>实例的ID是5ace35d4-7195-465e-afca-2c81279bb677。</p>
<p>查看block_device_mapping表的映射关系。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * from block_device_mapping <span class="built_in">where</span> instance_uuid=<span class="string">&quot;5ace35d4-7195-465e-afca-2c81279bb677&quot;</span> \G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           created_at: 2023-05-12 02:10:28</span><br><span class="line">           updated_at: 2023-05-12 02:10:28</span><br><span class="line">           deleted_at: NULL</span><br><span class="line">                   <span class="built_in">id</span>: 8746</span><br><span class="line">          device_name: /dev/hda</span><br><span class="line">delete_on_termination: 1</span><br><span class="line">          snapshot_id: NULL</span><br><span class="line">            volume_id: NULL</span><br><span class="line">          volume_size: NULL</span><br><span class="line">            no_device: 0</span><br><span class="line">      connection_info: NULL</span><br><span class="line">        instance_uuid: 5ace35d4-7195-465e-afca-2c81279bb677</span><br><span class="line">              deleted: 0</span><br><span class="line">          source_type: image</span><br><span class="line">     destination_type: <span class="built_in">local</span></span><br><span class="line">         guest_format: NULL</span><br><span class="line">          device_type: NULL</span><br><span class="line">             disk_bus: NULL</span><br><span class="line">           boot_index: 0</span><br><span class="line">             image_id: 60f8adab-fceb-47a2-a32a-f19d2351177e</span><br><span class="line">                  tag: NULL</span><br><span class="line">        attachment_id: NULL</span><br><span class="line">                 uuid: 6de66a02-6efb-4ce0-89a1-fa477f976909</span><br><span class="line">          volume_type: NULL</span><br><span class="line">*************************** 2. row ***************************</span><br><span class="line">           created_at: 2023-05-12 02:10:28</span><br><span class="line">           updated_at: 2023-05-12 02:11:02</span><br><span class="line">           deleted_at: NULL</span><br><span class="line">                   <span class="built_in">id</span>: 8747</span><br><span class="line">          device_name: /dev/hdb</span><br><span class="line">delete_on_termination: 0</span><br><span class="line">          snapshot_id: NULL</span><br><span class="line">            volume_id: c5f26969-397c-491b-8ee6-a2e9df1f9b42</span><br><span class="line">          volume_size: 1</span><br><span class="line">            no_device: 0</span><br><span class="line">      connection_info: &#123;<span class="string">&quot;driver_volume_type&quot;</span>: <span class="string">&quot;iscsi&quot;</span>, <span class="string">&quot;data&quot;</span>: &#123;<span class="string">&quot;target_discovered&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;target_portal&quot;</span>: <span class="string">&quot;10.10.15.12:3260&quot;</span>, <span class="string">&quot;target_iqn&quot;</span>: <span class="string">&quot;iqn.2010-10.org.openstack:volume-c5f26969-397c-491b-8ee6-a2e9df1f9b42&quot;</span>, <span class="string">&quot;target_lun&quot;</span>: 0, <span class="string">&quot;volume_id&quot;</span>: <span class="string">&quot;c5f26969-397c-491b-8ee6-a2e9df1f9b42&quot;</span>, <span class="string">&quot;auth_method&quot;</span>: <span class="string">&quot;CHAP&quot;</span>, <span class="string">&quot;auth_username&quot;</span>: <span class="string">&quot;MDksZ4gonTVKwayfr2fB&quot;</span>, <span class="string">&quot;auth_password&quot;</span>: <span class="string">&quot;jjEXzRGtzbFKiB6m&quot;</span>, <span class="string">&quot;encrypted&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;qos_specs&quot;</span>: null, <span class="string">&quot;access_mode&quot;</span>: <span class="string">&quot;rw&quot;</span>, <span class="string">&quot;device_path&quot;</span>: <span class="string">&quot;/dev/sdg&quot;</span>&#125;, <span class="string">&quot;status&quot;</span>: <span class="string">&quot;reserved&quot;</span>, <span class="string">&quot;instance&quot;</span>: <span class="string">&quot;5ace35d4-7195-465e-afca-2c81279bb677&quot;</span>, <span class="string">&quot;attached_at&quot;</span>: <span class="string">&quot;&quot;</span>, <span class="string">&quot;detached_at&quot;</span>: <span class="string">&quot;&quot;</span>, <span class="string">&quot;volume_id&quot;</span>: <span class="string">&quot;c5f26969-397c-491b-8ee6-a2e9df1f9b42&quot;</span>, <span class="string">&quot;serial&quot;</span>: <span class="string">&quot;c5f26969-397c-491b-8ee6-a2e9df1f9b42&quot;</span>&#125;</span><br><span class="line">        instance_uuid: 5ace35d4-7195-465e-afca-2c81279bb677</span><br><span class="line">              deleted: 0</span><br><span class="line">          source_type: image</span><br><span class="line">     destination_type: volume</span><br><span class="line">         guest_format: NULL</span><br><span class="line">          device_type: cdrom</span><br><span class="line">             disk_bus: ide</span><br><span class="line">           boot_index: NULL</span><br><span class="line">             image_id: eb2006ba-6416-4b68-b8bf-b358589fba34</span><br><span class="line">                  tag: NULL</span><br><span class="line">        attachment_id: c45a1ce7-16b0-4319-90d0-2a08463cc220</span><br><span class="line">                 uuid: 94a9eb85-e31b-41cd-bf07-431d7a6f9534</span><br><span class="line">          volume_type: NULL</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.000 sec)</span><br></pre></td></tr></table></figure>

<p>xml配置文件。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">domain</span> <span class="attr">type</span>=<span class="string">&#x27;kvm&#x27;</span> <span class="attr">id</span>=<span class="string">&#x27;69&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>instance-0000138e<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>5ace35d4-7195-465e-afca-2c81279bb677<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="tag">&lt;<span class="name">devices</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">emulator</span>&gt;</span>/usr/libexec/qemu-kvm<span class="tag">&lt;/<span class="name">emulator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">&#x27;file&#x27;</span> <span class="attr">device</span>=<span class="string">&#x27;cdrom&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;qemu&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;qcow2&#x27;</span> <span class="attr">cache</span>=<span class="string">&#x27;none&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">file</span>=<span class="string">&#x27;/var/lib/nova/instances/5ace35d4-7195-465e-afca-2c81279bb677/disk&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">backingStore</span> <span class="attr">type</span>=<span class="string">&#x27;file&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;3&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">format</span> <span class="attr">type</span>=<span class="string">&#x27;raw&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">source</span> <span class="attr">file</span>=<span class="string">&#x27;/var/lib/nova/instances/_base/77a37f6c71682eba3d2f883c4736edd52b431752&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">backingStore</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">backingStore</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;hda&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;ide&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">readonly</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;ide0-0-0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;drive&#x27;</span> <span class="attr">controller</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">target</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">&#x27;block&#x27;</span> <span class="attr">device</span>=<span class="string">&#x27;cdrom&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;qemu&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;raw&#x27;</span> <span class="attr">cache</span>=<span class="string">&#x27;none&#x27;</span> <span class="attr">io</span>=<span class="string">&#x27;native&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">dev</span>=<span class="string">&#x27;/dev/sdg&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">backingStore</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;hdb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;ide&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">readonly</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">serial</span>&gt;</span>c5f26969-397c-491b-8ee6-a2e9df1f9b42<span class="tag">&lt;/<span class="name">serial</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;ide0-0-1&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;drive&#x27;</span> <span class="attr">controller</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">target</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">  <span class="tag">&lt;/<span class="name">devices</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">domain</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>添加系统盘。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">openstack volume create --size 100 --availability-zone nova --bootable wkt-windows-test-volume</span><br><span class="line">+---------------------+--------------------------------------+</span><br><span class="line">| Field               | Value                                |</span><br><span class="line">+---------------------+--------------------------------------+</span><br><span class="line">| attachments         | []                                   |</span><br><span class="line">| availability_zone   | nova                                 |</span><br><span class="line">| bootable            | <span class="literal">false</span>                                |</span><br><span class="line">| consistencygroup_id | None                                 |</span><br><span class="line">| created_at          | 2023-05-12T02:16:56.000000           |</span><br><span class="line">| description         | None                                 |</span><br><span class="line">| encrypted           | False                                |</span><br><span class="line">| <span class="built_in">id</span>                  | d1e96c3b-7a2a-478d-ab98-de94aefcbc0e |</span><br><span class="line">| migration_status    | None                                 |</span><br><span class="line">| multiattach         | False                                |</span><br><span class="line">| name                | wkt-windows-test-volume              |</span><br><span class="line">| properties          |                                      |</span><br><span class="line">| replication_status  | None                                 |</span><br><span class="line">| size                | 100                                  |</span><br><span class="line">| snapshot_id         | None                                 |</span><br><span class="line">| source_volid        | None                                 |</span><br><span class="line">| status              | creating                             |</span><br><span class="line">| <span class="built_in">type</span>                | __DEFAULT__                          |</span><br><span class="line">| updated_at          | None                                 |</span><br><span class="line">| user_id             | 24d08826a98140ce8e2ade2606ff9ad8     |</span><br><span class="line">+---------------------+--------------------------------------+</span><br></pre></td></tr></table></figure>

<p>等待磁盘创建完成后，添加到实例上。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack server add volume 5ace35d4-7195-465e-afca-2c81279bb677 d1e96c3b-7a2a-478d-ab98-de94aefcbc0e</span><br></pre></td></tr></table></figure>

<p>查看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * from block_device_mapping <span class="built_in">where</span> instance_uuid=<span class="string">&quot;5ace35d4-7195-465e-afca-2c81279bb677&quot;</span> \G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           created_at: 2023-05-12 02:10:28</span><br><span class="line">           updated_at: 2023-05-12 02:10:28</span><br><span class="line">           deleted_at: NULL</span><br><span class="line">                   <span class="built_in">id</span>: 8746</span><br><span class="line">          device_name: /dev/hda</span><br><span class="line">delete_on_termination: 1</span><br><span class="line">          snapshot_id: NULL</span><br><span class="line">            volume_id: NULL</span><br><span class="line">          volume_size: NULL</span><br><span class="line">            no_device: 0</span><br><span class="line">      connection_info: NULL</span><br><span class="line">        instance_uuid: 5ace35d4-7195-465e-afca-2c81279bb677</span><br><span class="line">              deleted: 0</span><br><span class="line">          source_type: image</span><br><span class="line">     destination_type: <span class="built_in">local</span></span><br><span class="line">         guest_format: NULL</span><br><span class="line">          device_type: NULL</span><br><span class="line">             disk_bus: NULL</span><br><span class="line">           boot_index: 0</span><br><span class="line">             image_id: 60f8adab-fceb-47a2-a32a-f19d2351177e</span><br><span class="line">                  tag: NULL</span><br><span class="line">        attachment_id: NULL</span><br><span class="line">                 uuid: 6de66a02-6efb-4ce0-89a1-fa477f976909</span><br><span class="line">          volume_type: NULL</span><br><span class="line">*************************** 2. row ***************************</span><br><span class="line">           created_at: 2023-05-12 02:10:28</span><br><span class="line">           updated_at: 2023-05-12 02:11:02</span><br><span class="line">           deleted_at: NULL</span><br><span class="line">                   <span class="built_in">id</span>: 8747</span><br><span class="line">          device_name: /dev/hdb</span><br><span class="line">delete_on_termination: 0</span><br><span class="line">          snapshot_id: NULL</span><br><span class="line">            volume_id: c5f26969-397c-491b-8ee6-a2e9df1f9b42</span><br><span class="line">          volume_size: 1</span><br><span class="line">            no_device: 0</span><br><span class="line">      connection_info: &#123;<span class="string">&quot;driver_volume_type&quot;</span>: <span class="string">&quot;iscsi&quot;</span>, <span class="string">&quot;data&quot;</span>: &#123;<span class="string">&quot;target_discovered&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;target_portal&quot;</span>: <span class="string">&quot;10.10.15.12:3260&quot;</span>, <span class="string">&quot;target_iqn&quot;</span>: <span class="string">&quot;iqn.2010-10.org.openstack:volume-c5f26969-397c-491b-8ee6-a2e9df1f9b42&quot;</span>, <span class="string">&quot;target_lun&quot;</span>: 0, <span class="string">&quot;volume_id&quot;</span>: <span class="string">&quot;c5f26969-397c-491b-8ee6-a2e9df1f9b42&quot;</span>, <span class="string">&quot;auth_method&quot;</span>: <span class="string">&quot;CHAP&quot;</span>, <span class="string">&quot;auth_username&quot;</span>: <span class="string">&quot;MDksZ4gonTVKwayfr2fB&quot;</span>, <span class="string">&quot;auth_password&quot;</span>: <span class="string">&quot;jjEXzRGtzbFKiB6m&quot;</span>, <span class="string">&quot;encrypted&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;qos_specs&quot;</span>: null, <span class="string">&quot;access_mode&quot;</span>: <span class="string">&quot;rw&quot;</span>, <span class="string">&quot;device_path&quot;</span>: <span class="string">&quot;/dev/sdg&quot;</span>&#125;, <span class="string">&quot;status&quot;</span>: <span class="string">&quot;reserved&quot;</span>, <span class="string">&quot;instance&quot;</span>: <span class="string">&quot;5ace35d4-7195-465e-afca-2c81279bb677&quot;</span>, <span class="string">&quot;attached_at&quot;</span>: <span class="string">&quot;&quot;</span>, <span class="string">&quot;detached_at&quot;</span>: <span class="string">&quot;&quot;</span>, <span class="string">&quot;volume_id&quot;</span>: <span class="string">&quot;c5f26969-397c-491b-8ee6-a2e9df1f9b42&quot;</span>, <span class="string">&quot;serial&quot;</span>: <span class="string">&quot;c5f26969-397c-491b-8ee6-a2e9df1f9b42&quot;</span>&#125;</span><br><span class="line">        instance_uuid: 5ace35d4-7195-465e-afca-2c81279bb677</span><br><span class="line">              deleted: 0</span><br><span class="line">          source_type: image</span><br><span class="line">     destination_type: volume</span><br><span class="line">         guest_format: NULL</span><br><span class="line">          device_type: cdrom</span><br><span class="line">             disk_bus: ide</span><br><span class="line">           boot_index: NULL</span><br><span class="line">             image_id: eb2006ba-6416-4b68-b8bf-b358589fba34</span><br><span class="line">                  tag: NULL</span><br><span class="line">        attachment_id: c45a1ce7-16b0-4319-90d0-2a08463cc220</span><br><span class="line">                 uuid: 94a9eb85-e31b-41cd-bf07-431d7a6f9534</span><br><span class="line">          volume_type: NULL</span><br><span class="line">*************************** 3. row ***************************</span><br><span class="line">           created_at: 2023-05-12 02:19:10</span><br><span class="line">           updated_at: 2023-05-12 02:19:11</span><br><span class="line">           deleted_at: NULL</span><br><span class="line">                   <span class="built_in">id</span>: 8748</span><br><span class="line">          device_name: /dev/vda</span><br><span class="line">delete_on_termination: 0</span><br><span class="line">          snapshot_id: NULL</span><br><span class="line">            volume_id: d1e96c3b-7a2a-478d-ab98-de94aefcbc0e</span><br><span class="line">          volume_size: NULL</span><br><span class="line">            no_device: NULL</span><br><span class="line">      connection_info: NULL</span><br><span class="line">        instance_uuid: 5ace35d4-7195-465e-afca-2c81279bb677</span><br><span class="line">              deleted: 0</span><br><span class="line">          source_type: volume</span><br><span class="line">     destination_type: volume</span><br><span class="line">         guest_format: NULL</span><br><span class="line">          device_type: NULL</span><br><span class="line">             disk_bus: NULL</span><br><span class="line">           boot_index: NULL</span><br><span class="line">             image_id: NULL</span><br><span class="line">                  tag: NULL</span><br><span class="line">        attachment_id: 418d9322-eef3-4b15-9ca0-fbda0d7c9140</span><br><span class="line">                 uuid: b5f6b25d-44f3-416e-aab3-3ce350607d4a</span><br><span class="line">          volume_type: NULL</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.001 sec)</span><br></pre></td></tr></table></figure>

<p>xml配置文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&lt;domain <span class="built_in">type</span>=<span class="string">&#x27;kvm&#x27;</span> <span class="built_in">id</span>=<span class="string">&#x27;69&#x27;</span>&gt;</span><br><span class="line">  &lt;name&gt;instance-0000138e&lt;/name&gt;</span><br><span class="line">  &lt;uuid&gt;5ace35d4-7195-465e-afca-2c81279bb677&lt;/uuid&gt;</span><br><span class="line">  ...</span><br><span class="line">  &lt;devices&gt;</span><br><span class="line">    &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;</span><br><span class="line">    &lt;disk <span class="built_in">type</span>=<span class="string">&#x27;file&#x27;</span> device=<span class="string">&#x27;cdrom&#x27;</span>&gt;</span><br><span class="line">      &lt;driver name=<span class="string">&#x27;qemu&#x27;</span> <span class="built_in">type</span>=<span class="string">&#x27;qcow2&#x27;</span> cache=<span class="string">&#x27;none&#x27;</span>/&gt;</span><br><span class="line">      &lt;<span class="built_in">source</span> file=<span class="string">&#x27;/var/lib/nova/instances/5ace35d4-7195-465e-afca-2c81279bb677/disk&#x27;</span> index=<span class="string">&#x27;2&#x27;</span>/&gt;</span><br><span class="line">      &lt;backingStore <span class="built_in">type</span>=<span class="string">&#x27;file&#x27;</span> index=<span class="string">&#x27;3&#x27;</span>&gt;</span><br><span class="line">        &lt;format <span class="built_in">type</span>=<span class="string">&#x27;raw&#x27;</span>/&gt;</span><br><span class="line">        &lt;<span class="built_in">source</span> file=<span class="string">&#x27;/var/lib/nova/instances/_base/77a37f6c71682eba3d2f883c4736edd52b431752&#x27;</span>/&gt;</span><br><span class="line">        &lt;backingStore/&gt;</span><br><span class="line">      &lt;/backingStore&gt;</span><br><span class="line">      &lt;target dev=<span class="string">&#x27;hda&#x27;</span> bus=<span class="string">&#x27;ide&#x27;</span>/&gt;</span><br><span class="line">      &lt;<span class="built_in">readonly</span>/&gt;</span><br><span class="line">      &lt;<span class="built_in">alias</span> name=<span class="string">&#x27;ide0-0-0&#x27;</span>/&gt;</span><br><span class="line">      &lt;address <span class="built_in">type</span>=<span class="string">&#x27;drive&#x27;</span> controller=<span class="string">&#x27;0&#x27;</span> bus=<span class="string">&#x27;0&#x27;</span> target=<span class="string">&#x27;0&#x27;</span> unit=<span class="string">&#x27;0&#x27;</span>/&gt;</span><br><span class="line">    &lt;/disk&gt;</span><br><span class="line">    &lt;disk <span class="built_in">type</span>=<span class="string">&#x27;block&#x27;</span> device=<span class="string">&#x27;cdrom&#x27;</span>&gt;</span><br><span class="line">      &lt;driver name=<span class="string">&#x27;qemu&#x27;</span> <span class="built_in">type</span>=<span class="string">&#x27;raw&#x27;</span> cache=<span class="string">&#x27;none&#x27;</span> io=<span class="string">&#x27;native&#x27;</span>/&gt;</span><br><span class="line">      &lt;<span class="built_in">source</span> dev=<span class="string">&#x27;/dev/sdg&#x27;</span> index=<span class="string">&#x27;1&#x27;</span>/&gt;</span><br><span class="line">      &lt;backingStore/&gt;</span><br><span class="line">      &lt;target dev=<span class="string">&#x27;hdb&#x27;</span> bus=<span class="string">&#x27;ide&#x27;</span>/&gt;</span><br><span class="line">      &lt;<span class="built_in">readonly</span>/&gt;</span><br><span class="line">      &lt;serial&gt;c5f26969-397c-491b-8ee6-a2e9df1f9b42&lt;/serial&gt;</span><br><span class="line">      &lt;<span class="built_in">alias</span> name=<span class="string">&#x27;ide0-0-1&#x27;</span>/&gt;</span><br><span class="line">      &lt;address <span class="built_in">type</span>=<span class="string">&#x27;drive&#x27;</span> controller=<span class="string">&#x27;0&#x27;</span> bus=<span class="string">&#x27;0&#x27;</span> target=<span class="string">&#x27;0&#x27;</span> unit=<span class="string">&#x27;1&#x27;</span>/&gt;</span><br><span class="line">    &lt;/disk&gt;</span><br><span class="line">    &lt;disk <span class="built_in">type</span>=<span class="string">&#x27;block&#x27;</span> device=<span class="string">&#x27;disk&#x27;</span>&gt;</span><br><span class="line">      &lt;driver name=<span class="string">&#x27;qemu&#x27;</span> <span class="built_in">type</span>=<span class="string">&#x27;raw&#x27;</span> cache=<span class="string">&#x27;none&#x27;</span> io=<span class="string">&#x27;native&#x27;</span>/&gt;</span><br><span class="line">      &lt;<span class="built_in">source</span> dev=<span class="string">&#x27;/dev/sdh&#x27;</span> index=<span class="string">&#x27;4&#x27;</span>/&gt;</span><br><span class="line">      &lt;backingStore/&gt;</span><br><span class="line">      &lt;target dev=<span class="string">&#x27;vda&#x27;</span> bus=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span><br><span class="line">      &lt;serial&gt;d1e96c3b-7a2a-478d-ab98-de94aefcbc0e&lt;/serial&gt;</span><br><span class="line">      &lt;<span class="built_in">alias</span> name=<span class="string">&#x27;virtio-disk0&#x27;</span>/&gt;</span><br><span class="line">      &lt;address <span class="built_in">type</span>=<span class="string">&#x27;pci&#x27;</span> domain=<span class="string">&#x27;0x0000&#x27;</span> bus=<span class="string">&#x27;0x00&#x27;</span> slot=<span class="string">&#x27;0x06&#x27;</span> <span class="keyword">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span><br><span class="line">    &lt;/disk&gt;</span><br><span class="line">    ...</span><br><span class="line">  &lt;/devices&gt;</span><br><span class="line">&lt;/domain&gt;</span><br></pre></td></tr></table></figure>

<p>硬重启实例5ace35d4-7195-465e-afca-2c81279bb677。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack server reboot --hard 5ace35d4-7195-465e-afca-2c81279bb677</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * from block_device_mapping <span class="built_in">where</span> instance_uuid=<span class="string">&quot;5ace35d4-7195-465e-afca-2c81279bb677&quot;</span> \G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           created_at: 2023-05-12 02:10:28</span><br><span class="line">           updated_at: 2023-05-12 02:10:28</span><br><span class="line">           deleted_at: NULL</span><br><span class="line">                   <span class="built_in">id</span>: 8746</span><br><span class="line">          device_name: /dev/hda</span><br><span class="line">delete_on_termination: 1</span><br><span class="line">          snapshot_id: NULL</span><br><span class="line">            volume_id: NULL</span><br><span class="line">          volume_size: NULL</span><br><span class="line">            no_device: 0</span><br><span class="line">      connection_info: NULL</span><br><span class="line">        instance_uuid: 5ace35d4-7195-465e-afca-2c81279bb677</span><br><span class="line">              deleted: 0</span><br><span class="line">          source_type: image</span><br><span class="line">     destination_type: <span class="built_in">local</span></span><br><span class="line">         guest_format: NULL</span><br><span class="line">          device_type: NULL</span><br><span class="line">             disk_bus: NULL</span><br><span class="line">           boot_index: 0</span><br><span class="line">             image_id: 60f8adab-fceb-47a2-a32a-f19d2351177e</span><br><span class="line">                  tag: NULL</span><br><span class="line">        attachment_id: NULL</span><br><span class="line">                 uuid: 6de66a02-6efb-4ce0-89a1-fa477f976909</span><br><span class="line">          volume_type: NULL</span><br><span class="line">*************************** 2. row ***************************</span><br><span class="line">           created_at: 2023-05-12 02:10:28</span><br><span class="line">           updated_at: 2023-05-12 02:22:46</span><br><span class="line">           deleted_at: NULL</span><br><span class="line">                   <span class="built_in">id</span>: 8747</span><br><span class="line">          device_name: /dev/hdb</span><br><span class="line">delete_on_termination: 0</span><br><span class="line">          snapshot_id: NULL</span><br><span class="line">            volume_id: c5f26969-397c-491b-8ee6-a2e9df1f9b42</span><br><span class="line">          volume_size: 1</span><br><span class="line">            no_device: 0</span><br><span class="line">      connection_info: &#123;<span class="string">&quot;driver_volume_type&quot;</span>: <span class="string">&quot;iscsi&quot;</span>, <span class="string">&quot;data&quot;</span>: &#123;<span class="string">&quot;target_discovered&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;target_portal&quot;</span>: <span class="string">&quot;10.10.15.12:3260&quot;</span>, <span class="string">&quot;target_iqn&quot;</span>: <span class="string">&quot;iqn.2010-10.org.openstack:volume-c5f26969-397c-491b-8ee6-a2e9df1f9b42&quot;</span>, <span class="string">&quot;target_lun&quot;</span>: 0, <span class="string">&quot;volume_id&quot;</span>: <span class="string">&quot;c5f26969-397c-491b-8ee6-a2e9df1f9b42&quot;</span>, <span class="string">&quot;auth_method&quot;</span>: <span class="string">&quot;CHAP&quot;</span>, <span class="string">&quot;auth_username&quot;</span>: <span class="string">&quot;MDksZ4gonTVKwayfr2fB&quot;</span>, <span class="string">&quot;auth_password&quot;</span>: <span class="string">&quot;jjEXzRGtzbFKiB6m&quot;</span>, <span class="string">&quot;encrypted&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;qos_specs&quot;</span>: null, <span class="string">&quot;access_mode&quot;</span>: <span class="string">&quot;rw&quot;</span>, <span class="string">&quot;device_path&quot;</span>: <span class="string">&quot;/dev/sdh&quot;</span>&#125;, <span class="string">&quot;status&quot;</span>: <span class="string">&quot;reserved&quot;</span>, <span class="string">&quot;instance&quot;</span>: <span class="string">&quot;5ace35d4-7195-465e-afca-2c81279bb677&quot;</span>, <span class="string">&quot;attached_at&quot;</span>: <span class="string">&quot;&quot;</span>, <span class="string">&quot;detached_at&quot;</span>: <span class="string">&quot;&quot;</span>, <span class="string">&quot;volume_id&quot;</span>: <span class="string">&quot;c5f26969-397c-491b-8ee6-a2e9df1f9b42&quot;</span>, <span class="string">&quot;serial&quot;</span>: <span class="string">&quot;c5f26969-397c-491b-8ee6-a2e9df1f9b42&quot;</span>&#125;</span><br><span class="line">        instance_uuid: 5ace35d4-7195-465e-afca-2c81279bb677</span><br><span class="line">              deleted: 0</span><br><span class="line">          source_type: image</span><br><span class="line">     destination_type: volume</span><br><span class="line">         guest_format: NULL</span><br><span class="line">          device_type: cdrom</span><br><span class="line">             disk_bus: ide</span><br><span class="line">           boot_index: NULL</span><br><span class="line">             image_id: eb2006ba-6416-4b68-b8bf-b358589fba34</span><br><span class="line">                  tag: NULL</span><br><span class="line">        attachment_id: c45a1ce7-16b0-4319-90d0-2a08463cc220</span><br><span class="line">                 uuid: 94a9eb85-e31b-41cd-bf07-431d7a6f9534</span><br><span class="line">          volume_type: NULL</span><br><span class="line">*************************** 3. row ***************************</span><br><span class="line">           created_at: 2023-05-12 02:19:10</span><br><span class="line">           updated_at: 2023-05-12 02:22:45</span><br><span class="line">           deleted_at: NULL</span><br><span class="line">                   <span class="built_in">id</span>: 8748</span><br><span class="line">          device_name: /dev/vda</span><br><span class="line">delete_on_termination: 0</span><br><span class="line">          snapshot_id: NULL</span><br><span class="line">            volume_id: d1e96c3b-7a2a-478d-ab98-de94aefcbc0e</span><br><span class="line">          volume_size: 100</span><br><span class="line">            no_device: NULL</span><br><span class="line">      connection_info: &#123;<span class="string">&quot;driver_volume_type&quot;</span>: <span class="string">&quot;iscsi&quot;</span>, <span class="string">&quot;data&quot;</span>: &#123;<span class="string">&quot;target_discovered&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;target_portal&quot;</span>: <span class="string">&quot;10.10.15.12:3260&quot;</span>, <span class="string">&quot;target_iqn&quot;</span>: <span class="string">&quot;iqn.2010-10.org.openstack:volume-d1e96c3b-7a2a-478d-ab98-de94aefcbc0e&quot;</span>, <span class="string">&quot;target_lun&quot;</span>: 0, <span class="string">&quot;volume_id&quot;</span>: <span class="string">&quot;d1e96c3b-7a2a-478d-ab98-de94aefcbc0e&quot;</span>, <span class="string">&quot;auth_method&quot;</span>: <span class="string">&quot;CHAP&quot;</span>, <span class="string">&quot;auth_username&quot;</span>: <span class="string">&quot;7KCnU2hmY9nkUuAoM5Nc&quot;</span>, <span class="string">&quot;auth_password&quot;</span>: <span class="string">&quot;4SMDpNsTFFmzjJi5&quot;</span>, <span class="string">&quot;encrypted&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;qos_specs&quot;</span>: null, <span class="string">&quot;access_mode&quot;</span>: <span class="string">&quot;rw&quot;</span>, <span class="string">&quot;device_path&quot;</span>: <span class="string">&quot;/dev/sdg&quot;</span>&#125;, <span class="string">&quot;status&quot;</span>: <span class="string">&quot;reserved&quot;</span>, <span class="string">&quot;instance&quot;</span>: <span class="string">&quot;5ace35d4-7195-465e-afca-2c81279bb677&quot;</span>, <span class="string">&quot;attached_at&quot;</span>: <span class="string">&quot;&quot;</span>, <span class="string">&quot;detached_at&quot;</span>: <span class="string">&quot;&quot;</span>, <span class="string">&quot;volume_id&quot;</span>: <span class="string">&quot;d1e96c3b-7a2a-478d-ab98-de94aefcbc0e&quot;</span>, <span class="string">&quot;serial&quot;</span>: <span class="string">&quot;d1e96c3b-7a2a-478d-ab98-de94aefcbc0e&quot;</span>&#125;</span><br><span class="line">        instance_uuid: 5ace35d4-7195-465e-afca-2c81279bb677</span><br><span class="line">              deleted: 0</span><br><span class="line">          source_type: volume</span><br><span class="line">     destination_type: volume</span><br><span class="line">         guest_format: NULL</span><br><span class="line">          device_type: disk</span><br><span class="line">             disk_bus: virtio</span><br><span class="line">           boot_index: NULL</span><br><span class="line">             image_id: NULL</span><br><span class="line">                  tag: NULL</span><br><span class="line">        attachment_id: 418d9322-eef3-4b15-9ca0-fbda0d7c9140</span><br><span class="line">                 uuid: b5f6b25d-44f3-416e-aab3-3ce350607d4a</span><br><span class="line">          volume_type: NULL</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.001 sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">domain</span> <span class="attr">type</span>=<span class="string">&#x27;kvm&#x27;</span> <span class="attr">id</span>=<span class="string">&#x27;70&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>instance-0000138e<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>5ace35d4-7195-465e-afca-2c81279bb677<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="tag">&lt;<span class="name">devices</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">emulator</span>&gt;</span>/usr/libexec/qemu-kvm<span class="tag">&lt;/<span class="name">emulator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">&#x27;file&#x27;</span> <span class="attr">device</span>=<span class="string">&#x27;cdrom&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;qemu&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;qcow2&#x27;</span> <span class="attr">cache</span>=<span class="string">&#x27;none&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">file</span>=<span class="string">&#x27;/var/lib/nova/instances/5ace35d4-7195-465e-afca-2c81279bb677/disk&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;3&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">backingStore</span> <span class="attr">type</span>=<span class="string">&#x27;file&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;4&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">format</span> <span class="attr">type</span>=<span class="string">&#x27;raw&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">source</span> <span class="attr">file</span>=<span class="string">&#x27;/var/lib/nova/instances/_base/77a37f6c71682eba3d2f883c4736edd52b431752&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">backingStore</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">backingStore</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;hda&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;ide&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">readonly</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;ide0-0-0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;drive&#x27;</span> <span class="attr">controller</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">target</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">&#x27;block&#x27;</span> <span class="attr">device</span>=<span class="string">&#x27;cdrom&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;qemu&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;raw&#x27;</span> <span class="attr">cache</span>=<span class="string">&#x27;none&#x27;</span> <span class="attr">io</span>=<span class="string">&#x27;native&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">dev</span>=<span class="string">&#x27;/dev/sdh&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">backingStore</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;hdb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;ide&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">readonly</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">serial</span>&gt;</span>c5f26969-397c-491b-8ee6-a2e9df1f9b42<span class="tag">&lt;/<span class="name">serial</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;ide0-0-1&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;drive&#x27;</span> <span class="attr">controller</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">target</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">&#x27;block&#x27;</span> <span class="attr">device</span>=<span class="string">&#x27;disk&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;qemu&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;raw&#x27;</span> <span class="attr">cache</span>=<span class="string">&#x27;none&#x27;</span> <span class="attr">io</span>=<span class="string">&#x27;native&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">dev</span>=<span class="string">&#x27;/dev/sdg&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">backingStore</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;vda&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">serial</span>&gt;</span>d1e96c3b-7a2a-478d-ab98-de94aefcbc0e<span class="tag">&lt;/<span class="name">serial</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;virtio-disk0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x04&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">  <span class="tag">&lt;/<span class="name">devices</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">domain</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>进入系统的安装界面后开始安装windows系统。安装完成后，在实例内部重启系统，会进入系统安装界面，硬重启后解决。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">domain</span> <span class="attr">type</span>=<span class="string">&#x27;kvm&#x27;</span> <span class="attr">id</span>=<span class="string">&#x27;70&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>instance-0000138e<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>5ace35d4-7195-465e-afca-2c81279bb677<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="tag">&lt;<span class="name">devices</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">emulator</span>&gt;</span>/usr/libexec/qemu-kvm<span class="tag">&lt;/<span class="name">emulator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">&#x27;file&#x27;</span> <span class="attr">device</span>=<span class="string">&#x27;cdrom&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;qemu&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;qcow2&#x27;</span> <span class="attr">cache</span>=<span class="string">&#x27;none&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">file</span>=<span class="string">&#x27;/var/lib/nova/instances/5ace35d4-7195-465e-afca-2c81279bb677/disk&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;3&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">backingStore</span> <span class="attr">type</span>=<span class="string">&#x27;file&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;4&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">format</span> <span class="attr">type</span>=<span class="string">&#x27;raw&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">source</span> <span class="attr">file</span>=<span class="string">&#x27;/var/lib/nova/instances/_base/77a37f6c71682eba3d2f883c4736edd52b431752&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">backingStore</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">backingStore</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;hda&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;ide&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">readonly</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;ide0-0-0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;drive&#x27;</span> <span class="attr">controller</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">target</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">&#x27;block&#x27;</span> <span class="attr">device</span>=<span class="string">&#x27;cdrom&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;qemu&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;raw&#x27;</span> <span class="attr">cache</span>=<span class="string">&#x27;none&#x27;</span> <span class="attr">io</span>=<span class="string">&#x27;native&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">dev</span>=<span class="string">&#x27;/dev/sdh&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">backingStore</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;hdb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;ide&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">readonly</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">serial</span>&gt;</span>c5f26969-397c-491b-8ee6-a2e9df1f9b42<span class="tag">&lt;/<span class="name">serial</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;ide0-0-1&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;drive&#x27;</span> <span class="attr">controller</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">target</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">&#x27;block&#x27;</span> <span class="attr">device</span>=<span class="string">&#x27;disk&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;qemu&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;raw&#x27;</span> <span class="attr">cache</span>=<span class="string">&#x27;none&#x27;</span> <span class="attr">io</span>=<span class="string">&#x27;native&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">dev</span>=<span class="string">&#x27;/dev/sdg&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">backingStore</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;vda&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">serial</span>&gt;</span>d1e96c3b-7a2a-478d-ab98-de94aefcbc0e<span class="tag">&lt;/<span class="name">serial</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;virtio-disk0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x04&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">  <span class="tag">&lt;/<span class="name">devices</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">domain</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="Ubuntu镜像"><a href="#Ubuntu镜像" class="headerlink" title="Ubuntu镜像"></a>Ubuntu镜像</h2><p>创建磁盘。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">openstack volume create --size 100 --availability-zone nova --bootable wkt-ubuntu-test-volume</span><br><span class="line">+---------------------+--------------------------------------+</span><br><span class="line">| Field               | Value                                |</span><br><span class="line">+---------------------+--------------------------------------+</span><br><span class="line">| attachments         | []                                   |</span><br><span class="line">| availability_zone   | nova                                 |</span><br><span class="line">| bootable            | <span class="literal">false</span>                                |</span><br><span class="line">| consistencygroup_id | None                                 |</span><br><span class="line">| created_at          | 2023-05-12T06:50:54.000000           |</span><br><span class="line">| description         | None                                 |</span><br><span class="line">| encrypted           | False                                |</span><br><span class="line">| <span class="built_in">id</span>                  | 9275c580-6679-4f60-810b-06ca11ae8742 |</span><br><span class="line">| migration_status    | None                                 |</span><br><span class="line">| multiattach         | False                                |</span><br><span class="line">| name                | wkt-ubuntu-test-volume               |</span><br><span class="line">| properties          |                                      |</span><br><span class="line">| replication_status  | None                                 |</span><br><span class="line">| size                | 100                                  |</span><br><span class="line">| snapshot_id         | None                                 |</span><br><span class="line">| source_volid        | None                                 |</span><br><span class="line">| status              | creating                             |</span><br><span class="line">| <span class="built_in">type</span>                | __DEFAULT__                          |</span><br><span class="line">| updated_at          | None                                 |</span><br><span class="line">| user_id             | 24d08826a98140ce8e2ade2606ff9ad8     |</span><br><span class="line">+---------------------+--------------------------------------+</span><br></pre></td></tr></table></figure>

<p>创建实例，ID是dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">openstack server create --availability-zone cloud \</span><br><span class="line">--flavor 8-8-0 \</span><br><span class="line">--image 82f524ed-4d97-445f-b527-f5299c5d0b3b \</span><br><span class="line">--network 7b6c69b5-bfa5-4145-901c-26979103da77 \</span><br><span class="line">wkt-ubuntu-test</span><br></pre></td></tr></table></figure>

<p>查看block_device_mapping表。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * from block_device_mapping <span class="built_in">where</span> instance_uuid=<span class="string">&quot;dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361&quot;</span> \G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           created_at: 2023-05-12 06:54:05</span><br><span class="line">           updated_at: 2023-05-12 06:54:06</span><br><span class="line">           deleted_at: NULL</span><br><span class="line">                   <span class="built_in">id</span>: 8751</span><br><span class="line">          device_name: /dev/hda</span><br><span class="line">delete_on_termination: 1</span><br><span class="line">          snapshot_id: NULL</span><br><span class="line">            volume_id: NULL</span><br><span class="line">          volume_size: NULL</span><br><span class="line">            no_device: 0</span><br><span class="line">      connection_info: NULL</span><br><span class="line">        instance_uuid: dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361</span><br><span class="line">              deleted: 0</span><br><span class="line">          source_type: image</span><br><span class="line">     destination_type: <span class="built_in">local</span></span><br><span class="line">         guest_format: NULL</span><br><span class="line">          device_type: disk</span><br><span class="line">             disk_bus: NULL</span><br><span class="line">           boot_index: 0</span><br><span class="line">             image_id: 82f524ed-4d97-445f-b527-f5299c5d0b3b</span><br><span class="line">                  tag: NULL</span><br><span class="line">        attachment_id: NULL</span><br><span class="line">                 uuid: 8e57c44d-9fb5-44d9-807d-ae4c675a1c91</span><br><span class="line">          volume_type: NULL</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.001 sec)</span><br></pre></td></tr></table></figure>

<p>xml配置文件。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">domain</span> <span class="attr">type</span>=<span class="string">&#x27;kvm&#x27;</span> <span class="attr">id</span>=<span class="string">&#x27;73&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>instance-00001391<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="tag">&lt;<span class="name">devices</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">emulator</span>&gt;</span>/usr/libexec/qemu-kvm<span class="tag">&lt;/<span class="name">emulator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">&#x27;file&#x27;</span> <span class="attr">device</span>=<span class="string">&#x27;cdrom&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;qemu&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;qcow2&#x27;</span> <span class="attr">cache</span>=<span class="string">&#x27;none&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">file</span>=<span class="string">&#x27;/var/lib/nova/instances/dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361/disk&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">backingStore</span> <span class="attr">type</span>=<span class="string">&#x27;file&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;2&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">format</span> <span class="attr">type</span>=<span class="string">&#x27;raw&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">source</span> <span class="attr">file</span>=<span class="string">&#x27;/var/lib/nova/instances/_base/d2db90ced7b2064373138e505ea3ed5a0b6374c7&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">backingStore</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">backingStore</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;hda&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;ide&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">readonly</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;ide0-0-0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;drive&#x27;</span> <span class="attr">controller</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">target</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">  <span class="tag">&lt;/<span class="name">devices</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">domain</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>添加磁盘。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack server add volume dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361 9275c580-6679-4f60-810b-06ca11ae8742</span><br></pre></td></tr></table></figure>

<p>查看block_device_mapping表。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * from block_device_mapping <span class="built_in">where</span> instance_uuid=<span class="string">&quot;dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361&quot;</span> \G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           created_at: 2023-05-12 06:54:05</span><br><span class="line">           updated_at: 2023-05-12 06:54:06</span><br><span class="line">           deleted_at: NULL</span><br><span class="line">                   <span class="built_in">id</span>: 8751</span><br><span class="line">          device_name: /dev/hda</span><br><span class="line">delete_on_termination: 1</span><br><span class="line">          snapshot_id: NULL</span><br><span class="line">            volume_id: NULL</span><br><span class="line">          volume_size: NULL</span><br><span class="line">            no_device: 0</span><br><span class="line">      connection_info: NULL</span><br><span class="line">        instance_uuid: dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361</span><br><span class="line">              deleted: 0</span><br><span class="line">          source_type: image</span><br><span class="line">     destination_type: <span class="built_in">local</span></span><br><span class="line">         guest_format: NULL</span><br><span class="line">          device_type: disk</span><br><span class="line">             disk_bus: NULL</span><br><span class="line">           boot_index: 0</span><br><span class="line">             image_id: 82f524ed-4d97-445f-b527-f5299c5d0b3b</span><br><span class="line">                  tag: NULL</span><br><span class="line">        attachment_id: NULL</span><br><span class="line">                 uuid: 8e57c44d-9fb5-44d9-807d-ae4c675a1c91</span><br><span class="line">          volume_type: NULL</span><br><span class="line">*************************** 2. row ***************************</span><br><span class="line">           created_at: 2023-05-12 07:00:52</span><br><span class="line">           updated_at: 2023-05-12 07:00:58</span><br><span class="line">           deleted_at: NULL</span><br><span class="line">                   <span class="built_in">id</span>: 8752</span><br><span class="line">          device_name: /dev/vda</span><br><span class="line">delete_on_termination: 0</span><br><span class="line">          snapshot_id: NULL</span><br><span class="line">            volume_id: 9275c580-6679-4f60-810b-06ca11ae8742</span><br><span class="line">          volume_size: 100</span><br><span class="line">            no_device: NULL</span><br><span class="line">      connection_info: &#123;<span class="string">&quot;driver_volume_type&quot;</span>: <span class="string">&quot;iscsi&quot;</span>, <span class="string">&quot;data&quot;</span>: &#123;<span class="string">&quot;target_discovered&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;target_portal&quot;</span>: <span class="string">&quot;10.10.15.12:3260&quot;</span>, <span class="string">&quot;target_iqn&quot;</span>: <span class="string">&quot;iqn.2010-10.org.openstack:volume-9275c580-6679-4f60-810b-06ca11ae8742&quot;</span>, <span class="string">&quot;target_lun&quot;</span>: 0, <span class="string">&quot;volume_id&quot;</span>: <span class="string">&quot;9275c580-6679-4f60-810b-06ca11ae8742&quot;</span>, <span class="string">&quot;auth_method&quot;</span>: <span class="string">&quot;CHAP&quot;</span>, <span class="string">&quot;auth_username&quot;</span>: <span class="string">&quot;WEXNsUK3tjc7fB7Y7NoH&quot;</span>, <span class="string">&quot;auth_password&quot;</span>: <span class="string">&quot;CHpWUeYpQTmA4UMQ&quot;</span>, <span class="string">&quot;encrypted&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;qos_specs&quot;</span>: null, <span class="string">&quot;access_mode&quot;</span>: <span class="string">&quot;rw&quot;</span>, <span class="string">&quot;device_path&quot;</span>: <span class="string">&quot;/dev/sdi&quot;</span>&#125;, <span class="string">&quot;status&quot;</span>: <span class="string">&quot;reserved&quot;</span>, <span class="string">&quot;instance&quot;</span>: <span class="string">&quot;dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361&quot;</span>, <span class="string">&quot;attached_at&quot;</span>: <span class="string">&quot;&quot;</span>, <span class="string">&quot;detached_at&quot;</span>: <span class="string">&quot;&quot;</span>, <span class="string">&quot;volume_id&quot;</span>: <span class="string">&quot;9275c580-6679-4f60-810b-06ca11ae8742&quot;</span>, <span class="string">&quot;serial&quot;</span>: <span class="string">&quot;9275c580-6679-4f60-810b-06ca11ae8742&quot;</span>&#125;</span><br><span class="line">        instance_uuid: dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361</span><br><span class="line">              deleted: 0</span><br><span class="line">          source_type: volume</span><br><span class="line">     destination_type: volume</span><br><span class="line">         guest_format: NULL</span><br><span class="line">          device_type: NULL</span><br><span class="line">             disk_bus: NULL</span><br><span class="line">           boot_index: NULL</span><br><span class="line">             image_id: NULL</span><br><span class="line">                  tag: NULL</span><br><span class="line">        attachment_id: 95e2231a-919a-4a3e-8b2f-7549756fb293</span><br><span class="line">                 uuid: 5158750e-4680-4a13-990b-6ee735087162</span><br><span class="line">          volume_type: NULL</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.000 sec)</span><br></pre></td></tr></table></figure>

<p>xml配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;domain <span class="built_in">type</span>=<span class="string">&#x27;kvm&#x27;</span> <span class="built_in">id</span>=<span class="string">&#x27;73&#x27;</span>&gt;</span><br><span class="line">  &lt;name&gt;instance-00001391&lt;/name&gt;</span><br><span class="line">  &lt;uuid&gt;dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361&lt;/uuid&gt;</span><br><span class="line">  ...</span><br><span class="line">  &lt;devices&gt;</span><br><span class="line">    &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;</span><br><span class="line">    &lt;disk <span class="built_in">type</span>=<span class="string">&#x27;file&#x27;</span> device=<span class="string">&#x27;cdrom&#x27;</span>&gt;</span><br><span class="line">      &lt;driver name=<span class="string">&#x27;qemu&#x27;</span> <span class="built_in">type</span>=<span class="string">&#x27;qcow2&#x27;</span> cache=<span class="string">&#x27;none&#x27;</span>/&gt;</span><br><span class="line">      &lt;<span class="built_in">source</span> file=<span class="string">&#x27;/var/lib/nova/instances/dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361/disk&#x27;</span> index=<span class="string">&#x27;1&#x27;</span>/&gt;</span><br><span class="line">      &lt;backingStore <span class="built_in">type</span>=<span class="string">&#x27;file&#x27;</span> index=<span class="string">&#x27;2&#x27;</span>&gt;</span><br><span class="line">        &lt;format <span class="built_in">type</span>=<span class="string">&#x27;raw&#x27;</span>/&gt;</span><br><span class="line">        &lt;<span class="built_in">source</span> file=<span class="string">&#x27;/var/lib/nova/instances/_base/d2db90ced7b2064373138e505ea3ed5a0b6374c7&#x27;</span>/&gt;</span><br><span class="line">        &lt;backingStore/&gt;</span><br><span class="line">      &lt;/backingStore&gt;</span><br><span class="line">      &lt;target dev=<span class="string">&#x27;hda&#x27;</span> bus=<span class="string">&#x27;ide&#x27;</span>/&gt;</span><br><span class="line">      &lt;<span class="built_in">readonly</span>/&gt;</span><br><span class="line">      &lt;<span class="built_in">alias</span> name=<span class="string">&#x27;ide0-0-0&#x27;</span>/&gt;</span><br><span class="line">      &lt;address <span class="built_in">type</span>=<span class="string">&#x27;drive&#x27;</span> controller=<span class="string">&#x27;0&#x27;</span> bus=<span class="string">&#x27;0&#x27;</span> target=<span class="string">&#x27;0&#x27;</span> unit=<span class="string">&#x27;0&#x27;</span>/&gt;</span><br><span class="line">    &lt;/disk&gt;</span><br><span class="line">    &lt;disk <span class="built_in">type</span>=<span class="string">&#x27;block&#x27;</span> device=<span class="string">&#x27;disk&#x27;</span>&gt;</span><br><span class="line">      &lt;driver name=<span class="string">&#x27;qemu&#x27;</span> <span class="built_in">type</span>=<span class="string">&#x27;raw&#x27;</span> cache=<span class="string">&#x27;none&#x27;</span> io=<span class="string">&#x27;native&#x27;</span>/&gt;</span><br><span class="line">      &lt;<span class="built_in">source</span> dev=<span class="string">&#x27;/dev/sdi&#x27;</span> index=<span class="string">&#x27;3&#x27;</span>/&gt;</span><br><span class="line">      &lt;backingStore/&gt;</span><br><span class="line">      &lt;target dev=<span class="string">&#x27;vda&#x27;</span> bus=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span><br><span class="line">      &lt;serial&gt;9275c580-6679-4f60-810b-06ca11ae8742&lt;/serial&gt;</span><br><span class="line">      &lt;<span class="built_in">alias</span> name=<span class="string">&#x27;virtio-disk0&#x27;</span>/&gt;</span><br><span class="line">      &lt;address <span class="built_in">type</span>=<span class="string">&#x27;pci&#x27;</span> domain=<span class="string">&#x27;0x0000&#x27;</span> bus=<span class="string">&#x27;0x00&#x27;</span> slot=<span class="string">&#x27;0x06&#x27;</span> <span class="keyword">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span><br><span class="line">    &lt;/disk&gt;</span><br><span class="line">    ...</span><br><span class="line">  &lt;/devices&gt;</span><br><span class="line">&lt;/domain&gt;</span><br></pre></td></tr></table></figure>

<p>将实例硬重启。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack server reboot --hard dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361</span><br></pre></td></tr></table></figure>

<p>查看block_device_mapping表。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * from block_device_mapping <span class="built_in">where</span> instance_uuid=<span class="string">&quot;dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361&quot;</span> \G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           created_at: 2023-05-12 06:54:05</span><br><span class="line">           updated_at: 2023-05-12 06:54:06</span><br><span class="line">           deleted_at: NULL</span><br><span class="line">                   <span class="built_in">id</span>: 8751</span><br><span class="line">          device_name: /dev/hda</span><br><span class="line">delete_on_termination: 1</span><br><span class="line">          snapshot_id: NULL</span><br><span class="line">            volume_id: NULL</span><br><span class="line">          volume_size: NULL</span><br><span class="line">            no_device: 0</span><br><span class="line">      connection_info: NULL</span><br><span class="line">        instance_uuid: dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361</span><br><span class="line">              deleted: 0</span><br><span class="line">          source_type: image</span><br><span class="line">     destination_type: <span class="built_in">local</span></span><br><span class="line">         guest_format: NULL</span><br><span class="line">          device_type: disk</span><br><span class="line">             disk_bus: NULL</span><br><span class="line">           boot_index: 0</span><br><span class="line">             image_id: 82f524ed-4d97-445f-b527-f5299c5d0b3b</span><br><span class="line">                  tag: NULL</span><br><span class="line">        attachment_id: NULL</span><br><span class="line">                 uuid: 8e57c44d-9fb5-44d9-807d-ae4c675a1c91</span><br><span class="line">          volume_type: NULL</span><br><span class="line">*************************** 2. row ***************************</span><br><span class="line">           created_at: 2023-05-12 07:00:52</span><br><span class="line">           updated_at: 2023-05-12 07:04:11</span><br><span class="line">           deleted_at: NULL</span><br><span class="line">                   <span class="built_in">id</span>: 8752</span><br><span class="line">          device_name: /dev/vda</span><br><span class="line">delete_on_termination: 0</span><br><span class="line">          snapshot_id: NULL</span><br><span class="line">            volume_id: 9275c580-6679-4f60-810b-06ca11ae8742</span><br><span class="line">          volume_size: 100</span><br><span class="line">            no_device: NULL</span><br><span class="line">      connection_info: &#123;<span class="string">&quot;driver_volume_type&quot;</span>: <span class="string">&quot;iscsi&quot;</span>, <span class="string">&quot;data&quot;</span>: &#123;<span class="string">&quot;target_discovered&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;target_portal&quot;</span>: <span class="string">&quot;10.10.15.12:3260&quot;</span>, <span class="string">&quot;target_iqn&quot;</span>: <span class="string">&quot;iqn.2010-10.org.openstack:volume-9275c580-6679-4f60-810b-06ca11ae8742&quot;</span>, <span class="string">&quot;target_lun&quot;</span>: 0, <span class="string">&quot;volume_id&quot;</span>: <span class="string">&quot;9275c580-6679-4f60-810b-06ca11ae8742&quot;</span>, <span class="string">&quot;auth_method&quot;</span>: <span class="string">&quot;CHAP&quot;</span>, <span class="string">&quot;auth_username&quot;</span>: <span class="string">&quot;WEXNsUK3tjc7fB7Y7NoH&quot;</span>, <span class="string">&quot;auth_password&quot;</span>: <span class="string">&quot;CHpWUeYpQTmA4UMQ&quot;</span>, <span class="string">&quot;encrypted&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;qos_specs&quot;</span>: null, <span class="string">&quot;access_mode&quot;</span>: <span class="string">&quot;rw&quot;</span>, <span class="string">&quot;device_path&quot;</span>: <span class="string">&quot;/dev/sdi&quot;</span>&#125;, <span class="string">&quot;status&quot;</span>: <span class="string">&quot;reserved&quot;</span>, <span class="string">&quot;instance&quot;</span>: <span class="string">&quot;dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361&quot;</span>, <span class="string">&quot;attached_at&quot;</span>: <span class="string">&quot;&quot;</span>, <span class="string">&quot;detached_at&quot;</span>: <span class="string">&quot;&quot;</span>, <span class="string">&quot;volume_id&quot;</span>: <span class="string">&quot;9275c580-6679-4f60-810b-06ca11ae8742&quot;</span>, <span class="string">&quot;serial&quot;</span>: <span class="string">&quot;9275c580-6679-4f60-810b-06ca11ae8742&quot;</span>&#125;</span><br><span class="line">        instance_uuid: dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361</span><br><span class="line">              deleted: 0</span><br><span class="line">          source_type: volume</span><br><span class="line">     destination_type: volume</span><br><span class="line">         guest_format: NULL</span><br><span class="line">          device_type: disk</span><br><span class="line">             disk_bus: virtio</span><br><span class="line">           boot_index: NULL</span><br><span class="line">             image_id: NULL</span><br><span class="line">                  tag: NULL</span><br><span class="line">        attachment_id: 95e2231a-919a-4a3e-8b2f-7549756fb293</span><br><span class="line">                 uuid: 5158750e-4680-4a13-990b-6ee735087162</span><br><span class="line">          volume_type: NULL</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.000 sec)</span><br></pre></td></tr></table></figure>

<p>xml配置文件。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">domain</span> <span class="attr">type</span>=<span class="string">&#x27;kvm&#x27;</span> <span class="attr">id</span>=<span class="string">&#x27;74&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>instance-00001391<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="tag">&lt;<span class="name">devices</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">emulator</span>&gt;</span>/usr/libexec/qemu-kvm<span class="tag">&lt;/<span class="name">emulator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">&#x27;file&#x27;</span> <span class="attr">device</span>=<span class="string">&#x27;cdrom&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;qemu&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;qcow2&#x27;</span> <span class="attr">cache</span>=<span class="string">&#x27;none&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">file</span>=<span class="string">&#x27;/var/lib/nova/instances/dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361/disk&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">backingStore</span> <span class="attr">type</span>=<span class="string">&#x27;file&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;3&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">format</span> <span class="attr">type</span>=<span class="string">&#x27;raw&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">source</span> <span class="attr">file</span>=<span class="string">&#x27;/var/lib/nova/instances/_base/d2db90ced7b2064373138e505ea3ed5a0b6374c7&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">backingStore</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">backingStore</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;hda&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;ide&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">readonly</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;ide0-0-0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;drive&#x27;</span> <span class="attr">controller</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">target</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">&#x27;block&#x27;</span> <span class="attr">device</span>=<span class="string">&#x27;disk&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;qemu&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;raw&#x27;</span> <span class="attr">cache</span>=<span class="string">&#x27;none&#x27;</span> <span class="attr">io</span>=<span class="string">&#x27;native&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">dev</span>=<span class="string">&#x27;/dev/sdi&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">backingStore</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;vda&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">serial</span>&gt;</span>9275c580-6679-4f60-810b-06ca11ae8742<span class="tag">&lt;/<span class="name">serial</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;virtio-disk0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x04&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">  <span class="tag">&lt;/<span class="name">devices</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">domain</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>更改block_device_mapping。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">update block_device_mapping <span class="built_in">set</span> boot_index=NULL <span class="built_in">where</span> <span class="built_in">id</span>=8751;</span><br><span class="line">Query OK, 1 row affected (0.002 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">MariaDB [nova]&gt; update block_device_mapping <span class="built_in">set</span> boot_index=0 <span class="built_in">where</span> <span class="built_in">id</span>=8752;</span><br><span class="line">Query OK, 1 row affected (0.002 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br></pre></td></tr></table></figure>

<p>硬重启实例后，xml配置文件已修改。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">domain</span> <span class="attr">type</span>=<span class="string">&#x27;kvm&#x27;</span> <span class="attr">id</span>=<span class="string">&#x27;75&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>instance-00001391<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>dc6ee9e7-7f0b-4e97-b0eb-087cf22c7361<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="tag">&lt;<span class="name">devices</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">emulator</span>&gt;</span>/usr/libexec/qemu-kvm<span class="tag">&lt;/<span class="name">emulator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">&#x27;block&#x27;</span> <span class="attr">device</span>=<span class="string">&#x27;disk&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;qemu&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;raw&#x27;</span> <span class="attr">cache</span>=<span class="string">&#x27;none&#x27;</span> <span class="attr">io</span>=<span class="string">&#x27;native&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">dev</span>=<span class="string">&#x27;/dev/sdi&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">backingStore</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;vda&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">serial</span>&gt;</span>9275c580-6679-4f60-810b-06ca11ae8742<span class="tag">&lt;/<span class="name">serial</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;virtio-disk0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x04&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">  <span class="tag">&lt;/<span class="name">devices</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">domain</span>&gt;</span></span><br></pre></td></tr></table></figure>
            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-none-link" href="/tags/OpenStack/" rel="tag">OpenStack</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/%E9%95%9C%E5%83%8F/" rel="tag">镜像</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2023/09/21/OpenStack%E6%BC%AB%E6%B8%B8%E6%8C%87%E5%8D%97-%E7%BD%91%E7%BB%9C%E7%AF%87/"
                    data-tooltip="OpenStack漫游指南--网络篇"
                    aria-label="PREVIOUS: OpenStack漫游指南--网络篇"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2022/12/26/Libvirt%E7%BD%91%E7%BB%9C%E6%A1%A3%E6%A1%88/"
                    data-tooltip="Libvirt网络档案"
                    aria-label="NEXT: Libvirt网络档案"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="http://service.weibo.com/share/share.php?&amp;title=https://wangkuntian.github.io/2023/09/21/OpenStack%E6%BC%AB%E6%B8%B8%E6%8C%87%E5%8D%97-%E9%95%9C%E5%83%8F%E7%AF%87/"
                    title="Share on Weibo"
                    aria-label="Share on Weibo"
                >
                    <i class="fab fa-weibo" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=https://wangkuntian.github.io/2023/09/21/OpenStack%E6%BC%AB%E6%B8%B8%E6%8C%87%E5%8D%97-%E9%95%9C%E5%83%8F%E7%AF%87/&amp;title=OpenStack漫游指南--镜像篇"
                    title="Share on QQ"
                    aria-label="Share on QQ"
                >
                    <i class="fab fa-qq" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://wangkuntian.github.io/2023/09/21/OpenStack%E6%BC%AB%E6%B8%B8%E6%8C%87%E5%8D%97-%E9%95%9C%E5%83%8F%E7%AF%87/"
                    title="Share on Qzone"
                    aria-label="Share on Qzone"
                >
                    <i class="fa fa-star" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#table-of-contents" aria-label="目录">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
        
    </div>
</article>

<div class="main-content-wrap">
    
        
            <script src="//cdn.jsdelivr.net/npm/@waline/client"></script>
阅读量：<span id="2023/09/21/OpenStack漫游指南-镜像篇/" class="waline-visitor-count"></span>
<div id="vcomments"></div>
<script>
    new Waline({
        el: "#vcomments",
        serverURL: "https://blog-api-nu-nine.vercel.app/",
        lang: "zh-cn",
        visitor: true,
        emoji: [
            "https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/bilibili",
            "https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/qq",
        ],
        placeholder: "ヾﾉ≧∀≦)o来啊，快活啊!",
        dark: "auto",
        meta: ["nick", "mail", "link"],
        requiredMeta: [],
        wordLimit: "200",
        pageSize: "10",
        highlight: "hanabi",
        copyright: true,
        avatar: "wavatar",
    });
</script>
  
        
    
</div>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2024 Wang kuntian. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2023/09/21/OpenStack%E6%BC%AB%E6%B8%B8%E6%8C%87%E5%8D%97-%E7%BD%91%E7%BB%9C%E7%AF%87/"
                    data-tooltip="OpenStack漫游指南--网络篇"
                    aria-label="PREVIOUS: OpenStack漫游指南--网络篇"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2022/12/26/Libvirt%E7%BD%91%E7%BB%9C%E6%A1%A3%E6%A1%88/"
                    data-tooltip="Libvirt网络档案"
                    aria-label="NEXT: Libvirt网络档案"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="http://service.weibo.com/share/share.php?&amp;title=https://wangkuntian.github.io/2023/09/21/OpenStack%E6%BC%AB%E6%B8%B8%E6%8C%87%E5%8D%97-%E9%95%9C%E5%83%8F%E7%AF%87/"
                    title="Share on Weibo"
                    aria-label="Share on Weibo"
                >
                    <i class="fab fa-weibo" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=https://wangkuntian.github.io/2023/09/21/OpenStack%E6%BC%AB%E6%B8%B8%E6%8C%87%E5%8D%97-%E9%95%9C%E5%83%8F%E7%AF%87/&amp;title=OpenStack漫游指南--镜像篇"
                    title="Share on QQ"
                    aria-label="Share on QQ"
                >
                    <i class="fab fa-qq" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://wangkuntian.github.io/2023/09/21/OpenStack%E6%BC%AB%E6%B8%B8%E6%8C%87%E5%8D%97-%E9%95%9C%E5%83%8F%E7%AF%87/"
                    title="Share on Qzone"
                    aria-label="Share on Qzone"
                >
                    <i class="fa fa-star" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#table-of-contents" aria-label="目录">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="4">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="http://service.weibo.com/share/share.php?&amp;title=https://wangkuntian.github.io/2023/09/21/OpenStack%E6%BC%AB%E6%B8%B8%E6%8C%87%E5%8D%97-%E9%95%9C%E5%83%8F%E7%AF%87/"
                        aria-label="Share on Weibo"
                    >
                        <i class="fab fa-weibo" aria-hidden="true"></i><span>Share on Weibo</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="http://connect.qq.com/widget/shareqq/index.html?url=https://wangkuntian.github.io/2023/09/21/OpenStack%E6%BC%AB%E6%B8%B8%E6%8C%87%E5%8D%97-%E9%95%9C%E5%83%8F%E7%AF%87/&amp;title=OpenStack漫游指南--镜像篇"
                        aria-label="Share on QQ"
                    >
                        <i class="fab fa-qq" aria-hidden="true"></i><span>Share on QQ</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://wangkuntian.github.io/2023/09/21/OpenStack%E6%BC%AB%E6%B8%B8%E6%8C%87%E5%8D%97-%E9%95%9C%E5%83%8F%E7%AF%87/"
                        aria-label="Share on Qzone"
                    >
                        <i class="fa fa-star" aria-hidden="true"></i><span>Share on Qzone</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/faker.jpg" alt="Author&#39;s picture"/>
        
            <h4 id="about-card-name">Wang kuntian</h4>
        
            <div id="about-card-bio"><p>Hi</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Software Engineer</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                Beijing
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover-v1.2.0.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/script-ndtc2tx33sr3grlppafri7aw03fwgxbruphsl7cntcdkym8tusuknerf6c0g.min.js"></script>

<!--SCRIPTS END-->


    




    <script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"display":{"superSample":2.5,"width":180,"height":400,"position":"right","hOffset":0,"vOffset":40},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.2},"dialog":{"enable":true,"hitokoto":false},"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/hibiki.model.json"},"log":false});</script></body>
</html>
